<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","width":500,"display":"always","padding":1,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Blog41-nginx">
<meta property="og:url" content="http://example.com/2000/01/01/Blog41-nginx/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="nginx">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="1999-12-31T16:00:41.000Z">
<meta property="article:modified_time" content="2024-02-18T11:56:15.906Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2000/01/01/Blog41-nginx/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2000/01/01/Blog41-nginx/","path":"2000/01/01/Blog41-nginx/","title":"Blog41-nginx"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Blog41-nginx | Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Blog41-nginx"><span class="nav-text">Blog41-nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%AE%E5%8A%A9"><span class="nav-text">帮助</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AA%E6%95%B4%E7%90%86"><span class="nav-text">未整理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter01-nginx-%E4%BB%8B%E7%BB%8D"><span class="nav-text">Chapter01 nginx 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-nginx-%E4%BB%8B%E7%BB%8D"><span class="nav-text">1.1 nginx 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E7%AE%80%E4%BB%8B"><span class="nav-text">知识点：nginx 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E8%BF%9B%E7%A8%8B%E4%BD%93%E7%B3%BB"><span class="nav-text">知识点：nginx 进程体系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-text">知识点：nginx 目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E6%A8%A1%E5%9D%97"><span class="nav-text">知识点：nginx 模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-nginx-%E5%AE%89%E8%A3%85%E5%8D%87%E7%BA%A7%E5%8D%B8%E8%BD%BD"><span class="nav-text">1.2 nginx 安装升级卸载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91-configure-%E9%80%89%E9%A1%B9"><span class="nav-text">知识点：nginx 源码编译 configure 选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-text">知识点：nginx 编译安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-docker-%E5%AE%89%E8%A3%85"><span class="nav-text">知识点：nginx docker 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E5%8D%B8%E8%BD%BD"><span class="nav-text">知识点：nginx 卸载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E5%8D%87%E7%BA%A7"><span class="nav-text">知识点：nginx 升级</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-nginx-%E7%AE%A1%E7%90%86"><span class="nav-text">1.3 nginx 管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E5%91%BD%E4%BB%A4"><span class="nav-text">知识点：nginx 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-text">知识点：nginx 信号量操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter02-nginx-%E9%85%8D%E7%BD%AE"><span class="nav-text">Chapter02 nginx 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-nginx-%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D"><span class="nav-text">2.1 nginx 配置介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E9%85%8D%E7%BD%AE%E7%AE%80%E4%BB%8B"><span class="nav-text">知识点：nginx 配置简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="nav-text">知识点：nginx 配置语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E5%8F%98%E9%87%8F"><span class="nav-text">知识点：nginx 变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aurl"><span class="nav-text">知识点：url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E8%A7%A3%E6%9E%90-url-%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="nav-text">知识点：nginx 解析 url 的过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AMIME"><span class="nav-text">知识点：MIME</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-main-%E5%9D%97"><span class="nav-text">2.2 main 块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Amain-%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：main 块介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Auser-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：user 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Amaster-process-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：master_process 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aworker-processes-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：worker_processes 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Adaemon-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：daemon 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apid-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：pid 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aerror-log-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：error_log 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Ainclude-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：include 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-events-%E5%9D%97"><span class="nav-text">2.3 events 块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aevents-%E5%9D%97"><span class="nav-text">知识点：events 块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aaccept-mutex-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：accept_mutex 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Amulti-accept-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：multi_accept 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aworker-connections-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：worker_connections 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Ause-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：use 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-http-%E5%9D%97"><span class="nav-text">2.4 http 块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Ahttp-%E5%9D%97"><span class="nav-text">知识点：http 块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Alog-format-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：log_format 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aaccess-log-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：access_log 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Adefault-type-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：default_type 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aserver-tokens-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：server_tokens 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-server-%E5%9D%97"><span class="nav-text">2.5 server 块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aserver-%E5%9D%97"><span class="nav-text">知识点：server 块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Alisten-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：listen 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aserver-name-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：server_name 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-location-%E5%9D%97"><span class="nav-text">2.6 location 块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Alocation-%E5%9D%97"><span class="nav-text">知识点：location 块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Alocation-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：location 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aroot-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：root 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aalias-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：alias 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aindex-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：index 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Atry-files-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：try_files 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aerror-page-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：error_page 指令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter03-nginx-%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="nav-text">Chapter03 nginx 常用功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-https"><span class="nav-text">3.1 https</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ASSL-x2F-TLS"><span class="nav-text">知识点：SSL&#x2F;TLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Ahttps-%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：https 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Ahttps-%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：https 配置范例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Assl-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ssl 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Assl-certificate-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ssl_certificate 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Assl-certificate-key-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ssl_certificate_key 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Assl-session-cache-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ssl_session_cache 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Assl-session-timeout-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ssl_session_timeout 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Assl-ciphers-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ssl_ciphers 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Assl-prefer-server-ciphers-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ssl_prefer_server_ciphers 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-rewrite"><span class="nav-text">3.2 rewrite</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="nav-text">知识点：跨域问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E9%98%B2%E7%9B%97%E9%93%BE"><span class="nav-text">知识点：防盗链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Arewrite-%E9%87%8D%E5%86%99"><span class="nav-text">知识点：rewrite 重写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aset-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：set 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aif-%E5%9D%97"><span class="nav-text">知识点：if 块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Abreak-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：break 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Areturn-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：return 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Arewrite-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：rewrite 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Arewrite-log-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：rewrite_log 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Arewrite-%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：rewrite 配置范例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Arewrite-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">知识点：rewrite 应用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-text">3.3 反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-text">知识点：反向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-text">知识点：正向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aproxy-pass-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：proxy_pass 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aproxy-pass-%E6%8C%87%E4%BB%A4%E5%AF%B9-URL-%E7%9A%84%E6%94%B9%E5%86%99"><span class="nav-text">知识点：proxy_pass 指令对 URL 的改写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aproxy-set-header-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：proxy_set_header 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aproxy-connect-timeout-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：proxy_connect_timeout 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aproxy-redirect-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：proxy_redirect 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：nginx 反向代理配置范例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">3.4 负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-Load-Balancing"><span class="nav-text">知识点：负载均衡 Load Balancing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">知识点：nginx 七层负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Angx-http-upstream-module-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ngx_http_upstream_module 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%B8%B8%E7%94%A8%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-text">知识点：nginx 七层负载均衡的常用均衡策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86"><span class="nav-text">3.5 四层代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86%E4%B8%8E%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">知识点：nginx 四层代理与四层负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Angx-stream-core-module-%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ngx_stream_core_module 相关指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Angx-stream-core-module-%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4-1"><span class="nav-text">知识点：ngx_stream_core_module 相关指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Angx-stream-proxy-module-%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ngx_stream_proxy_module 相关指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：nginx 四层负载均衡范例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E7%BC%93%E5%AD%98%E9%9B%86%E6%88%90"><span class="nav-text">3.6 缓存集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2%E5%92%8C%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98"><span class="nav-text">知识点：nginx 代理缓冲和代理缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2%E9%85%8D%E7%BD%AE"><span class="nav-text">知识点：nginx 代理缓冲配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="nav-text">知识点：nginx 代理缓存配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E7%9A%84%E6%B8%85%E9%99%A4"><span class="nav-text">知识点：nginx 代理缓存的清除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="nav-text">3.7 其他常用功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">知识点：文件服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E9%99%90%E9%80%9F"><span class="nav-text">知识点：限速</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-text">知识点：访问控制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter04-nginx-%E4%BC%98%E5%8C%96"><span class="nav-text">Chapter04 nginx 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-nginx-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-text">4.1 nginx 性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aworker-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-text">知识点：worker 性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Asendfile-%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="nav-text">知识点：sendfile 零拷贝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akeepalive-%E9%95%BF%E8%BF%9E%E6%8E%A5"><span class="nav-text">知识点：keepalive 长连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-nginx-%E5%8E%8B%E7%BC%A9"><span class="nav-text">4.2 nginx 压缩</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E5%8A%A8%E6%80%81%E5%8E%8B%E7%BC%A9%E4%B8%8E-ngx-http-gzip-module-%E6%A8%A1%E5%9D%97"><span class="nav-text">知识点：动态压缩与 ngx_http_gzip_module 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E9%9D%99%E6%80%81%E5%8E%8B%E7%BC%A9%E4%B8%8E-ngx-http-gzip-static-module-%E6%A8%A1%E5%9D%97"><span class="nav-text">知识点：静态压缩与 ngx_http_gzip_static_module 模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-nginx-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="nav-text">4.3 nginx 浏览器缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：浏览器缓存介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anginx-%E9%85%8D%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="nav-text">知识点：nginx 配置浏览器缓存</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2000/01/01/Blog41-nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Blog41-nginx | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Blog41-nginx
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2000-01-01 00:00:41" itemprop="dateCreated datePublished" datetime="2000-01-01T00:00:41+08:00">2000-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-02-18 19:56:15" itemprop="dateModified" datetime="2024-02-18T19:56:15+08:00">2024-02-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <hr>
<h1 id="Blog41-nginx"><a href="#Blog41-nginx" class="headerlink" title="Blog41-nginx"></a>Blog41-nginx</h1><p><a href="#Chapter01-nginx-%E4%BB%8B%E7%BB%8D"><strong>Chapter01 nginx 介绍</strong></a></p>
<ul>
<li><a href="#1-1-nginx-%E4%BB%8B%E7%BB%8D">1.1 nginx 介绍</a></li>
<li><a href="#1-2-nginx-%E5%AE%89%E8%A3%85%E5%8D%87%E7%BA%A7%E5%8D%B8%E8%BD%BD">1.2 nginx 安装升级卸载</a></li>
<li><a href="#1-3-nginx-%E7%AE%A1%E7%90%86">1.3 nginx 管理</a></li>
</ul>
<p><a href="#Chapter02-nginx-%E9%85%8D%E7%BD%AE"><strong>Chapter02 nginx 配置</strong></a></p>
<ul>
<li><a href="#2-1-nginx-%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D">2.1 nginx 配置介绍</a></li>
<li><a href="#2-2-main-%E5%9D%97">2.2 main 块</a></li>
<li><a href="#2-3-events-%E5%9D%97">2.3 events 块</a></li>
<li><a href="#2-4-http-%E5%9D%97">2.4 http 块</a></li>
<li><a href="#2-5-server-%E5%9D%97">2.5 server 块</a></li>
<li><a href="#2-6-location-%E5%9D%97">2.6 location 块</a></li>
</ul>
<p><a href="#Chapter03-nginx-%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><strong>Chapter03 nginx 常用功能</strong></a></p>
<ul>
<li><a href="#3-1-https">3.1 https</a></li>
<li><a href="#3-2-rewrite">3.2 rewrite</a></li>
<li><a href="#3-3-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">3.3 反向代理</a></li>
<li><a href="#3-4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">3.4 负载均衡</a></li>
<li><a href="#3-5-%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86">3.5 四层代理</a></li>
<li><a href="#3-6-%E7%BC%93%E5%AD%98%E9%9B%86%E6%88%90">3.6 缓存集成</a></li>
<li><a href="#3-7-%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD">3.7 其他常用功能</a></li>
</ul>
<p><a href="#Chapter04-nginx-%E4%BC%98%E5%8C%96"><strong>Chapter04 nginx 优化</strong></a></p>
<ul>
<li><a href="#4-1-nginx-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">4.1 nginx 性能优化</a></li>
<li><a href="#4-2-nginx-%E5%8E%8B%E7%BC%A9">4.2 nginx 压缩</a></li>
<li><a href="#4-3-nginx-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98">4.3 nginx 浏览器缓存</a></li>
</ul>
<hr>
<h2 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h2><ol>
<li><strong>官网</strong></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://nginx.org/">https://nginx.org</a></li>
</ul>
<ol start="2">
<li><strong>官方文档</strong></li>
</ol>
<ul>
<li>官方文档：<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/">https://nginx.org/en/docs/</a></li>
<li>configure 编译选项：<ul>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/configure.html">https://nginx.org/en/docs/configure.html</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/#configuring-the-build-options">https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/#configuring-the-build-options</a></li>
</ul>
</li>
<li>指令索引：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/dirindex.html">http://nginx.org/en/docs/dirindex.html</a></li>
<li>变量索引：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/varindex.html">http://nginx.org/en/docs/varindex.html</a></li>
</ul>
<hr>
<h2 id="未整理"><a href="#未整理" class="headerlink" title="未整理"></a>未整理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">3. nginx 变量介绍</span><br><span class="line"></span><br><span class="line">5. ssl</span><br><span class="line">  ssl 的工作机制</span><br><span class="line">  数字证书和数字签名</span><br><span class="line">  生成数字证书、查看数字证书</span><br><span class="line">  搭建 ca</span><br><span class="line"></span><br><span class="line">7. 加载第三方模块</span><br><span class="line"></span><br><span class="line">9. web 服务器的本质</span><br><span class="line"></span><br><span class="line">10. rewrite</span><br><span class="line">  - rewrite 的工作流程</span><br><span class="line">  - 临时重定向、永久重定向</span><br><span class="line">  - return URL 的重定向</span><br><span class="line">  - break 的重定向</span><br><span class="line">  - 如果不加斜杠，nginx 服务器内部会做一个301重定向</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Chapter01-nginx-介绍"><a href="#Chapter01-nginx-介绍" class="headerlink" title="Chapter01 nginx 介绍"></a>Chapter01 nginx 介绍</h1><hr>
<h2 id="1-1-nginx-介绍"><a href="#1-1-nginx-介绍" class="headerlink" title="1.1 nginx 介绍"></a>1.1 nginx 介绍</h2><hr>
<h3 id="知识点：nginx-简介"><a href="#知识点：nginx-简介" class="headerlink" title="知识点：nginx 简介"></a>知识点：nginx 简介</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx，表示 engine x</span><br><span class="line">  - 开源 http web 服务器</span><br><span class="line"></span><br><span class="line">* 历史</span><br><span class="line">  - 由伊戈尔·赛索耶夫使用 C 编写</span><br><span class="line">  - 20041004 发布第一个版本 0.1.0</span><br><span class="line">  - 20190311 被 F5 收购，nginx 商业版为 nginxPlus</span><br><span class="line"></span><br><span class="line">* 核心功能</span><br><span class="line">  - 静态资源</span><br><span class="line">  - 反向代理</span><br><span class="line">  - 负载均衡</span><br><span class="line"></span><br><span class="line">* 特点</span><br><span class="line">  - 多进程</span><br><span class="line">  - 模块化</span><br><span class="line">  - 复用的多线程 IO 结构</span><br><span class="line">    - 异步非阻塞 IO</span><br><span class="line">    - 默认采用 epoll 系统呼叫</span><br><span class="line">      - epoll 需要 kernel 2.6 以上，因为从 2.6 才开始支持 epoll</span><br><span class="line">      - 也可以采用 select、poll 等系统呼叫，但需要手动添加模块</span><br><span class="line"></span><br><span class="line">* 优点</span><br><span class="line">  - 轻量级，速度快</span><br><span class="line">  - 并发高，官方数据五万每台服务器</span><br><span class="line">  - 扩展性</span><br><span class="line">  - 热部署</span><br><span class="line">    - 不停机升级版本</span><br><span class="line">    - 不停机变更配置文件、更换日志文件</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>版本</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* Mainline version</span><br><span class="line">  - 主要开发版</span><br><span class="line">  - 通常是最新版，通常版本号为奇数</span><br><span class="line">  - 生产环境不建议使用</span><br><span class="line"></span><br><span class="line">* Stable version</span><br><span class="line">  - 最新稳定版</span><br><span class="line">  - 通常版本号为偶数</span><br><span class="line">  - 生产环境建议使用此版本</span><br><span class="line">  - Legacy version</span><br><span class="line"></span><br><span class="line">* Legacy versions</span><br><span class="line">  - 旧稳定版</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>阵营</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 开源版 nginx</span><br><span class="line">  - http://nginx.org</span><br><span class="line"></span><br><span class="line">* 商业版 nginxPlus</span><br><span class="line">  - https://www.nginx.com</span><br><span class="line"></span><br><span class="line">* Openresty</span><br><span class="line">  - http://openresty.org</span><br><span class="line">  - 大量的 lua 整合</span><br><span class="line"></span><br><span class="line">* Tengine</span><br><span class="line">  - http://tengine.taobao.org</span><br><span class="line">  - 淘宝二次开发的 nginx，添加了众多的贴合生产的实用功能</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>业务角色</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 浏览器</span><br><span class="line">  - Chrome</span><br><span class="line"></span><br><span class="line">* 负载均衡</span><br><span class="line">  - haproxy</span><br><span class="line">  - lvs</span><br><span class="line"></span><br><span class="line">* 反向代理</span><br><span class="line">  - nginx</span><br><span class="line"></span><br><span class="line">* 后端</span><br><span class="line">  - java</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-进程体系"><a href="#知识点：nginx-进程体系" class="headerlink" title="知识点：nginx 进程体系"></a>知识点：nginx 进程体系</h3><ol>
<li><strong>master</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 监听端口</span><br><span class="line">  - 接收用户 request</span><br><span class="line">  - 保存用户连接的 socket</span><br><span class="line">  - fork 出 worker 进程，并保存在工作进程表中</span><br><span class="line">  - 通过单向管道发送指令给工作进程</span><br><span class="line"></span><br><span class="line">* 关于 master 进程使用 root 用户启动</span><br><span class="line">  - master 进程需要监听 80、443 端口</span><br><span class="line">  - linux 规定，1024 以下的端口，只能由 root 用户来监听</span><br><span class="line">  - 如果 nginx 不使用 1024 以下的端口，那么 master 可以使用非 root 用户来启动</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>worker</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - master 的子进程，负责具体的处理任务</span><br><span class="line">  - 与客户端建立连接，返回数据给客户端</span><br><span class="line">  - 工作进程之间相互隔离，需要依靠 master 来实现工作进程之间的通信</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-目录结构"><a href="#知识点：nginx-目录结构" class="headerlink" title="知识点：nginx 目录结构"></a>知识点：nginx 目录结构</h3><ol>
<li><strong>conf</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 的配置文件目录</span><br><span class="line"></span><br><span class="line">* nginx.conf</span><br><span class="line">  - nginx 的核心配置文件</span><br><span class="line"></span><br><span class="line">* mime.types</span><br><span class="line">  - 记录各种 mime 类型与后缀名的关系</span><br><span class="line"></span><br><span class="line">* *cgi.conf</span><br><span class="line">  - 各种 cgi 配置</span><br><span class="line"></span><br><span class="line">* *.default</span><br><span class="line">  - 各种配置文件的原始备份副本</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>html</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 默认静态文件目录</span><br><span class="line"></span><br><span class="line">* index.html</span><br><span class="line">  - 默认首页</span><br><span class="line"></span><br><span class="line">* 50x.html</span><br><span class="line">  - 访问失败的失败页面</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>logs</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 日志目录</span><br><span class="line"></span><br><span class="line">* access.log</span><br><span class="line">  - 访问日志，记录用户的访问请求</span><br><span class="line"></span><br><span class="line">* error.log</span><br><span class="line">  - 错误日志，记录 nginx 运行中的错误信息，不记录用户的访问请求</span><br><span class="line"></span><br><span class="line">* nginx.pid</span><br><span class="line">  - nginx master 进程的 pid</span><br><span class="line">  - nginx 程序基于此文件来控制 master</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>sbin</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 程序目录</span><br><span class="line"></span><br><span class="line">* nginx</span><br><span class="line">  - nginx 服务器的二进制程序文件</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-模块"><a href="#知识点：nginx-模块" class="headerlink" title="知识点：nginx 模块"></a>知识点：nginx 模块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 高度模块化，所有功能均由模块实现，通过增减模块来增减功能</span><br><span class="line">  - 早期不支持 DSO 机制</span><br><span class="line">  - 1.9.11 开始支持动态装载和卸载</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>核心模块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 服务正常运行必不可少的模块</span><br><span class="line">  - 默认编译包含，无法手动移除</span><br><span class="line"></span><br><span class="line">* 包括：</span><br><span class="line">  - ngx_core</span><br><span class="line">  - ngx_http_core_module</span><br><span class="line">  - ngx_errlog</span><br><span class="line">  - ngx_conf</span><br><span class="line">  - ngx_event</span><br><span class="line">  - ngx_events</span><br><span class="line">  - ngx_epoll</span><br><span class="line">  - ngs_regex</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>标准 HTTP 模块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 提供标准 http 服务</span><br><span class="line">  - 默认编译包含，可以使用 --without 手动移除</span><br><span class="line"></span><br><span class="line">* 包括：</span><br><span class="line">  - ngx_http_charset_module</span><br><span class="line">  - ngx_http_gzip_module</span><br><span class="line">  - ngx_http_rewrite_module</span><br><span class="line">  - ngx_http_upstream_*</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>扩展 HTTP 模块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 扩展标准 http 的功能</span><br><span class="line">  - 某些常用的模块都是通常建议添加的</span><br><span class="line">  - 源码已经包含在 nginx 源码包中</span><br><span class="line">  - 默认编译不包含，可以使用 --with 手动添加</span><br><span class="line"></span><br><span class="line">* 包括：</span><br><span class="line">  - ngx_http_gzip_static_module</span><br><span class="line">  - ngx_http_ssl_module</span><br><span class="line">  - ngx_stream_core_module</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>可选功能性模块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 让 nginx 具有特定功能的模块</span><br><span class="line">  - 只在特定的使用场景中才需要添加</span><br><span class="line">  - 源码已经包含在 nginx 源码包中</span><br><span class="line">  - 默认编译不包含，可以使用 --with 手动添加</span><br><span class="line"></span><br><span class="line">* 包括：</span><br><span class="line">  - 邮件服务模块，如 ngx_mail_*</span><br><span class="line">  - stream 服务，如 ngx_stream_*</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>第三方模块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 源码包中并不包含这些模块的源码，需要额外下载</span><br><span class="line">  - 编译时需要使用 --add-module 手动添加</span><br><span class="line"></span><br><span class="line">* 包括</span><br><span class="line">  - rds-json-nginx</span><br><span class="line">  - lua-nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* 常用第三方开源模块</span><br><span class="line">  - echo-nginx-module https://github.com/openresty/echo-nginx-module</span><br><span class="line">  - nginx-upstream-fair https://github.com/gnosek/nginx-upstream-fair</span><br><span class="line">  - ngx_cache_purge https://github.com/FRiCKLE/ngx_cache_purge</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="1-2-nginx-安装升级卸载"><a href="#1-2-nginx-安装升级卸载" class="headerlink" title="1.2 nginx 安装升级卸载"></a>1.2 nginx 安装升级卸载</h2><hr>
<h3 id="知识点：nginx-源码编译-configure-选项"><a href="#知识点：nginx-源码编译-configure-选项" class="headerlink" title="知识点：nginx 源码编译 configure 选项"></a>知识点：nginx 源码编译 configure 选项</h3><ol>
<li><strong>查看帮助</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* ./configure --help</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>常规类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* --user=USER</span><br><span class="line">  - 指定 nginx 的启动用户</span><br><span class="line"></span><br><span class="line">* --group=GROUP</span><br><span class="line">  - 指定 nginx 的启动用户组</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>PATH 类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* --prefix=DIR</span><br><span class="line">  - 指定 nginx 的安装目录的绝对路径</span><br><span class="line">  - 默认为 /usr/local/nginx</span><br><span class="line"></span><br><span class="line">* --sbin-path=PATH</span><br><span class="line">  - 指定 nginx 程序文件的绝对路径</span><br><span class="line">  - 默认为 prefix/sbin/nginx</span><br><span class="line"></span><br><span class="line">* --conf-path=PATH</span><br><span class="line">  - 指定 nginx.conf 文件的绝对路径</span><br><span class="line">  - 默认为 prefix/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">* --http-log-path=PATH</span><br><span class="line">  - 指定 access.log 文件的绝对路径</span><br><span class="line">  - 默认为 prefix/logs/access.log</span><br><span class="line"></span><br><span class="line">* --error-log-path=PATH</span><br><span class="line">  - 指定 error.log 文件的绝对路径</span><br><span class="line">  - 默认为 prefix/logs/error.log</span><br><span class="line"></span><br><span class="line">* --modules-path=PATH</span><br><span class="line">  - 指定动态模块的安装目录的绝对路径</span><br><span class="line">  - 默认为 prefix/modules</span><br><span class="line"></span><br><span class="line">* --pid-path=PATH</span><br><span class="line">  - 指定 pid 文件的位置</span><br><span class="line">  - 默认为 prefix/logs/nginx.pid</span><br><span class="line"></span><br><span class="line">* --add-module=DIR</span><br><span class="line">  - 指定添加第三方模块的源码目录</span><br><span class="line"></span><br><span class="line">* --lock-path=PATH</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>with 类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 向 nginx 添加模块</span><br><span class="line"></span><br><span class="line">* --with-http_gzip_static_module</span><br><span class="line">  - gzip 静态压缩</span><br><span class="line"></span><br><span class="line">* --with-http_gunzip_module</span><br><span class="line"></span><br><span class="line">* --with-http_geoip_module</span><br><span class="line"></span><br><span class="line">* --with-http_ssl_module</span><br><span class="line">  - https</span><br><span class="line"></span><br><span class="line">* --with-http_v2_module</span><br><span class="line">  - http 2.0</span><br><span class="line"></span><br><span class="line">* --with-http_realip_module</span><br><span class="line">  - 获取用户真实 IP</span><br><span class="line"></span><br><span class="line">* --with-http_addition_module</span><br><span class="line"></span><br><span class="line">* --with-http_image_filter_module</span><br><span class="line"></span><br><span class="line">* --with-http_stub_status_module</span><br><span class="line">  - 状态页</span><br><span class="line"></span><br><span class="line">* --with-stream</span><br><span class="line">* --with-stream_ssl_module</span><br><span class="line">* --with-stream_realip_module</span><br><span class="line">  - 四层负载均衡相关</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>without 类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 禁用 nginx 的默认模块</span><br><span class="line"></span><br><span class="line">* --without_http_gzip_module</span><br><span class="line">  - 禁用 ngx_http_gzip_module 模块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-编译安装"><a href="#知识点：nginx-编译安装" class="headerlink" title="知识点：nginx 编译安装"></a>知识点：nginx 编译安装</h3><ol>
<li><strong>规划</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 启动用户</span><br><span class="line">  - nginx:nginx</span><br><span class="line"></span><br><span class="line">* 安装位置</span><br><span class="line">  - /usr/local/nginx/</span><br><span class="line"></span><br><span class="line">* 添加模块</span><br><span class="line">  - 压缩</span><br><span class="line">  - https</span><br><span class="line">  - http 2.0</span><br><span class="line">  - realip</span><br><span class="line">  - geoip</span><br><span class="line">  - 四层负载均衡</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>准备工作</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载安装包</span></span><br><span class="line">wget https://nginx.org/download/nginx-1.24.0.tar.gz</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建用户</span></span><br><span class="line">useradd -s /bin/false nginx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum 安装依赖</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pcre 正则支持</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zlib 压缩支持</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> openssl https 支持</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> gd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> geoip</span></span><br><span class="line">yum -y install \</span><br><span class="line">  gcc \</span><br><span class="line">  pcre pcre-devel \</span><br><span class="line">  zlib zlib-devel \</span><br><span class="line">  openssl openssl-devel \</span><br><span class="line">  gd gd-devel \</span><br><span class="line">  geoip geoip-devel</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> apt 安装依赖</span></span><br><span class="line">apt-get -y install \</span><br><span class="line">  build-essential \</span><br><span class="line">  libpcre3 libpcre3-dev \</span><br><span class="line">  zlib1g zlib1g-dev \</span><br><span class="line">  libssl-dev \</span><br><span class="line">  libgd-dev \</span><br><span class="line">  libxml2 libxml2-dev \</span><br><span class="line">  uuid-dev \</span><br><span class="line">  geoip-database libgeoip1 geoip-bin libgeoip-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>源码编译安装</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">tar xf nginx-1.24.0.tar.gz</span><br><span class="line">cd nginx-1.24.0</span><br><span class="line">./configure \</span><br><span class="line"> --user=nginx \</span><br><span class="line"> --group=nginx \</span><br><span class="line"> --prefix=/usr/local/nginx \</span><br><span class="line"> --with-http_gzip_static_module \</span><br><span class="line"> --with-http_gunzip_module \</span><br><span class="line"> --with-http_ssl_module \</span><br><span class="line"> --with-http_v2_module \</span><br><span class="line"> --with-http_realip_module \</span><br><span class="line"> --with-http_addition_module \</span><br><span class="line"> --with-http_geoip_module \</span><br><span class="line"> --with-http_stub_status_module \</span><br><span class="line"> --with-http_image_filter_module \</span><br><span class="line"> --with-stream \</span><br><span class="line"> --with-stream_ssl_module \</span><br><span class="line"> --with-stream_realip_module</span><br><span class="line"></span><br><span class="line">make -j 4 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">chown -R nginx:nginx /usr/local/nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>配置系统服务</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx web service</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line"><span class="meta">#</span><span class="bash"> User=nginx</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Group=nginx</span></span><br><span class="line">PIDFile=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/usr/bin/rm -f /usr/local/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-docker-安装"><a href="#知识点：nginx-docker-安装" class="headerlink" title="知识点：nginx docker 安装"></a>知识点：nginx docker 安装</h3><hr>
<h3 id="知识点：nginx-卸载"><a href="#知识点：nginx-卸载" class="headerlink" title="知识点：nginx 卸载"></a>知识点：nginx 卸载</h3><ol>
<li><strong>操作</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop</span><br><span class="line"></span><br><span class="line">rm -rf /usr/local/nginx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除之前编译时生成的链接文件 *.o</span></span><br><span class="line">cd nginx-1.24.0</span><br><span class="line">make clean</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-升级"><a href="#知识点：nginx-升级" class="headerlink" title="知识点：nginx 升级"></a>知识点：nginx 升级</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 本质上，nginx 的升级，就只是替换了 nginx 二进制程序文件而已</span><br><span class="line">  - 其他诸如配置文件、页面文件，保持不变</span><br><span class="line"></span><br><span class="line">* 场景</span><br><span class="line">  - 旧版本升级到新版本</span><br><span class="line">  - 原有 nginx 增减模块，增减第三方模块</span><br><span class="line"></span><br><span class="line">* 优点</span><br><span class="line">  - 热部署是 nginx 的主要优点之一</span><br><span class="line">  - 可以在不影响终端业务的情况下，变更 nginx 程序</span><br><span class="line"></span><br><span class="line">* 操作步骤</span><br><span class="line">  Step1: 编译生成新的 nginx 二进制程序</span><br><span class="line">    - 仅 make</span><br><span class="line">    - 千万不要 make install</span><br><span class="line">  Step2: 平滑升级</span><br><span class="line">    - 信号量方式</span><br><span class="line">    - make upgrade 方式</span><br><span class="line">    - 纯手动方式</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>Step1 编译生成新的 nginx 二进制程序</strong></li>
</ol>
<ul>
<li>旧版本升级到新版本<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-XXXX</span><br><span class="line">./configure XXXX</span><br><span class="line">make</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>增减模块<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 保存原有 nginx 的 configure arguments</span></span><br><span class="line">nginx_OLD_CONFIG_ARGS=$(nginx -V 2&gt;&amp;1 | grep configure | sed &#x27;s/^configure arguments://&#x27;)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 进入 nginx 源码目录，清除之前的编译内容</span></span><br><span class="line">cd nginx-XXXX</span><br><span class="line">make clean</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 重新执行 configure 脚本生成新配置</span></span><br><span class="line">./configure $&#123;nginx_OLD_CONFIG_ARGS&#125; New_Configure_Arguments</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 生成新的 nginx 二进制文件</span></span><br><span class="line">make -j 4</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li><strong>Step2 平滑升级</strong></li>
</ol>
<ul>
<li>信号量方式<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入 nginx 源码目录</span></span><br><span class="line">cd nginx-X.XX.X</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份旧 nginx 程序</span></span><br><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old.bak</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝新 nginx 程序</span></span><br><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 平滑升级</span></span><br><span class="line">kill -USR2 `cat /usr/local/nginx/logs/nginx.pid`</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 旧 nginx 进行优雅退出</span></span><br><span class="line">kill -QUIT `cat /usr/local/nginx/logs/nginx.pid.oldbin`</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>make upgrade 方式<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> make upgrade 方式本质上只是将信号量方式中的操作自动做了一遍而已</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入 nginx 源码目录</span></span><br><span class="line">cd nginx-X.XX.X</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份旧 nginx 程序</span></span><br><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old.bak</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝新 nginx 程序</span></span><br><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行 make upgrade，nginx 自己会进行平滑升级和优雅退出</span></span><br><span class="line">make upgrade</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>纯手动方式<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 进入 nginx 源码目录</span><br><span class="line">cd nginx-X.XX.X</span><br><span class="line"></span><br><span class="line"># 备份旧 nginx 程序</span><br><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old.bak</span><br><span class="line"></span><br><span class="line"># 拷贝新 nginx 程序</span><br><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br><span class="line"></span><br><span class="line"># 进入 nginx 的工作目录</span><br><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line"></span><br><span class="line"># 停止之前的 nginx</span><br><span class="line">ps -ef | grep nginx</span><br><span class="line">kill -9 XXXX</span><br><span class="line"></span><br><span class="line"># 启动新的 nginx</span><br><span class="line">./nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="1-3-nginx-管理"><a href="#1-3-nginx-管理" class="headerlink" title="1.3 nginx 管理"></a>1.3 nginx 管理</h2><hr>
<h3 id="知识点：nginx-命令"><a href="#知识点：nginx-命令" class="headerlink" title="知识点：nginx 命令"></a>知识点：nginx 命令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 服务器的程序命令</span><br><span class="line">  - 通过执行 nginx 命令，来启动 nginx 服务器</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  ./nginx [Options]</span><br><span class="line"></span><br><span class="line">* 常用</span><br><span class="line">  ./nginx     &lt;== 启动 nginx 服务</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>选项</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">* -h</span><br><span class="line">  - 不启动服务器，仅查看 nginx 指令的帮助</span><br><span class="line"></span><br><span class="line">* -V</span><br><span class="line">  - 不启动服务器，仅查看 nginx 版本信息和 configure 配置</span><br><span class="line"></span><br><span class="line">* -t [file]</span><br><span class="line">  - 不启动服务器，仅检查 nginx 配置文件的语法</span><br><span class="line"></span><br><span class="line">* -T [file]</span><br><span class="line">  - 不启动服务器，仅检查 nginx 配置文件的语法，并列出配置文件的内容</span><br><span class="line"></span><br><span class="line">* -q [file]</span><br><span class="line">  - 不启动服务器，配置文件语法检查时只打印错误信息，通常用法为 -tq</span><br><span class="line"></span><br><span class="line">* -s SIGNAL</span><br><span class="line">  - nginx 信号量操作</span><br><span class="line">  - SIGNAL: stop、quit、reopen、reload</span><br><span class="line"></span><br><span class="line">* -p PREFIX</span><br><span class="line">  - 指定 nginx 的 prefix 路径</span><br><span class="line"></span><br><span class="line">* -c FILENAME</span><br><span class="line">  - 使用指定的配置文件</span><br><span class="line"></span><br><span class="line">* -g DIRECTIVE</span><br><span class="line">  - 添加补充配置，向 nginx 服务指定启动时应用全局的配置</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-信号量操作"><a href="#知识点：nginx-信号量操作" class="headerlink" title="知识点：nginx 信号量操作"></a>知识点：nginx 信号量操作</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 程序本身支持四种信号量操作</span><br><span class="line">  - 相当于手动使用 kill 指令向 nginx 进程发送信号量，通过 nginx 的 pid file 来确定 nginx 的 master 进程</span><br><span class="line">  - 生产中也经常使用 &quot;kill&quot; 指令来直接对 nginx 进程进行操作</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>四种信号量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* -s stop</span><br><span class="line">  - 等同于 kill -s TERM/INT NginxMasterPid</span><br><span class="line">  - 强制关闭 nginx 服务进程</span><br><span class="line"></span><br><span class="line">* -s quit</span><br><span class="line">  - 等同于 kill -s QUIT NginxMasterPid</span><br><span class="line">  - 优雅关闭 nginx 服务进程</span><br><span class="line">  - worker 不再接收新请求，worker 处理完当前请求后，再关闭</span><br><span class="line"></span><br><span class="line">* -s reopen</span><br><span class="line">  - 等同于 kill -s USR1 NginxMasterPid</span><br><span class="line">  - 重新打开日志文件</span><br><span class="line">  - 可以用来进行日志切割</span><br><span class="line"></span><br><span class="line">* -s reload</span><br><span class="line">  - 等同于 kill -s HUP NginxMasterPid</span><br><span class="line">  - 重新加载配置文件</span><br><span class="line">  - master 不会重启</span><br><span class="line">  - worker 会重建</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>kill 信号量操作</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* kill -s USR2 NginxMasterPid</span><br><span class="line">  - 对 nginx 二进制程序进行平滑升级</span><br><span class="line">     - 启动新的 master 进程及其 workder 进程，此时会有两个 master 进程</span><br><span class="line">     - 旧的 master 进程的 pid 保存到 nginx.pid.oldbin</span><br><span class="line">     - 新的 master 进程的 pid 保存到 nginx.pid</span><br><span class="line">  - 执行后，最好再对旧的 master 进程执行一次 QUIT</span><br><span class="line">     - kill -QUIT $(cat /usr/local/nginx/logs/nginx.pid.oldbin)</span><br><span class="line"></span><br><span class="line">* kill -s WINCH NginxMasterPid</span><br><span class="line">  - 所有 workder 进程不再接收新请求</span><br><span class="line">  - 与 QUIT 的区别，不会停止 master 进程，只停止 worker 进程</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter02-nginx-配置"><a href="#Chapter02-nginx-配置" class="headerlink" title="Chapter02 nginx 配置"></a>Chapter02 nginx 配置</h1><hr>
<h2 id="2-1-nginx-配置介绍"><a href="#2-1-nginx-配置介绍" class="headerlink" title="2.1 nginx 配置介绍"></a>2.1 nginx 配置介绍</h2><hr>
<h3 id="知识点：nginx-配置简介"><a href="#知识点：nginx-配置简介" class="headerlink" title="知识点：nginx 配置简介"></a>知识点：nginx 配置简介</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 基础结构</span><br><span class="line">  - main 块</span><br><span class="line">  - events 块</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-配置语法"><a href="#知识点：nginx-配置语法" class="headerlink" title="知识点：nginx 配置语法"></a>知识点：nginx 配置语法</h3><ol>
<li><strong>基本语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 指令结束必须加分号 &quot;;&quot;，块结束不可以加分号 &quot;;&quot;</span><br><span class="line"></span><br><span class="line">* 不识别断行，没有续航符，过长的行直接断行即可</span><br><span class="line"></span><br><span class="line">* 不识别缩进，缩进仅用于人类可读排版</span><br><span class="line"></span><br><span class="line">* 注释用 &quot;#&quot;</span><br><span class="line"></span><br><span class="line">* 块用 &quot;&#123; &#125;&quot;</span><br><span class="line"></span><br><span class="line">* 相对路径</span><br><span class="line">  - PATH 如果与配置有关，则相对路径的起点为 nginx.conf 的目录</span><br><span class="line">  - PATH 如果与资源有关，则相对路径的起点为 prefix</span><br><span class="line"></span><br><span class="line">* 单引号和双引号中，都可以使用变量</span><br><span class="line"></span><br><span class="line">* 双引号中，&quot;;&quot;、&quot;&#125;&quot; 等 nginx 配置的语法标记会恢复为普通字符</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>正则</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 的配置中使用正则不可以加单引号或双引号</span><br><span class="line"></span><br><span class="line">* 元字符</span><br><span class="line">  - .</span><br><span class="line"></span><br><span class="line">* 重复次数</span><br><span class="line">  - *、+、?</span><br><span class="line">  - &#123;N&#125;、&#123;N,&#125;、&#123;N,M&#125;</span><br><span class="line">    - 为避免与语句块标识符 &#x27;&#123; &#125;&#x27; 相冲突，实际为 \&#123;N\&#125;，\&#123;N,\&#125;，\&#123;N,M\&#125;</span><br><span class="line"></span><br><span class="line">* 锚点</span><br><span class="line">  - ^、$</span><br><span class="line"></span><br><span class="line">* 字符类</span><br><span class="line">  - [xyz]、[a-z]</span><br><span class="line"></span><br><span class="line">* 跳脱</span><br><span class="line">  - \</span><br><span class="line">  - \w、\d</span><br><span class="line"></span><br><span class="line">* 捕捉群</span><br><span class="line">  - $1、$2</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-变量"><a href="#知识点：nginx-变量" class="headerlink" title="知识点：nginx 变量"></a>知识点：nginx 变量</h3><ol>
<li><strong>变量介绍</strong></li>
<li><strong>变量用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$VariableName</span><br><span class="line">  - 定义变量</span><br><span class="line">  - 获取变量值</span><br><span class="line"></span><br><span class="line">$arg_XXXX</span><br><span class="line">  - 获取 request url 中某个请求参数的 value</span><br><span class="line"></span><br><span class="line">$cookie_XXXX</span><br><span class="line">  - 获取 cookie 中某个 field 的 valie</span><br><span class="line"></span><br><span class="line">$http_XXXX</span><br><span class="line">  - 获取 request header 中的某个 field 的 value</span><br><span class="line">  - 如 $http_username 表示获取 request header 中 username 的值</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>常用 nginx 内置全局变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">* $args</span><br><span class="line">* $query_string</span><br><span class="line">  - request 中 URL 中的查询参数</span><br><span class="line"></span><br><span class="line">* $http_user_agent</span><br><span class="line">  - request 中 User-Agent 的内容</span><br><span class="line">  - 用户访问 server 的代理信息</span><br><span class="line">  - 如果通过浏览器访问，则记录的是浏览器的版本信息</span><br><span class="line"></span><br><span class="line">* $host</span><br><span class="line">  - request 中 Host 的内容</span><br><span class="line">  - 目标服务器的 server_name</span><br><span class="line"></span><br><span class="line">* $document_uri 和 $uri</span><br><span class="line">  - request 中 URL 中的 URI</span><br><span class="line">  - 例如 http://192.168.200.133/server?id=10&amp;name=zhangsan 中，UIR 为 &quot;/server&quot;</span><br><span class="line"></span><br><span class="line">* $document_root</span><br><span class="line">  - 当前 request 所对应的 location 的 root 值</span><br><span class="line">  - 如果未设置，默认指向 nginx 自带 html 目录的位置</span><br><span class="line"></span><br><span class="line">* $content_length</span><br><span class="line">  - request 中 Content-Length 的内容</span><br><span class="line"></span><br><span class="line">* $content_type</span><br><span class="line">  - request 中 Content-Type 的内容</span><br><span class="line"></span><br><span class="line">* $http_cookie</span><br><span class="line">  - request 中 Cookie 的内容</span><br><span class="line">  - 可以通过 add_header Set-Cookie &#x27;cookieName=cookieValue&#x27; 来添加 cookie 数据</span><br><span class="line"></span><br><span class="line">* $limit_rate</span><br><span class="line">  - nginx 服务器对网络连接速率的限制，也就是 nginx 配置中对 limit_rate 指令设置的值，默认是 0，不限制</span><br><span class="line"></span><br><span class="line">* $proxy_host</span><br><span class="line">  - 被代理服务器的主机名和端口，按照 proxy_pass 指令中的设置</span><br><span class="line"></span><br><span class="line">* $proxy_port</span><br><span class="line">  - 被代理服务器的端口，按照 proxy_pass 指令中的设置</span><br><span class="line"></span><br><span class="line">* $remote_addr</span><br><span class="line">  - 客户端的 IP 地址</span><br><span class="line"></span><br><span class="line">* $remote_port</span><br><span class="line">  - 客户端的端口号</span><br><span class="line"></span><br><span class="line">* $remote_user</span><br><span class="line">  - 客户端的用户名，需要有认证模块才能获取</span><br><span class="line"></span><br><span class="line">* $request_body_file</span><br><span class="line">  - http request header 的第一行的内容</span><br><span class="line"></span><br><span class="line">* $request_body_file</span><br><span class="line">  - 反向代理时发送给后端服务器的本地资源名</span><br><span class="line"></span><br><span class="line">* $request_method</span><br><span class="line">  - request 的请求方式，如 GET、POST</span><br><span class="line"></span><br><span class="line">* $request_filename</span><br><span class="line">  - 当前 request 对应的资源文件的 PATH，即 URI 经过 root 或 alias 替换之后生成的 PATH</span><br><span class="line"></span><br><span class="line">* $request_uri</span><br><span class="line">  - request 中的原始 uri，包含请求参数</span><br><span class="line">  - 例如，http://192.168.200.133/server?id=10&amp;name=zhangsan 中，full original request URI 为 &quot;/server?id=10&amp;name=zhangsan&quot;</span><br><span class="line"></span><br><span class="line">* $status</span><br><span class="line">  - nginx 的响应状态码</span><br><span class="line"></span><br><span class="line">* $scheme</span><br><span class="line">  - request 的访问协议，http、https</span><br><span class="line"></span><br><span class="line">* $server_addr</span><br><span class="line">  - 接收 request 的 server 的 IP 地址</span><br><span class="line"></span><br><span class="line">* $server_name</span><br><span class="line">  - 接收 request 的 server 的 name</span><br><span class="line"></span><br><span class="line">* $server_port</span><br><span class="line">  - 接收 request 的 server 的 port</span><br><span class="line"></span><br><span class="line">* $server_protocol</span><br><span class="line">  - request 中的请求协议的版本，HTTP/1.0、HTTP/1.1、HTTP/2.0</span><br><span class="line"></span><br><span class="line">* $upstream_cache_status</span><br><span class="line">  - 是否命中代理缓存，HIT，MISS</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：url"><a href="#知识点：url" class="headerlink" title="知识点：url"></a>知识点：url</h3><ol>
<li><strong>uri</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 同一资源标识符 Uniform Resource Identifier</span><br><span class="line">  - 它是一个字符串用来标示抽象或物理资源</span><br><span class="line">  - 包括 url 和 urn</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>url</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 统一资源定位符 Uniform Resource Locator</span><br><span class="line">  - 描述了资源所在的位置和路径</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  SCHEME://USER:PASSWORD@HOST:PORT/PATH?QueryString#Fragment</span><br><span class="line"></span><br><span class="line">* SCHEME</span><br><span class="line">  - 协议，包括 http、https、ftp、ed2k 等</span><br><span class="line"></span><br><span class="line">* USER:PASSWORD</span><br><span class="line">  - 对于需要身份认证的服务器，指定用户名和密码</span><br><span class="line"></span><br><span class="line">* HOST</span><br><span class="line">  - 服务器的 ip 地址或域名</span><br><span class="line"></span><br><span class="line">* PORT#</span><br><span class="line">  - http 服务器的端口</span><br><span class="line"></span><br><span class="line">* PATH</span><br><span class="line">  - 访问的资源的绝对路径</span><br><span class="line"></span><br><span class="line">* QueryString</span><br><span class="line">  - 查询参数</span><br><span class="line">  - 格式为 key=value 的键值对，采用 &quot;&amp;&quot; 符号间隔</span><br><span class="line"></span><br><span class="line">* Fragment</span><br><span class="line">  - 分段标识</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>urn</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 同一资源命名 Uniform Resource Naming</span><br><span class="line">  - 仅描述资源的名称</span><br><span class="line">  - 典型应用就是磁力</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-解析-url-的过程"><a href="#知识点：nginx-解析-url-的过程" class="headerlink" title="知识点：nginx 解析 url 的过程"></a>知识点：nginx 解析 url 的过程</h3><ol>
<li><strong>确定 server 块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 通过 http 包中的 request header 中的 URL 中的 host 部分，与 server_name 匹配，确定具体使用哪一个 server 块</span><br><span class="line"></span><br><span class="line">* 如果没有与任何 server_name 匹配，则使用 default_server</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>确定 location 块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 通过 http 包中的 request header 中的 URL 中的 PATH 部分，与 location 匹配，确定具体使用哪一个 location 块</span><br><span class="line"></span><br><span class="line">* 如果没有与任何 location 块匹配，则采用 server 块的默认 location 配置 &#x27;location / &#123; ... &#125;&#x27; 进行处理</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>对 uri 进行改写</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 根据 location 块中 root、alias 的设置，对 URI 添加前缀或替换</span><br><span class="line"></span><br><span class="line">* 如果 location 块中没有指定 root、alias 指令，则按照隐藏默认配置 &#x27; root PREFIX ;&#x27; 指令处理</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>返回相应的资源</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 如果 URI 是文件，则返回文件</span><br><span class="line"></span><br><span class="line">* 如果 URI 没有匹配到文件，则认为 URI 是目录，自动在 URI 结尾加 &#x27;/&#x27;，查找此目录，并返回 index 指令指向的文件</span><br><span class="line"></span><br><span class="line">* 如果目录中没有配置 index 指令，则按照隐藏默认配置 &#x27;index index.html&#x27; 指令处理</span><br><span class="line"></span><br><span class="line">* 如果仍然没找到，则返回 404</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：MIME"><a href="#知识点：MIME" class="headerlink" title="知识点：MIME"></a>知识点：MIME</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 多用途互联网邮件扩展类型 Multipurpose Internet Mail Extensions</span><br><span class="line">  - 用来确定网络资源的媒体类型</span><br><span class="line">  - nginx 通过 mine type 的设置，识别前端请求的资源类型</span><br><span class="line"></span><br><span class="line">* nginx 对 mime type 的使用</span><br><span class="line">  1. nginx 从浏览器的请求的 url 中，识别出请求的文件的后缀名</span><br><span class="line">  2. nginx 通过后缀名，确定数据的 mime type 类型</span><br><span class="line">  3. nginx 在发送 response 时，在 header 的 context-type 字段中，填充数据的 mime type 类型名</span><br><span class="line">  4. 浏览器在收到 nginx 的 response 时，根据 context-type 字段中的内容，对 http 包中的数据采用相应的手段进行解析、渲染</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  TYPE/SubType</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>分类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* application</span><br><span class="line">  - application/json</span><br><span class="line"></span><br><span class="line">* audio</span><br><span class="line"></span><br><span class="line">* image</span><br><span class="line"></span><br><span class="line">* message</span><br><span class="line"></span><br><span class="line">* multipart</span><br><span class="line"></span><br><span class="line">* text</span><br><span class="line">  - test/plain</span><br><span class="line">  - test/html</span><br><span class="line">  - test/xml</span><br><span class="line"></span><br><span class="line">* video</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>配置文件</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 加载 mime 类型和后缀名</span><br><span class="line">include mime.types</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-2-main-块"><a href="#2-2-main-块" class="headerlink" title="2.2 main 块"></a>2.2 main 块</h2><hr>
<h3 id="知识点：main-块介绍"><a href="#知识点：main-块介绍" class="headerlink" title="知识点：main 块介绍"></a>知识点：main 块介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 的整体配置，主要与 nginx 的进程应该如何运行有关</span><br><span class="line">  - 是 nginx 配置的最顶级层级</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：user-指令"><a href="#知识点：user-指令" class="headerlink" title="知识点：user 指令"></a>知识点：user 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 worker 进程的用户和用户组</span><br><span class="line">  - 可以覆盖编译参数中的 --user 和 --group 配置</span><br><span class="line">  - 默认值 nobody</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  user UserName [Group] ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：master-process-指令"><a href="#知识点：master-process-指令" class="headerlink" title="知识点：master_process 指令"></a>知识点：master_process 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定是否开启多进程结构</span><br><span class="line">  - 不支持热部署，修改后必须重启 nginx</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  master_process on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：worker-processes-指令"><a href="#知识点：worker-processes-指令" class="headerlink" title="知识点：worker_processes 指令"></a>知识点：worker_processes 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 worker 进程的数量</span><br><span class="line">  - 推荐与 CPU core 数量相同</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  worker_processes N|auto ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：daemon-指令"><a href="#知识点：daemon-指令" class="headerlink" title="知识点：daemon 指令"></a>知识点：daemon 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 nginx 是否以 daemon 方式运行</span><br><span class="line">  - docker 中需要 off</span><br><span class="line">  - 不支持热部署</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  daemon on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pid-指令"><a href="#知识点：pid-指令" class="headerlink" title="知识点：pid 指令"></a>知识点：pid 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 pid 文件的位置</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  pid PATH ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：error-log-指令"><a href="#知识点：error-log-指令" class="headerlink" title="知识点：error_log 指令"></a>知识点：error_log 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 error_log 文件的位置和日志级别</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  error_log PATH [LEVEL] ;</span><br><span class="line"></span><br><span class="line">* LEVEL：</span><br><span class="line">  - debug</span><br><span class="line">  - info</span><br><span class="line">  - notice</span><br><span class="line">  - warn</span><br><span class="line">  - error（默认）</span><br><span class="line">  - crit</span><br><span class="line">  - alert</span><br><span class="line">  - emerg</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：include-指令"><a href="#知识点：include-指令" class="headerlink" title="知识点：include 指令"></a>知识点：include 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 导入其他文件中的内容</span><br><span class="line">  - PATH 使用相对路径，则起始位置为 nginx.conf 所在的目录</span><br><span class="line">  - 也就是说，只能导入 nginx/conf 目录中的文件</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - 可以放在配置文件中的任意位置</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  include PATH ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-3-events-块"><a href="#2-3-events-块" class="headerlink" title="2.3 events 块"></a>2.3 events 块</h2><hr>
<h3 id="知识点：events-块"><a href="#知识点：events-块" class="headerlink" title="知识点：events 块"></a>知识点：events 块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置与网络连接相关的内容</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：accept-mutex-指令"><a href="#知识点：accept-mutex-指令" class="headerlink" title="知识点：accept_mutex 指令"></a>知识点：accept_mutex 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定 nginx 网络连接序列化</span><br><span class="line">  - 可以解决 worker 进程惊群问题，但效率会降低</span><br><span class="line">  - 惊群问题，就是指当一个用户请求来到时，会有多个 worker 进程被唤醒，但只有一个 worker 进程会真正处理此请求，如果唤醒的 worker 进程太多，会影响 nginx 的性能</span><br><span class="line">  - 不适合高并发的环境</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - events 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  accept_mutex on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：multi-accept-指令"><a href="#知识点：multi-accept-指令" class="headerlink" title="知识点：multi_accept 指令"></a>知识点：multi_accept 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 worker 进程是否可以同时进行多个网络连接</span><br><span class="line">  - 默认 off，建议改成 on</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - events 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  multi_accept on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：worker-connections-指令"><a href="#知识点：worker-connections-指令" class="headerlink" title="知识点：worker_connections 指令"></a>知识点：worker_connections 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 worker 进程最大的连接数</span><br><span class="line">  - 不能大于 Linux unlimit</span><br><span class="line">  - 建议不要小于 65535</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - events 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  worker_connections NUMBER ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：use-指令"><a href="#知识点：use-指令" class="headerlink" title="知识点：use 指令"></a>知识点：use 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 nginx 使用的 connection processing method</span><br><span class="line">  - 默认采用最有效率的方法</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - events 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  use METHOD ;</span><br><span class="line"></span><br><span class="line">* METHOD</span><br><span class="line">  select</span><br><span class="line">  poll</span><br><span class="line">  epoll</span><br><span class="line">  kqueue</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-4-http-块"><a href="#2-4-http-块" class="headerlink" title="2.4 http 块"></a>2.4 http 块</h2><hr>
<h3 id="知识点：http-块"><a href="#知识点：http-块" class="headerlink" title="知识点：http 块"></a>知识点：http 块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 http 功能</span><br><span class="line">  - 所有 http 有关的设置全部放在 http 块中</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：log-format-指令"><a href="#知识点：log-format-指令" class="headerlink" title="知识点：log_format 指令"></a>知识点：log_format 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 创建一个可以在 access.log 中使用的日志格式</span><br><span class="line">  - 可以配置多个日志格式，分别命名，在使用时按照格式名来指定</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_format NAME [escape=default|json|none] STRING ... ;</span><br><span class="line"></span><br><span class="line"># 通常在 STRING 中使用变量</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：access-log-指令"><a href="#知识点：access-log-指令" class="headerlink" title="知识点：access_log 指令"></a>知识点：access_log 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 access.log 的属性，包括位置、格式、缓冲</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  access_log PATH [FORMAT [buffer=SIZE] [gzip[=LEVEL]]] ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：default-type-指令"><a href="#知识点：default-type-指令" class="headerlink" title="知识点：default_type 指令"></a>知识点：default_type 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 nginx 的 response 的默认 mime type</span><br><span class="line">  - 当 nginx 无法确认数据的 mime type 时，就填充 default_type 指令的值到 context-type 字段中</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  default_type TYPE/SUBTYPE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /get_text &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain ;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;this is a text&quot;</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /get_html &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/html ;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;&lt;h1&gt;this is a html&lt;/h1&gt;&quot;</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> /get_json &#123;</span><br><span class="line">    <span class="attribute">default_type</span> application/json ;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;&#123;&#x27;name&#x27;:&#x27;tom&#x27;,&#x27;age&#x27;:18&#125;&quot;</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：server-tokens-指令"><a href="#知识点：server-tokens-指令" class="headerlink" title="知识点：server_tokens 指令"></a>知识点：server_tokens 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置是否在 response header 的 Server 字段中显示 nginx 的版本</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  server_tokens on | off | build | String ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-5-server-块"><a href="#2-5-server-块" class="headerlink" title="2.5 server 块"></a>2.5 server 块</h2><hr>
<h3 id="知识点：server-块"><a href="#知识点：server-块" class="headerlink" title="知识点：server 块"></a>知识点：server 块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 用来定义一个 nginx 虚拟主机 vhost</span><br><span class="line"></span><br><span class="line">* 虚拟主机 vhost</span><br><span class="line">  - 一个 server 块定义一个 vhost</span><br><span class="line">  - vhost 通过地址和 port 来绑定生效范围</span><br><span class="line">  - 一个 PORT 可以被多个 vhost 监听</span><br><span class="line">  - 一个 vhost 只能监听一个 PORT</span><br><span class="line">  - 一个 vhost 可以监听多个地址</span><br><span class="line">  - 不同的 vhost 之间的生效范围可以重叠，会按照 server_name 配置的优先级选取最终的 vhost</span><br><span class="line"></span><br><span class="line">* 通过与 request 中 host 字段的匹配，确定最终使用哪个 vhost</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：listen-指令"><a href="#知识点：listen-指令" class="headerlink" title="知识点：listen 指令"></a>知识点：listen 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 vhost 的监听端口</span><br><span class="line">  - 设置端口的默认 server</span><br><span class="line"></span><br><span class="line">* 默认 server</span><br><span class="line">  - 当此 PORT 的 request 没有匹配到 vhost 时，则全部从此 server 块走</span><br><span class="line">  - 一个 PORT 只能有一个 default_server</span><br><span class="line">  - 每个 PORT 都有自己的 default_server</span><br><span class="line">  - 如没有手动指定，则默认每个 PORT 的第一个 server 块是 default_server</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  listen [ADDRESS:]PORT [default_server] ;</span><br><span class="line"></span><br><span class="line">* PORT</span><br><span class="line">  - 指定端口号，省略则为表示 80</span><br><span class="line"></span><br><span class="line">* ADDRESS</span><br><span class="line">  - 指定监听的 IP 地址</span><br><span class="line">  - 省略或 &#x27;*&#x27;，表示监听所有 IP 地址</span><br><span class="line"></span><br><span class="line">* default_server</span><br><span class="line">  - 指定此 server 为 PORT 的默认 server</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 一种用法：通过将 defaut_server 的 server_name 设置为空，来禁用 server_name 的 request</span><br><span class="line"># 这也是 nginx 的习惯配置</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server ;</span><br><span class="line">    server_name &quot;&quot; ;</span><br><span class="line">    return 444 ;               # 返回 444</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：server-name-指令"><a href="#知识点：server-name-指令" class="headerlink" title="知识点：server_name 指令"></a>知识点：server_name 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 vhost 的主机名，可以指定多个</span><br><span class="line">  - request 的 url 中的主机名若命中某个 vhost 的 server_name 配置，就会选择此 server 块</span><br><span class="line">  - 若有多个命中，则按照命中优先级选择</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line"></span><br><span class="line">* 注意</span><br><span class="line">  1. server_name 匹配 uri 时，不会对地址进行解析</span><br><span class="line">    - 例如，本机 IP、localhost、127.0.0.1，对于 nginx 三者是不同的 server_name</span><br><span class="line">    - 即使在 /etc/hosts 对 IP 和主机名做了绑定，也是不同的 server_name，/etc/hosts 工作在三层，http 工作在七层</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>匹配命中</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 命中优先级：精确匹配 &gt; 前通配符 &gt; 后通配符 &gt; 正则 &gt; 端口的 default_server</span><br><span class="line"></span><br><span class="line">* 精确匹配</span><br><span class="line">  例如，www.XXX.com</span><br><span class="line"></span><br><span class="line">* 通配符匹配</span><br><span class="line">  支持通配符 &#x27;*&#x27;，但不能出现在域名的中间，只能出现在首尾，并且必须代表域名的一个完整小节</span><br><span class="line">  正确用法：*.XXX.com、www.XXX.*</span><br><span class="line">  错误用法：www.*.com、*ww.XXX.com、www.XXX.c*</span><br><span class="line"></span><br><span class="line">* 正则表达式匹配</span><br><span class="line">  使用 &#x27;~&#x27; 作为正则表达式字符串的开始标记</span><br><span class="line">  例如，~^\w&#123;3&#125;.XXX.\w&#123;3&#125;$</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  server_name NAME ... ;</span><br><span class="line"></span><br><span class="line">* NAME</span><br><span class="line">  - 可以提供多个，中间用空格分隔</span><br><span class="line">  - 可以是 IP、域名</span><br><span class="line">  - 为空则不会与任何 request header 中的 host 字段匹配</span><br><span class="line">  - 从 0.8.48 开始，省略 server_name 就相当于 server_name 设置为空</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-6-location-块"><a href="#2-6-location-块" class="headerlink" title="2.6 location 块"></a>2.6 location 块</h2><hr>
<h3 id="知识点：location-块"><a href="#知识点：location-块" class="headerlink" title="知识点：location 块"></a>知识点：location 块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 与 request 的 uri 进行匹配，确定 request 具体想要访问的资源</span><br><span class="line">  - 首先，匹配 uri 中的 path 部分</span><br><span class="line">  - 然后，对 uri 进行改写，并利用改写后的 uri 匹配资源</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块，一个 server 块中可以配置多个 location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>返回资源方式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 若 URI 改写后，以 &#x27;/&#x27; 结尾，则认为是一个目录，直接返回 index 文件</span><br><span class="line"></span><br><span class="line">* 若 URI 改写后，不是以 &#x27;/&#x27; 结尾，则检查是否是一个文件</span><br><span class="line">  - 若找到了匹配的文件，则直接返回此文件</span><br><span class="line">  - 若未找到匹配的文件，则认为改写后的 uri 是一个目录，在末尾自动添加 &#x27;/&#x27;，尝试返回 index 文件</span><br><span class="line"></span><br><span class="line">* 若未搜索到对应的文件，则返回 403 资源不存在</span><br><span class="line">  - 目录指定了 index 但文件不存在</span><br><span class="line">  - 目录未指定 index 且没有 index.html 文件</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>server 块的隐藏默认 location 块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 若 server 块中未配置任何 location，或 request 与 server 块的任何 location 均不匹配，则按此配置执行</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> html ;</span><br><span class="line">    <span class="attribute">index</span> index.html ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>location 块的隐藏默认配置</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 若 location 块中没有定义任何 root、alias 等 uri 改写指令，则按照此配置执行</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root</span> html ;</span><br><span class="line"><span class="attribute">index</span> index.html ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：location-指令"><a href="#知识点：location-指令" class="headerlink" title="知识点：location 指令"></a>知识点：location 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 location 块匹配 uri path 的方式</span><br><span class="line"></span><br><span class="line">* 命中优先级</span><br><span class="line">  - 精确匹配 &gt; 正则前缀匹配 &gt; 正则匹配 &gt; 普通前缀匹配</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>. <strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  location [ = | ^~ | ~ | ~* | &lt;空&gt; ] URI &#123; LOCATION_BLOCK &#125;</span><br><span class="line">  location @NAME &#123; LOCATION_BLOCK &#125;</span><br><span class="line"></span><br><span class="line">* =</span><br><span class="line">  - 精确匹配</span><br><span class="line"></span><br><span class="line">* ^~</span><br><span class="line">  - 正则前缀匹配</span><br><span class="line">  - 不区分大小写</span><br><span class="line">  - 如果有多个命中，使用前缀最长的那个</span><br><span class="line"></span><br><span class="line">* ~，~*</span><br><span class="line">  - 正则匹配，逻辑为包含</span><br><span class="line">  - &#x27;~&#x27; 区分大小写</span><br><span class="line">  - &#x27;~*&#x27; 不区分大小写</span><br><span class="line">  - 如果有多个命中，则按在配置文件中的用上到下的顺序使用第一个</span><br><span class="line"></span><br><span class="line">* &lt;空&gt;</span><br><span class="line">  - 普通前缀匹配</span><br><span class="line">  - 如果有多个命中，使用前缀最长的那个</span><br><span class="line">  - 例如，location /abc，则 uri 为 /abcdef 和 /abc123 都可以访问</span><br><span class="line">  - 匹配算法与前缀匹配完全相同，唯一的区别就是命中优先级</span><br><span class="line"></span><br><span class="line">* @NAME</span><br><span class="line">  - 定义一个命名的地址 named location</span><br><span class="line">  - 命名的地址无法用于 request 直接请求访问，而是可以用作请求重定向，如 error_page</span><br><span class="line">  - 这样的 location 块中不可以使用 alias 指令</span><br><span class="line">  - 常用在 error_page 中，指定错误页面</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：root-指令"><a href="#知识点：root-指令" class="headerlink" title="知识点：root 指令"></a>知识点：root 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定返回资源所在的根目录，用来对 url 中的 path 进行改写</span><br><span class="line">  - 可以是绝对路径，也可以是相对路径，相对路径从 nginx 的 prefix 设置开始计算</span><br><span class="line"></span><br><span class="line">* 改写方式</span><br><span class="line">  - 将 PATH 添加到 url 中的 path 部分之前，即结果为 PATH/urlpath</span><br><span class="line">    - 实际是 PATHurlpath，不过 urlpath 都是以 &#x27;/&#x27; 开头的</span><br><span class="line">  - 会自动在 PATH 后添加 &#x27;/&#x27;，故 PATH 末尾是否追加了 &#x27;/&#x27; 无影响</span><br><span class="line">  - 改写后的 url path 真正指向最终想要访问的文件或目录</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if in location</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  root PATH ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：alias-指令"><a href="#知识点：alias-指令" class="headerlink" title="知识点：alias 指令"></a>知识点：alias 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定一个 PATH 参数，对 url path 进行替换</span><br><span class="line"></span><br><span class="line">* 改写方式</span><br><span class="line">  - 用 PATH 替换掉 url path 中与 location path 匹配的内容</span><br><span class="line">  - 不会自动在 PATH 后添加 &#x27;/&#x27;，故需要注意 PATH 末尾是否追加了 &#x27;/&#x27;</span><br><span class="line">  - 例如，假如 location 匹配到的部分是以 &#x27;/&#x27; 结尾，则 PATH 也应是以 &#x27;/&#x27; 结尾，否则会出错</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  alias PATH ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：index-指令"><a href="#知识点：index-指令" class="headerlink" title="知识点：index 指令"></a>知识点：index 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 如果 URI 指向的是一个目录，则返回目录中名为 FILENAME 的文件</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  index FILENAME ;</span><br><span class="line"></span><br><span class="line">* FILENAME</span><br><span class="line">  - 可以指定多个文件，使用 space 间隔，若前面的 FILE 未搜索到，则按顺序向后依次查找</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：try-files-指令"><a href="#知识点：try-files-指令" class="headerlink" title="知识点：try_files 指令"></a>知识点：try_files 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 按顺序检查文件/目录是否存在</span><br><span class="line">  - 返回第一个找的的文件/目录</span><br><span class="line">  - 如果未找到，则会进行一个内部重定向到最后一个参数</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 常用场景</span><br><span class="line">  - 找不到网页，就返回首页</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  try_files File ... URI;</span><br><span class="line">  try_files File ... =CODE ;</span><br><span class="line"></span><br><span class="line">* File</span><br><span class="line">  - 以 / 结尾，就表示目录</span><br><span class="line">  - File 都会经过 root 或 alias 指令的组装</span><br><span class="line"></span><br><span class="line">* URI</span><br><span class="line">  - 指定进行内部跳转的地址</span><br><span class="line">  - 可以是一个文件，也可以是一个 named location</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例一</span></span><br><span class="line"><span class="attribute">location</span> /images/ &#123;</span><br><span class="line">    <span class="attribute">try_files</span> $uri /images/default.gif;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> = /images/default.gif &#123;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">30s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例二，跳转到命名的地址</span></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">try_files</span> $uri $uri/index.html $uri.html /system/maintenance.html @mongrel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> @mongrel &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://mongrel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：error-page-指令"><a href="#知识点：error-page-指令" class="headerlink" title="知识点：error_page 指令"></a>知识点：error_page 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置网站的错误页面</span><br><span class="line">  - 当出现了相应的状态码时，返回相应的页面</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  error_page CODE [=[RESPONSE]] URI ;</span><br><span class="line"></span><br><span class="line">* CODE</span><br><span class="line">  - 指定生效的状态码，可以指定多个，使用 space 间隔</span><br><span class="line"></span><br><span class="line">* =[RESPONSE]</span><br><span class="line">  - 将相应的状态码更改为 RESPONSE 指定的状态码，然后返回</span><br><span class="line"></span><br><span class="line">* URI</span><br><span class="line">  - 指定返回的页面，有三种方式</span><br><span class="line">    1. 指定一个转跳网址，例：</span><br><span class="line">      error_page https://www.baidu.com ;</span><br><span class="line">    2. 指定一个重定向地址，指向相应的 location 块，例：</span><br><span class="line">      error_page 404 /40x ;</span><br><span class="line">      location /40x &#123;</span><br><span class="line">          alias /usr/share/nginx/html/40x.html ;</span><br><span class="line">      &#125;</span><br><span class="line">    3 指定重定向 named location，例：</span><br><span class="line">      error_page 404 @jump_to_err ;</span><br><span class="line">      location @jump_to_err &#123;</span><br><span class="line">          default_type text/html ;</span><br><span class="line">          return 200 &#x27;&lt;h1&gt;Not Found&lt;/h1&gt;&#x27; ;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter03-nginx-常用功能"><a href="#Chapter03-nginx-常用功能" class="headerlink" title="Chapter03 nginx 常用功能"></a>Chapter03 nginx 常用功能</h1><hr>
<h2 id="3-1-https"><a href="#3-1-https" class="headerlink" title="3.1 https"></a>3.1 https</h2><hr>
<h3 id="知识点：SSL-x2F-TLS"><a href="#知识点：SSL-x2F-TLS" class="headerlink" title="知识点：SSL&#x2F;TLS"></a>知识点：SSL&#x2F;TLS</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - TSL 和 SSL 都是非对称加密传输机制</span><br><span class="line">  - TLS 是 SSL 的升级版，目前普遍采用 TLS</span><br><span class="line"></span><br><span class="line">* 非对称加密</span><br><span class="line">  - 公钥加密，私钥解密</span><br><span class="line">  - 先加密再解密，先解密再加密，都能得到原文</span><br><span class="line">  - 加密解密的算法是公开的</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>数字证书</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 数字证书 Digitle Certificate</span><br><span class="line">  - 相当于网站域名的身份证</span><br><span class="line">  - 包含网站的域名、网站公钥、有效期、CA 数字签名</span><br><span class="line"></span><br><span class="line">* CA Certificate Authority</span><br><span class="line">  - 签发数字证书的权威认证机构</span><br><span class="line"></span><br><span class="line">* CA 数字签名</span><br><span class="line">  - CA 对网站域名、网站公钥进行的数字签名</span><br><span class="line"></span><br><span class="line">* 根证书</span><br><span class="line">  - 系统中预装的，可以信赖的 CA 机构及其公钥</span><br><span class="line"></span><br><span class="line">* 证书链</span><br><span class="line"></span><br><span class="line">* 数字签名</span><br><span class="line">  - A 先使用私钥解密，将秘文发送给 B</span><br><span class="line">  - B 再使用公钥加密，得到原文</span><br><span class="line">  - 并非为了进行保密，而是为了进行签名</span><br><span class="line">  - 保密的数字签名</span><br><span class="line">    - A 先使用自己的私钥解密，使用 B 的公钥加密</span><br><span class="line">    - B 再使用 A 的公钥加密，使用自己的私钥解密</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>TLS 1.2 握手过程</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在确定秘钥 K 阶段采用非对称加密，在正式通信阶段采用对称加密</span><br><span class="line"></span><br><span class="line">* 过程</span><br><span class="line">  1. TCP 三次握手</span><br><span class="line">  2. C 发送 Client Hello，包含以下内容</span><br><span class="line">    - 支持的 TLS 版本</span><br><span class="line">    - 支持的加密算法</span><br><span class="line">    - 第一随机数</span><br><span class="line">  3. S 发送 Server Hello</span><br><span class="line">    - 选择的 TLS 版本</span><br><span class="line">    - 选择的加密算法</span><br><span class="line">    - 第二随机数</span><br><span class="line">  4. S 发送 Cerfiticate</span><br><span class="line">    - S 的数字证书</span><br><span class="line">  5. S 发送 Server Key Exchange</span><br><span class="line">    - S 的公钥</span><br><span class="line">  6. S 发送 Server Hello Done</span><br><span class="line">  7. C 对 S 的证书进行验证</span><br><span class="line">  8. C 生成第三随机数，称为预主秘钥</span><br><span class="line">  9. C 通过第一随机数+第二随机数+预主秘钥，计算出会话秘钥 K</span><br><span class="line">  10. C 发送 Client Key Exchange，Change Cipher Spec，Encrypted Handshake Message</span><br><span class="line">    - Client Key Exchange，预主秘钥，并使用 S 的公钥加密</span><br><span class="line">    - Change Cipher Spec，确认 TLS 版本</span><br><span class="line">    - Encrypted Handshake Message，标识加密开始</span><br><span class="line">  12. S 通过第一随机数+第二随机数+预主秘钥，计算出会话秘钥 K</span><br><span class="line">  13. S 发送 Encrypted Handshake Message</span><br><span class="line">    - 确认加密开始</span><br><span class="line">  14. S 和 C 之间开始使用 K 进行加密通讯</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：https-介绍"><a href="#知识点：https-介绍" class="headerlink" title="知识点：https 介绍"></a>知识点：https 介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 中使用 ngx_http_ssl_module 模块用来支持 https 功能</span><br><span class="line">  - 需要 openssl 和 openssl-devel</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：https-配置范例"><a href="#知识点：https-配置范例" class="headerlink" title="知识点：https 配置范例"></a>知识点：https 配置范例</h3><ol>
<li><strong>范例一，常用 https 配置</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> www.abc.com ;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 指定证书文件和私钥文件</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> cert/Cert.pem ;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> cert/Cert.key ;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 指定 ssl 版本和加密套件</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span> ;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4 ;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置 ssl 会话缓存和超时时间</span></span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">1m</span> ;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 指定服务器优先于客户端密码</span></span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> html ;</span><br><span class="line">        <span class="attribute">index</span> index.html index.htm ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>配置范例二，将 http 请求转发到 https</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80 ;</span><br><span class="line">    server_name XXXX ;</span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^(.*) https://XXXX$1 ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl ;</span><br><span class="line">    ssl_certificate FILE ;</span><br><span class="line">    ssl_certificate_key FILE ;</span><br><span class="line">    server_name XXXX &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ssl-指令"><a href="#知识点：ssl-指令" class="headerlink" title="知识点：ssl 指令"></a>知识点：ssl 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定开启 https 功能</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  ssl on | off ;</span><br><span class="line">  listen 443 ssl ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ssl-certificate-指令"><a href="#知识点：ssl-certificate-指令" class="headerlink" title="知识点：ssl_certificate 指令"></a>知识点：ssl_certificate 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定数字证书文件，通常以 .pem 或 .crt 或 .cert 结尾</span><br><span class="line">  - 如果采用相对路径，则相对路径的起始位置为 nginx.conf 文件所在的目录</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  ssl_certificate FILE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ssl-certificate-key-指令"><a href="#知识点：ssl-certificate-key-指令" class="headerlink" title="知识点：ssl_certificate_key 指令"></a>知识点：ssl_certificate_key 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定私钥文件，通常以 .key 结尾</span><br><span class="line">  - 如果采用相对路径，则相对路径的起始位置为 nginx.conf 文件所在的目录</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  ssl_certificate_key FILE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ssl-session-cache-指令"><a href="#知识点：ssl-session-cache-指令" class="headerlink" title="知识点：ssl_session_cache 指令"></a>知识点：ssl_session_cache 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置用于 ssl 会话的缓存</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  ssl_session_cache off | none | [builtin[:SIZE]] [shared:NAME:SIZE] ;</span><br><span class="line"></span><br><span class="line">* off</span><br><span class="line">  - 禁用会话缓存，客户端不得重复使用会话</span><br><span class="line"></span><br><span class="line">* none</span><br><span class="line">  - 禁止使用会话缓存，客户端可以重复使用，但是并没有在缓存中存储会话参数</span><br><span class="line"></span><br><span class="line">* builtin</span><br><span class="line">  - 内置 OpenSSL 缓存，仅在一个工作进程中使用</span><br><span class="line"></span><br><span class="line">* shared</span><br><span class="line">  - 所有工作进程之间共享缓存，缓存的相关信息用 NAME 和 SIZE 来指定</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ssl-session-timeout-指令"><a href="#知识点：ssl-session-timeout-指令" class="headerlink" title="知识点：ssl_session_timeout 指令"></a>知识点：ssl_session_timeout 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 开启 SSL 会话功能后，设置客户端能够反复使用储存在缓存中的会话参数时间</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  ssl_session_timeout TIME ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ssl-ciphers-指令"><a href="#知识点：ssl-ciphers-指令" class="headerlink" title="知识点：ssl_ciphers 指令"></a>知识点：ssl_ciphers 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 允许的密码，密码指定为 OpenSSL 支持的格式</span><br><span class="line">  - 可以使用 Linux 命令 &#x27;openssl ciphers&#x27; 查看 openssl 支持的格式</span><br><span class="line">  - 默认值：ssl_ciphers HIGH:!aNULL:!MD5 ;</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  ssl_ciphers CIPHERS ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ssl-prefer-server-ciphers-指令"><a href="#知识点：ssl-prefer-server-ciphers-指令" class="headerlink" title="知识点：ssl_prefer_server_ciphers 指令"></a>知识点：ssl_prefer_server_ciphers 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 是否服务器密码优先客户端密码</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  ssl_perfer_server_ciphers on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-2-rewrite"><a href="#3-2-rewrite" class="headerlink" title="3.2 rewrite"></a>3.2 rewrite</h2><hr>
<h3 id="知识点：跨域问题"><a href="#知识点：跨域问题" class="headerlink" title="知识点：跨域问题"></a>知识点：跨域问题</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 同源策略</span><br><span class="line">  - 源 origin，是指协议 scheme、域名 host、端口 port 相同即为同源</span><br><span class="line">  - 同源策略，是指限制一个 origin 的页面只能加载同样的 origin 的资源，不能加载别的 origin 的资源</span><br><span class="line">  - 同源策略是浏览器的一个重要的安全策略</span><br><span class="line"></span><br><span class="line">* 跨域问题</span><br><span class="line">  - 一个 origin 请求另一个 origin 的资源，即为跨域 cross origin</span><br><span class="line">  - 出现的原因，在网页的代码中添加了对其他源的引用</span><br><span class="line">  - 当发生跨域时，A 的页面会要求浏览器发送请求给 B，本地除了要与 A 建立连接外，还要与 B 建立连接</span><br><span class="line">  - 非跨域请求，header 中只会包含 host 字段，表示请求的目标服务器的域名</span><br><span class="line">  - 跨域请求，header 中会包含 host 字段记录请求的目标服务器的域名、Origin 字段记录原始页面的域名</span><br><span class="line">  - 对于跨域请求，浏览器通常设置为正常的发送 request，但不处理 response</span><br><span class="line">  - 浏览器也可以设置启用 CORS(Cross-Origin RequestS) 来允许跨域</span><br><span class="line"></span><br><span class="line">* 解决跨域问题的常见方式</span><br><span class="line">  1. 修改网页代码</span><br><span class="line">  2. nginx 服务器端设置允许跨域</span><br><span class="line">  3. 改为使用反向代理</span><br></pre></td></tr></table></figure></li>
<li><strong>服务端设置允许跨域</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 位置：locations 块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Access-Control-Allow-Origin * ;</span></span><br><span class="line">Access-Control-Allow-<span class="attribute">Origin</span> http://192.168.100.1:8080 ;</span><br><span class="line"><span class="comment"># Access-Control-Allow-Method * ;</span></span><br><span class="line">Access-Control-Allow-<span class="attribute">Method</span> GET,POST,PUT,DELETE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：防盗链"><a href="#知识点：防盗链" class="headerlink" title="知识点：防盗链"></a>知识点：防盗链</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 资源盗链</span><br><span class="line">  - 资源盗链，是指最终内容并不在自己的服务器上，而是通过技术手段，绕过别人的限制，将别人的内容展示在自己的页面上</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>防盗链的实现原理</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* Referer 字段</span><br><span class="line">  - 当浏览器向服务器发送请求时，一般都会带上 Referer 字段，其中记录的该请求是从哪个页面链接过来的</span><br><span class="line"></span><br><span class="line">* 防盗链的实现机制</span><br><span class="line">  - 在 nginx 配置中，设置对 Referer 字段的检查，是否为自己信任的站点，如果是则放行，否则就拒绝</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>valid_referers 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 nginx 对 Referer 字段的检查，并设置 $invalid_refer 变量</span><br><span class="line">  - invalid_refer 为 0 表示允许访问，1 表示拒绝访问</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  valid_referers none | blocked | SERVER_NAMES | STRING ;</span><br><span class="line"></span><br><span class="line">* none</span><br><span class="line">  - 如果 Referer 字段为空，则允许访问</span><br><span class="line">  - 相当于完全禁止引用</span><br><span class="line"></span><br><span class="line">* blocked</span><br><span class="line">  - Referer 字段不是以 &quot;http&quot; 或 &quot;https&quot; 开头，则允许访问</span><br><span class="line"></span><br><span class="line">* SERVER_NAMES</span><br><span class="line">  - 指定放行的域名或 ip 地址，多个采用空格间隔</span><br><span class="line"></span><br><span class="line">* STRING</span><br><span class="line">  - 指定放行的</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：rewrite-重写"><a href="#知识点：rewrite-重写" class="headerlink" title="知识点：rewrite 重写"></a>知识点：rewrite 重写</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 通过对 url 重写来实现访问跳转</span><br><span class="line">  - rewrite 是 所有 Web 服务器的一个重要基本功能</span><br><span class="line">  - nginx 中为 ngx_http_rewrite_module</span><br><span class="line">  - nginx 的 Rewrite 功能的实现需要 PCRE 的支持</span><br><span class="line"></span><br><span class="line">* rewrite 的应用场景</span><br><span class="line">  - 域名跳转</span><br><span class="line">  - 域名镜像</span><br><span class="line">  - 独立域名</span><br><span class="line">  - 目录自动添加 &#x27;/&#x27;</span><br><span class="line">  - 合并目录，实现在 uri 中一级目录来访问实际多级目录的资源</span><br><span class="line">  - 防盗链的实现</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：set-指令"><a href="#知识点：set-指令" class="headerlink" title="知识点：set 指令"></a>知识点：set 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 用来设置一个新的变量</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  set $VarName Value ;</span><br><span class="line"></span><br><span class="line">* $VarName</span><br><span class="line">  - 指定变量名</span><br><span class="line">  - 第一课字符必须是 &quot;$&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：if-块"><a href="#知识点：if-块" class="headerlink" title="知识点：if 块"></a>知识点：if 块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在 nginx 配置文件中进行条件判断</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  if (CONDITION)&#123; ... &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>条件 CONDITION</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">* VAR</span><br><span class="line">  - 变量为空或 0，false</span><br><span class="line">  - 其他情况    ，true</span><br><span class="line">  - 范例: if ($var1) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">* 比较变量和字符串是否相等</span><br><span class="line">  - =   ，相等则 true，不相等则 false</span><br><span class="line">  - !=  ，不相等则 true，相等则 false</span><br><span class="line">  - 范例: if ($var1 = access) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">* 正则搜索，pattern 放在右侧</span><br><span class="line">  - ~   ，包含则 true，不包含则 false，区分大小写</span><br><span class="line">  - ~*  ，包含则 true，不包含则 false，不区分大小写</span><br><span class="line">  - !~  ，不包含则 true，包含则 false，区分大小写</span><br><span class="line">  - !~* ，不包含则 true，包含则 false，不区分大小写</span><br><span class="line">  - 范例: if ($http_user_agent ~ Mozilla) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">* 判断文件是否存在</span><br><span class="line">  - -f  ，文件存在则 true，不存在则 false</span><br><span class="line">  - !-f ，文件不存在则 true，存在则 false</span><br><span class="line">  - 范例: if ($var1 -f $request_filename ) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">* 判断目录是否存在</span><br><span class="line">  - -d</span><br><span class="line">  - !-d</span><br><span class="line"></span><br><span class="line">* 判断目录或者文件是否存在</span><br><span class="line">  - -e</span><br><span class="line">  - !-e</span><br><span class="line"></span><br><span class="line">* 判断请求的文件是否可执行</span><br><span class="line">  - -x</span><br><span class="line">  - !-x</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：break-指令"><a href="#知识点：break-指令" class="headerlink" title="知识点：break 指令"></a>知识点：break 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在当前作用域中，停止处理后续的 rewrite 指令，包括 return、if、set 等，并把当前 uri 在本 location 进行重定向访问处理</span><br><span class="line">  - 作用域是指 server 块、location 块，if 块不算作用域</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  break ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：return-指令"><a href="#知识点：return-指令" class="headerlink" title="知识点：return 指令"></a>知识点：return 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 完成对请求的处理，直接向客户端返回</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  return CODE [TEXT] ;</span><br><span class="line">  return [CODE] URL ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：rewrite-指令"><a href="#知识点：rewrite-指令" class="headerlink" title="知识点：rewrite 指令"></a>知识点：rewrite 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 对 resquest 中的 URI 进行替换，实现访问跳转</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  rewrite REGEX REPLACEMENT [FLAG] ;</span><br><span class="line"></span><br><span class="line">* REGEX</span><br><span class="line">  - 指定正则，在 URI 中进行搜索</span><br><span class="line"></span><br><span class="line">* REPLACEMENT</span><br><span class="line">  - 指定转跳的地址</span><br><span class="line">  - 可以使用捕捉群</span><br><span class="line">  - 如果 REPLACEMENT 是以 &quot;http://&quot; 或 &quot;https://&quot; 开头，则不会再对 URI 做其他处理，直接将 REPLACEMENT 的内容返回给客户端</span><br><span class="line">    - 此时，REGEX 的意义仅为提供捕捉群，即使 REGEX 完全没有命中也不影响跳转</span><br><span class="line"></span><br></pre></td></tr></table></figure>
3.<strong>FLAG</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* last</span><br><span class="line">  - 将替换后的 URI 作为一个新的 URI，在 server 块中开始新一轮的查找相应的 location 块</span><br><span class="line">  - 提供了一个从一个 location 转入其他 location 块中的方式</span><br><span class="line"></span><br><span class="line">* break</span><br><span class="line">  - 将替换后的 URI 作为一个新的 URI，继续在本块中进行处理，并停止处理后续的的 rewrite 指令</span><br><span class="line"></span><br><span class="line">* redirect</span><br><span class="line">  - 临时重定向 302</span><br><span class="line">  - 将重写后的 URI 直接返回给客户端用于跳转，不再做其他处理</span><br><span class="line">  - 主要用在 REPLACEMENT 不是以 &quot;http://&quot;、&quot;https://&quot; 开头的情况</span><br><span class="line"></span><br><span class="line">* permanent</span><br><span class="line">  - 永久重定向 301</span><br><span class="line">  - 将重写后的 URI 返回给客户端用于跳转，不再做其他处理</span><br><span class="line">  - 主要用在 REPLACEMENT 不是以 &quot;http://&quot;、&quot;https://&quot; 开头的情况</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：rewrite-log-指令"><a href="#知识点：rewrite-log-指令" class="headerlink" title="知识点：rewrite_log 指令"></a>知识点：rewrite_log 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 开启 URL 重写的日志记录</span><br><span class="line">  - 以 notice 级别记录在 error_log 中</span><br><span class="line">  - 注意 error_log 的默认级别是 error</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  rewrite_log on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：rewrite-配置范例"><a href="#知识点：rewrite-配置范例" class="headerlink" title="知识点：rewrite 配置范例"></a>知识点：rewrite 配置范例</h3><ol>
<li><strong>域名跳转</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 需求</span><br><span class="line">  - 将 www.123.xxx 和 www.123.yyy 域名跳转到 www.123.zzz</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9999</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.<span class="number">123</span>.xxx www.<span class="number">123</span>.yyy ;</span><br><span class="line">    <span class="attribute">rewrite</span> <span class="number">1</span> http://www.123.zzz ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9999</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.<span class="number">123</span>.zzz ;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/html ;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&lt;h1&gt;test&lt;/h1&gt;&#x27;</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>域名跳转，使用捕捉群</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 需求</span><br><span class="line">  - 使用捕捉群实现域名跳转的过程中携带 request 中的 URI</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9999</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.<span class="number">123</span>.xxx www.<span class="number">123</span>.yyy ;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> http://www.123.zzz<span class="variable">$1</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9999</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.<span class="number">123</span>.zzz ;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/html ;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&lt;h1&gt;test&lt;/h1&gt;&#x27;</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>域名跳转，指定跳转的目录</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 需求</span><br><span class="line">  - 只对 data 目录进行跳转</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9999</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.<span class="number">123</span>.xxx www.<span class="number">123</span>.yyy ;</span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~</span> /<span class="regexp">data.*</span> &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(/data.*)</span> http://www.123.zzz<span class="variable">$1</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        ........</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">9999</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> http://www.123.zzz ;</span><br><span class="line">    <span class="attribute">location</span> /data &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/html ;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&lt;h1&gt;data&lt;/h1&gt;&#x27;</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：rewrite-应用场景"><a href="#知识点：rewrite-应用场景" class="headerlink" title="知识点：rewrite 应用场景"></a>知识点：rewrite 应用场景</h3><ol>
<li><strong>独立域名</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 一个完整的 Web 项目通常包含多个模块</span><br><span class="line">  - 通常每一个模块的程序放在单独的服务器上</span><br><span class="line">  - 为每一个模块设置独立的域名</span><br><span class="line">  - 实际采用代理服务器功能</span><br><span class="line"></span><br><span class="line">* 需求</span><br><span class="line">  - 用户通过 www.shop.com 进行访问</span><br><span class="line">  - 主页放在当前服务器</span><br><span class="line">  - 搜索、物品、购物车，分别放在不同的服务器，需要进行跳转</span><br><span class="line">  - 跳转时同时将 URI 中的参数部分一起传递</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.shop.com ;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 搜索页面跳转</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ ^/search/(.*)</span> &#123;</span><br><span class="line">        <span class="attribute">rewrite</span>  http://search.shop.com/<span class="variable">$1</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 物品页面跳转</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ ^/item/(.*)</span> &#123;</span><br><span class="line">        <span class="attribute">rewrite</span> X http://item.shop.com/<span class="variable">$1</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 购物车页面跳转</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ ^/cart/(.*)</span> &#123;</span><br><span class="line">        <span class="attribute">rewrite</span> X http://cart.shop.com/<span class="variable">$1</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回主页</span></span><br><span class="line">    <span class="attribute">location</span> /&#123;</span><br><span class="line">        <span class="attribute">root</span> /data/MainPage ;</span><br><span class="line">        <span class="attribute">index</span> main_page.index ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>目录合并</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 搜索引擎优化 SEO 的一个重要原则就是 URL 中目录不要超过三级</span><br><span class="line">  - 使用 Rewrite 来实现通过 URL 中的一级模块来访问实际的多级目录中的资源</span><br><span class="line">  - 使用 Rewrite，将 URL 中的 &#x27;/&#x27; 替换成其他字符，如 &#x27;-&#x27;</span><br><span class="line"></span><br><span class="line">* 需求</span><br><span class="line">  - 将 /data/11/22/33/44/55/index.html 映射为 /data-11-22-33-44-55/index.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> abc.text.com ;</span><br><span class="line">    <span class="attribute">location</span> /data &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/data-(\w+)-(\w+)-(\w+)-(\w+)-(\w+)/index.html$</span> /data/<span class="variable">$1</span>/<span class="variable">$2</span>/<span class="variable">$3</span>/<span class="variable">$4</span>/<span class="variable">$5</span>/index.html <span class="literal">last</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> /data/<span class="number">11</span>/<span class="number">22</span>/<span class="number">33</span>/<span class="number">44</span>/<span class="number">55</span> &#123;</span><br><span class="line">        <span class="attribute">root</span> /webpages ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>防盗链</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 使用 rewrite 将请求发送到自定义的页面或图片，提供更好的用户体验</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /images &#123;</span><br><span class="line">    <span class="attribute">root</span> html ;</span><br><span class="line">    <span class="attribute">vaild_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> www.baidu.com ;</span><br><span class="line">    <span class="attribute">if</span> $(invalid_referer) &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/</span> /images/forbidden.jpg <span class="literal">break</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-3-反向代理"><a href="#3-3-反向代理" class="headerlink" title="3.3 反向代理"></a>3.3 反向代理</h2><hr>
<h3 id="知识点：反向代理"><a href="#知识点：反向代理" class="headerlink" title="知识点：反向代理"></a>知识点：反向代理</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 模块 ngx_http_proxy_module</span><br><span class="line"></span><br><span class="line">* 流程</span><br><span class="line">  - nginx Proxy 接收用户 request</span><br><span class="line">  - nginx Proxy 将 request 转发给后端服务器</span><br><span class="line">  - nginx Proxy 接收后端服务器的 response</span><br><span class="line">  - nginx Proxy 将 response 发送给用户</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - 动静分离</span><br><span class="line">  - 安全隔离</span><br><span class="line">    - 客户端 --&gt; 防火墙 --&gt; nginx 代理 --&gt; 后端服务器</span><br><span class="line">  - 多级代理</span><br><span class="line">    - 客户端 --&gt; 防火墙 --&gt; LVS --&gt; nginx 代理 --&gt; 后端服务器</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：正向代理"><a href="#知识点：正向代理" class="headerlink" title="知识点：正向代理"></a>知识点：正向代理</h3><ol>
<li><strong>配置范例</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">88</span> ;</span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span> ;</span><br><span class="line">    <span class="attribute">location</span> / &#123; <span class="attribute">proxy_pass</span> http://$host$request_uri ; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：proxy-pass-指令"><a href="#知识点：proxy-pass-指令" class="headerlink" title="知识点：proxy_pass 指令"></a>知识点：proxy_pass 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置反向代理的后端服务器的地址 URL</span><br><span class="line">  - nginx 会对 request URL 进行改写，然后根据改写后的 URL 将请求转发给后端服务器</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  proxy_pass URL ;</span><br><span class="line"></span><br><span class="line">* URL</span><br><span class="line">  - 指定后端服务器的地址</span><br><span class="line">  - 可以包含协议、地址、端口、PATH</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /sjkfdown &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://10.150.148.64:9000 ;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto $scheme;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Port $server_port;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    <span class="comment"># proxy_set_header Upgrade $http_upgrade;</span></span><br><span class="line">    <span class="comment"># proxy_set_header Connection &quot;upgrade&quot;;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：proxy-pass-指令对-URL-的改写"><a href="#知识点：proxy-pass-指令对-URL-的改写" class="headerlink" title="知识点：proxy_pass 指令对 URL 的改写"></a>知识点：proxy_pass 指令对 URL 的改写</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - proxy_pass 指令对 URL 的改写，本质上都是将 request URL 中的 PATH 以及之后的查询参数等，追加到 proxy_pass URL 之后</span><br><span class="line">  - 区别为，从 request URL PATH 哪一部分开始处理</span><br><span class="line">  - 取决于 proxy_pass URL 中是否带 PATH，哪怕只包含一个 &quot;/&quot; 字符</span><br><span class="line"></span><br><span class="line">* 无 PATH 情况</span><br><span class="line">  - 类似 root 指令</span><br><span class="line">  - 会将整个 request URL PATH 以及之后的查询参数等，追加到 proxy_pass URL 之后</span><br><span class="line"></span><br><span class="line">* 有 PATH 情况</span><br><span class="line">  - 类似 alias 指令</span><br><span class="line">  - 会从 request URL PATH 中与 location 匹配结束的位置开始，将之后的内容包括查询参数追加到 proxy_pass URL 之后</span><br><span class="line">  - 易错点</span><br><span class="line">    1. 与 alias 指令类型，proxy_pass URL PATH 末尾不会自动追加 &quot;/&quot;，所以当 location 以 &quot;/&quot; 结尾时，要特别注意 proxy_pass URL 是否以 &quot;/&quot; 结尾</span><br><span class="line">    2. proxy_pass URL PATH 哪怕只包含一个 &quot;/&quot; 字符，如 http://192.168.100.9:8001/，也被视为有 PATH 情况，PAHT 为 &quot;/&quot;</span><br><span class="line"></span><br><span class="line">* 与 location 指令匹配方式的影响</span><br><span class="line">  - 无 PATH 情况，location 指令可以使用所有的匹配方式</span><br><span class="line">  - 有 PATH 情况，由于改写是基于 request URL PATH 的前缀进行的，因此 location 指令中不能指定正则匹配，只能使用精确匹配、正则前缀匹配、普通前缀匹配三种</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例一，无 PATH 情况</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 配置</span><br><span class="line">  location /data &#123; proxy_path http://192.168.100.9:8001 ; &#125;</span><br><span class="line"></span><br><span class="line">* request URL</span><br><span class="line">  http://192.168.100.1:9999/data/yum/index.html</span><br><span class="line"></span><br><span class="line">* 改写后的 URL</span><br><span class="line">  http://192.168.100.9:8001/data/yum/index.html</span><br><span class="line"></span><br><span class="line">* 解析</span><br><span class="line">  - 无 PATH 情况</span><br><span class="line">  - 将 request URL PATH 全部，即 /data/yum/index.html，追加到 proxy_path URL 之后，即 http://192.168.100.9:8001</span><br><span class="line">  - 最终得到 http://192.168.100.9:8001/data/yum/index.html</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例二，有 PATH 情况</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 配置</span><br><span class="line">  location /data &#123; proxy_path http://192.168.100.9:8001/app/data ; &#125;</span><br><span class="line"></span><br><span class="line">* request URL</span><br><span class="line">  http://192.168.100.1:9999/data/yum/index.html</span><br><span class="line"></span><br><span class="line">* 改写后的 URL</span><br><span class="line">  http://192.168.100.9:8001/app/data/yum/index.html</span><br><span class="line"></span><br><span class="line">* 解析</span><br><span class="line">  - 有 PATH 情况</span><br><span class="line">  - request URL PATH 中与 location 匹配的部分为 /data，剩余部分为 /yum/index.html</span><br><span class="line">  - 将剩余部分追加到 proxy_path URL 之后，即 http://192.168.100.9:8001/app/data</span><br><span class="line">  - 最终得到 http://192.168.100.9:8001/app/data/yum/index.html</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例三，错误范例，有 PATH 情况时 proxy_path URL 末尾未带 “&#x2F;“</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 配置</span><br><span class="line">  location /data/ &#123; proxy_path http://192.168.100.9:8001/app/data ; &#125;</span><br><span class="line"></span><br><span class="line">* request URL</span><br><span class="line">  http://192.168.100.1:9999/data/yum/index.html</span><br><span class="line"></span><br><span class="line">* 改写后的 URL</span><br><span class="line">  http://192.168.100.9:8001/app/datayum/index.html</span><br><span class="line"></span><br><span class="line">* 解析:</span><br><span class="line">  - 有 PATH 情况</span><br><span class="line">  - location PATH 为 /data/</span><br><span class="line">  - request URL PATH 中与 location 匹配的部分为 /data/，剩余部分为 yum/index.html</span><br><span class="line">  - 将剩余部分追加到 proxy_path URL 之后，即 http://192.168.100.9:8001/app/data</span><br><span class="line">  - 最终得到 http://192.168.100.9:8001/app/datayum/index.html</span><br><span class="line"></span><br><span class="line">* 解决方法</span><br><span class="line">  1. 在 proxy_path URL 末尾加一个 &quot;/&quot;</span><br><span class="line">  2. 在 location PATH 部分去除末尾的 &quot;/&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：proxy-set-header-指令"><a href="#知识点：proxy-set-header-指令" class="headerlink" title="知识点：proxy_set_header 指令"></a>知识点：proxy_set_header 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 对于客户端发来的 request，先变更请求头信息，再转发给后端服务器</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  proxy_set_header FIELD VALUE ;</span><br><span class="line"></span><br><span class="line">* 默认值</span><br><span class="line">  proxy_set_header Host $proxy_host ;</span><br><span class="line">  proxy_set_header Connection close ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：proxy-connect-timeout-指令"><a href="#知识点：proxy-connect-timeout-指令" class="headerlink" title="知识点：proxy_connect_timeout 指令"></a>知识点：proxy_connect_timeout 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - Defines a timeout for establishing a connection with a proxied server.</span><br><span class="line">  - 默认值 60s</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  proxy_connect_timeout TIME ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：proxy-redirect-指令"><a href="#知识点：proxy-redirect-指令" class="headerlink" title="知识点：proxy_redirect 指令"></a>知识点：proxy_redirect 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 对后端服务器的 response header 中的 Location 和 Refresh 的值进行替换</span><br><span class="line">  - 当后端服务器发生跳转时，在 response header 中隐藏后端服务器的地址</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  proxy_redirect REDIRECT REPLACEMENT ;</span><br><span class="line">  proxy_redirect off ;</span><br><span class="line">  proxy_redirect default ;</span><br><span class="line">  proxy_set_header Host $proxy_host ;</span><br><span class="line">  proxy_set_header Connection close ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-反向代理配置范例"><a href="#知识点：nginx-反向代理配置范例" class="headerlink" title="知识点：nginx 反向代理配置范例"></a>知识点：nginx 反向代理配置范例</h3><ol>
<li><strong>范例一</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实现带有 URL 改写的负载均衡</span></span><br><span class="line"><span class="comment"># 先将 request uri 进行改写，再进行负载均衡</span></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>  <span class="number">80</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.abc.com ;</span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~</span> /file/ &#123;</span><br><span class="line">        <span class="attribute">rewrite</span> /file/(.*) /server/<span class="variable">$1</span> <span class="literal">break</span> ;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.1.101 ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 另一种写法</span></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>  <span class="number">80</span> ;</span><br><span class="line">    <span class="attribute">server_name</span> www.abc.com ;</span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~</span> /file/ &#123;</span><br><span class="line">        <span class="attribute">rewrite</span> /file/(.*) /server/<span class="variable">$1</span> <span class="literal">last</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span><span class="regexp"> ^~</span> /server/ &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.1.101 ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-4-负载均衡"><a href="#3-4-负载均衡" class="headerlink" title="3.4 负载均衡"></a>3.4 负载均衡</h2><hr>
<h3 id="知识点：负载均衡-Load-Balancing"><a href="#知识点：负载均衡-Load-Balancing" class="headerlink" title="知识点：负载均衡 Load Balancing"></a>知识点：负载均衡 Load Balancing</h3><pre><code>1. 系统的扩展
    # 纵向扩展，提升单机的性能
    # 横向扩展，添加机器
2. 负载均衡的优点
    # 提升高并发时的处理能力
    # 故障转移，高可用
    # 可扩展性
    # 在负载均衡器上进行过滤，提高安全性
3. 负载均衡实现方式
    # 用户手动选择
    # DNS 轮询
        * 网站在域名注册商处为一个主机添加多条 A 记录，即一个域名可以对应多个 IP
        * 每当有用户解析 DNS，DNS 就会按次序分别返回 IP
        * 由于 DNS 有缓存，存在可靠性低、压力不均衡的问题
    # 四层/七层负载均衡
        * 四层负载均衡，工作在传输层，基于 IP + PORT
            - 硬件，F5、BIG-IP、Radware 等，效率高，成本高，扩展性低
            - 软件，LVS、nginx、Hayproxy 等
        * 七层负载均衡，工作在应用层，基于 URL 或 IP
            - nginx、Hayproxy 等
        * 四层和七层的区别
            - 四层是在底层进行分发，七层是在最顶端进行分发，所以四层比七层效率高
            - 四层不识别域名，七层识别域名
</code></pre>
<hr>
<h3 id="知识点：nginx-七层负载均衡"><a href="#知识点：nginx-七层负载均衡" class="headerlink" title="知识点：nginx 七层负载均衡"></a>知识点：nginx 七层负载均衡</h3><pre><code>1. 介绍
    # 通过反向代理功能实现
        * 本质上是反向代理的一个应用场景，即将请求转发给后端的多个功能相同的服务器
    # 基于 ngx_http_proxy_module 和 ngx_http_upstream_module
        * proxy 模块用来将请求发送到后端服务器组
        * upstream 模块用来定义一个后端服务器组
    # 使用 proxy_pass 指令转发请求
        * proxy_pass http://UPSTREAM ;
</code></pre>
<hr>
<h3 id="知识点：ngx-http-upstream-module-指令"><a href="#知识点：ngx-http-upstream-module-指令" class="headerlink" title="知识点：ngx_http_upstream_module 指令"></a>知识点：ngx_http_upstream_module 指令</h3><pre><code>1. upstream
    # 语句块，每个 upstream 语句块定义一个后端服务器组
    # 位置，http
        * 与 server 块同级
    # 知识点
        * upstream NAME &#123;...&#125;
2. server
    # 为后端服务器组中添加一台服务器，以及此服务器的一些参数
    # 位置，upstream
    # 知识点
        * server ADDRESS [PARAMETERS] [weight=Number] ;
        * ADDRESS
            - 指定后端服务器
            - 可以使用域名、IP、IP + 端口、unix socket 等
        * weight=Number
            - 设置服务器的权重
        * PARAMETERS
            - down              &lt;== 设置此服务器永久不可用，使 server 暂时不参与负载均衡，通常用于 server 停机维护操作
            - backup            &lt;== 将此服务器标记为备份服务器，当主服务器不可用时上线，当主服务器恢复时下线
            - max_conns=NUMBER  &lt;== 设置此后端服务器的最大连接数，0 表示 no limit
            - max_fails=NUMBER  &lt;== 此后端服务器允许的最大尝试连接失败次数，超过后认为此后端服务器已不可用
            - fail_timeout=TIME &lt;== 此后端服务器经过 max_fails 失败后，服务的暂停时间
3. ip_hash
    # 设置后端服务器组的 load balancing method 为根据 client IP addresses 进行哈希
        * ipv4 的前三个网段
        * ipv6 的全部
    # 位置，upstream
    # 知识点
        * ip_hash ;
4. hash
    # 设置后端服务器组的 load balancing method 为根据指定的 KEY 进行哈希
        * 对指定的 KEY 进行哈希
        * 根据哈希的结果建立 client-server mapping
    # 位置，upstream
    # 知识点
        * hash KEY [consistent] ;
        * KEY
            - 可以是 text、variables，或二者的组合
            - variables 通常采用 request header 中的非固定字段
5. least_conn;
    # 设置后端服务器组的 load balancing method 为根据基于最小 active connection
    # 位置，upstream
    # 知识点
        * least_conn ;
</code></pre>
<hr>
<h3 id="知识点：nginx-七层负载均衡的常用均衡策略"><a href="#知识点：nginx-七层负载均衡的常用均衡策略" class="headerlink" title="知识点：nginx 七层负载均衡的常用均衡策略"></a>知识点：nginx 七层负载均衡的常用均衡策略</h3><pre><code>1. 负载均衡策略 load balancing method
    # 用来确定 nginx 负载均衡服务器向每个后端服务器发送请求的比例
    # 策略选择
        * 每种策略都有其优点缺点
        * 实际使用中应根据实际情况选择某个策略
    # 六种策略
        * 一般轮询
        * 加权轮询
        * ip 哈希
        * uri 哈希
        * 最少连接
        * 公平 fair
2. 一般轮询 round-robin
    # upstream 模块的默认策略
    # 每个请求会按顺序依次分配到后端服务器
    # 优点
        * 配置简单，轮询不需要额外的配置
  # 缺点
    * 无法保持会话
    # 范例
        | upstream backend &#123;
        |   server 192.168.200.146 ;
        |   server 192.168.200.147 ;
        |   server 192.168.200.148 ;
        | &#125;
        | server &#123;
        |   listen 80 ;
        |   server_name www.abc.com ;
        |   location / &#123;
        |       proxy_pass http://backend ;
        |   &#125;
        | &#125;
3. 加权轮询 Weighted load balancing
    # 按照服务器的权重，向服务器转发请求
        * upstream 模块的 server 指令的 weight 子句
    # 默认权重为 1
        * 一般轮询可以看成一个特殊的加权轮询
    # 当采用其他策略时，如 ip-hash，则配置的 weight 语句会被覆盖
    # 优点
        * 适合服务器硬件性能不同的情况
            - 性能强的服务器权重可以高一些
            - 性能弱的服务器权重可以小一些
    # 范例
        | upstream backend &#123;
        |   server 192.168.200.146 weight=5 ;
        |   server 192.168.200.147 weight=10 ;
        |   server 192.168.200.148 weight=15 ;
        | &#125;
        | server &#123;
        |   listen 80 ;
        |   server_name www.abc.com ;
        |   location / &#123;
        |       proxy_pass http://backend ;
        |   &#125;
        | &#125;
4. ip 哈希 ip-hash
    # 依照客户端 ip 进行哈希，并与后端服务器绑定
    # 通过 upstream 模块的 ip_hash 语句实现
    # 优点
        * 会话保持 Session persistence
    # 缺点
        * 可能导致不均衡
    # 范例
        | upstream backend &#123;
        |   ip_hash ;
        |   server 192.168.200.146 ;
        |   server 192.168.200.147 ;
        |   server 192.168.200.148 ;
        | &#125;
        | server &#123;
        |   listen 80 ;
        |   server_name www.abc.com ;
        |   location / &#123;
        |       proxy_pass http://backend ;
        |   &#125;
        | &#125;
5. uri 哈希 uri-hash
    # 按照 request 的 uri 的内容进行哈希
    # 通过 upstream 的 hash 命令实现，指定 key 为 $request_uri
    # 优点
        * 可以将某个 uri 的资源与具体的后端服务器绑定
        * 如果结合代理缓存使用，可以提高缓存命中
    # 范例
        | upstream backend &#123;
        |   hash $request_uri ;
        |   server 192.168.200.146 ;
        |   server 192.168.200.147 ;
        |   server 192.168.200.148 ;
        | &#125;
        | server &#123;
        |   listen 80 ;
        |   server_name www.abc.com ;
        |   location / &#123;
        |       proxy_pass http://backend ;
        |   &#125;
        | &#125;
6. 最少连接 least_connection
    # 把请求转发给连接数较少的后端服务器
    # 通过 upstream 的 least_conn 命令实现
    # 优点
        * 适合于请求处理时间长短不一的情况
    # 范例
        | upstream backend &#123;
        |   least_conn ;
        |   server 192.168.200.146 ;
        |   server 192.168.200.147 ;
        |   server 192.168.200.148 ;
        | &#125;
        | server &#123;
        |   listen 80 ;
        |   server_name www.abc.com ;
        |   location / &#123;
        |       proxy_pass http://backend ;
        |   &#125;
        | &#125;
7. 公平 fair
    # 从多个维度，如页面大小、加载时间长短等进行只能判断
    # 需要加载第三方模块 nginx-upstream-fair
        * 下载源码
            - mkdir -p /XXXX/module
            - cd /XXXX/module/
            - git clone https://github.com/gnosek/nginx-upstream-fair.git
        * 修改 nginx 源码
            - vim nginx-X.XX.X/src/http/ngx_http_upstream.h
            - 在 ngx_http_upstream_srv_conf_s 函数之下添加一行 &#39;in_port_t       default_port&#39;
        * 添加第三方模块并编译升级
            - mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old
            - cd nginx-X.XX.X
            - ./configure $(nginx -V 2&gt;&amp;1 | grep configure | sed &#39;s/^configure arguments://&#39;) --add-module=/XXXX/module/nginx-upstream-fair
            - cp nginx-X.XX.X/objs/nginx /usr/local/nginx/sbin
            - make upgrade
    # 范例
        | upstream backend &#123;
        |   fair ;
        |   server 192.168.200.146 ;
        |   server 192.168.200.147 ;
        |   server 192.168.200.148 ;
        | &#125;
        | server &#123;
        |   listen 80 ;
        |   server_name www.abc.com ;
        |   location / &#123;
        |       proxy_pass http://backend ;
        |   &#125;
        | &#125;
</code></pre>
<hr>
<h2 id="3-5-四层代理"><a href="#3-5-四层代理" class="headerlink" title="3.5 四层代理"></a>3.5 四层代理</h2><hr>
<h3 id="知识点：nginx-四层代理与四层负载均衡"><a href="#知识点：nginx-四层代理与四层负载均衡" class="headerlink" title="知识点：nginx 四层代理与四层负载均衡"></a>知识点：nginx 四层代理与四层负载均衡</h3><pre><code>1. 介绍
    # nginx 1.9 开始，增加了一系列 stream 模块，用于支持四层代理
        * --with-stream
    # 四层代理称为流服务器
    # 四层负载均衡基于四层代理实现
    # stream 块位于 main 块中，与 http 块同级
    # nginx 四层负载均衡，相比 LVS、HAProxy、F5 等，性能差一些，成本低一些，配置简单一些
</code></pre>
<hr>
<h3 id="知识点：ngx-stream-core-module-相关指令"><a href="#知识点：ngx-stream-core-module-相关指令" class="headerlink" title="知识点：ngx_stream_core_module 相关指令"></a>知识点：ngx_stream_core_module 相关指令</h3><pre><code>1. stream
    # 用于指定流服务器语句块
    # 位置，main
    # 知识点
        * stream &#123; ... &#125;
2. server
    # 语句块，配置一个流服务器 stream_vhost
        * ngx_stream_core_module 指令
    # 位置，stream
    # 知识点
        * server &#123; ... &#125; ;
3. listen
    # 指定 stream_vhost 的监听
    # 位置，server
    # 知识点
        * listen [ADDRESS]:PORT [ssl] ;
</code></pre>
<hr>
<h3 id="知识点：ngx-stream-core-module-相关指令-1"><a href="#知识点：ngx-stream-core-module-相关指令-1" class="headerlink" title="知识点：ngx_stream_core_module 相关指令"></a>知识点：ngx_stream_core_module 相关指令</h3><pre><code>1. proxy_pass
    # 配置 stream_vhost 将流量转发到何地
    # 位置，server
    # 知识点
        * proxy_pass ADDRESS|stream_upstream ;
</code></pre>
<hr>
<h3 id="知识点：ngx-stream-proxy-module-相关指令"><a href="#知识点：ngx-stream-proxy-module-相关指令" class="headerlink" title="知识点：ngx_stream_proxy_module 相关指令"></a>知识点：ngx_stream_proxy_module 相关指令</h3><pre><code>1. upstream
    # 语句块，在流服务器配置中，创建一个后端服务器主机组
    # 位置，stream
    # 知识点
        * upstream NAME &#123; ... &#125;
2. server
    # 为 stream_upstream 主机组中添加主机
    # 位置，upstream
    # 知识点
        * server ADDRESS [PARAMETERS] ;
        * 配置细节与 http_upstream 中的 server 语句相同
3. hash
    # 指定 stream_upstream 主机组的 load balancing method 为基于指定的 key 进行哈希
    # 位置，upstream
    # 知识点
        * hash KEYs [consistent];
        * 配置细节与 http_upstream 中的 hash 语句相同
4. least_conn
    # 指定 stream_upstream 主机组的 load balancing method 为基于最小 active connection
    # 位置，upstream
    # 知识点
        * least_conn ;
</code></pre>
<hr>
<h3 id="知识点：nginx-四层负载均衡范例"><a href="#知识点：nginx-四层负载均衡范例" class="headerlink" title="知识点：nginx 四层负载均衡范例"></a>知识点：nginx 四层负载均衡范例</h3><pre><code>1. 范例一
    | # 对 81 端口的访问转发到 x 组，对 82 端口的流量转发到 y 组
    | stream &#123;
    |   upstream backendx &#123;
    |       server 192.168.1.101 ;
    |       server 192.168.1.102 ;
    |   &#125;
    |   upstream backendy &#123;
    |       server 192.168.1.103 ;
    |       server 192.168.1.104 ;
    |   &#125;
    |   server &#123;
    |       listen 81 ;
    |       proxy_pass backendx ;
    |   &#125;
    |   server &#123;
    |       listen 82 ;
    |       proxy_pass backendy ;
    |   &#125;
    | &#125;
</code></pre>
<hr>
<h2 id="3-6-缓存集成"><a href="#3-6-缓存集成" class="headerlink" title="3.6 缓存集成"></a>3.6 缓存集成</h2><hr>
<h3 id="知识点：nginx-代理缓冲和代理缓存"><a href="#知识点：nginx-代理缓冲和代理缓存" class="headerlink" title="知识点：nginx 代理缓冲和代理缓存"></a>知识点：nginx 代理缓冲和代理缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">1. 缓冲与缓存</span><br><span class="line">    # 缓冲，写速率大，读速率小，写进程间歇性工作</span><br><span class="line">    # 缓存，读速率大，写速率小，读进程间歇性工作</span><br><span class="line">    # 对于 nginx 代理服务器，客户端相当于读，后端服务器相当于写</span><br><span class="line"></span><br><span class="line">2. nginx 代理缓冲 ProxyBuffer</span><br><span class="line">    * nginx 代理服务器和后端服务器通常在同一个机房，之间的网络很好</span><br><span class="line">    * nginx 代理服务器和客户端的网络很差</span><br><span class="line">    * 配置 ProxyBuffer 可以让 nginx 代理服务器更快的从后端服务器读取数据</span><br><span class="line"></span><br><span class="line">3. nginx 代理缓存 ProxyCache</span><br><span class="line">    # 意义</span><br><span class="line">        * 后端服务器的 response http 在 nginx 代理服务器的 HD 缓存</span><br><span class="line">        * 返回客户端的数据直接从 nginx 代理服务器的 HD 读取</span><br><span class="line">        * 减轻后端服务器的压力</span><br><span class="line">    # 特点</span><br><span class="line">        * 采用 LRU 算法来释放空间</span><br><span class="line">        * 支持对 404/301/302 等非 200 状态码进行分类</span><br><span class="line">        * 主要由 ngx_http_proxy_module 中的 proxy_cache_* 指令进行配置</span><br><span class="line">    # 流程</span><br><span class="line">        * 若本地无缓存，则将 request 转发给后端服务器</span><br><span class="line">        * 对 $scheme$proxy_host$request_uri 进行 MD5，得到 key</span><br><span class="line">        * 以 key 为基准，创建目录，将被代理服务器的 response http 包存到目录中</span><br><span class="line">        * 将 response http 包发送给客户端</span><br><span class="line">    # 缺点</span><br><span class="line">        * 数据不一致</span><br><span class="line"></span><br><span class="line">4. 相关变量</span><br><span class="line">    # $upstream_cache_status</span><br><span class="line">        * 是否命中缓存</span><br><span class="line">        * HIT、MISS、BYPASS</span><br><span class="line">        * 在 response 中体现是否命中缓存</span><br><span class="line">            - add_header nginx_cache $upstream_cache_status ;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="知识点：nginx-代理缓冲配置"><a href="#知识点：nginx-代理缓冲配置" class="headerlink" title="知识点：nginx 代理缓冲配置"></a>知识点：nginx 代理缓冲配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">1. proxy_buffering</span><br><span class="line">    # nginx 代理服务器开启或关闭 ProxyBuffer</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_buffering on|off ;</span><br><span class="line"></span><br><span class="line">2. proxy_buffers</span><br><span class="line">    # 指定单个连接从代理服务器读取响应的缓冲区的个数和大小</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_buffers NUMBER SIZE ;</span><br><span class="line"></span><br><span class="line">3. proxy_buffer_size</span><br><span class="line">    # 设置从后端服务器获取的第一部分响应数据的大小，保持与 proxy_buffers 中的 SIZE 一致即可，当然也可以更小</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_buffer_size SIZE ;</span><br><span class="line"></span><br><span class="line">4. proxy_busy_buffers_size</span><br><span class="line">    # 限制同时处于 BUSY 状态的缓冲总大小</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_busy_buffers_size SIZE ;</span><br><span class="line"></span><br><span class="line">5. proxy_temp_path</span><br><span class="line">    # 当缓冲区存满后，仍未被 nginx 服务器完全接受，磁盘上临时保存数据的目录</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_temp_path PATH [LEVELS] ;</span><br><span class="line">        * LEVEL</span><br><span class="line">            - 设置子目录的命名方式，按照 nginx MD5 命名方式，最多 3 层</span><br><span class="line"></span><br><span class="line">6. proxy_temp_file_write_size</span><br><span class="line">    # 对磁盘缓冲文件的一次写操作的大小</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_temp_file_write_size SIZE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="知识点：nginx-代理缓存配置"><a href="#知识点：nginx-代理缓存配置" class="headerlink" title="知识点：nginx 代理缓存配置"></a>知识点：nginx 代理缓存配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">1. proxy_cache_path</span><br><span class="line">    # 创建缓存区</span><br><span class="line">    # 位置，http</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_cache_path PATH [LEVELS] KYES_ZONE [INACTIVE] [MAX_SIZE] ;</span><br><span class="line">        * PATH</span><br><span class="line">            - 设置缓存目录</span><br><span class="line">            - 若不存在会自动创建</span><br><span class="line">        * LEVELS</span><br><span class="line">            - levels=N[:N[:N]]</span><br><span class="line">            - 设置缓存目录的子目录的层级，以及每一层的命名长度，最多三层</span><br><span class="line">            - 对 MD5 从末尾开始截取字符串</span><br><span class="line">            - 范例</span><br><span class="line">                levels=2:2:2</span><br><span class="line">                b75606018d56926df635cc9141dda6b8，则缓存目录为 b8/a6/dd</span><br><span class="line">        * KYES_ZONE</span><br><span class="line">            - keys_zone=ZONE_NAME:ZONE_SIZE</span><br><span class="line">            - 设置缓存的名称，和 keys 命名空间的大小</span><br><span class="line">            - 1M 的命名空间可以储存 8192 个 keys</span><br><span class="line">        * INACTIVE</span><br><span class="line">            - inactive=TIME</span><br><span class="line">            - 设置缓存的活跃时间，若某个缓存在此时间内没有被访问，则会被删除，不论此缓存多新鲜</span><br><span class="line">        * MAX_SIZE</span><br><span class="line">            - max_size=SIZE</span><br><span class="line">            - 设置缓存区的大小</span><br><span class="line"></span><br><span class="line">2. proxy_cache</span><br><span class="line">    # 启用或禁用某个缓存区</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_cache ZONE_NAME on|off ;</span><br><span class="line"></span><br><span class="line">3. proxy_cache_key</span><br><span class="line">    # 确定 MD5 的计算基准</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_cache_key KEY ;</span><br><span class="line">        * 默认值，proxy_cache_key $scheme$proxy_host$request_uri ;</span><br><span class="line"></span><br><span class="line">4. proxy_cache_valid</span><br><span class="line">    # 按状态码分类，设置不同的缓存时间</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_cache_valid [CODE ...] TIME ;</span><br><span class="line">        * CODE</span><br><span class="line">            - 省略表示 200 301 302</span><br><span class="line">            - any 表示所有</span><br><span class="line"></span><br><span class="line">5. proxy_cache_min_uses</span><br><span class="line">    # 设置资源被访问多少次后被缓存，默认 1</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_cache_min_uses NUMBER ;</span><br><span class="line"></span><br><span class="line">6. proxy_cache_methods</span><br><span class="line">    # 设置缓存哪些 http 方法，默认 GET 和 HEAD</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_cache_methods METHOD [...] ;</span><br><span class="line"></span><br><span class="line">7. proxy_no_cache</span><br><span class="line">    # 定义不进行缓存的条件</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">    # 知识点</span><br><span class="line">        * proxy_no_cache STRING [...] ;</span><br><span class="line">        * STRING</span><br><span class="line">            - 可以设置多个，如果全部为 0，则不进行缓存</span><br><span class="line">    # 范例</span><br><span class="line">        * proxy_cache_bypass $cookie_nocache $arg_nocache $arg_comment ;</span><br><span class="line">            - $cookie_nocache 可以通过在向后端服务器转发时先 add_header Set-Cookie 进行设置</span><br><span class="line"></span><br><span class="line">8. proxy_cache_bypass</span><br><span class="line">    # 定义跳过缓存的条件</span><br><span class="line">    # 位置，http、server、location</span><br><span class="line">        * proxy_cache_bypass STRING [...] ;</span><br><span class="line">            - 可以设置多个，除非如果全部为 0 或空，否则跳过缓存</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="知识点：nginx-代理缓存的清除"><a href="#知识点：nginx-代理缓存的清除" class="headerlink" title="知识点：nginx 代理缓存的清除"></a>知识点：nginx 代理缓存的清除</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. 方式</span><br><span class="line">    # 手动清除，rm 缓存目录</span><br><span class="line">    # 自动清除</span><br><span class="line">        * 商业版 nginx 支持 proxy_cache_purge 指令</span><br><span class="line">        * 第三方模块 ngx_cache_purge 提供了另一种 proxy_cache_purge 指令</span><br><span class="line"></span><br><span class="line">2. proxy_cache_purge (same location syntax)</span><br><span class="line"></span><br><span class="line">3. proxy_cache_purge (separate location syntax)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-7-其他常用功能"><a href="#3-7-其他常用功能" class="headerlink" title="3.7 其他常用功能"></a>3.7 其他常用功能</h2><hr>
<h3 id="知识点：文件服务器"><a href="#知识点：文件服务器" class="headerlink" title="知识点：文件服务器"></a>知识点：文件服务器</h3><ol>
<li><strong>autoindex 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 使 nginx 提供下载功能</span><br><span class="line">  - 基于 ngx_http_autoindex_module 模块实现</span><br><span class="line">  - 实际作用为开启目录浏览功能，针对目录 produces a directory listing</span><br><span class="line">  - 可以用来搭建 yum 源</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  autoindex on | off;</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 范例</span><br><span class="line">  location /yum &#123;</span><br><span class="line">    alias /mnt/yum ;</span><br><span class="line">    autoindex on ;              # 开启目录浏览功能；</span><br><span class="line">    autoindex_exact_size off ;  # 关闭详细文件大小统计，让文件大小显示 MB、GB 单位，默认为 b；</span><br><span class="line">    autoindex_localtime on ;    # 开启以服务器本地时区显示文件修改日期</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>作为上传服务器</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client_max_body_size 100m ;                       # 客户端允许上传的单个文件的最大值</span><br><span class="line">client_body_buffer_size 1024k ;                   # 接受每个客户端请求的 body 部分的缓冲区大小</span><br><span class="line">client_body_temp_path /app/nginx/temp/ 1 2 2 ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：限速"><a href="#知识点：限速" class="headerlink" title="知识点：限速"></a>知识点：限速</h3><ol>
<li><strong>limit_rate 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 限制下载速度</span><br><span class="line">  - The limit is set per a request, and so if a client simultaneously opens two connections, the overall rate will be twice as much as the specified limit.</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  limit_rate RATE ;</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if in location</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>limit_rate_after 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定只有在数据量达到一定规模后才开始限制下载速度</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  limit_rate_after SIZE ;</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - if in location</span><br><span class="line"></span><br><span class="line">* 范例</span><br><span class="line">  location /download &#123;</span><br><span class="line">    alias /data/download ;</span><br><span class="line">    autoindex on ;</span><br><span class="line">    limit_rate_after 500k;</span><br><span class="line">    limit_rate       50k;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：访问控制"><a href="#知识点：访问控制" class="headerlink" title="知识点：访问控制"></a>知识点：访问控制</h3><ol>
<li><strong>基于 ip 地址的访问控制</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 基于 ngx_http_access_module 模块实现</span><br><span class="line">  - 针对客户端的源 ip 地址进行访问控制</span><br><span class="line">  - 注意，如果有防火墙，则针对 ip 地址的访问控制推荐在防火墙中实现而不是在 nginx 中实现</span><br><span class="line"></span><br><span class="line">* 指令</span><br><span class="line">  allow address | CIDR | unix: | all;</span><br><span class="line">  deny  address | CIDR | unix: | all;</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line">  - limit_except</span><br><span class="line"></span><br><span class="line">* 检查方式</span><br><span class="line">  - 与 iptables 的方式类似，从上向下依次与 allow/deny 指令进行匹配，直到找到第一个匹配</span><br><span class="line">  - allow 相当于 iptables 中的 -J ACCEPT</span><br><span class="line">  - deny  相当于 iptables 中的 -J DROP</span><br><span class="line"></span><br><span class="line">* 范例</span><br><span class="line">  location / &#123;</span><br><span class="line">    deny  192.168.1.1;</span><br><span class="line">    allow 192.168.1.0/24;</span><br><span class="line">    allow 10.1.1.0/16;</span><br><span class="line">    allow 2001:0db8::/32;</span><br><span class="line">    deny  all;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>基于账号的访问控制</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 基于 ngx_http_auth_basic_module 模块实现</span><br><span class="line">  - 实现 HTTP Basic Authentication 级别的认证功能</span><br><span class="line">  - 读取 htpasswd 指令创建的虚拟用户列表，对其中的虚拟用户进行认证</span><br><span class="line">  - WWW-authenticate</span><br><span class="line"></span><br><span class="line">* 指令</span><br><span class="line">  auth_basic String | off;</span><br><span class="line">  auth_basic_user_file File;</span><br><span class="line"></span><br><span class="line">* 范例</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter04-nginx-优化"><a href="#Chapter04-nginx-优化" class="headerlink" title="Chapter04 nginx 优化"></a>Chapter04 nginx 优化</h1><hr>
<h2 id="4-1-nginx-性能优化"><a href="#4-1-nginx-性能优化" class="headerlink" title="4.1 nginx 性能优化"></a>4.1 nginx 性能优化</h2><hr>
<h3 id="知识点：worker-性能优化"><a href="#知识点：worker-性能优化" class="headerlink" title="知识点：worker 性能优化"></a>知识点：worker 性能优化</h3><ol>
<li><strong>worker_cpu_affinity 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 将 worker 进程与物理 CPU 进行绑定，CPU 粘性，cpu 亲和性</span><br><span class="line">  - 可以减少 worker 进程在切换 cpu 时产生的损耗</span><br><span class="line">  - 建议不要使用 cpu 0</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  worker_cpu_affinity auto [CPUMASK] ;</span><br><span class="line">  worker_cpu_affinity CPUMASK ... ;</span><br><span class="line"></span><br><span class="line">* auto</span><br><span class="line">  - 推荐</span><br><span class="line"></span><br><span class="line">* CPUMASK</span><br><span class="line">  - 范例：4 个 cpu，4 个 worker，则 0001 0010 0100 1000 表示将 4 个 worker 分别与 4 个 cpu 绑定</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>worker_priority 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 worker 进程的 nice 值</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  worker_priority NICE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>worker_rlimit_nofile</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 更改 worker 能打开的最大文件数，也就是更改 worker 能建立的连接数</span><br><span class="line">  - 不能超过 Linux ulimit</span><br><span class="line">  - 默认 1024，建议不要少于 65535</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - main 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  worker_rlimit_nofile NUMBER ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：sendfile-零拷贝"><a href="#知识点：sendfile-零拷贝" class="headerlink" title="知识点：sendfile 零拷贝"></a>知识点：sendfile 零拷贝</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 调用 sendfile() SystemCall 来传输数据，可以提高 nginx 处理静态资源的性能，建议 on</span><br><span class="line">  - 可以节约一次 IO 操作</span><br><span class="line">  - 可以节省用户态和内核态的进程切换</span><br><span class="line"></span><br><span class="line">* 传统方式</span><br><span class="line">  - 硬盘 --&gt; 内核缓冲区 --&gt; 应用程序缓冲区 --&gt; socket 缓冲区 --&gt; 网卡</span><br><span class="line">  - 使用 read() 和 write() 两个 SystemCall</span><br><span class="line"></span><br><span class="line">* 零拷贝方式</span><br><span class="line">  - 硬盘 --&gt; 内核缓冲区 --&gt; socker 缓冲区 --&gt; 网卡</span><br><span class="line">  - 使用 sendfile() SystemCall</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>sendﬁle 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 是否开启零拷贝功能</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  sendfile on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>tcp_nopush 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 缓存数据，存满后再发送</span><br><span class="line">  - 可以提高 tcp 包的利用率，但牺牲实时性</span><br><span class="line">  - 只有 sendfile on 时才会生效</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  tcp_nopush on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：keepalive-长连接"><a href="#知识点：keepalive-长连接" class="headerlink" title="知识点：keepalive 长连接"></a>知识点：keepalive 长连接</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 长连接 keep-alive connection</span><br><span class="line">  - 不使用长连接，则每次 http 请求都需要进行 tcp 连接</span><br><span class="line">  - 使用长连接，第一个 http 请求建立 tcp 连接后，此 tcp 连接会保持一段时间，后续的 http 请求都可以复用此 tcp 连接</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>keepalive_timeout 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置长连接的空闲等待时间，默认值 75s</span><br><span class="line">  - 空闲等待时间不宜设置过长，会占用资源</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  keepalive_timeout TIMEOUT [HEADER_TIMEOUT] ;</span><br><span class="line"></span><br><span class="line">* TIMOUT</span><br><span class="line">  - 设置具体的长连接保持时间</span><br><span class="line">  - 0，表示禁用 keepalive 功能</span><br><span class="line"></span><br><span class="line">* HEADER_TIMEOUT</span><br><span class="line">  - 设置在 response header 中显示的长连接的保持时间</span><br><span class="line">  - 可以设置返回假信息</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>keepalive_requests 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置长连接使用的次数，tcp 连接处理的 http 请求超过此数值后会断开</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  keepalive_requests NUMBER ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>keepalive_disable 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置针对某些 client Browser，比如 IE 浏览器，不开启长连接功能</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  keepalive_disable none|BROWSER ;</span><br><span class="line"></span><br><span class="line">* none</span><br><span class="line">  - 对所有浏览器都不禁用</span><br><span class="line"></span><br><span class="line">* BROWSER</span><br><span class="line">  - 指定禁用的浏览器，可以写多个，space 间隔</span><br><span class="line">  - msie6         &lt;== 对老版本的 MSIE 禁用</span><br><span class="line">  - safari        &lt;== 对 macOS 和 macOS-like 操作系统上的 safari 和 safari-like 浏览器禁用</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>tcp_nodelay 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 不缓存数据，有数据就直接发送</span><br><span class="line">  - 可以提高网络包传输的实时性，但牺牲 tcp 包的利用率</span><br><span class="line">  - 只有 keep-alive 连接的情况下才生效</span><br><span class="line"></span><br><span class="line">* tcp_nopush 和 tcp_nodelay</span><br><span class="line">  - 理论上 tcp_nopush 与 tcp_nodelay 互斥，但依然建议 tcp_nopush 和 tcp_nodelay 全部打开</span><br><span class="line">  - linux 2.5.9 以后两者可以兼容</span><br><span class="line">  - 当数据持续的在向缓存中写入时，会等到缓存装满后再发送数据</span><br><span class="line">  - 当数据写入结束而缓存并未装满时，nginx 会忽略 tcp_nopush，tcp_nodelay 强制 socket 发送数据</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  tcp_nodelay on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="4-2-nginx-压缩"><a href="#4-2-nginx-压缩" class="headerlink" title="4.2 nginx 压缩"></a>4.2 nginx 压缩</h2><hr>
<h3 id="知识点：动态压缩与-ngx-http-gzip-module-模块"><a href="#知识点：动态压缩与-ngx-http-gzip-module-模块" class="headerlink" title="知识点：动态压缩与 ngx_http_gzip_module 模块"></a>知识点：动态压缩与 ngx_http_gzip_module 模块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 动态压缩</span><br><span class="line">  - 每次 response，都进行压缩</span><br><span class="line">  - 使用 gzip 来对 response 进行压缩</span><br><span class="line"></span><br><span class="line">* 动态压缩存与 sendfile 共存有问题</span><br><span class="line">  - sendfile on 会导致数据不经过应用缓冲区</span><br><span class="line">  - gzip 需要在应用缓冲区中进行数据压缩</span><br><span class="line">  - 可以通过静态压缩来实现与 sendfile 共存的问题</span><br><span class="line"></span><br><span class="line">* ngx_http_gzip_module 模块</span><br><span class="line">  - 实现动态压缩功能的模块</span><br><span class="line">  - 默认模块，不用 --with 添加</span><br><span class="line">  - 由于指令重复性较高，建议将指令保存到外部文件中，通过 include 进行添加</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 启用或者关闭动态压缩功能</span><br><span class="line">  - 默认 off</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_types 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定进行压缩的 MIME 类型</span><br><span class="line">  - text/html 默认会进行压缩</span><br><span class="line">  - 不建议对图片、视频进行压缩，因为本身已经被压缩过，再次压缩意义不大</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_types MIME-TYPE ;</span><br><span class="line"></span><br><span class="line">* MIME-TYPE</span><br><span class="line">  - 指定需要进行压缩的 mime 类型，可以指定多个，以 space 间隔</span><br><span class="line">  - &#x27;*&#x27; 表示所有 MIME 类型</span><br><span class="line"></span><br><span class="line">* 范例</span><br><span class="line">  gzip_types * ;        对所有 mime 类型进行压缩</span><br><span class="line">  gzip_types text/* ;   对所有 text 分类的 mime 类型进行压缩</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_comp_level 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 gzip 压缩级别，范围 1-9，1 压缩级别最低，9 最高，默认 1</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_comp_level LEVEL ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_vary 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 是否通知客户端，数据是经过了 gzip 压缩处理过的</span><br><span class="line">  - 在 response header 中添加 &quot;Vary:Accept-Encoding&quot; 的内容</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_vary on|off ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_buffers 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 gzip 压缩缓冲区的大小和数量，建议使用默认值即可</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_buffers NUMBER SIZE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_disable 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 针对某些客户端浏览器，禁用动态压缩功能</span><br><span class="line">  - 读取 request header 中的 User-Agent 内容</span><br><span class="line">  - 可以用来排除一些低版本的不支持 gzip 的浏览器，比如 IE</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_disable REGEX ;</span><br><span class="line"></span><br><span class="line">* REGEX</span><br><span class="line">  - 可以写多个</span><br><span class="line">  - 例：gzip_disable &quot;MSIE [4-6]\.&quot; ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_http_version 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置开启压缩的最低 HTTP 版本</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_http_version 1.0|1.1 ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_min_length 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置针对响应数据的大小，选择性地开启和关闭 gzip 压缩</span><br><span class="line">  - 对较小的数据不进行压缩</span><br><span class="line">  - 根据 response header 中的 Content-Length 字段进行判断</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_min_length SIZE ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>gzip_proxied 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - nginx 作为反向代理时，是否对后端返回的结果进行压缩</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_proxied off|any|expired|no-cache|no-store|private|no_last_modified|no_etag|auth ;</span><br><span class="line"></span><br><span class="line">* 说明</span><br><span class="line">  - off               &lt;== 不压缩</span><br><span class="line">  - any               &lt;== 启用压缩</span><br><span class="line">  - expired           &lt;== 启用压缩，如果 header 头中包含 &quot;Expires&quot; 头信息</span><br><span class="line">  - no-cache          &lt;== 启用压缩，如果 header 头中包含 &quot;Cache-Control:no-cache&quot; 头信息</span><br><span class="line">  - no-store          &lt;== 启用压缩，如果 header 头中包含 &quot;Cache-Control:no-store&quot; 头信息</span><br><span class="line">  - private           &lt;== 启用压缩，如果 header 头中包含 &quot;Cache-Control:private&quot; 头信息</span><br><span class="line">  - no_last_modified  &lt;== 启用压缩，如果 header 头中不包含 &quot;Last-Modified&quot; 头信息</span><br><span class="line">  - no_etag           &lt;== 启用压缩，如果 header 头中不包含 &quot;ETag&quot; 头信息</span><br><span class="line">  - auth              &lt;== 启用压缩，如果 header 头中包含 &quot;Authorization&quot; 头信息</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：静态压缩与-ngx-http-gzip-static-module-模块"><a href="#知识点：静态压缩与-ngx-http-gzip-static-module-模块" class="headerlink" title="知识点：静态压缩与 ngx_http_gzip_static_module 模块"></a>知识点：静态压缩与 ngx_http_gzip_static_module 模块</h3><ol>
<li><strong>静态压缩</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 原文件同目录下提前手动存放同名的 .gz 结尾的预压缩文件</span><br><span class="line">  - 返回数据时，不再返回原文件，而是改为返回预压缩文件</span><br><span class="line"></span><br><span class="line">* ngx_http_gzip_static_module 模块</span><br><span class="line">  - 实现静态压缩功能的模块</span><br><span class="line">  - 非默认模块，需要 --with 添加</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>**gzip_static 指令<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置开启静态压缩功能</span><br><span class="line">  - gzip_static 会覆盖 gzip_types 指令</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  gzip_static on|off|always ;</span><br><span class="line"></span><br><span class="line">* on</span><br><span class="line">  - 发送 gz 压缩文件，仅当客户端浏览器支持 gzip 功能时</span><br><span class="line"></span><br><span class="line">* always</span><br><span class="line">  - 永远发送 gz 压缩文件，不管客户端浏览器是否支持 gzip 功能</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="4-3-nginx-浏览器缓存"><a href="#4-3-nginx-浏览器缓存" class="headerlink" title="4.3 nginx 浏览器缓存"></a>4.3 nginx 浏览器缓存</h2><hr>
<h3 id="知识点：浏览器缓存介绍"><a href="#知识点：浏览器缓存介绍" class="headerlink" title="知识点：浏览器缓存介绍"></a>知识点：浏览器缓存介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 特点</span><br><span class="line">  - 以 http 包为单位，在本地保存服务端的 response</span><br><span class="line">  - 包含 request header、response header、响应数据</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>response header 中和页面缓存相关的字段</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">* Expires</span><br><span class="line">  - 记录缓存过期的时刻，GMT 时间</span><br><span class="line"></span><br><span class="line">* Cache-Control</span><br><span class="line">  - 与缓存相关的一组信息</span><br><span class="line">  - 功能与 Expires 重叠</span><br><span class="line">    - Expires 是 http 1.0 的标准</span><br><span class="line">    - Cache-Control 是 http 1.1 引入的标准</span><br><span class="line">    - Expires 可能因为本地时间和服务端时间不一致导致功能缺失</span><br><span class="line">    - 浏览器会优先使用 Cache-Control，当 response 中没有 Cache-Control 时才会使用 Expires</span><br><span class="line">  - 取值</span><br><span class="line">    - 可以包含以下多个值，逗号间隔</span><br><span class="line">    - no-cache              &lt;== 缓存前必须确认其有效性，也就是强制弱缓存</span><br><span class="line">    - no-store              &lt;== 不缓存</span><br><span class="line">    - max-age=N             &lt;== 缓存过期秒数</span><br><span class="line">    - must-revalidate       &lt;== 可缓存，但必须再向源服务器进行确认</span><br><span class="line">    - no-transform          &lt;== 代理不可更改媒体类型</span><br><span class="line">    - public                &lt;== 可向任意方提供响应的缓存</span><br><span class="line">    - private               &lt;== 仅向特定用户返回响应</span><br><span class="line">    - proxy-revalidate      &lt;== 要求中间缓存服务器对缓存的响应有效性再进行确认</span><br><span class="line">    - s-maxage=N            &lt;== 公共缓存服务器响应的最大 Age 值</span><br><span class="line"></span><br><span class="line">* Last-Modified</span><br><span class="line">  - 请求的资源的最后修改时间</span><br><span class="line"></span><br><span class="line">* ETag</span><br><span class="line">  - 请求的资源的实体标签值，如文件的 MD5 值</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>强缓存和弱缓存</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 强缓存</span><br><span class="line">  - 缓存并未过期</span><br><span class="line">  - 直接返回缓存数据，不会发送 request 给 server</span><br><span class="line"></span><br><span class="line">* 弱缓存</span><br><span class="line">  - 缓存已过期，但未发生变化</span><br><span class="line">  - 手动刷新浏览器，则会强制跳过强缓存，强制执行弱缓存的判断过程</span><br><span class="line">  - 需要询问 server 缓存是否发生变动</span><br><span class="line">    - 会发送 request 给 server，包含缓存 http 包的 Last-Modified 和 ETag 值</span><br><span class="line">    - 如未变动，则 server 返回 304，Browser 返回缓存数据</span><br><span class="line">    - 如已变动，则 server 返回 200，并返回数据给 Browser</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>浏览器缓存的执行流程</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 判断是否有缓存</span><br><span class="line">  - 无缓存，则向 server 请求数据，得到返回的 http 包后会缓存，状态码 200</span><br><span class="line">    - 200 实际为缓存的 http 包中保存的状态码，并不是服务器重新发送的状态码</span><br><span class="line">  - 有缓存，则向下进行</span><br><span class="line"></span><br><span class="line">* 判断缓存是否过期</span><br><span class="line">  - 根据缓存 http 包的 Expires 或 Cache-Control 两字段进行判断</span><br><span class="line">  - 未过期，则读取缓存，强缓存，状态码 200</span><br><span class="line">  - 已过期，则向下进行</span><br><span class="line"></span><br><span class="line">* 判断缓存数据是否发生变化</span><br><span class="line">  - 客户端发送 request 给 server，包含缓存 http 包的 Last-Modified 和 Etag 两个字段的值</span><br><span class="line">    - Last-Modified，in-None-Match</span><br><span class="line">    - Etag，if-Modified-Since</span><br><span class="line">  - server 根据本地资源和用户 request 中的数据进行判断</span><br><span class="line">    - 未变化，则读取缓存，弱缓存，状态码 304</span><br><span class="line">    - 已变化，则返回数据给客户端，客户端得到 http 包后缓存，状态码 200</span><br><span class="line"></span><br><span class="line">* 手动刷新浏览器，都会使强缓存失效，强制判断缓存是否失效</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：nginx-配置浏览器缓存"><a href="#知识点：nginx-配置浏览器缓存" class="headerlink" title="知识点：nginx 配置浏览器缓存"></a>知识点：nginx 配置浏览器缓存</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 通过使用 ngx_http_headers_module 模块的指令，修改 header，继而影响浏览器缓存</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>expires 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - ngx_http_headers_module 模块的指令</span><br><span class="line">  - 设置缓存过期时间</span><br><span class="line">      * 会修改 response header 中 Expires 和 Cache-Control 两个字段的值</span><br><span class="line">      * 只有在 response code 为 200、201 (1.3.10)、204、206、301、302、303、304、307 (1.1.16, 1.0.13)、308 (1.13.0) 之一时，才生效</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  expires [modified] TIME ;</span><br><span class="line">  expires epoch|max|off ;</span><br><span class="line"></span><br><span class="line">* TIME</span><br><span class="line">  - 指定过期时间</span><br><span class="line">  - 正数 N</span><br><span class="line">    - 指定缓存在 N 秒后过期</span><br><span class="line">    - Expires: ServerCurrentTime+N秒，GMT 时间</span><br><span class="line">    - Cache-Control: max-age=N</span><br><span class="line">  - 0</span><br><span class="line">    - 指定缓存在 0 秒后过期，相当于强制弱缓存</span><br><span class="line">    - Expires: ServerCurrentTime，GMT 时间</span><br><span class="line">    - Cache-Control: max-age=0</span><br><span class="line">  - @XhXm</span><br><span class="line">    - 指定具体的时刻，超过此时刻缓存过期</span><br><span class="line">    - XhXm 表示时和分</span><br><span class="line">    - Expires 设置为指定的时刻，GMT 时间</span><br><span class="line">    - Cache-Control: max-age，根据当前时间与指定时间推算出秒数</span><br><span class="line">  - 负数 -N</span><br><span class="line">    - 相当于强制弱缓存</span><br><span class="line">    - Expires: CurrentTime-N秒，GMT 时间</span><br><span class="line">    - Cache-Control: no-cache</span><br><span class="line"></span><br><span class="line">* epoch</span><br><span class="line">  - 相当于强制弱缓存</span><br><span class="line">  - Expires: &#x27;1 January,1970,00:00:01 GMT&#x27;</span><br><span class="line">  - Cache-Control: no-cache</span><br><span class="line"></span><br><span class="line">* max</span><br><span class="line">  - 相当于缓存永远不过期</span><br><span class="line">  - Expires: &#x27;31 December2037 23:59:59 GMT&#x27;</span><br><span class="line">  - Cache-Control: max-age=315360000，即 3650 天</span><br><span class="line"></span><br><span class="line">* off</span><br><span class="line">  - 不缓存</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>add_header 指令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 向 response header 中添加指定的字段和值</span><br><span class="line">  - 通过手动添加与缓存相关的 field，来实现对缓存功能的控制</span><br><span class="line">  - 默认只有在 response code 为 200、201 (1.3.10)、204、206、301、302、303、304、307 (1.1.16, 1.0.13)、308 (1.13.0) 之一时，才生效</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - http 块</span><br><span class="line">  - server 块</span><br><span class="line">  - location 块</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  add_header NAME VALUE [always] ;</span><br><span class="line"></span><br><span class="line">* NAME</span><br><span class="line">  - 指定字段名</span><br><span class="line"></span><br><span class="line">* VALUE</span><br><span class="line">  - 指定字段值</span><br><span class="line">* always</span><br><span class="line">  - 永远添加，不管 response code 是多少</span><br><span class="line"></span><br><span class="line">* 缓存配置范例</span><br><span class="line">  add_header Cache-Control max-age=315360000 ;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2000/01/01/Blog32-k8s/" rel="prev" title="Blog32-k8s">
                  <i class="fa fa-chevron-left"></i> Blog32-k8s
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2000/01/01/Blog42-redis/" rel="next" title="Blog42-redis">
                  Blog42-redis <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2000 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"per_page":true,"tags":"none","cdn":"//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
