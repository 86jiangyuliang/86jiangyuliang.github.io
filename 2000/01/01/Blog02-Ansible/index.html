<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","width":500,"display":"always","padding":1,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Ansible">
<meta property="og:type" content="article">
<meta property="og:title" content="Blog02-Ansible">
<meta property="og:url" content="http://example.com/2000/01/01/Blog02-Ansible/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Ansible">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="1999-12-31T16:00:02.000Z">
<meta property="article:modified_time" content="2024-05-29T02:24:14.652Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2000/01/01/Blog02-Ansible/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2000/01/01/Blog02-Ansible/","path":"2000/01/01/Blog02-Ansible/","title":"Blog02-Ansible"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Blog02-Ansible | Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Blog02-Ansible"><span class="nav-text">Blog02-Ansible</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%AE%E5%8A%A9"><span class="nav-text">帮助</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AA%E6%95%B4%E7%90%86"><span class="nav-text">未整理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E6%95%B4%E7%90%86"><span class="nav-text">不整理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter01-Ansible-%E5%9F%BA%E7%A1%80"><span class="nav-text">Chapter01 Ansible 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-ansible-%E4%BB%8B%E7%BB%8D"><span class="nav-text">1.1 ansible 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：ansible 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-%E5%AE%89%E8%A3%85"><span class="nav-text">知识点：ansible 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-Jinja2"><span class="nav-text">知识点：ansible Jinja2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-python"><span class="nav-text">知识点：ansible python</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-ansible-%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="nav-text">1.2 ansible 命令行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ansible 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-doc-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ansible-doc 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-playbook-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ansible-playbook 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9"><span class="nav-text">知识点：ansible 命令行选项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-ansible-%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95"><span class="nav-text">1.3 ansible 主机清单</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95"><span class="nav-text">知识点：主机清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E4%B8%BB%E6%9C%BA%E5%8C%B9%E9%85%8D%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-text">知识点：主机匹配字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95%E5%8F%98%E9%87%8F"><span class="nav-text">知识点：主机清单变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95%E5%8F%98%E9%87%8F%E6%96%87%E4%BB%B6"><span class="nav-text">知识点：主机清单变量文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-ansible-%E9%85%8D%E7%BD%AE"><span class="nav-text">1.4 ansible 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-%E9%85%8D%E7%BD%AE"><span class="nav-text">知识点：ansible 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="nav-text">知识点：ansible 配置项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-config-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：ansible-config 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-ansible-Puilgin"><span class="nav-text">1.5 ansible Puilgin</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-Puilgin-%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：ansible Puilgin 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-Module-%E6%A8%A1%E5%9D%97"><span class="nav-text">知识点：ansible Module 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-Filter-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-text">知识点：ansible Filter 过滤器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-Test-%E6%9D%A1%E4%BB%B6%E6%B5%8B%E8%AF%95"><span class="nav-text">知识点：ansible Test 条件测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-Lookup-%E6%9F%A5%E6%89%BE"><span class="nav-text">知识点：ansible Lookup 查找</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter02-Playbook"><span class="nav-text">Chapter02 Playbook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-playbook-%E4%BB%8B%E7%BB%8D"><span class="nav-text">2.1 playbook 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aplaybook-%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：playbook 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aplaybook-%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：playbook 范例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-playbook-%E5%8F%98%E9%87%8F"><span class="nav-text">2.2 playbook 变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E5%8F%98%E9%87%8F"><span class="nav-text">知识点：变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aregister-%E5%8F%98%E9%87%8F"><span class="nav-text">知识点：register 变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Afact-%E5%8F%98%E9%87%8F"><span class="nav-text">知识点：fact 变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AMagic-%E5%8F%98%E9%87%8F"><span class="nav-text">知识点：Magic 变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-playbook-%E8%A6%81%E7%B4%A0"><span class="nav-text">2.3 playbook 要素</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">知识点：关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E6%9D%A1%E4%BB%B6-when"><span class="nav-text">知识点：条件 when</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%BF%AD%E4%BB%A3-loop"><span class="nav-text">知识点：迭代 loop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%BF%AD%E4%BB%A3%E9%AB%98%E7%BA%A7"><span class="nav-text">知识点：迭代高级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%A7%A6%E5%8F%91%E5%99%A8-handler"><span class="nav-text">知识点：触发器 handler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-playbook-%E6%89%A7%E8%A1%8C"><span class="nav-text">2.4 playbook 执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aplaybook-%E6%89%A7%E8%A1%8C"><span class="nav-text">知识点：playbook 执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aplaybook-%E6%A0%87%E7%AD%BE-tag"><span class="nav-text">知识点：playbook 标签 tag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aplaybook-%E6%89%A7%E8%A1%8C%E6%8E%A7%E5%88%B6"><span class="nav-text">知识点：playbook 执行控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aplaybook-%E5%A4%B1%E8%B4%A5%E6%8E%A7%E5%88%B6"><span class="nav-text">知识点：playbook 失败控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aplaybook-%E8%BF%9E%E6%8E%A5%E6%8E%A7%E5%88%B6"><span class="nav-text">知识点：playbook 连接控制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E8%A7%92%E8%89%B2"><span class="nav-text">2.5 角色</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E5%AF%BC%E5%85%A5"><span class="nav-text">知识点：导入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%A7%92%E8%89%B2-role"><span class="nav-text">知识点：角色 role</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aimport-playbook"><span class="nav-text">知识点：import_playbook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aimport-tasks-%E5%92%8C-include-tasks"><span class="nav-text">知识点：import_tasks 和 include_tasks</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter03-Ansible-%E6%A8%A1%E5%9D%97"><span class="nav-text">Chapter03 Ansible 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97"><span class="nav-text">3.1 基础模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-ping"><span class="nav-text">知识点：ansible.builtin.ping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-pause"><span class="nav-text">知识点：ansible.builtin.pause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-debug"><span class="nav-text">知识点：ansible.builtin.debug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-setup"><span class="nav-text">知识点：ansible.builtin.setup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-template"><span class="nav-text">知识点：ansible.builtin.template</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-set-fact"><span class="nav-text">知识点：ansible.builtin.set_fact</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%9D%97"><span class="nav-text">3.2 命令模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-command"><span class="nav-text">知识点：ansible.builtin.command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-shell"><span class="nav-text">知识点：ansible.builtin.shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-script"><span class="nav-text">知识点：ansible.builtin.script</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86"><span class="nav-text">3.3 文件管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-file"><span class="nav-text">知识点：ansible.builtin.file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-copy"><span class="nav-text">知识点：ansible.builtin.copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-fetch"><span class="nav-text">知识点：ansible.builtin.fetch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-unarchive"><span class="nav-text">知识点：ansible.builtin.unarchive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Acommunity-general-archive"><span class="nav-text">知识点：community.general.archive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-find"><span class="nav-text">知识点：ansible.builtin.find</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91"><span class="nav-text">3.4 文件编辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-lineinfile"><span class="nav-text">知识点：ansible.builtin.lineinfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-replace"><span class="nav-text">知识点：ansible.builtin.replace</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E7%BD%91%E7%BB%9C%E5%B7%A5%E5%85%B7"><span class="nav-text">3.5 网络工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-get-url"><span class="nav-text">知识点：ansible.builtin.get_url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-uri"><span class="nav-text">知识点：ansible.builtin.uri</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86"><span class="nav-text">3.6 系统管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-service"><span class="nav-text">知识点：ansible.builtin.service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-cron"><span class="nav-text">知识点：ansible.builtin.cron</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-hostname"><span class="nav-text">知识点：ansible.builtin.hostname</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-yum"><span class="nav-text">知识点：ansible.builtin.yum</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-yum-repository"><span class="nav-text">知识点：ansible.builtin.yum_repository</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-posix-selinux"><span class="nav-text">知识点：ansible.posix.selinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-posix-sysctl"><span class="nav-text">知识点：ansible.posix.sysctl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Acommunity-general-modprobe"><span class="nav-text">知识点：community.general.modprobe</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="nav-text">3.7 用户管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-user"><span class="nav-text">知识点：ansible.builtin.user</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-builtin-group"><span class="nav-text">知识点：ansible.builtin.group</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-posix-authorized-key"><span class="nav-text">知识点：ansible.posix.authorized_key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Acommunity-general-sudoers"><span class="nav-text">知识点：community.general.sudoers</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-%E7%A1%AC%E7%9B%98%E7%AE%A1%E7%90%86"><span class="nav-text">3.8 硬盘管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Acommunity-general-parted"><span class="nav-text">知识点：community.general.parted</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Acommunity-general-filesystem"><span class="nav-text">知识点：community.general.filesystem</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aansible-posix-mount"><span class="nav-text">知识点：ansible.posix.mount</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter04-Ansible-Filters"><span class="nav-text">Chapter04 Ansible Filters</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter05-Ansible-Tests"><span class="nav-text">Chapter05 Ansible Tests</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter06-Ansible-Lookup"><span class="nav-text">Chapter06 Ansible Lookup</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2000/01/01/Blog02-Ansible/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Blog02-Ansible | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Blog02-Ansible
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2000-01-01 00:00:02" itemprop="dateCreated datePublished" datetime="2000-01-01T00:00:02+08:00">2000-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-05-29 10:24:14" itemprop="dateModified" datetime="2024-05-29T10:24:14+08:00">2024-05-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <hr>
<h1 id="Blog02-Ansible"><a href="#Blog02-Ansible" class="headerlink" title="Blog02-Ansible"></a>Blog02-Ansible</h1><p><a href="#Chapter01-Ansible-%E5%9F%BA%E7%A1%80"><strong>Chapter01 Ansible 基础</strong></a></p>
<ul>
<li><a href="#1-1-ansible-%E4%BB%8B%E7%BB%8D">1.1 ansible 介绍</a></li>
<li><a href="#1-2-ansible-%E5%91%BD%E4%BB%A4%E8%A1%8C">1.2 ansible 命令行</a></li>
<li><a href="#1-3-ansible-%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95">1.3 ansible 主机清单</a></li>
<li><a href="#1-4-ansible-%E9%85%8D%E7%BD%AE">1.4 ansible 配置</a></li>
<li><a href="#1-5-ansible-Puilgin">1.5 ansible Puilgin</a></li>
</ul>
<p><a href="#Chapter02-Playbook"><strong>Chapter02 Playbook</strong></a></p>
<ul>
<li><a href="#2-1-playbook-%E4%BB%8B%E7%BB%8D">2.1 playbook 介绍</a></li>
<li><a href="#2-2-playbook-%E5%8F%98%E9%87%8F">2.2 playbook 变量</a></li>
<li><a href="#2-3-playbook-%E8%A6%81%E7%B4%A0">2.3 playbook 要素</a></li>
<li><a href="#2-4-playbook-%E6%89%A7%E8%A1%8C">2.4 playbook 执行</a></li>
<li><a href="#2-5-%E8%A7%92%E8%89%B2">2.5 角色</a></li>
</ul>
<p><a href="#Chapter03-Ansible-Modules"><strong>Chapter03 Ansible Modules</strong></a></p>
<ul>
<li><a href="#3-1-%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97">3.1 基础模块</a></li>
<li><a href="#3-2-%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%9D%97">3.2 命令模块</a></li>
<li><a href="#3-3-%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86">3.3 文件管理</a></li>
<li><a href="#3-4-%E6%96%87%E4%BB%B6%E7%BC%96%E8%BE%91">3.4 文件编辑</a></li>
<li><a href="#3-5-%E7%BD%91%E7%BB%9C%E5%B7%A5%E5%85%B7">3.5 网络工具</a></li>
<li><a href="#3-6-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86">3.6 系统管理</a></li>
<li><a href="#3-7-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86">3.7 用户管理</a></li>
<li><a href="#3-8-%E7%A1%AC%E7%9B%98%E7%AE%A1%E7%90%86">3.8 硬盘管理</a></li>
</ul>
<p><a href="#Chapter04-Ansible-Filters"><strong>Chapter04 Ansible Filters</strong></a></p>
<p><a href="#Chapter05-Ansible-Tests"><strong>Chapter05 Ansible Tests</strong></a></p>
<p><a href="#Chapter06-Ansible-Lookup"><strong>Chapter06 Ansible Lookup</strong></a></p>
<hr>
<h2 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h2><ol>
<li><strong>官方文档</strong></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/index.html">https://docs.ansible.com/ansible/latest/index.html</a></li>
</ul>
<ol start="2">
<li><strong>使用手册</strong></li>
</ol>
<ul>
<li>Inventory <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/inventory_guide/index.html">https://docs.ansible.com/ansible/latest/inventory_guide/index.html</a></li>
<li>CommandLine <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/command_guide/index.html">https://docs.ansible.com/ansible/latest/command_guide/index.html</a></li>
<li>Playbook <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/playbook_guide/index.html">https://docs.ansible.com/ansible/latest/playbook_guide/index.html</a><ul>
<li>Work With Playbook <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html</a></li>
<li>Executing Playbook <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_execution.html">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_execution.html</a></li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>插件索引</strong></li>
</ol>
<ul>
<li>Modules<ul>
<li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index_module.html">https://docs.ansible.com/ansible/latest/collections/index_module.html</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html">https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html</a></li>
</ul>
</li>
<li>Filter  <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index_filter.html">https://docs.ansible.com/ansible/latest/collections/index_filter.html</a></li>
<li>Test    <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index_test.html">https://docs.ansible.com/ansible/latest/collections/index_test.html</a></li>
<li>Lookup  <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index_lookup.html">https://docs.ansible.com/ansible/latest/collections/index_lookup.html</a></li>
<li>Collection <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index.html">https://docs.ansible.com/ansible/latest/collections/index.html</a></li>
</ul>
<hr>
<h2 id="未整理"><a href="#未整理" class="headerlink" title="未整理"></a>未整理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">* 模块</span><br><span class="line">  - ansible.builtin.uri</span><br><span class="line">  - ansible.builtin.wait_for</span><br><span class="line">  - ansible.builtin.atp</span><br><span class="line">  - ansible.builtin.atp_repo</span><br><span class="line">  - ansible.builtin.yum_repository</span><br><span class="line">  - community.general.parted</span><br><span class="line">  - community.general.filesystem</span><br><span class="line">  - community.general.timezone</span><br><span class="line">  - community.general.pam_limits</span><br><span class="line"></span><br><span class="line">* community.docker</span><br><span class="line">  https://docs.ansible.com/ansible/latest/collections/community/docker/docsite/scenario_guide.html</span><br><span class="line"></span><br><span class="line">* 编译</span><br><span class="line">  - community.general.make</span><br><span class="line"></span><br><span class="line">* ansible 加密</span><br><span class="line"></span><br><span class="line">* loopup 和 query 的格式</span><br><span class="line"></span><br><span class="line">* handler</span><br><span class="line">  - meta https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html#id4</span><br><span class="line"></span><br><span class="line">* Re-use</span><br><span class="line">  - https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse.html</span><br><span class="line">  - include https://docs.ansible.com/ansible/2.9/modules/include_module.html#include-module</span><br><span class="line">  - include_role</span><br><span class="line">  - import_role</span><br><span class="line">  - include_vars https://docs.ansible.com/ansible/2.9/modules/include_vars_module.html#include-vars-module</span><br><span class="line"></span><br><span class="line">* loop</span><br><span class="line">  - var in re-use https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html#defining-inner-and-outer-variable-names-with-loop-var</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="不整理"><a href="#不整理" class="headerlink" title="不整理"></a>不整理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 模块</span><br><span class="line">  - ansible.builtin.raw</span><br><span class="line"></span><br><span class="line">* block</span><br><span class="line">  - https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_blocks.html</span><br><span class="line"></span><br><span class="line">* fact</span><br><span class="line">  - cache fact https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_vars_facts.html#id5</span><br><span class="line">  - Adding custom facts https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_vars_facts.html#adding-custom-facts</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Chapter01-Ansible-基础"><a href="#Chapter01-Ansible-基础" class="headerlink" title="Chapter01 Ansible 基础"></a>Chapter01 Ansible 基础</h1><hr>
<h2 id="1-1-ansible-介绍"><a href="#1-1-ansible-介绍" class="headerlink" title="1.1 ansible 介绍"></a>1.1 ansible 介绍</h2><hr>
<h3 id="知识点：ansible-介绍"><a href="#知识点：ansible-介绍" class="headerlink" title="知识点：ansible 介绍"></a>知识点：ansible 介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - ansible，是一款基于 ssh 的并发管理工具，主要用于实现配置管理 CM Configuration Management</span><br><span class="line">  - ansible 使用 python 开发，内置 Jinja2 支持</span><br><span class="line">  - 分为免费版和收费版，免费版的功能就已经足够强大</span><br><span class="line"></span><br><span class="line">* 历史</span><br><span class="line">  - 2012，Michael DeHaan 开发</span><br><span class="line">  - 2015，被 RedHat 收购</span><br><span class="line">  - 从 2.5 版本开始，支持使用 python3</span><br><span class="line"></span><br><span class="line">* 版本</span><br><span class="line">  - 2.10.7 以前不做区分</span><br><span class="line">  - 2.10.7 以后，ansible 被分为两个产品，ansible-core 和 ansible community package</span><br><span class="line">  - ansible-core 专注于 ansible 的核心功能，版本号依然沿用 2.X.X 的形式</span><br><span class="line">  - ansible community package 是在 ansible-core 的基础上，额外添加一些生产上常用的功能，如 collection 等，版本号采用 3.X、4.X 的形式</span><br><span class="line">  - ansible community package 与 ansible-core 的版本一一对应，比如 3.X 对应 ansible-core 的 2.10、6.X 对应 ansible-core 的 2.13</span><br><span class="line">  - centos7 yum 安装最多只能到 2.9.27</span><br><span class="line"></span><br><span class="line">* 调用方式</span><br><span class="line">  - ad-hoc</span><br><span class="line">  - playbook，ansible 的核心</span><br><span class="line">  - 其他 API，如公有云/私有云工具、第三方 Web 工具</span><br><span class="line"></span><br><span class="line">* 执行过程，可以通过 -vvv 来查看</span><br><span class="line">  - 加载主配置文件</span><br><span class="line">  - 加载模块的 py 文件</span><br><span class="line">  - 在 master 上的 local_tmp 中生成临时 py 脚本</span><br><span class="line">  - 将临时 py 脚本和涉及到的其他文件一起复制到远程主机的 remote_tmp 目录下</span><br><span class="line">  - 在远程主机上执行 py 脚本</span><br><span class="line">  - 在远程主机上执行结束，删除 py 脚本</span><br><span class="line">  - 返回信息给 master</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>ansible 特性</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 插件化</span><br><span class="line">  - 除最基础的功能 ansible-core 外，其他功能均通过插件来实现</span><br><span class="line">  - 通过安装额外的插件，可以拓展功能</span><br><span class="line">  - 通过编写/修改插件可以自定义添加功能</span><br><span class="line"></span><br><span class="line">* 重要的依赖库</span><br><span class="line">  - paramiko 库，python 对 ssh 的实现，在一个 ssh 连接下执行多个命令</span><br><span class="line">  - pyYAML 库，python 对 yaml 的支持</span><br><span class="line">  - Jinja2 库，模版语言 template</span><br><span class="line">  - openssh，保障 ssh 安全</span><br><span class="line"></span><br><span class="line">* 幂等性 idempotent</span><br><span class="line">  - 执行一次与执行多次具有相同的结果</span><br><span class="line">  - 多次执行时，如果发现已经达到 desired final state，则不会执行</span><br><span class="line">  - 例如安装软件如果发现已经安装则不会进行重复安装</span><br><span class="line">  - 注意，不是所有的模块都支持幂等性</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>ansible 体系</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">* ansible Command-line</span><br><span class="line">  - ansible</span><br><span class="line">  - ansible-playbook</span><br><span class="line">  - ansible-doc</span><br><span class="line">  - ansible-config</span><br><span class="line">  - 其他</span><br><span class="line">    - ansible-vault       对 playbook 文件进行加密解密</span><br><span class="line">    - ansible-galaxy      查看 roles，从 galaxy.ansible.com 下载 roles</span><br><span class="line">    - ansible-console     交互式 ansible</span><br><span class="line">    - ansible-pull        推送式 ansible，要求较高</span><br><span class="line"></span><br><span class="line">* ansible Plugin</span><br><span class="line">  - Module</span><br><span class="line">  - Filter</span><br><span class="line">  - Test</span><br><span class="line">  - Lookup</span><br><span class="line"></span><br><span class="line">* ansible 主机</span><br><span class="line">  - master</span><br><span class="line">    - 安装 ansible 程序的主机，也称为 controller</span><br><span class="line">    - master 的 python 版本应大于 2.6</span><br><span class="line">  - remote</span><br><span class="line">    - 远程主机，被控机，也称为 node、managed machine</span><br><span class="line">    - 如果 python 版本小于 2.4，则需要安装 python-simplejson</span><br><span class="line">    - 被控机如果开启了 selinux，则需要安装 libselinux-python</span><br><span class="line">    - windows 可以作为 slave，不可以作为 master</span><br><span class="line"></span><br><span class="line">* ansible 相关文件</span><br><span class="line">  - /etc/ansible/ansible.cfg    默认主配置文件</span><br><span class="line">  - /etc/ansible/hosts          默认主机清单文件 inventory</span><br><span class="line">  - ~/.ansible*                 个人 ansible 目录</span><br><span class="line">  - ~/.ansible.cfg              个人 ansible 配置文件</span><br><span class="line">  - PYTHON_HOME/dist-packages/ansible*    ansible 的安装位置</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>相关环境变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* export ANSIBLE_HOST_KEY_CHECKING=False</span><br><span class="line">  - 不针对远程主机进行 host key 检查</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-安装"><a href="#知识点：ansible-安装" class="headerlink" title="知识点：ansible 安装"></a>知识点：ansible 安装</h3><ol>
<li><strong>yum epel 安装</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum install ansible</span><br><span class="line">yum install ansible-python3</span><br><span class="line"></span><br><span class="line">yum install ansible --downloadonly --downloaddir=/root/ansible-rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>centos7 编译安装</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> centos7</span></span><br><span class="line">yum install python-jinja2 PyYAML python-paramiko python-babel python-crypto sshpass</span><br><span class="line"><span class="meta">#</span><span class="bash"> centos8、ctyunos</span></span><br><span class="line">yum install python3-jinja2 python3-pyyaml python3-paramiko python3-babel python3-crypto python3-cryptography sshpass</span><br><span class="line"></span><br><span class="line">wget https://releases.ansible.com/ansible/ansible-2.9.27.tar.gz</span><br><span class="line">tar xf ansible-2.9.27.tar.gz</span><br><span class="line"></span><br><span class="line">cd ansible-2.9.27</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br><span class="line"></span><br><span class="line">mkdir /etc/ansible</span><br><span class="line">cp -r examples/* /etc/ansible</span><br><span class="line"></span><br><span class="line">cd</span><br><span class="line">mkdir -p /root/.ansible/collections/ansible_collections/ansible/posix</span><br><span class="line">mkdir -p /root/.ansible/collections/ansible_collections/community/general</span><br><span class="line">mkdir -p /root/.ansible/collections/ansible_collections/community/mysql</span><br><span class="line">tar --warning=no-timestamp -xf ansible-posix-1.5.4.tar.gz -C /root/.ansible/collections/ansible_collections/ansible/posix/</span><br><span class="line">tar --warning=no-timestamp -xf community-general-4.8.11.tar.gz -C /root/.ansible/collections/ansible_collections/community/general/</span><br><span class="line">tar --warning=no-timestamp -xf community-mysql-3.8.0.tar.gz -C /root/.ansible/collections/ansible_collections/community/mysql/</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>git 安装</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone --recursive git://github.com/ansible/ansible.git</span><br><span class="line">cd ./ansible</span><br><span class="line">source ./hacking/env-setup</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>pip 安装</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip python-devel</span><br><span class="line">yum install gcc glibc-devel zlib-devel rpm-build openssl-devel</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install --upgrade ansible</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-Jinja2"><a href="#知识点：ansible-Jinja2" class="headerlink" title="知识点：ansible Jinja2"></a>知识点：ansible Jinja2</h3><ol>
<li><strong>Jinja2 语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* playbook</span><br><span class="line">  - ansible 支持直接在 playbook 中使用 Jinja2 语法</span><br><span class="line">  - 最终执行的 playbook 是经过了 Jinja2 填充后生成的 playbook</span><br><span class="line">  - playbook 中支持 Jinja2 的 &#123;&#123; &#125;&#125; 格式，不支持 Jinjia2 中的 &#123;% %&#125; 和 &#123;# #&#125; 格式</span><br><span class="line"></span><br><span class="line">* template 模块</span><br><span class="line">  - template 模块通过 Jinja2 template 模板文件，来生成最终文件</span><br><span class="line">  - template 模板文件中可以使用所有的 Jinja2 格式</span><br><span class="line"></span><br><span class="line">* 填充</span><br><span class="line">  - 所有的对 Jinja2 的填充都发生在 master 上，不论是 playbook 还是 template 模块，包括 filter、test 等</span><br><span class="line">  - 先进行填充，在填充完成后才将 task 发送到 remote 上执行</span><br><span class="line">  - 因此 Jinja2 只要在 master 上有安装即可</span><br><span class="line"></span><br><span class="line">* 函数</span><br><span class="line">  - ansible 中可以使用所有的 Jinja2 内置 filter、test 函数</span><br><span class="line">  - ansible 自己也额外提供了一些 filter 函数</span><br><span class="line">  - ansible 提供的 lookup 插件，也是以 Jinja2 普通函数的方式来运行</span><br><span class="line"></span><br><span class="line">* python method</span><br><span class="line">  - 由于 Jinja2 的支持，可以对相应的数据类型调用其对应的 python method</span><br><span class="line">  - 构造器作为 filter 来调用</span><br><span class="line">  - 普通方法则直接调用</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/test.&#123;&#123;</span> <span class="string">now(true,</span> <span class="string">&#x27;%H%M%S&#x27;</span><span class="string">)</span> <span class="string">&#125;&#125;.tmp</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">    <span class="attr">force:</span> <span class="literal">yes</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-python"><a href="#知识点：ansible-python" class="headerlink" title="知识点：ansible python"></a>知识点：ansible python</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 方法</span><br><span class="line">  - 由于 Jinja2 的支持，在 playbook 中，Str 型、List 型 Dict 型等 python 基础类型的对象可以直接使用其 python 中的方法</span><br><span class="line">  - 支持各种常规方法，如 Dict.keys()</span><br><span class="line">  - 支持各种魔法方法，如 List.__len__()</span><br><span class="line">  - 支持各种魔法操作，如 List * 3</span><br><span class="line">  - 对于原地操作，暂未搞清楚，先不要用</span><br><span class="line"></span><br><span class="line">* 正则</span><br><span class="line">  - playbook 中的正则使用 python re 模块的正则语法，如命名的捕捉群等</span><br><span class="line">  - 对于需要使用 &#x27;\&#x27; 的地方，需要采用 &#x27;\\&#x27; 的方式，无法使用 raw string</span><br><span class="line"></span><br><span class="line">* 时间参数</span><br><span class="line">  - 使用 python datetime 模块的 strftime 语法</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="1-2-ansible-命令行"><a href="#1-2-ansible-命令行" class="headerlink" title="1.2 ansible 命令行"></a>1.2 ansible 命令行</h2><hr>
<h3 id="知识点：ansible-指令"><a href="#知识点：ansible-指令" class="headerlink" title="知识点：ansible 指令"></a>知识点：ansible 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - ad-hoc 方式调用 ansible</span><br><span class="line"></span><br><span class="line">* 返回信息</span><br><span class="line">  - 绿色，执行成功，无修改</span><br><span class="line">  - 黄色，执行成功，有修改，或者需要进行修改</span><br><span class="line">  - 红色，出错</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  ansible -m ModuleName -a ModuleArgs [OPTIONS] HostPattern</span><br><span class="line"></span><br><span class="line">* -m ModuleName, --module-name ModuleName</span><br><span class="line">  - 指定模块名</span><br><span class="line"></span><br><span class="line">* -a ModuleArgs, --args ModuleArgs</span><br><span class="line">  - 指定模块参数</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-doc-指令"><a href="#知识点：ansible-doc-指令" class="headerlink" title="知识点：ansible-doc 指令"></a>知识点：ansible-doc 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 作用</span><br><span class="line">  - ansible 的帮助程序，查看 plugin 的帮助</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  ansible-doc [OPTIONS] Plugin</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>选项</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* -l, --list</span><br><span class="line">  - 列出当前所有的 ansible Plugin</span><br><span class="line"></span><br><span class="line">* -t Type, --type Type</span><br><span class="line">  - 指定 Plugin 的类型，如 module、lookup 等</span><br><span class="line"></span><br><span class="line">* -s, --snippet</span><br><span class="line">  - 仅显示简略帮助</span><br><span class="line"></span><br><span class="line">* 其他选项</span><br><span class="line">  -h, --help</span><br><span class="line">  -v, --verbose</span><br><span class="line">  --version</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-playbook-指令"><a href="#知识点：ansible-playbook-指令" class="headerlink" title="知识点：ansible-playbook 指令"></a>知识点：ansible-playbook 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 运行 ansible playbook</span><br><span class="line">  - 不需要在命令行上指定目标主机，因为已经在 playbook 文件指定了 hosts 参数</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  ansible-playbook Playbook.yml [OPTIONS]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-命令行选项"><a href="#知识点：ansible-命令行选项" class="headerlink" title="知识点：ansible 命令行选项"></a>知识点：ansible 命令行选项</h3><ol>
<li><strong>基础选项</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* -v, ---verbose</span><br><span class="line"></span><br><span class="line">* --help</span><br><span class="line"></span><br><span class="line">* --version</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>运行选项</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">* -t Tags, --tags Tags</span><br><span class="line">  - 仅执行某个或某些标签的 play、task</span><br><span class="line"></span><br><span class="line">* --skip-tags TAGS</span><br><span class="line">  - 不执行某个或某些标签的 play、task</span><br><span class="line"></span><br><span class="line">* -C, --check</span><br><span class="line">  - 以 check mode 运行</span><br><span class="line"></span><br><span class="line">* -D, --diff</span><br><span class="line">  - 以 diff mode 运行</span><br><span class="line"></span><br><span class="line">* -f Forks, --forks Forks</span><br><span class="line">  - 指定并发数</span><br><span class="line"></span><br><span class="line">* -e Extre_Vars, --extra-vars Extre_Vars</span><br><span class="line">  - 额外指定变量或变量文件，优先级最高</span><br><span class="line">  - EXTRA_VARS 格式</span><br><span class="line">    - var=value[,...]</span><br><span class="line">    - &#x27;json-string&#x27;</span><br><span class="line">    - @file.json</span><br><span class="line">    - @file.yaml</span><br><span class="line"></span><br><span class="line">* --list-hosts</span><br><span class="line">  - 不执行 playbook，仅列出目标主机</span><br><span class="line"></span><br><span class="line">* --list-tags</span><br><span class="line">  - 不执行 playbook，仅列出标签</span><br><span class="line"></span><br><span class="line">* --list-tasks</span><br><span class="line">  - 不执行 playbook，仅列出 tasks</span><br><span class="line"></span><br><span class="line">* --syntax-check</span><br><span class="line">  - 不执行 playbook，仅对 playbook 进行语法检查</span><br><span class="line">  - 对于 template 模块</span><br><span class="line">    - 不会对 template 文件进行语法检查</span><br><span class="line">    - 如果想要检查 template 文件的语法，可以在 127.0.0.1 上以 -C 方式运行 playbook</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>主机选项</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* -l SubSet, --limit SubSet</span><br><span class="line">  - 对目标主机进行进一步的筛选，只针对符合 HostPattern 和 SubSet 的主机执行操作</span><br><span class="line">  - 范例</span><br><span class="line">    --limit &quot;host1&quot;           只在 host1 上执行操作</span><br><span class="line">    --limit &quot;host1, host2&quot;    只在 host1 和 host2 上执行操作</span><br><span class="line">  - --limit @filename         表示 SUBSET 是一个 Inventory 文件</span><br><span class="line"></span><br><span class="line">* -i INVENTORY, --inventory INVENTORY, --inventory-file INVENTORY</span><br><span class="line">  - 指定使用的 INVENTORY 文件目录</span><br><span class="line">  - 多个文件采用 comma 间隔</span><br></pre></td></tr></table></figure></li>
<li><strong>连接选项</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* -u Remote_User, --user Remote_User</span><br><span class="line">  - 指定登录到远程主机使用的用户</span><br><span class="line"></span><br><span class="line">* -k, --ask-pass</span><br><span class="line">  - 指定登录到目标主机时需要输入密码</span><br><span class="line"></span><br><span class="line">* --private-key Private_Key_File, --key-file Private_Key_File</span><br><span class="line">  - 指定使用的私钥文件</span><br><span class="line"></span><br><span class="line">* -T Timeout, --timeout Timeout</span><br><span class="line">  - 指定连接超时时间</span><br><span class="line"></span><br><span class="line">* -b, --become</span><br><span class="line">  - 以权限升级的方式运行，即 su、sudo 方式</span><br><span class="line"></span><br><span class="line">* --become-user Remote_User</span><br><span class="line">  - 指定权限升级的目标用户</span><br><span class="line"></span><br><span class="line">* -K, --ask-become-pass</span><br><span class="line">  - 指定权限升级时需要输入密码</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="1-3-ansible-主机清单"><a href="#1-3-ansible-主机清单" class="headerlink" title="1.3 ansible 主机清单"></a>1.3 ansible 主机清单</h2><hr>
<h3 id="知识点：主机清单"><a href="#知识点：主机清单" class="headerlink" title="知识点：主机清单"></a>知识点：主机清单</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 主机清单文件 INVENTORY</span><br><span class="line">  - 用来记录所有要管理的目标主机</span><br><span class="line">  - ansible 只会去管理记录在 INVENTORY 中的主机</span><br><span class="line">  - 默认为 /etc/ansible/hosts</span><br><span class="line">  - 支持 ini 格式或 yaml 格式，其中 yml 格式是从 &#x27;all:&#x27; 标签开始</span><br><span class="line"></span><br><span class="line">* INVENTORY 目录</span><br><span class="line">  - 当主机过多时，可以将多个 INVENTORY 文件放到一个专用的目录中，作为 INVENTORY 目录</span><br><span class="line">  - 在使用时，使用 &#x27;-i&#x27; 选项手动指定 INVENTORY 目录</span><br><span class="line">  - INVENTORY 目录中的文件最好以序号命名，使 ansible 在加载时可以按序加载</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>主机</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 可以是 ip、hostname、fqdn</span><br><span class="line">  - 一个主机可以属于多个主机组</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init 格式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># host 单条</span></span><br><span class="line">192.168.1.1</span><br><span class="line">hostname</span><br><span class="line">www01.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># hosts 范围</span></span><br><span class="line">www<span class="section">[01:50]</span>.example.com</span><br><span class="line">www<span class="section">[01:50:2]</span>.example.com</span><br><span class="line">db-<span class="section">[a:f]</span>.example.com</span><br><span class="line">192.168.1.<span class="section">[1:100]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 额外指定 ssh 端口号</span></span><br><span class="line">192.168.1.1:8080</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yaml 格式</span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="comment"># host 单条</span></span><br><span class="line">    <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">    <span class="string">hostname</span></span><br><span class="line">    <span class="string">www01.example.com</span></span><br><span class="line">    <span class="comment"># host 范围</span></span><br><span class="line">    <span class="string">www[01:50].example.com</span></span><br><span class="line">    <span class="string">www[01:50:2].example.com</span></span><br><span class="line">    <span class="string">db-[a:f].example.com</span></span><br><span class="line">    <span class="number">192.168</span><span class="number">.1</span><span class="string">.[1:100]</span></span><br><span class="line">    <span class="comment"># 额外指定 ssh 端口号</span></span><br><span class="line">    <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span><span class="string">:8080</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>主机组 Group</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 默认组 Default groups</span><br><span class="line">  - all</span><br><span class="line">  - ungrouped</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ini 格式</span></span><br><span class="line"><span class="section">[GroupName]</span></span><br><span class="line">host1</span><br><span class="line">host2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yaml 格式</span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">hosts:</span>      <span class="comment"># ungrouped 组中的主机</span></span><br><span class="line">    <span class="string">host1</span></span><br><span class="line">    <span class="string">host2</span></span><br><span class="line">  <span class="attr">GroupName:</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">      <span class="string">host1</span></span><br><span class="line">      <span class="string">host2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>父组子组</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 当 Inventory 文件被分为多个时，应当保证先加载 ChildGroup，再加载 ParentGroup</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ini 格式，使用 &#x27;:childern&#x27; 来标记</span></span><br><span class="line"></span><br><span class="line">host01</span><br><span class="line">host02</span><br><span class="line"></span><br><span class="line"><span class="section">[ChildGroup1]</span></span><br><span class="line">host03</span><br><span class="line">host04</span><br><span class="line"></span><br><span class="line"><span class="section">[ChildGroup2]</span></span><br><span class="line">host05</span><br><span class="line">host06</span><br><span class="line"></span><br><span class="line"><span class="section">[ParentGroup:children]</span></span><br><span class="line">ChildGroup1</span><br><span class="line">ChildGroup2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yaml 格式，使用 childern 关键字来标记</span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="string">host1</span></span><br><span class="line">    <span class="string">host2</span></span><br><span class="line">  <span class="attr">ChildGroup1:</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">      <span class="string">host03</span></span><br><span class="line">      <span class="string">host04</span></span><br><span class="line">  <span class="attr">ChildGroup2:</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">      <span class="string">host05</span></span><br><span class="line">      <span class="string">host06</span></span><br><span class="line">  <span class="attr">ParentGroup:</span></span><br><span class="line">    <span class="attr">childern:</span></span><br><span class="line">      <span class="string">ChildGroup1</span></span><br><span class="line">      <span class="string">ChildGroup1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>主机别名 Alias</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 使用特殊变量 ansible_host 和 ansible_port 来为主机设置别名</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ini 格式</span></span><br><span class="line">jumper <span class="attr">ansible_port</span>=<span class="number">5555</span> ansible_host=<span class="number">192.0</span>.<span class="number">2.50</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yml 格式</span></span><br><span class="line"><span class="attr">hosts:</span></span><br><span class="line">  <span class="attr">jumper:</span></span><br><span class="line">    <span class="attr">ansible_port:</span> <span class="number">5555</span></span><br><span class="line">    <span class="attr">ansible_host:</span> <span class="number">192.0</span><span class="number">.2</span><span class="number">.50</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：主机匹配字符串"><a href="#知识点：主机匹配字符串" class="headerlink" title="知识点：主机匹配字符串"></a>知识点：主机匹配字符串</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - HostPattern</span><br><span class="line">  - 用在 ad-hoc 或 playbook 中，指定目标主机</span><br><span class="line">  - HostPattern 必须要与 Inventory 中的记录相匹配</span><br><span class="line">    - 例如在 Inventory 记录的 IP 而在 HostPattern 上写的 hostname，则无法使用</span><br><span class="line">    - 如果在 Inventory 记录的 alias 则在 HostPattern 也必须使用 alias</span><br><span class="line"></span><br><span class="line">* 匹配过程</span><br><span class="line">  - ansible 会根据 HostPattern 与 Inventory 进行匹配</span><br><span class="line">  - 对匹配到的结果，进行扁平化，最终得到一个主机列表</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">* all</span><br><span class="line">  - 指定 all 主机组，对主机清单文件中的所有主机执行操作</span><br><span class="line"></span><br><span class="line">* 192.168.1.*</span><br><span class="line">  - 通配符方式</span><br><span class="line">  - 对主机清单中所有此网段的地址进行操作</span><br><span class="line"></span><br><span class="line">* ,</span><br><span class="line">  - 主机列表，如 host1,host2</span><br><span class="line"></span><br><span class="line">* &amp;</span><br><span class="line">  - 逻辑与</span><br><span class="line">  - 例如 Group1&amp;Group2</span><br><span class="line">  - 在 ad-hoc 上由于 shell 的原因需要加引用，如 ansible &#x27;group1&amp;group2&#x27; -m XXXX -a &#x27;XXXX&#x27;</span><br><span class="line"></span><br><span class="line">* :</span><br><span class="line">  - 逻辑或</span><br><span class="line">  - 例如 Group1:Group2、ip1:ip2</span><br><span class="line">  - 逻辑与或非可以组合，按照从左向右的顺序进行解析</span><br><span class="line"></span><br><span class="line">* :!</span><br><span class="line">  - 逻辑非</span><br><span class="line">  - 例如 Group1:!Group2、Group1:!ip2</span><br><span class="line">  - 在 ad-hoc 上由于 shell 的原因需要加引用，如 ansible &#x27;group1:!group2&#x27; -m XXXX -a &#x27;XXXX&#x27;</span><br><span class="line"></span><br><span class="line">* ~</span><br><span class="line">  - 正则表示法，放在字符串的第一个字符</span><br><span class="line">  - 在 ad-hoc 上由于 shell 的原因需要加引用，例如 &#x27;~^192.168.1.*&#x27;、&#x27;~*.example.net$&#x27;</span><br><span class="line"></span><br><span class="line">* Group[]</span><br><span class="line">  - 主机组位置，以类似 python 切片的方式指向主机组中的主机，index 从 0 开始</span><br><span class="line">  - 例如 webservers[0]、webservers[0:2]、webservers[1:]</span><br><span class="line"></span><br><span class="line">* &#123;&#123; &#125;&#125;</span><br><span class="line">  - 在 playbook 中引用变量</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：主机清单变量"><a href="#知识点：主机清单变量" class="headerlink" title="知识点：主机清单变量"></a>知识点：主机清单变量</h3><ol>
<li><strong>主机变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 只对特定主机生效</span><br><span class="line">  - 优先级高于主机组变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ini 格式</span></span><br><span class="line"><span class="section">[web-servers]</span></span><br><span class="line">192.168.11.101 <span class="attr">http_port</span>=<span class="number">303</span> MaxRequestPerChild=<span class="number">100</span></span><br><span class="line">192.168.11.102 <span class="attr">http_port</span>=<span class="number">8080</span> MaxRequestPerChild=<span class="number">200</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yml 格式</span></span><br><span class="line"><span class="attr">web-servers:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">192.168.11.101:</span></span><br><span class="line">      <span class="attr">http_port:</span> <span class="number">303</span></span><br><span class="line">      <span class="attr">MaxRequestPerChild:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">192.168.11.102:</span></span><br><span class="line">      <span class="attr">http_port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="string">MaxRequestPerChild:200</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>主机组变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 主机组中的所有主机均能使用主机组的变量值</span><br><span class="line">  - 子主机组可以继承父主机组的主机组变量，子主机组的主机组变量优先级高于父主机组的主机组变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ini 格式</span></span><br><span class="line"><span class="section">[web-servers]</span></span><br><span class="line">192.168.11.101</span><br><span class="line">192.168.11.102</span><br><span class="line"><span class="section">[web-servers:vars]</span></span><br><span class="line"><span class="attr">http_port</span>=<span class="number">80</span></span><br><span class="line"><span class="attr">MaxRequestPerChild</span>=<span class="number">100</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yml 格式</span></span><br><span class="line"><span class="attr">web-servers:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">192.168.11.101:</span></span><br><span class="line">    <span class="attr">192.168.11.102:</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">http_port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">MaxRequestPerChild:</span> <span class="number">100</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：主机清单变量文件"><a href="#知识点：主机清单变量文件" class="headerlink" title="知识点：主机清单变量文件"></a>知识点：主机清单变量文件</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 将主机变量、主机组变量从主机清单中分离出来，单独写在其他变量文件中</span><br><span class="line">  - 变量文件，只能使用 yaml 格式，后缀名可以是 .yml、.yaml 等</span><br><span class="line">  - 变量文件的位置是特定的，ansible 会按照这些位置自动搜索相应的变量文件并加载进来</span><br><span class="line"></span><br><span class="line">* 优点</span><br><span class="line">  - 结构化管理</span><br><span class="line">  - 缩减 inventory 文件的大小</span><br><span class="line">  - ansible vault</span><br><span class="line"></span><br><span class="line">* 位置</span><br><span class="line">  - inventory file 或者 playbook file 的相对路径</span><br><span class="line">  - group_vars 目录</span><br><span class="line">    - 存放主机组变量，变量文件的命名为 GroupName.yml</span><br><span class="line">    - 也可以创建 GroupName 的子目录，里面可以存放多个 yml 文件，ansible 会按照字典序先后读取所有的变量文件</span><br><span class="line">  - host_vars 目录</span><br><span class="line">    - 存放主机变量，变量文件的命名为 HostName.yml</span><br><span class="line"></span><br><span class="line">* 注意</span><br><span class="line">  - ansible-playbook 命令会搜索 current working directory 的 group_vars 和 host_vars 目录</span><br><span class="line">  - 其他命令，如 ansible、ansible-console 只会搜索 inventory directory 的 group_vars 和 host_vars 目录</span><br><span class="line"></span><br><span class="line">* 范例</span><br><span class="line">  - 使用的主机清单文件为 /etc/ansible/hosts，有一个主机组 raleigh，有一个主机 foosball</span><br><span class="line">  - 主机组变量文件：/etc/ansible/group_vars/raleigh.yml</span><br><span class="line">  - 主机变量文件：  /etc/ansible/host_vars/foosball.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="1-4-ansible-配置"><a href="#1-4-ansible-配置" class="headerlink" title="1.4 ansible 配置"></a>1.4 ansible 配置</h2><hr>
<h3 id="知识点：ansible-配置"><a href="#知识点：ansible-配置" class="headerlink" title="知识点：ansible 配置"></a>知识点：ansible 配置</h3><ol>
<li><strong>介绍</strong></li>
<li><strong>配置文件</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* /etc/ansible/ansible.cfg</span><br><span class="line">  - 全局主配置文件</span><br><span class="line">  - 默认一开始并没有，需要调用 ansible-config init --disabled -t all &gt; ansible.cfg 指令来创建</span><br><span class="line">  - 不建议修改</span><br><span class="line"></span><br><span class="line">* ~/.ansible.cfg</span><br><span class="line">  - 个人配置文件，优先级要比主配置文件高</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-配置项"><a href="#知识点：ansible-配置项" class="headerlink" title="知识点：ansible 配置项"></a>知识点：ansible 配置项</h3><ol>
<li><strong>[defaults] 块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - ansible 最基础的配置</span><br><span class="line"></span><br><span class="line">* inventory</span><br><span class="line">  - 指定主机清单文件的文件名</span><br><span class="line"></span><br><span class="line">* local_tmp</span><br><span class="line">  - 指定 master 上本地存放临时 py 程序的目录</span><br><span class="line"></span><br><span class="line">* remote_tmp</span><br><span class="line">  - 指定 remote 上存放临时 py 程序的目录</span><br><span class="line"></span><br><span class="line">* forks</span><br><span class="line">  - 并发数</span><br><span class="line"></span><br><span class="line">* ask_pass</span><br><span class="line">  - master 连接远程主机时，是否要求输入远程主机用户的密码</span><br><span class="line"></span><br><span class="line">* sudo_user</span><br><span class="line">  - 基于 sudo 方式时，指定 sudo 的目标用户，默认 root</span><br><span class="line"></span><br><span class="line">* ask_sudo_pass</span><br><span class="line">  - 基于 sudo 方式时，是否需要输入登录所使用的普通用户的密码</span><br><span class="line"></span><br><span class="line">* remote_port</span><br><span class="line">  - 指定远程主机的 ssh 端口号</span><br><span class="line"></span><br><span class="line">* host_key_checking</span><br><span class="line">  - 首次 ssh 连接时，是否对远程主机的 host_key 进行验证</span><br><span class="line"></span><br><span class="line">* module_name</span><br><span class="line">  - 指定 ansible 的默认模块</span><br><span class="line"></span><br><span class="line">* log_path</span><br><span class="line">  - 指定 ansible 的日志文件的存放位置</span><br><span class="line">  - 需要解除注释才能启用日志功能</span><br><span class="line">  - 日志保留 ansible 执行过程中输出到 STDOUT 上的内容，故 -vvv 可以让日志保存更多信息</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>[colors] 块</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定 ansible 的返回信息的颜色所代表的意义</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-config-指令"><a href="#知识点：ansible-config-指令" class="headerlink" title="知识点：ansible-config 指令"></a>知识点：ansible-config 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 作用</span><br><span class="line">  - 查看当前的 ansible 配置</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  ansible-config list     查看所有配置项的介绍</span><br><span class="line">  ansible-config dump     查看当前配置项的值</span><br><span class="line">  ansible-config view     查看当前的配置文件</span><br><span class="line">  ansible-config init</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="1-5-ansible-Puilgin"><a href="#1-5-ansible-Puilgin" class="headerlink" title="1.5 ansible Puilgin"></a>1.5 ansible Puilgin</h2><hr>
<h3 id="知识点：ansible-Puilgin-介绍"><a href="#知识点：ansible-Puilgin-介绍" class="headerlink" title="知识点：ansible Puilgin 介绍"></a>知识点：ansible Puilgin 介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* Plugin 介绍</span><br><span class="line">  - ansible 除了核心部分 ansible-core 外，其余的功能都是以 Plugin 的方式存在</span><br><span class="line">  - 一个 Plugin，通常只是一个 py 文件</span><br><span class="line"></span><br><span class="line">* collection</span><br><span class="line">  - 对 plugin 的分组，也记作 namespace</span><br><span class="line">  - plugin 的名字会记作 Collection.Name</span><br><span class="line">  - ansible 也推荐在使用 Plugin 时使用 Collection.Name 格式，因为不同的 collection 可能存在重名的插件</span><br><span class="line">  - 如果只指定 Name，则通常表示 ansible.builtin 中的插件</span><br><span class="line"></span><br><span class="line">* Plugin 的类型</span><br><span class="line">  - 使用 ansible-doc -l -t Type，可以在 master 上查看已经安装的对应类型的 Plugin 列表</span><br><span class="line">  - 最常用的类型包括 Module、Filter、Test、Lookup</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-Module-模块"><a href="#知识点：ansible-Module-模块" class="headerlink" title="知识点：ansible Module 模块"></a>知识点：ansible Module 模块</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 模块，表示 ansible 中的一个操作，即一个 task</span><br><span class="line"></span><br><span class="line">* 模块的返回值</span><br><span class="line">  - task 在执行结束后，通常都会返回一段数据结构，里面记录了各种信息，作为 task 的返回值</span><br><span class="line">  - 每个模块的返回值的结构和内容取决于模块</span><br><span class="line">    - 返回值的类型</span><br><span class="line">    - 返回值中包含的通用字段</span><br><span class="line">    - 返回值中包含的特有字段</span><br><span class="line">  - 详细见 register 变量</span><br><span class="line"></span><br><span class="line">* 模块的执行状态</span><br><span class="line">  - task 在执行结束后，会报告每个 task 在每个主机上的执行的情况，如成功或失败等</span><br><span class="line">  - 包括 successed、failed、changed、unreachable 等</span><br><span class="line">  - 详细见 playbook 执行</span><br></pre></td></tr></table></figure></li>
<li><strong>常用参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* boolean 型参数</span><br><span class="line">  - 支持任何可以被 yaml 解析为 true/false 的值，如 &#x27;true&#x27;、&#x27;yes&#x27;、1、1.2 等</span><br><span class="line"></span><br><span class="line">* status 参数</span><br><span class="line">  - 对于需要进行修改的操作，status 参数来应该进行何种修改</span><br><span class="line">  - present，创建文件、安装软件包等</span><br><span class="line">  - absent，删除文件、卸载软件包等</span><br><span class="line"></span><br><span class="line">* backup 参数</span><br><span class="line">  - ansible 的 backup 功能，通过调用 backup_local 函数来确定备份文件的文件名</span><br><span class="line">  - backup_local 函数中使用 python 中 datetime 模块的 strftime 的时间格式参数</span><br><span class="line">  - 位置 /usr/lib/python3/dist-packages/ansible/module_utils/basic.py</span><br></pre></td></tr></table></figure></li>
<li><strong>模块的默认参数值</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* module_defaults 关键字</span><br><span class="line">  - 通过 module_defaults 关键字，可以在 playbook 中为模块指定默认参数值，来覆盖 module 的原始默认参数值</span><br><span class="line">  - 在 task 中显式指定参数值，可以覆盖 module_defaults 中的设定</span><br><span class="line">  - 如果已经在 play 层指定了 module_defaults，可以继续在 task 层指定 module_defaults 并将模块的默认参数值设置为空 &#x27;&#123;&#125;&#x27;，表示恢复模块的原始默认参数值</span><br><span class="line"></span><br><span class="line">* 模块默认组 Module defaults groups</span><br><span class="line">  - 从 ansible 2.7 开始，ansible 内置了一些默认的组名，用来对一组相关联的模块一起设置默认参数值</span><br><span class="line">  - 组名包括 aws、azure、k8s、docker 等</span><br><span class="line">  - 格式，group/GroupName</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例一，在 play 中指定模块的默认参数值</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">play1</span></span><br><span class="line">  <span class="attr">module_defaults:</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">trim_blocks:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">lstrip_blocks:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例二，在 task 中恢复模块的原始默认参数值</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task1</span></span><br><span class="line">  <span class="attr">module_defaults:</span></span><br><span class="line">    <span class="attr">template:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例三，在 play 中为多个 aws 相关模块设置 region 的默认参数值</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">paly01</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">my_region:</span> <span class="string">us-west-2</span></span><br><span class="line">  <span class="attr">module_defaults:</span></span><br><span class="line">    <span class="attr">amazon.aws.ec2:</span>                     &#123; <span class="string">region=&#x27;<span class="template-variable">&#123;&#123; my_region &#125;&#125;</span></span><span class="string">&#x27; &#125;</span></span><br><span class="line"><span class="string">    amazon.aws.ec2_vpc_net_info:        &#123; region=&#x27;</span>&#123;&#123; <span class="string">my_region</span> &#125;&#125;<span class="string">&#x27; &#125;</span></span><br><span class="line"><span class="string">    community.aws.ec2_instance_info:    &#123; region=&#x27;</span>&#123;&#123; <span class="string">my_region</span> &#125;&#125;<span class="string">&#x27; &#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例四，在 play 中为 aws 组设置 region 的默认参数值</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">paly01</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">my_region:</span> <span class="string">us-west-2</span></span><br><span class="line">  <span class="attr">module_defaults:</span></span><br><span class="line">    <span class="attr">group/aws:</span></span><br><span class="line">      <span class="string">region=&#x27;&#123;&#123;</span> <span class="string">my_region</span> <span class="string">&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-Filter-过滤器"><a href="#知识点：ansible-Filter-过滤器" class="headerlink" title="知识点：ansible Filter 过滤器"></a>知识点：ansible Filter 过滤器</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 过滤器，用来操作数据 data manipulation</span><br><span class="line">  - ansible 支持所有的 jinja2 内置过滤器，并且额外自定义了一些过滤器，作为 Pluggin 存在</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  &#123;&#123; Expression | Filter &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>常用过滤器</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">* default</span><br><span class="line">  - 默认值</span><br><span class="line">  - &#123;&#123; SomeVar | default(5) &#125;&#125;</span><br><span class="line">  - &#123;&#123; SomeVar | default(omit) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* type_debug</span><br><span class="line">  - 查看数据类型</span><br><span class="line">  - &#123;&#123; SomeVar | type_debug &#125;&#125;</span><br><span class="line"></span><br><span class="line">* random</span><br><span class="line">  - 随机数、List 随机项</span><br><span class="line">  - &#123;&#123; [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;] | random &#125;&#125;</span><br><span class="line">  - &#123;&#123; 60 | random &#125;&#125;</span><br><span class="line">  - &#123;&#123; 60 | random(start=1, step=10, seed=SEED) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* log、pow、root</span><br><span class="line">  - 求对数、求幂、求根</span><br><span class="line">  - &#123;&#123; 8 | log(2) &#125;&#125;    =&gt; 3</span><br><span class="line">  - &#123;&#123; 2 | pow(10) &#125;&#125;   =&gt; 1024</span><br><span class="line">  - &#123;&#123; 2 | root(2) &#125;&#125;   =&gt; 1.414</span><br><span class="line"></span><br><span class="line">* strftime(second=LocalEpoch, utc=&#x27;false&#x27;)</span><br><span class="line">  - 对时间戳进行格式化</span><br><span class="line">  - &#123;&#123; &#x27;%Y-%m-%d %H:%M:%S&#x27; | strftime(1441357287) &#125;&#125;</span><br><span class="line">  - &#123;&#123; &#x27;%Y-%m-%d %H:%M:%S&#x27; | strftime(ansible_date_time.epoch) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* ansible.netcommon.ipaddr</span><br><span class="line">* ansible.netcommon.ipv4</span><br><span class="line">* ansible.netcommon.ipv6</span><br><span class="line">  - 从 CIDR 中提取 ip 地址</span><br><span class="line">  - 检查 String 是否是 ip 地址</span><br><span class="line">  - &#123;&#123; &#x27;192.168.1.1&#x27; | ansible.netcommon.ipaddr &#125;&#125;                =&gt; 192.168.1.1</span><br><span class="line">  - &#123;&#123; &#x27;192.168.1.1/24&#x27; | ansible.netcommon.ipaddr(&#x27;address&#x27;) &#125;&#125;  =&gt; 192.168.1.1</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>List、Dict 常用过滤器</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* first、last</span><br><span class="line">  - 获取 List 的第一个元素、最后一个元素</span><br><span class="line">  - 获取 Dict 的第一个元素的 key、最后一个元素的 key</span><br><span class="line"></span><br><span class="line">* max、min</span><br><span class="line">  - 对 List 求最大值、最小值</span><br><span class="line">  - &#123;&#123; List | min &#125;&#125;</span><br><span class="line">  - &#123;&#123; [&#123;&#x27;name&#x27;: &#x27;jack&#x27;, &#x27;age&#x27;: 15&#125;, &#123;&#x27;name&#x27;: &#x27;tom&#x27;, &#x27;age&#x27;:20&#125;] | min(attribute=&#x27;age&#x27;) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* dict2items</span><br><span class="line">* items2dict</span><br><span class="line">  - 字典转列表，列表转字典</span><br><span class="line">  - 列表是由包含两个 K-V 的小字典组成的列表</span><br><span class="line">  - 默认每个小字典的第一个 K-V 的 key 为 &#x27;key&#x27;，第二个 K-V 的 key 为 &#x27;value&#x27;，也可以手动指定</span><br><span class="line">  - &#123;&#123; Dict | dict2items &#125;&#125;</span><br><span class="line">  - &#123;&#123; &#123;apple: 20, pear: 15&#125; | dict2items(key=&#x27;fruit&#x27;, value=&#x27;price&#x27;) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* community.general.json_query</span><br><span class="line">  - json 搜索</span><br><span class="line">  - &#123;&#123; RegisteredVar | community.general.json_query(&#x27;results[*].stdout_lines&#x27;)&#125;&#125;</span><br><span class="line">  - &#123;&#123; SomeVar | to_json | from_josn | community.general.json_query(XXXX)&#125;&#125;</span><br><span class="line"></span><br><span class="line">* List | unique                         唯一值</span><br><span class="line">* List | union(List2)                   返回并集</span><br><span class="line">* List | intersect(List)                返回交集</span><br><span class="line">* List | difference(List2)              返回差集</span><br><span class="line">* List | symmetric_difference(List2)    返回对称差集</span><br><span class="line">  - 各种集合操作</span><br><span class="line">  - 对称差集，即 union - intersect，即一个元素，要么只属于 List1，要么只属于 List2，不能同时属于 List1 和 List2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">综合使用范例，只针对记录的</span> <span class="string">ip</span> <span class="string">执行操作</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">db-servers</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">hosts_configs:</span></span><br><span class="line">      <span class="attr">ip_config:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">ipaddr:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>, <span class="attr">name:</span> <span class="string">host01</span> &#125;</span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">ipaddr:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span>, <span class="attr">name:</span> <span class="string">host02</span> &#125;</span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">ipaddr:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>, <span class="attr">name:</span> <span class="string">host03</span> &#125;</span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">ipaddr:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.4</span>, <span class="attr">name:</span> <span class="string">host04</span> &#125;</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_facts.hostname &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_facts.all_ipv4_address</span> <span class="string">|</span> <span class="string">intersect(</span> <span class="string">hosts_configs</span> <span class="string">|</span> <span class="string">json_query(ip_config[*].ipaddr))</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>String 常用过滤器</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* password_hash</span><br><span class="line">  - 生成密码的加密字符</span><br><span class="line">  - 见 ansible.builtin.user 模块</span><br><span class="line">  - &#123;&#123; &#x27;123456&#x27; | password_hash(&#x27;sha512&#x27;) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* join、split</span><br><span class="line">  - 将 List 元素拼接为 String</span><br><span class="line">  - 将 String 切分为 List</span><br><span class="line">  - &#123;&#123; List | join(&quot;, &quot;) &#125;&#125;</span><br><span class="line">  - &#123;&#123; CsvString | split(&quot;,&quot;) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* regex_search</span><br><span class="line">  - 正则搜索</span><br><span class="line">  - &#123;&#123; &#x27;server1/database42&#x27; | regex_search(&#x27;database[0-9]+&#x27;) &#125;&#125;</span><br><span class="line"></span><br><span class="line">* regex_replace</span><br><span class="line">  - 正则替换</span><br><span class="line">  - &#123;&#123; &#x27;www.example.com&#x27; | regex_replace(&#x27;www&#x27;, &#x27;https:\\1&#x27;) &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-Test-条件测试"><a href="#知识点：ansible-Test-条件测试" class="headerlink" title="知识点：ansible Test 条件测试"></a>知识点：ansible Test 条件测试</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - Test 条件测试，对表达式按照指定的方式来进行判断，计算布尔值</span><br><span class="line">  - ansible 支持所有的 Jinja2 Test，同时额外新增了自己的 Test，以 Plugin 的方式添加</span><br><span class="line">  - 注意，ansible 并不支持 Jinja2 的 ture/false 两个 Test，取而代之的是 truthy/falsy</span><br><span class="line">  - 除 Test 外，ansible 也支持 python 方式的 boolean 类型转换，可以直接将变量值作为 true/false 值来使用</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  Expression is Test</span><br><span class="line">  Expression is not Test</span><br><span class="line">  Expression is Test Arg      如果只有一个 Arg，则可以省略括号</span><br><span class="line">  Expression is Test(Args)    如果需要多个 Arg，则必须使用括号方式</span><br><span class="line"></span><br><span class="line">* 关于格式的说明</span><br><span class="line">  - 早先的 ansible 支持以 &#x27;|&#x27; 来调用 Test</span><br><span class="line">  - 从 2.5 开始，以 &#x27;|&#x27; 来调用 Test 会报一个 deprecation 警告</span><br><span class="line">  - 从 2.9 开始，强制只能适应 &#x27;is&#x27; 来调用 Test</span><br></pre></td></tr></table></figure></li>
<li><strong>常用 Test</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">* gt、ge、lt、le、eq、ne</span><br><span class="line">  - 比较，基于 python 的比较法则</span><br><span class="line">  - 注意，如果是两个数值比较但其中一个数值是 String 类型，则其需要先经过 Filter 转换为数值型</span><br><span class="line"></span><br><span class="line">* truthy(convert_bool=&#x27;false&#x27;)</span><br><span class="line">* falsy(convert_bool=&#x27;false&#x27;)</span><br><span class="line">  - 按照 python 的类型转换规则对 Expression 检查 boolean</span><br><span class="line">  - 参数 convert_bool=&#x27;true&#x27;</span><br><span class="line">    - 表示检查时额外考虑语义</span><br><span class="line">    - 如 &#x27;no&#x27;、&#x27;off&#x27;、&#x27;false&#x27;，在不考虑语义会被时被为 true，在考虑语义时会被识别为 false</span><br><span class="line">  - 0 is truthy                           =&gt; false</span><br><span class="line">  - &#x27;no&#x27; is truthy                        =&gt; true</span><br><span class="line">  - &#x27;no&#x27; is truthy(convert_bool=&#x27;true&#x27;)   =&gt; false</span><br><span class="line"></span><br><span class="line">* is number</span><br><span class="line">* is integer</span><br><span class="line">* is float</span><br><span class="line">  - 检查类型</span><br><span class="line">  - Int 是 number、integer</span><br><span class="line">  - Float 是 number、float</span><br><span class="line"></span><br><span class="line">* is string</span><br><span class="line">* is mapping</span><br><span class="line">* is iterable</span><br><span class="line">* is sequence</span><br><span class="line">  - 检查类型</span><br><span class="line">  - String 是 string、mapping、iterable、sequence</span><br><span class="line">  - List 是 iterable、sequence</span><br><span class="line">  - Dict 是 iterable、sequence、mapping</span><br><span class="line"></span><br><span class="line">* result is succeeded</span><br><span class="line">* result is failed</span><br><span class="line">* result is changed</span><br><span class="line">* result is skipped</span><br><span class="line">  - 检查返回值</span><br><span class="line"></span><br><span class="line">* is directory</span><br><span class="line">* is file</span><br><span class="line">* is link</span><br><span class="line">* is exists</span><br><span class="line">* is abs</span><br><span class="line">* is same_file(File)</span><br><span class="line">* is mount</span><br><span class="line">  - 对 master 检查 path</span><br><span class="line">  - 对于 is directory、is file，并不实际检查文件是否存在，而是仅根据 path 的字面量进行基于语义的判断</span><br></pre></td></tr></table></figure></li>
<li><strong>String Test</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* match</span><br><span class="line">  - 对 String 进行从 beginning 开始的正则匹配检测，与 python 的 re.match 函数相同</span><br><span class="line">  - Url is match &quot;https://example.com/users/.*/resources&quot;</span><br><span class="line"></span><br><span class="line">* search</span><br><span class="line">  - 对 String 进行部分正则匹配检测，与 python 的 re.search 函数相同</span><br><span class="line">  - Url is search &quot;users/.*/resources&quot;</span><br><span class="line"></span><br><span class="line">* regex(ignorecase=&#x27;false&#x27;, match_type=&#x27;search&#x27;, pattern)</span><br><span class="line">  - 对 String 进行正则匹配检测</span><br><span class="line">  - 功能最全的正则匹配检测 Test，可以通过 match_type 参数来决定使用 &#x27;match&#x27; 模式或 &#x27;search&#x27; 模式</span><br></pre></td></tr></table></figure></li>
<li><strong>List Test</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* in</span><br><span class="line">* contains</span><br><span class="line">  - 检查元素与 List 之间的包含关系</span><br><span class="line">  - 3               is in [1, 2, 3, 4, 5]   ==&gt; true</span><br><span class="line">  - [1, 2, 3, 4, 5] is contains 3           ==&gt; true</span><br><span class="line"></span><br><span class="line">* subset</span><br><span class="line">* superset</span><br><span class="line">  - 检查 List 与 List 之间的包含关系，即检查子集或超集</span><br><span class="line">  - [2,3]       is subset [1,2,3,4,5]  ==&gt; true</span><br><span class="line">  - [1,2,3,4,5] is superset [2,3]      ==&gt; true</span><br><span class="line"></span><br><span class="line">* any</span><br><span class="line">* all</span><br><span class="line">  - 检查 List 的元素是否全是 True、至少包含一个 True</span><br><span class="line">  - [0, 1, 2]  is all ==&gt; false</span><br><span class="line">  - [&#x27;&#x27;, 0, 1] is any ==&gt; true</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-Lookup-查找"><a href="#知识点：ansible-Lookup-查找" class="headerlink" title="知识点：ansible Lookup 查找"></a>知识点：ansible Lookup 查找</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - ansible 提供的一种功能，可以从外部数据源中读取数据到 ansible 中，如文件、数据库、API 等</span><br><span class="line">  - 与所有的 Jinja2 模板相同，ansible 对 lookup 的处理发生在 master 上</span><br><span class="line">  - 与所有的 Jinja2 模板相同，lookup 可以用在任何使用 Jinja2 格式的地方</span><br><span class="line">  - 所有的 lookup 功能都以 Plugin 的形式存在</span><br><span class="line">  - lookup 最主要的用处，就是在迭代中使用</span><br><span class="line"></span><br><span class="line">* 调用格式</span><br><span class="line">  lookup(&#x27;LookupFunction&#x27;, Parameters)</span><br><span class="line"></span><br><span class="line">* 格式说明</span><br><span class="line">  1. 使用 lookup() 函数调用 lookup 功能</span><br><span class="line">  2. lookup() 函数的第一个参数，必须指定使用的 LookupFunction</span><br><span class="line">  3. lookup() 函数的其他参数，是使用的 LookupFunction 的参数</span><br><span class="line">    - lookup() 函数的第二个参数，即 LookupFunction 的第一个参数，通常都是用来指定数据源</span><br><span class="line">  4. lookup() 函数额外支持一个参数 wantlist=True，表示必须返回一个 List，lookup() 的默认行为是返回一个 &#x27;,&#x27; 间隔的 string 值</span><br><span class="line">  5. query() 函数，相当于指定了 wantlist=True 的 lookup() 函数</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从文件中读取内容，保存到变量中</span></span><br><span class="line"><span class="attr">vars:</span></span><br><span class="line">  <span class="attr">motd_value:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;, &#x27;/etc/motd&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lookup 用在迭代中</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">count</span> <span class="string">to</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">list01:</span> [<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>], <span class="number">4</span>]</span><br><span class="line">  <span class="attr">with_items:</span> <span class="string">list01</span></span><br></pre></td></tr></table></figure></li>
<li><strong>常用 lookup</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* list(List)</span><br><span class="line">  - 原样返回 List</span><br><span class="line"></span><br><span class="line">* items(List)</span><br><span class="line">  - 原样返回 List，但会对 top-level 的元素进行平整</span><br><span class="line">  - 相当于 lookup(&#x27;list&#x27;, SomeList) | flatten(1)</span><br><span class="line"></span><br><span class="line">* dict(Dict)</span><br><span class="line">  - 返回一个 List，其由二项的小字典组成，每个字典的第一个元素的 key 为 &#x27;key&#x27;，第二个元素的 key 为 &#x27;value&#x27;</span><br><span class="line"></span><br><span class="line">* file(Path)</span><br><span class="line">  - 返回一个 String，从外部文件中读取全部 content</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter02-Playbook"><a href="#Chapter02-Playbook" class="headerlink" title="Chapter02 Playbook"></a>Chapter02 Playbook</h1><hr>
<h2 id="2-1-playbook-介绍"><a href="#2-1-playbook-介绍" class="headerlink" title="2.1 playbook 介绍"></a>2.1 playbook 介绍</h2><hr>
<h3 id="知识点：playbook-介绍"><a href="#知识点：playbook-介绍" class="headerlink" title="知识点：playbook 介绍"></a>知识点：playbook 介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - playbook，使用脚本化的方式组织多个 ansible 操作</span><br><span class="line">  - playbook 是 ansible 的核心</span><br><span class="line">  - playbook 使用 yaml 格式，支持内嵌 jinja2 格式</span><br><span class="line"></span><br><span class="line">* playbook 的层级</span><br><span class="line">  - role</span><br><span class="line">  - playbook</span><br><span class="line">    - 一个 yml 文件</span><br><span class="line">  - plays</span><br><span class="line">    - 一段 yml 配置，一个 playbook 由 play 列表组成</span><br><span class="line">    - playbook 中从上向下执行 play</span><br><span class="line">  - tasks</span><br><span class="line">    - 任务列表，放在 play 中，由 tasks 关键字指定</span><br><span class="line">    - 每一个 task 对应一个 ad-hoc 指令，调用一个 module</span><br><span class="line">    - play 中至少要包含一个 task</span><br><span class="line">    - play 中从上向下执行 task</span><br><span class="line"></span><br><span class="line">* ansible-examples repository</span><br><span class="line">  - 官方推荐的 playbook 范例库</span><br><span class="line">  - https://github.com/ansible/ansible-examples</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：playbook-范例"><a href="#知识点：playbook-范例" class="headerlink" title="知识点：playbook 范例"></a>知识点：playbook 范例</h3><ol>
<li><strong>范例一，安装 httpd 和 postgresql</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">web</span> <span class="string">servers</span> <span class="comment"># 安装和启用 httpd</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line">    <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">ansible.builtin.template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">/srv/httpd.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/httpd.conf</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">db</span> <span class="string">servers</span> <span class="comment"># 安装和启用 postgresql</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">databases</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line">    <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ensure</span> <span class="string">that</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">ansible.builtin.service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgresql</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例二，安装 mysql</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">update</span> <span class="string">mysql</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">db-servers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span> <span class="comment"># 创建组</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="string">name=mysql</span></span><br><span class="line">      <span class="string">system=yes</span></span><br><span class="line">      <span class="string">gid=306</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span> <span class="comment"># 创建用户</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="string">name=mysql</span></span><br><span class="line">      <span class="string">shell=/sbin/nologin</span></span><br><span class="line">      <span class="string">system=yes</span></span><br><span class="line">      <span class="string">uid=306</span></span><br><span class="line">      <span class="string">home=/data/mysql</span></span><br><span class="line">      <span class="string">create_home=no</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">mysql</span> <span class="comment"># 安装 mysql</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">mysql</span> <span class="string">service</span> <span class="comment"># 启动 mysql</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例三，安装 nginx</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">web-servers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">nginx</span> <span class="string">group</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="string">name=nginx</span></span><br><span class="line">      <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">nginx</span> <span class="string">user</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="string">user=nginx</span></span><br><span class="line">      <span class="string">group=nginx</span></span><br><span class="line">      <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="string">name=nginx</span></span><br><span class="line">      <span class="string">state=present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="string">name=nginx</span></span><br><span class="line">      <span class="string">state=started</span></span><br><span class="line">      <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例四，创建 wheel 用户</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Linux</span> <span class="string">Create</span> <span class="string">User</span> <span class="string">and</span> <span class="string">Upload</span> <span class="string">User</span> <span class="string">Public</span> <span class="string">keys</span>     <span class="comment"># 创建一个用户 test，将其添加到 wheel 组中</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">host01</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">user01:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27;|password_hash(&#x27;sha512&#x27;) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">sure</span> <span class="string">we</span> <span class="string">have</span> <span class="string">a</span> <span class="string">&#x27;wheel&#x27;</span> <span class="string">group</span>               <span class="comment"># 确定 wheel 组存在</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">wheel</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Allow</span> <span class="string">&#x27;wheel&#x27;</span> <span class="string">group</span> <span class="string">to</span> <span class="string">have</span> <span class="string">passwordless</span> <span class="string">sudo</span>   <span class="comment"># 设定 wheel 组可以无密码 sudo</span></span><br><span class="line">    <span class="attr">lineinfile:</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/sudoers</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">regexp:</span> <span class="string">&#x27;^%wheel&#x27;</span></span><br><span class="line">      <span class="attr">line:</span> <span class="string">&#x27;%wheel ALL=(ALL) NOPASSWD: ALL&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">user</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user01.name &#125;&#125;</span>&quot;</span>                 <span class="comment"># 创建用户 test</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user01.name &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user01.password &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Append</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user.name &#125;&#125;</span>&quot;</span> <span class="string">to</span> <span class="string">the</span> <span class="string">wheel</span> <span class="string">group</span>     <span class="comment"># 将用户添加到 wheel 组中</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user01.name &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">append:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">groups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wheel</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-2-playbook-变量"><a href="#2-2-playbook-变量" class="headerlink" title="2.2 playbook 变量"></a>2.2 playbook 变量</h2><hr>
<h3 id="知识点：变量"><a href="#知识点：变量" class="headerlink" title="知识点：变量"></a>知识点：变量</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 变量，与编程语言中相同，用来储存值、引用值</span><br><span class="line">  - 变量可以用在 playbook 中的各种地方，如 when 语句、loop 结构、模板、task 参数等</span><br><span class="line"></span><br><span class="line">* 变量名</span><br><span class="line">  - 使用字母、数字、下划线</span><br><span class="line">  - 以字母、下划线开头</span><br><span class="line"></span><br><span class="line">* 特殊变量 Special Variables</span><br><span class="line">  - 特殊变量，是 ansible 自动定义，自动赋值的变量，并且在 ansible 的运行中具有特殊的功能</span><br><span class="line">  - 特殊变量包括如下几种</span><br><span class="line">    - Facts</span><br><span class="line">    - Magic Variables</span><br><span class="line">    - Connection Variable</span><br><span class="line"></span><br><span class="line">* 未定义的变量 undefined</span><br><span class="line">  - 默认情况下，如果调用 undefined 变量，ansible 会抛出异常</span><br><span class="line">  - ansible 的配置项 DEFAULT_UNDEFINED_VAR_BEHAVIOR 用来控制引用 undefined 变量时是否抛出异常</span><br><span class="line">  - 还可以使用以下方式来进行控制</span><br><span class="line">    1. &#123;&#123; variable | default(5) &#125;&#125;，给变量设置默认值，则引用 undefined 变量时就不会抛出异常</span><br><span class="line">    2. &#123;&#123; variable | mandatory &#125;&#125;，指定变量为 mandatory，则不论 DEFAULT_UNDEFINED_VAR_BEHAVIOR 配置如何，若此变量为 undefined 则引用时都会抛出异常</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>定义变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 变量来源</span><br><span class="line">  - fact，ansible fact 都可以当做变量直接调用</span><br><span class="line">  - 主机清单变量</span><br><span class="line">  - vars 关键字</span><br><span class="line">  - vars_files 关键字</span><br><span class="line">  - register 关键字</span><br><span class="line">  - -e 命令行选项</span><br><span class="line">    - 在命令行上指定变量</span><br><span class="line">    - 优先级永远最高</span><br><span class="line"></span><br><span class="line">* 优先级</span><br><span class="line">  - fact = register &gt; vars_files &gt; vars &gt; 主机清单变量</span><br><span class="line"></span><br><span class="line">* 变量值</span><br><span class="line">  - 对于变量值，playbook 大多直接采用 yaml 的要求，如 Integer 值、Float 值、String 值</span><br><span class="line">  - List 值，同时支持 yaml 中 &#x27;[ ]&#x27; 单行格式和 &#x27;-&#x27; 分行格式</span><br><span class="line">  - Dict 值，同时支持 yaml 中 &#x27;[ ]&#x27; 单行格式和分行格式</span><br><span class="line">  - Bool 值，ansible 可以灵活的接受各种值，不区分大小写</span><br><span class="line">    - True , &#x27;true&#x27; , &#x27;t&#x27; , &#x27;yes&#x27; , &#x27;y&#x27; , &#x27;on&#x27; , &#x27;1&#x27; , 1 , 1.0</span><br><span class="line">    - False , &#x27;false&#x27; , &#x27;f&#x27; , &#x27;no&#x27; , &#x27;n&#x27; , &#x27;off&#x27; , &#x27;0&#x27; , 0 , 0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>引用变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 关于是否要加引号</span><br><span class="line">  - 由于 yaml 解析的原因，如果 value 部分中第一个字符是 &#x27;&#123;&#x27;，则 yaml 会将其作为一个 Dict 值进行解析</span><br><span class="line">  - 如果 &#123;&#123; var &#125;&#125; 是放在 value 部分的开头，则必须放在引号中</span><br><span class="line">  - 如果 &#123;&#123; var &#125;&#125; 不是放在 value 部分的开头，则可以不加引号</span><br><span class="line">  - 范例</span><br><span class="line">    - name: &quot;&#123;&#123; var &#125;&#125;&quot;-test</span><br><span class="line">    - name: test-&#123;&#123; var &#125;&#125;</span><br><span class="line"></span><br><span class="line">* 基本格式</span><br><span class="line">  &#123;&#123; var &#125;&#125;</span><br><span class="line"></span><br><span class="line">* 引用列表元素，index 从 0 开始计数</span><br><span class="line">  &#123;&#123; list[index] &#125;&#125;</span><br><span class="line"></span><br><span class="line">* 引用字典值</span><br><span class="line">  &#123;&#123; dict.field &#125;&#125;</span><br><span class="line">  &#123;&#123; dict[&#x27;field&#x27;] &#125;&#125;</span><br><span class="line"></span><br><span class="line">* 引用属性</span><br><span class="line">  &#123;&#123; ansible_facts[&quot;eth0&quot;][&quot;ipv4&quot;][&quot;address&quot;] &#125;&#125;</span><br><span class="line">  &#123;&#123; ansible_facts.eth0.ipv4.address &#125;&#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>变量文件</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 通过 vars_files 关键字导入变量文件，获得变量</span><br><span class="line">  - 变量文件支持使用 yaml 或 json</span><br><span class="line"></span><br><span class="line">* vars_files 格式</span><br><span class="line">  vars_files:</span><br><span class="line">  - path01</span><br><span class="line">  - path02</span><br><span class="line"></span><br><span class="line">* 变量文件格式</span><br><span class="line">  ---</span><br><span class="line">  var1: 001</span><br><span class="line">  var2: 002</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>在命令行上输入变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 使用 vars_prompt 关键字，指定需要在 prompt 上输入值的变量</span><br><span class="line">  - 只能放在 play 上</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">vars_prompt:</span><br><span class="line">- name          String，指定变量名</span><br><span class="line">  prompt        String，指定 prompt 的提示文字</span><br><span class="line">  default       String，指定变量的默认值</span><br><span class="line">  private       Boolean，指定是否因此用户的输入，true 表示隐藏</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：register-变量"><a href="#知识点：register-变量" class="headerlink" title="知识点：register 变量"></a>知识点：register 变量</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在 task 中，使用 register 关键字，可以将一个 task 的返回值保存在变量中</span><br><span class="line">  - register 变量的类型取决于模块，可能是字符串、列表、字典，或者更加复杂的结构，多数情况下是字典</span><br><span class="line">  - register 变量的生命期持续到 playbook 的结束，同一个 playbook 中的其他 play 也可以引用此 register 变量的值</span><br><span class="line"></span><br><span class="line">* register 变量是 host-level 变量</span><br><span class="line">  - 每一个 host 的变量结果单独保存</span><br><span class="line">  - 在之后的 task 的使用中，一个 host 只能看到自己主机对应的 register 变量的结果</span><br><span class="line"></span><br><span class="line">* register 变量用在 loop 中</span><br><span class="line">  - register 变量此时保存的是所有迭代 task 的执行结果</span><br><span class="line">  - register 变量中会包含一个字段 results，为迭代 task 中每一次迭代的执行结果组成的列表</span><br><span class="line">  - 每一个执行结果都会额外包含一些字段，如 ansible_loop_var、item 等，用来记录迭代的信息</span><br><span class="line">  - If a task fails or is skipped, Ansible still registers a variable with a failure or skipped status, unless the task is skipped based on tags.</span><br></pre></td></tr></table></figure></li>
<li><strong>返回值字段</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 通用返回值字段</span><br><span class="line">  - changed         A boolean indicates if the task *had to* make changes to the target</span><br><span class="line">  - failed          A boolean indicates if the task was failed or not.</span><br><span class="line">  - skipped         A boolean indicates if the task was skipped or not</span><br><span class="line">  - rc              Some modules execute command line utilities or are geared for executing commands directly (raw, shell, command, and so on). This field contains &#x27;return code&#x27; of these utilities.</span><br><span class="line">  - stdout          Some modules execute command line utilities or are geared for executing commands directly (raw, shell, command, and so on). This field contains the normal output of these utilities.</span><br><span class="line">  - stderr          Some modules execute command line utilities or are geared for executing commands directly (raw, shell, command, and so on). This field contains the error output of these utilities.</span><br><span class="line">  - stderr_lines    When stderr is returned, Ansible always provides a list of strings, each containing one item per line from the original error output.</span><br><span class="line">  - stdout_lines    When stdout is returned, Ansible always provides a list of strings, each containing one item per line from the original output.</span><br><span class="line">  - backup_file     path to the backup file created</span><br><span class="line">  - msg             A string with a generic message relayed to the user.</span><br><span class="line">  - diff            Information on differences between the previous and current state. Often a dictionary with entries before and after</span><br><span class="line">  - invocation      Information on how the module was invoked.</span><br><span class="line">  - results         List，当使用了迭代时，保存每一个迭代子 task 的返回结果</span><br><span class="line"></span><br><span class="line">* 内部使用返回值</span><br><span class="line">  - 用于 Ansible 内部使用的返回值</span><br><span class="line">  - 模块在执行结束后会正常的返回这些信息，但如果 register 到变量中时则不会保存</span><br><span class="line">  - ansible_facts</span><br><span class="line">  - exception     This key can contain traceback information caused by an exception in a module. It will only be displayed on high verbosity (-vvv).</span><br><span class="line">  - warnings      This key contains a list of strings that will be presented to the user.</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：fact-变量"><a href="#知识点：fact-变量" class="headerlink" title="知识点：fact 变量"></a>知识点：fact 变量</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - fact，是指 ansible 在运行时，收集的一些有关远程主机或有关 ansible 自己本身的信息</span><br><span class="line">  - fact 可以作为变量在 playbook 中使用</span><br><span class="line">  - fact 与主机相关联</span><br><span class="line">    - 在 task 中引用 fact 则得到的是与 current host 相关的信息</span><br><span class="line">    - 如果想在 task 中引用其他 host 的 fact，则需要借助 Magic 变量 hostvars</span><br><span class="line">  - fact 的收集</span><br><span class="line">    - 收集 fact，是通过在 remote 上执行某些 OS 命令来实现的，如网络相关的信息是通过 ip 命令来收集</span><br><span class="line">    - 如果 remote 上没有安装相关的命令，则对应的 fact 就会为空或默认值</span><br><span class="line"></span><br><span class="line">* setup 模块</span><br><span class="line">  - ansible 通过 setup 模块来收集 fact</span><br><span class="line">  - 每一个 play 在运行之前，默认都会先运行 setup</span><br><span class="line">  - 可以通过关键字 gather_facts 来控制 play 对 setup 模块的执行</span><br><span class="line">  - 禁用 gather_facts 可以加快 playbook 的执行速度，尤其是在 remote 很多的情况</span><br><span class="line"></span><br><span class="line">* INJECT_FACTS_AS_VARS 配置项</span><br><span class="line">  - 理论上，fact 全部储存在 ansible_facts 变量中，只能以字典的形式来引用</span><br><span class="line">  - INJECT_FACTS_AS_VARS 配置可以设置允许使用 &#x27;ansible_&#x27; 前缀的方式来引用某些常用的 fact</span><br><span class="line">  - 默认此功能为开启</span><br><span class="line">  - 注意</span><br><span class="line">    - 当使用 ansible_facts.XX 的方式时，&quot;XX&quot; 一定不是以 &#x27;ansible_&#x27; 开头的，即使是在 ansible_facts 中以这个名字显示的</span><br><span class="line">    - 典型就是 all_ipv4_addresses，在 ansible_facts 中记录为 ansible_all_ipv4_addresses，但实际上是 ansible_facts.all_ipv4_addresses</span><br><span class="line">    - 这他妈算是个 bug 了</span><br><span class="line"></span><br><span class="line">* 基础变量</span><br><span class="line">  - ansible_facts，Dict，储存 ansible 默认的 fact 信息，不论是 setup 模块收集的或者从缓存中读取的</span><br><span class="line">  - ansible_local，Dict，储存 custom facts</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 fact 加载针对性的模板文件、变量文件</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">task01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_facts.hostname &#125;&#125;</span>&quot;</span><span class="string">.j2</span>      <span class="comment"># 模板文件的名字应当符合相应的 fact 的值</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/test.txt</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_facts.os_family &#125;&#125;</span>&quot;</span><span class="string">.vars.yml</span>    <span class="comment"># 变量文件的名字应当符合相应的 fact 值</span></span><br></pre></td></tr></table></figure></li>
<li><strong>系统相关 fact 信息</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">* 基础信息</span><br><span class="line">  - ansible_facts.uptime_seconds</span><br><span class="line">  - ansible_facts.env                   记录了在 remote 上执行 task 时的 shell 环境变量</span><br><span class="line">    - ansible_facts.env.USER</span><br><span class="line">    - ansible_facts.env.PATH</span><br><span class="line">    - ansible_facts.env.SSH_CLIENT</span><br><span class="line">    - ansible_facts.env.SSH_CONNECTION</span><br><span class="line">  - ansible_facts.date_time             记录了 setup 收集 fact 时的各种时间信息，若 playbook 执行的时间过长，则可以在 task 中使用 now() 来获得 current time</span><br><span class="line">    - ansible_facts.date_time.year</span><br><span class="line">    - ansible_facts.date_time.hour</span><br><span class="line">    - ansible_facts.date_time.epoch</span><br><span class="line">    - ansible_facts.date_time.iso8601</span><br><span class="line"></span><br><span class="line">* OS 相关</span><br><span class="line">  - ansible_facts.system                &#x27;Linux&#x27;</span><br><span class="line">  - ansible_facts.kernel</span><br><span class="line">  - ansible_facts.kernel_version</span><br><span class="line">  - ansible_facts.lsb</span><br><span class="line">  - ansible_facts.os_family             常用，&#x27;RedHat&#x27;、&#x27;Debian&#x27;</span><br><span class="line">  - ansible_facts.architecture          常用，&#x27;Centos&#x27;、&#x27;Ubuntu&#x27;、&#x27;RedHat&#x27; 等</span><br><span class="line">  - ansible_facts.distribution</span><br><span class="line">  - ansible_facts.distribution_*</span><br><span class="line">    - ansible_facts.distribution_major_version    常用，通常用来比较系统版本，注意类型为 String</span><br><span class="line"></span><br><span class="line">* 网络相关</span><br><span class="line">  - ansible_facts.all_ipv4_addresses            记录了 remote 所有的 ipv4 地址</span><br><span class="line">  - ansible_facts.default_ipv4                  记录了 remote 的默认 ipv4 有关的各种信息</span><br><span class="line">    - ansible_facts.default_ipv4.address</span><br><span class="line">    - ansible_facts.default_ipv4.gateway</span><br><span class="line">    - ansible_facts.default_ipv4.interface</span><br><span class="line">  - ansible_facts.interfaces                    记录了 remote 所有的网络接口</span><br><span class="line">  - ansible_facts.NetInterfaceName              记录 remote 某一个网络接口的各种信息，NetInterfaceName 是网卡的名字</span><br><span class="line">    - ansible_facts.NetInterfaceName.active</span><br><span class="line">    - ansible_facts.NetInterfaceName.ipv4</span><br><span class="line">    - ansible_facts.NetInterfaceName.ipv4.address</span><br><span class="line">    - ansible_facts.NetInterfaceName.macaddress</span><br><span class="line">  - ansible_facts.hostname</span><br><span class="line">  - ansible_facts.domain</span><br><span class="line">  - ansible_facts.dns</span><br><span class="line"></span><br><span class="line">* 用户相关</span><br><span class="line">  - ansible_facts.user_*</span><br><span class="line">    - ansible_facts.user_id</span><br><span class="line">    - ansible_facts.user_uid</span><br><span class="line">    - ansible_facts.user_gid</span><br><span class="line">  - ansible_facts.effective_user_id</span><br><span class="line">  - ansible_facts.effective_group_id</span><br><span class="line">  - ansible_facts.real_user_id</span><br><span class="line">  - ansible_facts.real_group_id</span><br><span class="line"></span><br><span class="line">* python 相关</span><br><span class="line">  - ansible_facts.python</span><br><span class="line">  - ansible_facts.discovered_interpreter_python</span><br><span class="line"></span><br><span class="line">* 其他</span><br><span class="line">  - ansible_facts.ssh_host_key_*</span><br><span class="line">  - ansible_facts.userspace_*</span><br><span class="line">  - ansible_facts.virtualization_*</span><br></pre></td></tr></table></figure></li>
<li><strong>硬件相关 fact 信息</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">* CPU 相关</span><br><span class="line">  - ansible_facts.processor</span><br><span class="line">  - ansible_facts.processor_*</span><br><span class="line">    - ansible_facts.processor_count</span><br><span class="line">    - ansible_facts.processor_cores</span><br><span class="line">    - ansible_facts.processor_vcpus</span><br><span class="line">    - ansible_facts.processor_threads_per_core</span><br><span class="line"></span><br><span class="line">* 内存相关</span><br><span class="line">  - ansible_facts.memtotal_mb</span><br><span class="line">  - ansible_facts.memfree_mb</span><br><span class="line">  - ansible_facts.memory_mb</span><br><span class="line">    - ansible_facts.memory_mb.real</span><br><span class="line">    - ansible_facts.memory_mb.real.free</span><br><span class="line">    - ansible_facts.memory_mb.real.used</span><br><span class="line">    - ansible_facts.memory_mb.real.total</span><br><span class="line"></span><br><span class="line">* 硬盘相关</span><br><span class="line">  - ansible_facts.devices                   记录了 remote 与硬盘有关的各种信息，严格意义上说，应该是与 hard device 有关的信息，因为其中还记录了 loop 设备</span><br><span class="line">    - ansible_facts.devices.sda</span><br><span class="line">    - ansible_facts.devices.sda.size</span><br><span class="line">    - ansible_facts.devices.sda.partitions.sda1.size</span><br><span class="line">    - ansible_facts.devices.sda.partitions.sda1.uuid</span><br><span class="line">  - ansible_facts.mounts                    记录了 remote 与挂载点有关的各种信息</span><br><span class="line">    - ansible_facts.mounts[0].mount</span><br><span class="line">    - ansible_facts.mounts[0].device</span><br><span class="line">    - ansible_facts.mounts[0].size_total</span><br><span class="line">    - ansible_facts.mounts[0].uuid</span><br><span class="line"></span><br><span class="line">* 产品信息</span><br><span class="line">  - ansible_facts.bios_*</span><br><span class="line">  - ansible_facts.board_*</span><br><span class="line">  - ansible_facts.chassis_*</span><br><span class="line">  - ansible_facts.prooduct_*</span><br><span class="line">    - ansible_facts.product_name</span><br><span class="line">    - ansible_facts.product_serial</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Magic-变量"><a href="#知识点：Magic-变量" class="headerlink" title="知识点：Magic 变量"></a>知识点：Magic 变量</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - Magic variables</span><br><span class="line">  - 特殊变量的一种，记录了 ansible 的操作的本身的一些信息</span><br><span class="line">  - 用户只能引用 Magic 变量，无法对其修改，即使修改了也会被 ansible 自动覆盖</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>ansible 相关 Magic 变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* ansible 基础信息</span><br><span class="line">  - ansible_version</span><br><span class="line">  - ansible_config_file</span><br><span class="line">  - ansible_inventory_sources   使用的 inventory 文件</span><br><span class="line">  - ansible_playbook_python     master 上使用的 python 的 path</span><br><span class="line">  - ansible_search_path         搜索 plugin 和 lookup 的目录</span><br><span class="line"></span><br><span class="line">* 命令行选项相关</span><br><span class="line">  - ansible_limit               命令行选项 &#x27;--limit&#x27; 的内容</span><br><span class="line">  - ansible_run_tags            命令行选项 &#x27;--tags&#x27; 的内容，默认为 [&quot;all&quot;]</span><br><span class="line">  - ansible_skip_tags           命令行选项 &#x27;--skip-tags&#x27; 的内容</span><br><span class="line"></span><br><span class="line">* 运行时相关</span><br><span class="line">  - ansible_check_mode          记录当前是否是 check mode</span><br><span class="line">  - ansible_diff_mode           记录当前是否是 diff mode</span><br><span class="line">  - ansible_forks               记录当前的最大并发数</span><br><span class="line">  - ansible_verbosity           记录当前的 verbosity 设置</span><br><span class="line"></span><br><span class="line">* 特殊变量</span><br><span class="line">  - omit</span><br><span class="line">    - Omit 类，特殊变量中的特殊变量</span><br><span class="line">    - 黑洞变量，类似 /dev/null，不记录任何信息，而是作为函数的参数，来表示忽略此参数 omit an option in a task</span><br><span class="line">    - 例如，user: name=bob home=&#123;&#123; bobs_home|default(omit) &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>playbook 相关 Magic 变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">* Inventory 相关</span><br><span class="line">  - inventory_hostname          当前主机在 inventory 文件中记录的名字</span><br><span class="line">  - inventory_hostname_short    当前主机在 inventory 文件中记录的名字，但只包含从开始到第一个 &#x27;.&#x27; 的内容</span><br><span class="line">  - inventory_file</span><br><span class="line">  - inventory_dir</span><br><span class="line"></span><br><span class="line">* 主机相关</span><br><span class="line">  - group_names                 List，记录 current host 所在的所有的主机组</span><br><span class="line">  - groups</span><br><span class="line">    - Dict，记录 Inventory 中所有的主机组及其所包含的主机</span><br><span class="line">    - key 为主机组，value 是主机组的 host List</span><br><span class="line">  - hostvars</span><br><span class="line">    - Dict，记录所有主机的所有变量，包括主机组变量和运行时变量等</span><br><span class="line">    - key 为 Inventory 中所有的 host，Value 是此 host 的所有变量的构成的字典</span><br><span class="line">    - 注意，只记录为主机定义的变量，如果变量是定义在 play 层，则不记录在 hostvars 中</span><br><span class="line">    - 最常用的 Magic 变量</span><br><span class="line">    - 最常用的用法，通过 hostvars[host][&#x27;ansible_facts&#x27;] 来引用其他主机的 fact</span><br><span class="line"></span><br><span class="line">* play 相关</span><br><span class="line">  - ansible_play_name           String，记录 current play 的名字</span><br><span class="line">  - ansible_play_hosts_all      List，记录 current play 的所有目标 host，host 是对主机在 Inventory 中的记录经过解析后的结果</span><br><span class="line">  - ansible_play_hosts          List of hosts in the current play run, not limited by the serial. Failed/Unreachable hosts are excluded from this list.</span><br><span class="line">  - ansible_play_batch          List of active hosts in the current play run, limited by the serial, aka batch. Failed/Unreachable hosts are not considered active.</span><br><span class="line">  - playbook_dir                String，记录 current playbook 文件所在的目录，如果 playbook 中使用的 import_playbook，则可能与实际情况不同</span><br><span class="line">  - ansible_collection_name     String，记录 current task 的 module 所在的 collection，格式为 namespace.collection</span><br><span class="line"></span><br><span class="line">* loop 相关</span><br><span class="line">  - ansible_loop</span><br><span class="line">    A dictionary/map containing extended loop information when enabled through loop_control.extended</span><br><span class="line">  - ansible_loop_var</span><br><span class="line">    The name of the value provided to loop_control.loop_var. Added in 2.8</span><br><span class="line">  - ansible_index_var</span><br><span class="line">    The name of the value provided to loop_control.index_var. Added in 2.9</span><br><span class="line"></span><br><span class="line">* 角色相关</span><br><span class="line">  - role_name</span><br><span class="line">  - role_names</span><br><span class="line">  - role_path</span><br><span class="line">  - ansible_role_name</span><br><span class="line">  - ansible_role_names</span><br><span class="line">  - ansible_dependent_role_names</span><br><span class="line">  - ansible_parent_role_names</span><br><span class="line">  - ansible_parent_role_paths</span><br><span class="line">  - ansible_play_role_names</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;# 打印某个主机组 app_servers 中所有的主机的 ip 地址 #&#125;</span><br><span class="line"></span><br><span class="line">&#123;% for host in groups[&#x27;app_servers&#x27;] %&#125;</span><br><span class="line">   &#123;&#123; hostvars[host][&#x27;ansible_facts&#x27;][&#x27;eth0&#x27;][&#x27;ipv4&#x27;][&#x27;address&#x27;] &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-3-playbook-要素"><a href="#2-3-playbook-要素" class="headerlink" title="2.3 playbook 要素"></a>2.3 playbook 要素</h2><hr>
<h3 id="知识点：关键字"><a href="#知识点：关键字" class="headerlink" title="知识点：关键字"></a>知识点：关键字</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 关键字，即 playbook 中每一层的指令</span><br><span class="line">  - 本质上，playbook 中的每一层都是一个对象，如 play 对象、task 对象，而关键字用来指定此对象的某个属性</span><br><span class="line"></span><br><span class="line">* 关键字的覆盖</span><br><span class="line">  - 对于在不同层级中都支持的关键字，细粒度的层级的关键字优先级更高</span><br><span class="line">  - 例如 task vars 会覆盖 play vars</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>play 层常用关键字</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - String，指定名字，不建议省略</span><br><span class="line">  - play 层、task 层</span><br><span class="line"></span><br><span class="line">* hosts</span><br><span class="line">  - List，远程主机列表，使用 host pattern</span><br><span class="line">  - paly 层</span><br><span class="line"></span><br><span class="line">* gather_facts</span><br><span class="line">  - Boolean，是否收集 fact 信息开关</span><br><span class="line">  - paly 层</span><br><span class="line"></span><br><span class="line">* check_mode</span><br><span class="line">* diff</span><br><span class="line">  - Boolean，是否以 check mode 和 diff mode 运行</span><br><span class="line">  - play 层，task 层</span><br><span class="line"></span><br><span class="line">* remote_user</span><br><span class="line">  - String，登录到远程主机的用户</span><br><span class="line">  - paly 层，task 层</span><br><span class="line"></span><br><span class="line">* become，Boolean</span><br><span class="line">* become_user，String</span><br><span class="line">  - 权限升级相关</span><br><span class="line">  - paly 层，task 层</span><br><span class="line"></span><br><span class="line">* tasks</span><br><span class="line">  - List，task 列表</span><br><span class="line">  - play 层</span><br><span class="line"></span><br><span class="line">* handlers</span><br><span class="line">  - List，handler task 列表</span><br><span class="line">  - paly 层</span><br><span class="line"></span><br><span class="line">* tags</span><br><span class="line">  - List，标签列表</span><br><span class="line">  - paly 层，task 层</span><br><span class="line"></span><br><span class="line">* environment</span><br><span class="line">  - Dict，指定在远程主机上执行时使用的环境变量</span><br><span class="line">  - paly 层，task 层</span><br><span class="line"></span><br><span class="line">* vars</span><br><span class="line">  - Dict，变量字典</span><br><span class="line">  - paly 层，task 层</span><br><span class="line"></span><br><span class="line">* vars_files</span><br><span class="line">  - List，变量文件列表</span><br><span class="line">  - paly 层</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>tasks 常用层关键字</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* action，String</span><br><span class="line">* args，String</span><br><span class="line">  - task 的 shell 方式格式相关</span><br><span class="line"></span><br><span class="line">* ModuleName</span><br><span class="line">  - Obj，以 exec 格式指定 task 的动作</span><br><span class="line"></span><br><span class="line">* register</span><br><span class="line">  - String，将 task 的状态、module 的返回值，保存到一个变量中</span><br><span class="line"></span><br><span class="line">* notify</span><br><span class="line">  - List，扳机列表，指定当 task 返回 changed=True 时执行哪些 handler</span><br><span class="line"></span><br><span class="line">* loop</span><br><span class="line">* loop_control</span><br><span class="line">* until</span><br><span class="line">* with_&lt;lookup_plugin&gt;</span><br><span class="line">  - task 循环相关</span><br><span class="line"></span><br><span class="line">* when</span><br><span class="line">  - task 条件控制</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：条件-when"><a href="#知识点：条件-when" class="headerlink" title="知识点：条件 when"></a>知识点：条件 when</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - when 条件，用来对 task 的 host 进行条件控制</span><br><span class="line">    - 只在 true 的 host 上运行 task</span><br><span class="line">    - 结果为 false 的 host 不会执行此 task，并且记录为 skiped</span><br><span class="line">  - when 可以直接使用 raw Jinja2 expression，不需要加 &#123;&#123; &#125;&#125; 标识</span><br><span class="line">  - when 通常使用变量、fact、register 等来作为条件判断的依据</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  when ConditionExpression</span><br><span class="line"></span><br><span class="line">* 多个条件</span><br><span class="line">  - 使用逻辑运算 and、or、not</span><br><span class="line">    - 如 when Condition and Condition</span><br><span class="line">    - 如 when Condition or Condition</span><br><span class="line">  - 使用列表的形式，如 [Condition, Condition]，则隐含多个条件之间的使用 and 逻辑运算</span><br><span class="line"></span><br><span class="line">* 使用</span><br><span class="line">  - 变量</span><br><span class="line">  - register</span><br><span class="line">  - ansible_facts，对于 fact，大多数都是 String，作为数字进行比较前应当先经过 filter 转换</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只针对 RedHat 主机执行操作</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test01</span></span><br><span class="line">  <span class="attr">temlpate:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">template.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/test.txt</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">is</span> <span class="string">search(&quot;redhat&quot;,</span> <span class="string">ignorecase=&#x27;true&#x27;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多个条件</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test01</span></span><br><span class="line">  <span class="attr">temlpate:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">template.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/test.txt</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span> <span class="string">and</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;6&quot;</span><span class="string">)</span> <span class="string">or</span> <span class="string">(ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;Debian&quot;</span> <span class="string">and</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;7&quot;</span><span class="string">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 多个条件，列表</span><br><span class="line">- name: test01</span><br><span class="line">  ansible.builtin.command: /sbin/shutdown -t now</span><br><span class="line">  when:</span><br><span class="line">    - ansible_facts[&#x27;distribution&#x27;] == &quot;CentOS&quot;</span><br><span class="line">    - ansible_facts[&#x27;distribution_major_version&#x27;] | int &gt; &quot;6&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：迭代-loop"><a href="#知识点：迭代-loop" class="headerlink" title="知识点：迭代 loop"></a>知识点：迭代 loop</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 迭代，用在 task 上，实现以不同的参数值重复执行一个 task</span><br><span class="line">  - loop 会将一个 task 解析为多个 task，然后再执行</span><br><span class="line">  - 迭代变量的变量名固定使用 item</span><br><span class="line">  - 如果 task 上有 when 条件，则在解析之后的每一轮迭代 task，都会 host 检测条件</span><br><span class="line">    - 条件 true 的 host 上执行当前轮迭代 task</span><br><span class="line">    - 条件 false 不会影响到下一轮迭代的 task</span><br><span class="line"></span><br><span class="line">* 迭代的两种形式</span><br><span class="line">  - with_*，其中 &#x27;*&#x27; 表示使用的 lookup 函数</span><br><span class="line">  - loop，默认相当于 with_list，但仍可以指定其他的 lookup 函数</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>迭代类型</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">* with_items</span><br><span class="line">  - 最常用的循环</span><br><span class="line">  - 会对列表进行压平 flatten</span><br><span class="line"></span><br><span class="line">* with_list</span><br><span class="line">  - 返回列表的元素</span><br><span class="line">  - 不会对列表中的列表进行压平</span><br><span class="line"></span><br><span class="line">* with_dict</span><br><span class="line">  - 对字典进行拆解</span><br><span class="line">  - 字典的每一个属性，都会被拆解为一个小字典</span><br><span class="line">  - 通过 item.key、item.value 来引用值</span><br><span class="line"></span><br><span class="line">* with_nested</span><br><span class="line">* with_cartesian</span><br><span class="line">  - 两个或多个列表，组成笛卡尔积，对笛卡尔积的元素进行迭代</span><br><span class="line">  - 使用 item[0]、item[1] 来分别引用相应的列表中的元素</span><br><span class="line">  - 迭代的次数为 m*n*...，m、n 分别是每个列表的元素的个数</span><br><span class="line"></span><br><span class="line">* with_sequence</span><br><span class="line">  - 生成一个序列，然后进行迭代</span><br><span class="line">  - 需要指定参数，start、end、stride</span><br><span class="line"></span><br><span class="line">* with_random_choice</span><br><span class="line">  - 从列表中，随机选择一个元素，进行迭代，只迭代一次</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建多个文件</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/test-&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;.txt</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">testuser1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">testuser2</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">添加多个用户</span></span><br><span class="line">  <span class="attr">ansible.builtin.user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.name &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.passwd &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">with_list:</span></span><br><span class="line">  <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;user1&#x27;</span>, <span class="attr">passwd:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;123456&#x27; | password_hash(&#x27;sha512&#x27;) &#125;&#125;</span>&quot;</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&#x27;user2&#x27;</span>, <span class="attr">passwd:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; &#x27;654321&#x27; | password_hash(&#x27;sha512&#x27;) &#125;&#125;</span>&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">范例，with_nested，对多个用户授予多个库的权限</span></span><br><span class="line">  <span class="attr">community.mysql.mysql_user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item[0] &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">priv:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item[1] &#125;&#125;</span>.*:ALL&quot;</span></span><br><span class="line">    <span class="attr">append_privs:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;foo&quot;</span></span><br><span class="line">  <span class="attr">with_nested:</span></span><br><span class="line">  <span class="bullet">-</span> [ <span class="string">&#x27;alice&#x27;</span>, <span class="string">&#x27;bob&#x27;</span> ]</span><br><span class="line">  <span class="bullet">-</span> [ <span class="string">&#x27;clientdb&#x27;</span>, <span class="string">&#x27;employeedb&#x27;</span>, <span class="string">&#x27;providerdb&#x27;</span> ]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">范例，with_sequence</span></span><br><span class="line">  <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span> seconds to detonation&quot;</span></span><br><span class="line">  <span class="attr">with_sequence:</span> <span class="string">start=10</span> <span class="string">end=0</span> <span class="string">stride=-1</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">范例，with_random_choice</span></span><br><span class="line">  <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">with_random_choice:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;go through the door&quot;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;drink from the goblet&quot;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;press the red button&quot;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;do nothing&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：迭代高级"><a href="#知识点：迭代高级" class="headerlink" title="知识点：迭代高级"></a>知识点：迭代高级</h3><ol>
<li><strong>持续尝试</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 对迭代添加基于条件的持续尝试</span><br><span class="line">  - 对于迭代中的每一轮迭代 task，如果条件失败，则持续尝试进行此轮迭代 task</span><br><span class="line">  - 直到条件满足，或者尝试次数达到要求，才放弃并开始下一轮的迭代 task</span><br><span class="line"></span><br><span class="line">* 关键字</span><br><span class="line">  until</span><br><span class="line">  retries</span><br><span class="line">  delay</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例，持续尝试迭代</span></span><br><span class="line"><span class="comment"># 由于写了一个必然 false 的条件，实际每个 host 上执行的迭代 task 数量是 5*5=25</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Retry</span> <span class="string">a</span> <span class="string">task</span> <span class="string">until</span> <span class="string">a</span> <span class="string">certain</span> <span class="string">condition</span> <span class="string">is</span> <span class="string">met</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">with_list:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">  <span class="attr">until:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; now(false, &#x27;%Y&#x27;) | int is gt 4000 &#125;&#125;</span>&quot;</span>    <span class="comment"># 指定持续检测的条件</span></span><br><span class="line">  <span class="attr">retries:</span> <span class="number">5</span>                                          <span class="comment"># 指定迭代的最大次数</span></span><br><span class="line">  <span class="attr">delay:</span> <span class="number">10</span>                                           <span class="comment"># 指定每次尝试之间的间隔</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>迭代控制</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 通过 loop_control 关键字，可以添加对迭代进行控制的指令</span><br><span class="line">  - extend                启用扩展 loop 变量</span><br><span class="line">  - extended_allitems     启用扩展 loop 变量中的 allitems 变量</span><br><span class="line">  - label                 压缩输出报告中对迭代变量 item 进行填充的过程</span><br><span class="line">  - pause                 设置每一轮迭代之间的时间间隔</span><br><span class="line">  - index_var             将当前迭代的轮次保存到变量中</span><br><span class="line"></span><br><span class="line">* 扩展 loop 变量</span><br><span class="line">  - 介绍</span><br><span class="line">    - 特殊变量的一种</span><br><span class="line">    - 使用 loop_control 中的 extend: yes 指令来启用</span><br><span class="line">  - 关于 ansible_loop.allitems</span><br><span class="line">    - 若启用 ansible_loop.allitems 则会使内存用量急剧升高</span><br><span class="line">    - 使用 loop_control 中的 extended_allitems: false 指令来禁用</span><br><span class="line">  - 变量列表</span><br><span class="line">    ansible_loop.index      The current iteration of the loop. (1 indexed)</span><br><span class="line">    ansible_loop.index0     The current iteration of the loop. (0 indexed)</span><br><span class="line">    ansible_loop.revindex   The number of iterations from the end of the loop (1 indexed)</span><br><span class="line">    ansible_loop.revindex0  The number of iterations from the end of the loop (0 indexed)</span><br><span class="line">    ansible_loop.first      True if first iteration</span><br><span class="line">    ansible_loop.last       True if last iteration</span><br><span class="line">    ansible_loop.length     The number of items in the loop</span><br><span class="line">    ansible_loop.previtem   The item from the previous iteration of the loop. Undefined during the first iteration.</span><br><span class="line">    ansible_loop.nextitem   The item from the following iteration of the loop. Undefined during the last iteration.</span><br><span class="line">    ansible_loop.allitems   The list of all items in the loop</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">迭代控制范例</span></span><br><span class="line">  <span class="attr">module:</span></span><br><span class="line">    <span class="attr">arg1:</span> <span class="string">XXXX</span></span><br><span class="line">    <span class="attr">arg2:</span> <span class="string">XXXX</span></span><br><span class="line">  <span class="attr">loop:</span> <span class="string">XXXX</span></span><br><span class="line">  <span class="attr">loop_control:</span></span><br><span class="line">    <span class="attr">label:</span> <span class="string">XXXX</span>           <span class="comment"># 压缩输出，在输出结果中 item 项打印为 &#x27;XXXX&#x27; 而不是真实参与迭代的数据结构</span></span><br><span class="line">    <span class="string">pause:3</span>               <span class="comment"># 每一轮迭代之间间隔 3 秒</span></span><br><span class="line">    <span class="attr">index_var:</span> <span class="string">var</span>        <span class="comment"># 将当前迭代的轮次保存到变量中</span></span><br><span class="line">    <span class="attr">extend:</span> <span class="literal">yes</span>           <span class="comment"># 启用扩展 loop 变量</span></span><br><span class="line">    <span class="attr">extended_allitems:</span> <span class="literal">no</span> <span class="comment"># 启用 ansible_loop.allitems 变量</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>嵌套迭代</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 只发生在使用 include_tasks 来从外部 playbook 文件中加载 task 的情况</span><br><span class="line">  - 由于 ansible 的迭代变量固定为 item，故在 inner 中 outer 的 item 变量会被覆盖掉，因此要想办法保存 outer 的 item 变量</span><br><span class="line">  - 和角色相关，故暂不整理</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">inner.yml</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">loop_control:</span></span><br><span class="line">    <span class="attr">loop_var:</span> <span class="string">outer_item</span>                <span class="comment"># main.yml 中的 item 的值保存到 outer_item 变量中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inner.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">outer</span> <span class="string">and</span> <span class="string">inner</span> <span class="string">items</span></span><br><span class="line">  <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;outer: <span class="template-variable">&#123;&#123; outer_item &#125;&#125;</span>, inner: <span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span>   <span class="comment"># 在 inner.yml 中，通过 outer_item 变量来使用 main.yml 中的 item 的值</span></span><br><span class="line">  <span class="attr">loop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">a</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">b</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">c</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：触发器-handler"><a href="#知识点：触发器-handler" class="headerlink" title="知识点：触发器 handler"></a>知识点：触发器 handler</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 触发器，用来基于 chenged=yes 来触发某个 task</span><br><span class="line">  - 只有当某个 task 造成了修改，即返回 changed 状态，才执行指定的 handler task</span><br><span class="line">  - handler task 并不是被触发后立刻执行，而是在所有常规的 task 都执行结束后，才开始执行被触发的 handler task</span><br><span class="line"></span><br><span class="line">* notify 关键字</span><br><span class="line">  - List，在 task 中指定要触发的 handler task</span><br><span class="line">  - 可以是 task name</span><br><span class="line">  - 可以是一段字符串，即主题 topic</span><br><span class="line"></span><br><span class="line">* handlers 关键字</span><br><span class="line">  - List，编写 handler task</span><br><span class="line">  - handler task 的执行顺序是按照在 handlers 中的顺序执行，而不是被触发的顺序</span><br><span class="line"></span><br><span class="line">* listen 关键字</span><br><span class="line">  - List，在 handler task 中，指定 handler task 监听的主题 topic</span><br><span class="line">  - 当 notify 触发了 topic 之后，所有 listen 此 topic 的 handler task 都被触发</span><br><span class="line">  - listen 的使用使触发多个 handler task 的编写变得简单</span><br><span class="line">  - 注意，topic 的字符串必须手动指定，不能使用 template</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装和启动 httpd</span></span><br><span class="line"><span class="comment"># 在 &quot;config file&quot; task 中，如果配置文件发生变更，则通过 notify 重启 httpd 服务</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/tmp/httpd.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/httpd/conf</span></span><br><span class="line">  <span class="attr">notify:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">check</span> <span class="string">httpd</span> <span class="string">process</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">process</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">killall</span> <span class="number">-0</span> <span class="string">httpd</span> <span class="string">&amp;&gt;</span> <span class="string">/tmp/httpd.log</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-4-playbook-执行"><a href="#2-4-playbook-执行" class="headerlink" title="2.4 playbook 执行"></a>2.4 playbook 执行</h2><hr>
<h3 id="知识点：playbook-执行"><a href="#知识点：playbook-执行" class="headerlink" title="知识点：playbook 执行"></a>知识点：playbook 执行</h3><ol>
<li><strong>playbook 的执行</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 默认情况下 playbook 的执行过程</span><br><span class="line">  1. 对 hosts 中指定的所有主机执行所有 paly 的所有 task</span><br><span class="line">    - 先对所有主机执行一个 task</span><br><span class="line">    - 当此 task 在所有主机上都执行结束后，ansible 才开始下一个 task 的执行</span><br><span class="line">  2. 若在一个 task 中，某个 host 执行失败，即返回了 failed 或 unreachable 等状态</span><br><span class="line">    - ansible 会将此 host 从活跃主机池 active host pool 中移除</span><br><span class="line">    - 后续的 task 不会再在此主机上执行，包括 handler task</span><br><span class="line"></span><br><span class="line">* 执行报告</span><br><span class="line">  - 在 playbook 执行结束后，会根据 play name、task name，在执行报告中进行分组，报告每个 task 在每个 host 的执行情况</span><br><span class="line">  - 在报告的末尾，会追加汇总信息，记录每个 task 的相应的执行状况对应的 host 数量</span><br><span class="line">  - 包括 ok、changed、unreachable、failed、skipped、rescued、ignored 等</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>执行模式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">* check mode</span><br><span class="line">  - 在 playbook 的执行中，不会对目标主机做任何修改</span><br><span class="line">  - 对于基于 refister 变量的 when 控制的 task，不会生成 output</span><br><span class="line">  - 此时执行报告中 changed 的含义为，如果发生修改则会有多少 host 会被修改</span><br><span class="line">  - 可以通过命令行的 -C 选项来指定</span><br><span class="line">  - 可以通过 chech_mode 关键字来是的</span><br><span class="line"></span><br><span class="line">* diff mode</span><br><span class="line">  - 如果对目标主机会有修改，则显示修改前和修改后的变化，如 replace、template 模块等</span><br><span class="line">  - 通常配合 check mode 一起使用</span><br><span class="line">  - 可以通过命令行的 -D 选项来指定</span><br><span class="line">  - 可以通过 diff_mode 关键字来是的</span><br><span class="line"></span><br><span class="line">* 模式的覆盖</span><br><span class="line">  - task 的 check_mode/diff_mode 关键字优先级最高，会覆盖 playbook 和命令行选项的 check_mode/diff_mode 设置</span><br><span class="line"></span><br><span class="line">* 相关变量</span><br><span class="line">  - ansible_check_mode，记录了当前是否是以 check mode 运行</span><br><span class="line">  - ansible_diff_mode，记录了当前是否是以 diff mode 运行</span><br><span class="line">  - 应用</span><br><span class="line">    - ignore_errors: &quot;&#123;&#123; ansible_check_mode &#125;&#125;&quot;，可以让在 check_mode 中不要输出错误信息</span><br><span class="line"></span><br><span class="line">* start-at-task</span><br><span class="line">  - 使用命令行选项 --start-at-task=&quot;TaskName&quot;，可以指导 playbook 从指定的 task 开始执行</span><br><span class="line"></span><br><span class="line">* Step mode</span><br><span class="line">  - 使用命令行选项 --step，可以以交互的方式执行 playbook，针对每一个 task 进行确认</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>远程环境变量</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 使用 environment 关键字，可以为 task 设置在远程主机上执行命令时的环境变量</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  environment:</span><br><span class="line">    http_proxy: http://proxy.bos.example.com:8080</span><br><span class="line"></span><br><span class="line">* 可重复使用的方式</span><br><span class="line">  vars:</span><br><span class="line">    env_vars:</span><br><span class="line">      http_proxy: http://proxy.bos.example.com:8080</span><br><span class="line">      https_proxy: http://proxy.bos.example.com:8081</span><br><span class="line">  environment: &quot;&#123;&#123; env_vars &#125;&#125;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：playbook-标签-tag"><a href="#知识点：playbook-标签-tag" class="headerlink" title="知识点：playbook 标签 tag"></a>知识点：playbook 标签 tag</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 使用标签，可以在执行 playbook 时，只执行某些 task 或跳过某些 task，而不是整个 playbook</span><br><span class="line"></span><br><span class="line">* tags 关键字</span><br><span class="line">  - Play 层、task 层</span><br><span class="line">  - List，标签列表，为 play 或 task 设置标签</span><br><span class="line"></span><br><span class="line">* --tags</span><br><span class="line">* --skip-tags</span><br><span class="line">  - 命令行选项，用来进行基于标签的执行控制，也是基于标签的执行控制的唯一方式</span><br><span class="line">  --tags Tag          仅执行具有某个标签的 task</span><br><span class="line">  --skip-tags Tag     不执行具有某个标签的 task</span><br><span class="line">  --tags [tag1, tag2] 指定多个标签，or 逻辑，只要 task 有其中一个标签就执行</span><br><span class="line">  --tags all          执行所有 task，不管是否有标签</span><br><span class="line">  --tags tagged       仅执行具有标签的 task，不管是什么标签</span><br><span class="line">  --tags untagged     仅执行没有标签的 task</span><br><span class="line"></span><br><span class="line">* --list-tags</span><br><span class="line">  - 命令行选项，用来查看 playbook 中有哪些 tag</span><br><span class="line"></span><br><span class="line">* --list-tasks</span><br><span class="line">  - 命令行选项，用来查看 playbook 中有哪些 task</span><br><span class="line">  - 配合 -tags Tag 或 --skip-tags Tag 一起使用时，可以查看某个标签下有哪些 task</span><br><span class="line"></span><br><span class="line">* always 和 never 标签</span><br><span class="line">  - ansible 的两个保留标签</span><br><span class="line">  - always 标签的 task，在任何情况下都会执行，除非显式的指定 --skip-tags always</span><br><span class="line">  - never 标签的 task，在任何情况选都不执行，除非显式的指定 --tags never</span><br><span class="line"></span><br><span class="line">* TAGS_RUN</span><br><span class="line">* TAGS_SKIP</span><br><span class="line">  - 配置项，用来配置默认运行的标签或默认跳过的标签</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装和启动</span> <span class="string">httpd，其中设置</span> <span class="string">conf</span> <span class="string">标签</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">web-servers</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">分发配置文件，并且设置</span> <span class="string">conf</span> <span class="string">标签</span></span><br><span class="line">    <span class="attr">copy:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">/tmp/httpd.conf</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/httpd/conf</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">process</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">conf</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">process</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">killall</span> <span class="number">-0</span> <span class="string">httpd</span> <span class="string">&amp;&gt;</span> <span class="string">/tmp/httpd.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅执行 conf 标签的 task</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">httpd.yml</span> <span class="string">-t</span> <span class="string">conf</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：playbook-执行控制"><a href="#知识点：playbook-执行控制" class="headerlink" title="知识点：playbook 执行控制"></a>知识点：playbook 执行控制</h3><ol>
<li><strong>执行策略 strategy</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 执行策略，是 ansible 运行 playbook 中的 task 的方式</span><br><span class="line">  - 执行策略以 strategy Plugin 的方式存在</span><br><span class="line">  - 使用 strategy 关键字来更改 playbook 的执行策略</span><br><span class="line"></span><br><span class="line">* linear strategy</span><br><span class="line">  - 默认的执行策略</span><br><span class="line">  - 以线性的方式执行 task，一个 task 执行结束后才可以执行之后的 task</span><br><span class="line"></span><br><span class="line">* free strategy</span><br><span class="line">  - 尽快执行</span><br><span class="line">  - linear 策略中，一个 task 必须在所有的 host 上都执行结束，才可以开始下一个 task 的执行</span><br><span class="line">  - free 则略，则是一个 host，只要一个 task 结束，就可以开始下一个 task 的执行，不管其他 host 上的执行情况</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>并行</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* forks</span><br><span class="line">  - 用来控制同一时间，一个 task 可以同时在多少个 host 上进行执行，默认 5 个</span><br><span class="line">  - 命令行选项 --focks 和配置项 forks 可以调整并发数量</span><br><span class="line"></span><br><span class="line">* throttle 关键字</span><br><span class="line">  - play 层、task 层</span><br><span class="line">  - 节流阀，在 forks 和 serial 的基础上，继续对 task 的并行数量进行限制</span><br><span class="line">  - throttle 的设置不会超过 forks 和 serial</span><br><span class="line">  - 典型应用场景，对于 playbook 的某一个 CPU-intensive task，额外设置 throttle</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>串行</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 纵向维度上对 play 的执行主机数量进行限制</span><br><span class="line">    - 默认情况下，ansible 会同时对所有 hosts 开始 play 的执行</span><br><span class="line">    - 设置串行，可以将 hosts 分批次 batch，每次只对一个批次的 hosts 运行 playbook</span><br><span class="line">    - 当一个批次中所有 hosts 都结束执行 play 后，才开始下一个批次的 hosts 的执行</span><br><span class="line">  - 典型应用场景，滚动升级</span><br><span class="line"></span><br><span class="line">* serial 关键字</span><br><span class="line">  - play 层</span><br><span class="line">  - 设置 batch 的 host 的数量</span><br><span class="line">  - 注意，serial 的设置是 play 层的</span><br><span class="line">  - ansibl 会自动设置每一个批次中 host 最少为 1 个</span><br><span class="line">  - 可用值</span><br><span class="line">    - 数量</span><br><span class="line">    - 百分比</span><br><span class="line">    - 列表，设置每一个批次的 hosts 数量，最后一个批次无论设置多少都会包含所有剩余的主机</span><br><span class="line"></span><br><span class="line">* run_once 关键字</span><br><span class="line">  - task 只在每一个 batch 的第一个 host 上执行</span><br><span class="line">  - result 和 fact 会 apply 到 batch 中所有的 hosts</span><br><span class="line">  - 如果想要 task 只在一个 host 上运行</span><br><span class="line">    - 添加 when: inventory_hostname == ansible_play_hosts_all[0] 的结构</span><br><span class="line">    - 只在 current play 的 hosts 中的第一个 host 上运行</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>委派</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 常规情况下，Ansible 的 task 是在 playbook 的 hosts 中的定义的主机上进行</span><br><span class="line">  - 所谓委派，就是将某个 task 在其他的机器上执行，比如其他的主机组、本地，甚至是不属于 inventory 的主机</span><br><span class="line"></span><br><span class="line">* delegate_to 关键字</span><br><span class="line">  - 指定委派的主机</span><br><span class="line">  - 格式：</span><br><span class="line">    delegate_to: 192.168.100.1</span><br><span class="line">    delegate_to: localhost</span><br><span class="line"></span><br><span class="line">* delegate_facts 关键字</span><br><span class="line">  - 对于 setup task，正常情况下，委派的任务收集的 fact 会被会被分配给原始主机，而不是被委派的主机</span><br><span class="line">  - 指定 delegate_facts 为 true，可以让 task 在执行时，使用的是被委派的主机的 fact</span><br><span class="line"></span><br><span class="line">* local_action</span><br><span class="line">  - delegate_to 的特殊用法，特指委派到 127.0.0.1，即 ansible 主机</span><br><span class="line">  - 用法不明确，不建议使用</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">将其他主机的</span> <span class="string">HOSTNAME</span> <span class="string">添加到</span> <span class="string">ansible</span> <span class="string">主机的</span> <span class="string">hosts</span> <span class="string">文件中</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/hosts</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>  <span class="template-variable">&#123;&#123;hostvars[item].HOSTNAME&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">insertafter:</span> <span class="string">EOF</span></span><br><span class="line">  <span class="attr">delegate_to:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">with_items:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_play_hosts &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：playbook-失败控制"><a href="#知识点：playbook-失败控制" class="headerlink" title="知识点：playbook 失败控制"></a>知识点：playbook 失败控制</h3><ol>
<li><strong>playbook 全局失败控制</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 默认情况下，除非一个 task 在所有的 host 都失败，否则失败 task 不会影响 playbook 的整体的执行，只会影响后续 task 的 host</span><br><span class="line">  - 以下关键字可以对此进行控制</span><br><span class="line"></span><br><span class="line">* any_errors_fatal 关键字</span><br><span class="line">  - paly 层，task 层</span><br><span class="line">  - Boolean，true 表示只要有一个 task 在一个 host 上执行失败，就终止 playbook 的执行，后续的 play 和 task 都不会再执行</span><br><span class="line">  - 主要用处是用来表示 fatal error</span><br><span class="line"></span><br><span class="line">* max_fail_percentage 关键字</span><br><span class="line">  - play 层</span><br><span class="line">  - 设置失败 task 的阈值，如果一个 task 失败的 host 超过此阈值，则认为此 task 整体失败，并终止 playbook 的执行</span><br><span class="line">  - 注意，必须大于阈值才会生效，等于阈值依然不认为 task 整体失败</span><br><span class="line">    - 例如有 10 台 host，如果希望 5 个 host 失败就终止 playbook，则阈值应设置为 49 而不是 50</span><br><span class="line"></span><br><span class="line">* 其他</span><br><span class="line">  - block 的 rescue 部分可以设置在退出 playbook 前执行 debug 来输出某些信息</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>task 执行失败控制</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 默认情况下，如果 task 在一个 host 上执行失败，则后续的 task 将不会在此 host 上运行</span><br><span class="line">  - 以下关键字可以对此进行控制</span><br><span class="line"></span><br><span class="line">* ignore_errors 关键字</span><br><span class="line">  - Boolean</span><br><span class="line">  - play 层、task 层</span><br><span class="line">  - 针对 task 的 faild 的情况</span><br><span class="line">  - 即使 host 某个 task 的状态为 failed，后续 task 会依然在此主机上执行</span><br><span class="line"></span><br><span class="line">* ignore_unreachable 关键字</span><br><span class="line">  - Boolean</span><br><span class="line">  - play 层、task 层</span><br><span class="line">  - 针对 task 的 unreachable 的情况</span><br><span class="line">  - 即使 host 某个 task 的状态为 unreachable，后续 task 会依然在此主机上执行</span><br><span class="line"></span><br><span class="line">* force_handlers 关键字</span><br><span class="line">  - Boolean</span><br><span class="line">  - play 层</span><br><span class="line">  - 针对 handler task</span><br><span class="line">  - 即使 host 在常规 task 的执行中失败，在执行 handler task 时依然在此 host 上执行</span><br><span class="line">  - 也可以使用 --force-handlers 命令行选项</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>task 执行结果判断</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 默认情况下，ansible 根据 task 执行的命令的 return code 来判断 task 是否 failed，非 0 则认为失败</span><br><span class="line">  - 以下关键字可以重新设置 ansible 判断 task 的执行状态的条件</span><br><span class="line">  - 对于多个条件，如果使用 List 来组织，即 [condition, Condition]，则表示多个条件之间为 and 的逻辑关系</span><br><span class="line"></span><br><span class="line">* failed_when 关键字</span><br><span class="line">  - task 层关键字</span><br><span class="line">  - 重新设置判断 task failed 的条件</span><br><span class="line">  - 常用用法，先 register 返回值，再根据返回值进行判断</span><br><span class="line"></span><br><span class="line">* changed_when 关键字</span><br><span class="line">  - task 层关键字</span><br><span class="line">  - 重新设置判断 task changed 的条件</span><br><span class="line">  - 注意，会影响到对 handler task 的触发</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：playbook-连接控制"><a href="#知识点：playbook-连接控制" class="headerlink" title="知识点：playbook 连接控制"></a>知识点：playbook 连接控制</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* ansible 的默认连接方式</span><br><span class="line">  - 使用 master 上运行 ansible 的用户，登录到所有的 remote 上并执行 task</span><br></pre></td></tr></table></figure></li>
<li><strong>ssh 连接</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* ControlMaster 和 ControlPersist</span><br><span class="line">  - ansible 的 ssh 连接默认开启了 ssh 的 ControlMaster 和 ControlPersist 这两个选项，以提高运行效率</span><br><span class="line">  - 可以在 ansible 配置文件中的 ssh_args 配置项中，设置这两个选项的配置，或添加其他的 ssh 选项</span><br><span class="line">  - 特别注意，当 ssh 复用 master 连接时，不会进行 ssh 的登录验证</span><br><span class="line">  - ControlMaster 选项</span><br><span class="line">    - 网络连接复用，在一个 network connection 上建立多个 ssh 会话</span><br><span class="line">    - 最先建立 network connection 的 ssh 会话被称为 master 会话</span><br><span class="line">    - 其他的 ssh 可以复用 master 会话的连接，不需要额外进行 ssh 的登录验证</span><br><span class="line">  - ControlPersist 选项</span><br><span class="line">    - 指定 master 会话的静默时间</span><br><span class="line">    - 当已经没有其他 ssh 存活时，master 会话不会立刻结束，而是在后台静默一段时间</span><br><span class="line">    - 静默期间，如果有新的需要建立，则 master 会话会立刻苏醒</span><br><span class="line">    - 如果静默期结束后，依然没有新的 ssh 会话建立，则此时 master 会话才结束，此时新建会话需要重新建立连接并进行 ssh 登录验证</span><br><span class="line">    - 设置为 no，则表示 master 会话立刻结束</span><br><span class="line"></span><br><span class="line">* host key 检查</span><br><span class="line">  - ansible 默认启用 ssh 的 host key 检查</span><br><span class="line">  - 配置项 host_key_checking=false 可以禁用 host key 检查</span><br><span class="line">  - 环境变量 ANSIBLE_HOST_KEY_CHECKING=False 也可以禁用 host key 检查</span><br><span class="line"></span><br><span class="line">* 密码登录</span><br><span class="line">  - 使用 -k、--ask-pass 命令行选项，可以为 ansible 指定 ssh 登录时使用的密码</span><br><span class="line">  - 密码是全局级别的，即针对所有的 host 只能使用一个密码</span><br></pre></td></tr></table></figure></li>
<li><strong>连接控制变量 Connection Variable</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 特殊变量的一种，可以对连接行为进行控制</span><br><span class="line">  - 常用，写在 Inventory 中，可以实现对不同的 host 使用不同的 password、private_key_file</span><br><span class="line"></span><br><span class="line">* 基础设置</span><br><span class="line">  - ansible_host</span><br><span class="line">  - ansible_port</span><br><span class="line">  - ansible_user</span><br><span class="line">  - ansible_password</span><br><span class="line"></span><br><span class="line">* 远程主机环境</span><br><span class="line">  - ansible_shell_type</span><br><span class="line">  - ansible_shell_executable</span><br><span class="line">  - ansible_python_interpreter</span><br><span class="line">  - ansible_*_interpreter</span><br><span class="line"></span><br><span class="line">* 权限升级相关</span><br><span class="line">  - ansible_become、ansible_sudo、ansible_su</span><br><span class="line">  - ansible_become_user、ansible_sudo_user、ansible_su_user</span><br><span class="line">  - ansible_become_password、ansible_sudo_password、ansible_su_password</span><br><span class="line">  - ansible_become_method</span><br><span class="line">  - ansible_become_exe、ansible_sudo_exe、ansible_su_exe</span><br><span class="line">  - ansible_become_flags、ansible_sudo_flags、ansible_su_flags</span><br><span class="line"></span><br><span class="line">* SSH 相关</span><br><span class="line">  - ansible_ssh_private_key_file</span><br><span class="line">  - ansible_ssh_common_args</span><br><span class="line">  - ansible_sftp_extra_args</span><br><span class="line">  - ansible_scp_extra_args</span><br><span class="line">  - ansible_ssh_extra_args</span><br><span class="line">  - ansible_ssh_pipelining</span><br><span class="line">  - ansible_ssh_executable</span><br></pre></td></tr></table></figure></li>
<li><strong>权限升级 privilege escalation</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 权限升级，即在登录到 remote 上后，以 sudo 的方式来实际执行命令</span><br><span class="line"></span><br><span class="line">* Become Plugin</span><br><span class="line">  - ansible 支持各种权限升级的方法，以 Become Plugin 的方式存在</span><br><span class="line">  - 使用 become_method 关键字/配置项用来是定使用的 Become Plugin</span><br><span class="line">  - 默认是使用 sudo，可以在配置文件中更改</span><br><span class="line"></span><br><span class="line">* 关键字</span><br><span class="line">  - become</span><br><span class="line">  - become_user</span><br><span class="line">  - become_method</span><br><span class="line">  - become_flags</span><br><span class="line"></span><br><span class="line">* 命令行选项</span><br><span class="line">  -b, --become</span><br><span class="line">  --become-user</span><br><span class="line">  -K, --ask-become-pass</span><br></pre></td></tr></table></figure></li>
<li><strong>non-ssh 连接</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* ansible_connection</span><br><span class="line">  - 特殊变量，控制 ansible 建立连接的方式</span><br><span class="line">  - 变量值 smart、ssh、paramiko，都是采用 ssh 连接</span><br><span class="line">  - 变量值 local、docker 则是采用 non-ssh 连接，连接到 localhost 或 local docker</span><br><span class="line"></span><br><span class="line">* 当采用 docker 连接时，支持以下连接控制变量</span><br><span class="line">  - ansible_host    The name of the Docker container to connect to.</span><br><span class="line">  - ansible_user    The user name to operate within the container. The user must exist inside the container.</span><br><span class="line">  - ansible_become  If set to true the become_user will be used to operate within the container.</span><br><span class="line">  - ansible_docker_extra_args</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="2-5-角色"><a href="#2-5-角色" class="headerlink" title="2.5 角色"></a>2.5 角色</h2><hr>
<h3 id="知识点：导入"><a href="#知识点：导入" class="headerlink" title="知识点：导入"></a>知识点：导入</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 导入，可以将一个超级大的 playbook 文件分成一个主文件和多个小文件，在主文件中导入小文件</span><br><span class="line"></span><br><span class="line">* 动态和静态</span><br><span class="line">  - 导入分为动态和静态</span><br><span class="line">  - include_XXX 都是代表动态，动态是指在 runtime 阶段导入。All include* statements are processed as they are encountered during the execution of the playbook.</span><br><span class="line">  - import_XXX 都是代表静态，静态是指在 parsing 阶段导入。All import* statements are pre-processed at the time playbooks are parsed.</span><br><span class="line">  - 动态导入的优点</span><br><span class="line">    1. 如果 include_XXX 是写在 loop 中，则 loop 的每次迭代都会执行一次 include</span><br><span class="line">  - 静态导入的优点</span><br><span class="line">    1. 诸如 &quot;--list-tags&quot;、&quot;--list-tasks&quot;，静态可以显示出来，动态无法显示出来</span><br><span class="line">    2. 主文件无法 notify 写在动态导入的文件中的 handler</span><br><span class="line">  - 静态导入的缺点</span><br><span class="line">    1. When using variables for the target file or role name, variables from inventory sources (host/group vars, etc.) cannot be used.</span><br><span class="line">    2. Handlers using import* will not be triggered when notified by their name, as importing overwrites the handler’s named task with the imported task list.</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>关键字</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import_tasks – Import a task list</span><br><span class="line">import_playbook – Import a playbook</span><br><span class="line">import_role – Import a role into a play</span><br><span class="line"></span><br><span class="line">include – Include a play or task list</span><br><span class="line">include_role – Load and execute a role</span><br><span class="line">include_tasks – Dynamically include a task list</span><br><span class="line">include_vars – Load variables from files, dynamically within a task</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：角色-role"><a href="#知识点：角色-role" class="headerlink" title="知识点：角色 role"></a>知识点：角色 role</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 角色，是 ansible 提供的一种，基于文件系统的目录结构，自动动态加载各种 task_list、var_file、handlers 的结构</span><br><span class="line">  - 将相应的文件放到固定的 name 的子目录中，ansible 在运行时会自动加载其中的内容，无需在 playbook 中手动指定导入操作</span><br><span class="line">  - 角色的作用，是用来实现复杂目的，在运维复杂的环境可以减少重复工作</span><br><span class="line">  - 用于结构化、层次化的组织 playbook</span><br><span class="line"></span><br><span class="line">* main.yml</span><br><span class="line">  - 每一个子目录中，都必须有一个 main.yml 文件，用来 include/import 相同目录下的其他文件的内容，也可以在其中直接定义相关的内容</span><br><span class="line"></span><br><span class="line">* 角色的组织</span><br><span class="line">  - 将变量文件、任务文件、模版文件分别放在单独的目录中，在 playbook 中 include 相应的文件即可</span><br><span class="line"></span><br><span class="line">* 角色的存放目录</span><br><span class="line">  - ~/.ansible/roles</span><br><span class="line">  - /etc/ansible/roles</span><br><span class="line">  - /usr/share/ansible/roles</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>调用角色</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 编写一个 playbook，在其中使用 roles 关键字，在其他指定 role list</span><br><span class="line">  - roles 关键字会调用同路径的 roles 目录下所编写的角色</span><br><span class="line">  - 支持使用字典，来在调用角色时向角色传递变量</span><br><span class="line">  - 支持使用 when 字句，在调用角色前进行判断</span><br><span class="line">  - 支持以在调用 role 时加标签，这样在执行 playbook 时可以指定标签执行</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>角色常见目录编排</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">* RoleName/</span><br><span class="line">  - 角色的目录，角色名取决于目录名</span><br><span class="line"></span><br><span class="line">* RoleName/tasks/</span><br><span class="line">* RoleName/tasks/main.yml</span><br><span class="line">* RoleName/tasks/XXXX.yml</span><br><span class="line">  - 存放具体的任务文件的目录</span><br><span class="line">  - main.yml</span><br><span class="line">    - 作为角色的总入口</span><br><span class="line">    - 在里面通过 include 其他的 task 文件来总体管理</span><br><span class="line">    - 每个 task 文件被 include 的顺序决定了的执行顺序</span><br><span class="line">  - XXXX.yml</span><br><span class="line">    - 其他的 task 文件</span><br><span class="line">    - 通常一个 task.yml 文件中只放一个或一类 task</span><br><span class="line">    - 一种用法为，一个 yml 文件中有多个 task，并且每一个 task 都做的是相同的事，只不过每一个都有一个 when 字句，以应对不同的情况</span><br><span class="line"></span><br><span class="line">* RoleName/files/</span><br><span class="line">  - 存放 copy 或 script 模块所用到的文件</span><br><span class="line">  - 调用时，直接写文件名即可</span><br><span class="line">  - 如果放在子目录中，则只写相对于 RoleName/files/ 的相对路径即可</span><br><span class="line"></span><br><span class="line">* RoleName/vars/</span><br><span class="line">* RoleName/vars/main.yml</span><br><span class="line">* RoleName/vars/XXXX.yml</span><br><span class="line">  - 存放变量 yml 文件</span><br><span class="line">  - main.yml</span><br><span class="line">    - 其中定义的变量可以在 task 中直接调用，不需要先 include</span><br><span class="line"></span><br><span class="line">* RoleName/handlers/</span><br><span class="line">* RoleName/handlers/main.yml</span><br><span class="line">* RoleName/handlers/XXXX.yml</span><br><span class="line">  - 存放 handler yml 文件</span><br><span class="line">  - main.yml</span><br><span class="line">    - 其中定义的 handler，可以在 task 中直接 notiry，不需要先 include</span><br><span class="line"></span><br><span class="line">* RoleName/templates/</span><br><span class="line">  - 存放模版 j2 文件</span><br><span class="line"></span><br><span class="line">* RoleName/defaults/</span><br><span class="line">  - 存放默认变量文件</span><br><span class="line">  - 默认变量的优先级比 vars 低</span><br><span class="line"></span><br><span class="line">* RoleName/meta/</span><br><span class="line">  -  定义当前角色的特殊设定及其依赖关系</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例一</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">host01</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="comment"># 直接调用角色</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="comment"># 字典传递变量</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">install</span></span><br><span class="line">  <span class="comment"># when 字句在调用角色前先判断</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">memcached</span></span><br><span class="line">    <span class="attr">aciton:</span> <span class="string">install</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution==&#x27;CentOS&#x27;</span> <span class="string">and</span> <span class="string">&#x27;ansible_distribution_major_version&#x27;</span> <span class="string">==</span> <span class="string">&#x27;7&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例二，带标签的 role 的调用</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="string">host01</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;web&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;db&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">install</span></span><br><span class="line">    <span class="attr">tag:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;nginx&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;web&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">memcached</span></span><br><span class="line">    <span class="attr">aciton:</span> <span class="string">install</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">ansible_distribution==&#x27;CentOS&#x27;</span> <span class="string">and</span> <span class="string">&#x27;ansible_distribution_major_version&#x27;</span> <span class="string">==</span> <span class="string">&#x27;7&#x27;</span></span><br><span class="line">    <span class="attr">tabs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;db&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;app&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">enable</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">service</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">os</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只调用标签为 db 和 app 的角色</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">playbook.yml</span> <span class="string">--tags=&#x27;db,</span> <span class="string">app&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例三，跨角色调用文件</span></span><br><span class="line"><span class="comment"># 可以在一个角色中，调用其他角色的 files 目录中的文件</span></span><br><span class="line"><span class="comment"># src 仍写相对路径，但相对路径的起点为 roles 目录</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">roles/roleXX/files/XXXX.xxx</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">XXXX</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>复杂范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 规划</span><br><span class="line">  - 使用角色安装 httpd</span><br><span class="line">  - 角色名为 httpd_install_role</span><br><span class="line"></span><br><span class="line">* 准备工作，创建角色的相关目录</span><br><span class="line">  mkdir -p ~/.ansible/roles/httpd_install_role/&#123;files,tasks,handlers&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一步，编写角色主文件 tasks/main.yml</span></span><br><span class="line"><span class="comment"># vim ~/.ansible/roles/httpd_install_role/tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Task 1，安装软件</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">install.yml</span></span><br><span class="line"><span class="comment"># Task 2，拷贝配置文件</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">config.yml</span></span><br><span class="line"><span class="comment"># Task 3，拷贝主页文件</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">homepage.yml</span></span><br><span class="line"><span class="comment"># Task 4，启动服务</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">service.yml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第二步，编写各个 task 的 yml 文件</span></span><br><span class="line"><span class="comment"># 编写 install.yml 文件</span></span><br><span class="line"><span class="comment"># vim ~/.ansible/roles/httpd_install_role/tasks/install.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写 config.yml 文件</span></span><br><span class="line"><span class="comment"># vim ~/.ansible/roles/httpd_install_role/tasks/config.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">httpd.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/httpd/conf/</span></span><br><span class="line">    <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写 homepage.yml 文件</span></span><br><span class="line"><span class="comment"># vim ~/.ansible/roles/httpd_install_role/tasks/homepage.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">homepage.html</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">homepage.html</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/var/www/html/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写 service.yml 文件</span></span><br><span class="line"><span class="comment"># vim ~/.ansible/roles/httpd_install_role/tasks/service.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第三步，编写触发器 yml 文件</span></span><br><span class="line"><span class="comment"># vim ~/.ansible/roles/httpd_install_role/handlers/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第四步，编写调用角色的 playbook</span></span><br><span class="line"><span class="comment"># vim role_httpd.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="string">host01</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">httpd_install_role</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：import-playbook"><a href="#知识点：import-playbook" class="headerlink" title="知识点：import_playbook"></a>知识点：import_playbook</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 在 playbook 中导入其他的 playbook</span><br><span class="line"></span><br><span class="line">* 限制</span><br><span class="line">  - Files with a list of plays can only be included at the top level. You cannot use this action inside a play.</span><br><span class="line"></span><br><span class="line">* 语法</span><br><span class="line">  - 没有参数，直接将文件名作为参数</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">the</span> <span class="string">first</span> <span class="string">play</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">play1</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Include</span> <span class="string">a</span> <span class="string">play</span> <span class="string">after</span> <span class="string">another</span> <span class="string">play</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">otherplays.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">otherplays_2.yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：import-tasks-和-include-tasks"><a href="#知识点：import-tasks-和-include-tasks" class="headerlink" title="知识点：import_tasks 和 include_tasks"></a>知识点：import_tasks 和 include_tasks</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 在 playbook 导入其他的 tasks 列表</span><br><span class="line">  - 通常放在 tasks 层，也可放在 play 层、handlers 层</span><br><span class="line">  - 指定的文件名，必须是一个 tasks 列表</span><br><span class="line">  - 在父层指定的变量，可以传递到 import_tasks 和 include_tasks 中</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - import_tasks 没有参数，直接将 filename 作为参数即可</span><br><span class="line">  - 以下的参数都是 include_tasks 的</span><br><span class="line"></span><br><span class="line">* file</span><br><span class="line">  - 指定文件名</span><br><span class="line"></span><br><span class="line">* apply</span><br><span class="line">  - Accepts a hash of task keywords (e.g. tags, become) that will be applied to the tasks within the include.</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">task1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Include</span> <span class="string">task</span> <span class="string">list</span> <span class="string">in</span> <span class="string">play</span></span><br><span class="line">    <span class="attr">include_tasks:</span> <span class="string">stuff.yaml</span></span><br><span class="line">    <span class="attr">vars:</span>                 <span class="comment"># vars 可以将变量传递给 import_tasks 和 include_tasks 中</span></span><br><span class="line">      <span class="attr">wp_user:</span> <span class="string">timmy</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># include_tasks 的 apply 用法</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">task1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Apply</span> <span class="string">tags</span> <span class="string">to</span> <span class="string">tasks</span> <span class="string">within</span> <span class="string">included</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">include_tasks:</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">install.yml</span></span><br><span class="line">      <span class="attr">apply:</span></span><br><span class="line">        <span class="attr">tags:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">install</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># include_tasks 放在 play 层</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Include</span> <span class="string">task</span> <span class="string">list</span> <span class="string">on</span> <span class="string">play</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">include_tasks:</span> <span class="string">install.yml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter03-Ansible-模块"><a href="#Chapter03-Ansible-模块" class="headerlink" title="Chapter03 Ansible 模块"></a>Chapter03 Ansible 模块</h1><hr>
<h2 id="3-1-基础模块"><a href="#3-1-基础模块" class="headerlink" title="3.1 基础模块"></a>3.1 基础模块</h2><hr>
<h3 id="知识点：ansible-builtin-ping"><a href="#知识点：ansible-builtin-ping" class="headerlink" title="知识点：ansible.builtin.ping"></a>知识点：ansible.builtin.ping</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 测试主机连通性</span><br><span class="line">  - 连接到远程主机上的 python，由其返回 &#x27;pong&#x27;</span><br><span class="line"></span><br><span class="line">* SEE ALSO</span><br><span class="line">  - For Windows targets, use the ansible.windows.win_ping module</span><br><span class="line">  - For Network targets, use the ansible.netcommon.net_ping module</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="string">from</span> <span class="string">an</span> <span class="string">Ansible</span> <span class="string">Playbook</span></span><br><span class="line">  <span class="attr">ansible.builtin.ping:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-pause"><a href="#知识点：ansible-builtin-pause" class="headerlink" title="知识点：ansible.builtin.pause"></a>知识点：ansible.builtin.pause</h3><hr>
<h3 id="知识点：ansible-builtin-debug"><a href="#知识点：ansible-builtin-debug" class="headerlink" title="知识点：ansible.builtin.debug"></a>知识点：ansible.builtin.debug</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在 playbook 执行的过程中打印内容</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - 打印表达式的结果</span><br><span class="line">  - 打印之前的 task 的返回值</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* msg</span><br><span class="line">  - 需要打印的内容</span><br><span class="line">  - 可以是任何类型，string、list、dict、复杂结构</span><br><span class="line"></span><br><span class="line">* var</span><br><span class="line">  - 输出一个变量的内容</span><br><span class="line">  - 通常与 msg 参数相斥</span><br><span class="line">  - 与 msg 参数的区别，变量名不需要加 &#x27;&#123;&#123; &#125;&#125;&#x27; 的格式</span><br><span class="line"></span><br><span class="line">* verbosity</span><br><span class="line">  - 设置 verbosity 级别，0-3</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">return</span> <span class="string">information</span> <span class="string">from</span> <span class="string">the</span> <span class="string">previous</span> <span class="string">task</span></span><br><span class="line">  <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">    <span class="attr">var:</span> <span class="string">result</span></span><br><span class="line">    <span class="attr">verbosity:</span> <span class="number">2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">the</span> <span class="string">gateway</span> <span class="string">for</span> <span class="string">each</span> <span class="string">host</span> <span class="string">when</span> <span class="string">defined</span></span><br><span class="line">  <span class="attr">ansible.builtin.debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">System</span> &#123;&#123; <span class="string">inventory_hostname</span> &#125;&#125; <span class="string">has</span> <span class="string">gateway</span> &#123;&#123; <span class="string">ansible_default_ipv4.gateway</span> &#125;&#125;</span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_default_ipv4.gateway</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-setup"><a href="#知识点：ansible-builtin-setup" class="headerlink" title="知识点：ansible.builtin.setup"></a>知识点：ansible.builtin.setup</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 收集远程主机的 fact 信息</span><br><span class="line">  - playbook 执行前默认先执行一次 setup 模块</span><br><span class="line">  - fact 信息通过各种变量，来标识远程主机的信息</span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* filter</span><br><span class="line">  - list / elements=string</span><br><span class="line">  - 对 fact 信息进行筛选，仅返回指定的 fact 信息</span><br><span class="line"></span><br><span class="line">* gather_subset</span><br><span class="line">  - list / elements=string</span><br><span class="line">  - 对 fact 信息进行筛选，仅返回指定的 subset 的 fact 信息</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">setup</span> <span class="string">filter</span> <span class="string">example</span>    <span class="comment"># 收集信息，只保留内存、处理器相关</span></span><br><span class="line">  <span class="attr">ansible.builtin.setup:</span></span><br><span class="line">    <span class="attr">filter:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*mem*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*processor*&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-template"><a href="#知识点：ansible-builtin-template" class="headerlink" title="知识点：ansible.builtin.template"></a>知识点：ansible.builtin.template</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - ansible 对模板功能的实现，以 template 文件为基础，创造内容不同的目标文件</span><br><span class="line">  - 对 template 文件的填充是在 ansible 主机上进行，在填充完成后再将最终文件发送到远程主机上</span><br><span class="line"></span><br><span class="line">* Jinja2</span><br><span class="line">  - template 文件支持所有的 Jinja2 语法，包括 &#123;% %&#125; 和 &#123;# #&#125;</span><br><span class="line">  - template 模块支持 Jinja2 的空白控制</span><br><span class="line"></span><br><span class="line">* template 文件</span><br><span class="line">  - template 文件必须使用 utf-8 编码</span><br><span class="line">  - template 文件的优先级</span><br><span class="line">    - ~/template/file</span><br><span class="line">    - pwd/file</span><br><span class="line"></span><br><span class="line">* template variable</span><br><span class="line">  - template 内置变量，可以用在 template 文件中，大多数是用来记录 template 文件本身的一些属性</span><br><span class="line">  - template_host       template 文件所在的主机的 hostname</span><br><span class="line">  - template_uid        template 文件的 owner 的 uid</span><br><span class="line">  - template_path       template 文件的 path</span><br><span class="line">  - template_fullpath   template 文件的 absolute path</span><br><span class="line">  - template_destpath   is the path of the template on the remote system (added in 2.8).</span><br><span class="line">  - template_run_date   is the date that the template was rendered.</span><br><span class="line">  - ansible_managed     contains a string which can be used to describe the template name, host, modification time of the template file and the owner uid. (configurable via the defaults section of ansible.cfg)</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - 最常用的场景，生成不同的配置文件</span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">* src</span><br><span class="line">  - required，指定模版文件的存放位置</span><br><span class="line">  - 如果指定的是相对路径，则会尝试在 pwd/、pwd/templates/ 下搜索文件</span><br><span class="line"></span><br><span class="line">* dest</span><br><span class="line">  - 目标主机上存放生成的文件的位置</span><br><span class="line"></span><br><span class="line">* owner</span><br><span class="line">* group</span><br><span class="line">* mode</span><br><span class="line">  - 设置目标文件的拥有者、组、权限</span><br><span class="line"></span><br><span class="line">* force</span><br><span class="line">  - boolean</span><br><span class="line"></span><br><span class="line">* backup</span><br><span class="line">  - boolean，是否对目标文件创建备份文件</span><br><span class="line"></span><br><span class="line">* trim_blocks</span><br><span class="line">  - boolean，默认 true，在进行模板填充时是否开启 trim_blocks 功能</span><br><span class="line"></span><br><span class="line">* lstrip_blocks</span><br><span class="line">  - boolean，默认 false，在进行模板填充时是否开启 lstrip_blocks 功能</span><br><span class="line"></span><br><span class="line">* output_encoding</span><br><span class="line">  - String，指定最终文件的 encoding，默认 utf-8</span><br><span class="line"></span><br><span class="line">* block_start_string、block_end_string</span><br><span class="line">* comment_start_string、comment_end_string</span><br><span class="line">* variable_start_string、variable_end_string</span><br><span class="line">  - 对 Jinja2 格式进行微调</span><br><span class="line">  - 不要乱动</span><br></pre></td></tr></table></figure></li>
<li><strong>基础范例一</strong><br><em>模版文件 &#x2F;tmp&#x2F;template.j2</em><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">There are &#123;&#123; apple_number &#125;&#125; apples.</span><br></pre></td></tr></table></figure>
<em>playbook 文件</em><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ubuntu01</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">apple_number:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">ansible.builtin.template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">/tmp/template.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/tmp/apple.txt</span></span><br></pre></td></tr></table></figure></li>
<li><strong>基础范例二，对不同的主机生成不同的配置</strong><br><em>模版文件 &#x2F;tmp&#x2F;template.j2</em><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">There are &#123;&#123; appleconfig[ansible_facts.default_ipv4.address].count &#125;&#125; apples.</span><br><span class="line">Price are &#123;&#123; appleconfig[ansible_facts.default_ipv4.address].money &#125;&#125;.</span><br></pre></td></tr></table></figure>
<em>playbook 文件</em><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ubuntu02</span>    <span class="comment"># ip 为 192.168.31.162</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ubuntu03</span>    <span class="comment"># ip 为 192.168.31.163</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">appleconfig:</span></span><br><span class="line">      <span class="attr">192.168.31.162:</span> &#123; <span class="attr">count:</span> <span class="number">10</span>, <span class="attr">money:</span> <span class="number">100</span> &#125;</span><br><span class="line">      <span class="attr">192.168.31.163:</span> &#123; <span class="attr">count:</span> <span class="number">20</span>, <span class="attr">money:</span> <span class="number">200</span> &#125;</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">ansible.builtin.template:</span></span><br><span class="line">      <span class="attr">src:</span>  <span class="string">/tmp/template.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/tmp/apple.txt</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例，生成 nginx 配置，其中 worker 数量为 vcpu 数量 +2</strong><br><em>模版文件 template.j2</em><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...(nginx.conf 文件的原始内容)</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus + 2&#125;&#125; ;</span><br><span class="line">...(nginx.conf 文件的原始内容)</span><br></pre></td></tr></table></figure>
<em>playbook 文件</em><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">template.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">trim_blocks:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">lstrip_blocks:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例，生成 nginx 配置，其中使用 for 标签来添加多个监听端口</strong><br><em>模版文件 template.j2</em><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...(nginx.conf 文件的原始内容)</span><br><span class="line">&#123;% for listen_port in nginx_ports %&#125;</span><br><span class="line">  listen &#123;&#123; listen_port &#125;&#125; ;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">...(nginx.conf 文件的原始内容)</span><br></pre></td></tr></table></figure>
<em>playbook 文件</em><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">nginx_ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">template.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">trim_blocks:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">lstrip_blocks:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例，生成 nginx 配置，其中使用 if 标签来只针对存在的 server_name 生成 server_name 配置</strong><br><em>模版文件 template.j2</em><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...(nginx.conf 文件的原始内容)</span><br><span class="line">&#123;% for vhost in nginx_vhosts %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen &#123;&#123; vhost.listen&#125;&#125; ;</span><br><span class="line">  &#123;% if vhost.server_name is defined %&#125;</span><br><span class="line">  server_name &#123;&#123; vhost.server_name &#125;&#125; ;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  root &#123;&#123; vhost.root &#125;&#125; ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">...(nginx.conf 文件的原始内容)</span><br></pre></td></tr></table></figure>
<em>playbook 文件</em><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">nginx_vhosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web1:</span></span><br><span class="line">      <span class="attr">listen:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">root:</span> <span class="string">&quot;/var/nginx/www/web1/&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web2:</span></span><br><span class="line">      <span class="attr">listen:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">root:</span> <span class="string">&quot;/var/nginx/www/web2/&quot;</span></span><br><span class="line">      <span class="attr">server_name:</span> <span class="string">&quot;web2.example.com&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web3:</span></span><br><span class="line">      <span class="attr">listen:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">root:</span> <span class="string">&quot;/var/nginx/www/web3/&quot;</span></span><br><span class="line">      <span class="attr">server_name:</span> <span class="string">&quot;web3.example.com&quot;</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">templates</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">template.j2</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">trim_blocks:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">lstrip_blocks:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-set-fact"><a href="#知识点：ansible-builtin-set-fact" class="headerlink" title="知识点：ansible.builtin.set_fact"></a>知识点：ansible.builtin.set_fact</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 在 play 的运行过程中设置变量</span><br><span class="line">  - 变量会在当前 play 的后续运行中持续生效</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* key_value</span><br><span class="line">  - 指定多个 key/value 对，来进行设置变量</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- name: 设置变量</span><br><span class="line">  ansible.builtin.set_fact:</span><br><span class="line">    var1: value1</span><br><span class="line">    var2: value2</span><br><span class="line">    var3: &quot;&#123;&#123; &#x27;value3&#x27; if bol_var is true else &#x27;value4&#x27; &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">- name: 只修改某一个主机的变量</span><br><span class="line">  ansible.builtin.set_fact:</span><br><span class="line">    var1: value1</span><br><span class="line">  when: inventory_hostname == &#x27;172.31.30.122&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-2-命令模块"><a href="#3-2-命令模块" class="headerlink" title="3.2 命令模块"></a>3.2 命令模块</h2><hr>
<h3 id="知识点：ansible-builtin-command"><a href="#知识点：ansible-builtin-command" class="headerlink" title="知识点：ansible.builtin.command"></a>知识点：ansible.builtin.command</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* ansible 的默认模块</span><br><span class="line"></span><br><span class="line">* 在远程主机上执行命令</span><br><span class="line"></span><br><span class="line">* 局限性较大，很多东西都不支持</span><br><span class="line">  - 不支持 $VAR 方式变量</span><br><span class="line">  - 不支持 &lt; &gt; 方式重定向</span><br><span class="line">  - 不支持 | 管道</span><br><span class="line">  - 不支持 ; &amp; 作业控制</span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="attr">chdir:</span> <span class="string">&lt;path&gt;</span>       <span class="comment"># 在远程主机上执行命令前，先切换到指定的目录下</span></span><br><span class="line">  <span class="attr">cmd:</span> <span class="string">&lt;string&gt;</span>       <span class="comment"># 具体要执行的命令</span></span><br><span class="line">  <span class="attr">creates:</span> <span class="string">&lt;path&gt;</span>     <span class="comment"># 如果某个文件不存在，则执行命令，如果文件已存在，则不执行命令，注意，并不是创建文件</span></span><br><span class="line">  <span class="attr">removes:</span> <span class="string">&lt;path&gt;</span>     <span class="comment"># 如果某个文件已存在，则执行命令，如果文件不存在，则不执行命令，与 creates 正好相反，注意，并不是删除文件</span></span><br></pre></td></tr></table></figure></li>
<li><strong>ad-hoc 范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动 vsftpd 服务</span></span><br><span class="line">ansible host1 -a &#x27;service vsftpd restart&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">chdir</span> 范例</span></span><br><span class="line">ansible host1 -a &#x27;chdir=/etc cat centos-release&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> removes 范例</span></span><br><span class="line">ansible host1 -a &#x27;chdir=/etc removes=/data/1.txt cat centos-release&#x27;</span><br></pre></td></tr></table></figure></li>
<li><strong>playbook 范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例一</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">host01</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span> <span class="string">module</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="attr">chdir:</span> <span class="string">/etc</span></span><br><span class="line">      <span class="attr">cmd:</span> <span class="string">cat</span> <span class="string">hosts</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 范例二</span></span><br><span class="line"><span class="comment"># free_from 方式</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">host01</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">command</span> <span class="string">module</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">cat</span> <span class="string">/etc/hosts</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-shell"><a href="#知识点：ansible-builtin-shell" class="headerlink" title="知识点：ansible.builtin.shell"></a>知识点：ansible.builtin.shell</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 与 command 类似，但适用性更广一些，可以支持与 $var 变量引用、重定向、管道、作业控制</span><br><span class="line"></span><br><span class="line">* 仍不适合复杂命令，如 awk 命令，解决办法为使用 script 模块</span><br><span class="line"></span><br><span class="line">* 支持 free_from 方式</span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shell:</span></span><br><span class="line">  <span class="attr">chdir:</span> <span class="string">&lt;path&gt;</span></span><br><span class="line">  <span class="attr">cmd:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">creates:</span> <span class="string">&lt;path&gt;</span></span><br><span class="line">  <span class="attr">removes:</span> <span class="string">&lt;path&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>ad-hoc 范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible host1 -m shell -a &#x27;echo $HOSTNAME; cat /etc/os-release | head -n 2&#x27;</span><br></pre></td></tr></table></figure></li>
<li><strong>playbook 范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">host01</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span> <span class="string">module</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">shell:</span></span><br><span class="line">      <span class="attr">chdir:</span> <span class="string">/etc</span></span><br><span class="line">      <span class="attr">cmd:</span> <span class="string">cat</span> <span class="string">hosts</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-script"><a href="#知识点：ansible-builtin-script" class="headerlink" title="知识点：ansible.builtin.script"></a>知识点：ansible.builtin.script</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 将 master 上的 shell 脚本，放在远程主机上进行执行</span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="attr">chdir:</span> <span class="string">&lt;path&gt;</span>       <span class="comment"># 在远程主机上执行命令前，先切换到指定的目录下</span></span><br><span class="line">  <span class="attr">cmd:</span> <span class="string">&lt;string&gt;</span>       <span class="comment"># 指定本地脚本的位置，并可以追加参数</span></span><br><span class="line">  <span class="attr">creates:</span> <span class="string">&lt;string&gt;</span>   <span class="comment"># 文件开关，文件不存在才执行</span></span><br><span class="line">  <span class="attr">removes:</span> <span class="string">&lt;string&gt;</span>   <span class="comment"># 文件开关，文件存在才执行</span></span><br></pre></td></tr></table></figure></li>
<li><strong>ad-hoc 范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible host1 -m script -a &#x27;/tmp/1.sh&#x27;</span><br></pre></td></tr></table></figure></li>
<li><strong>playbook 范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">host01</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">script</span> <span class="string">module</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">shell:</span></span><br><span class="line">      <span class="attr">cmd:</span> <span class="string">/tmp/1.sh</span> <span class="string">XXX</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-3-文件管理"><a href="#3-3-文件管理" class="headerlink" title="3.3 文件管理"></a>3.3 文件管理</h2><hr>
<h3 id="知识点：ansible-builtin-file"><a href="#知识点：ansible-builtin-file" class="headerlink" title="知识点：ansible.builtin.file"></a>知识点：ansible.builtin.file</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 设置远程主机上的文件或目录的属性</span><br><span class="line">  - 新建文件、目录、链接</span><br><span class="line">  - 删除文件、目录、链接</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">* path</span><br><span class="line">  - 指定需要操作的文件或目录</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - 对目标文件或目录的一些基础操作</span><br><span class="line">  - file        &lt;-- 查看文件的属性信息</span><br><span class="line">  - touch       &lt;-- 创建文件，或者更新文件的 mtime</span><br><span class="line">  - directory   &lt;-- 递归创建目录，或者查看目录的属性信息</span><br><span class="line">  - absent      &lt;-- 删除文件或目录，删除链接，如果是删除目录，并且指定了 -D 的 diff 功能，则被删除的目录中的内容会并被打印出来</span><br><span class="line">  - link        &lt;-- 创建一个软链接</span><br><span class="line">  - hard        &lt;-- 创建一个硬链接</span><br><span class="line"></span><br><span class="line">* src</span><br><span class="line">  - 在创建链接时，指定源文件的位置</span><br><span class="line"></span><br><span class="line">* force</span><br><span class="line">  - 在创建软链接时，如果源文件不存在，或者链接已存在，强制创建</span><br><span class="line"></span><br><span class="line">* owner、group、mode</span><br><span class="line">  - 修改文件的 owner、group、mode</span><br><span class="line"></span><br><span class="line">* access_time、modification_time</span><br><span class="line">  - 修改文件的 atime、mtime</span><br><span class="line"></span><br><span class="line">* recurse</span><br><span class="line">  - 在修改目录的属性时，同时将目录下所有的内容的属性也一并修改</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建一个空文件</span></span><br><span class="line">  <span class="attr">ansible.builtin.file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/text.txt</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">删除一个文件</span></span><br><span class="line">  <span class="attr">ansible.builtin.file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/text.txt</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">修改目录及其所有内容的</span> <span class="string">owner</span></span><br><span class="line">  <span class="attr">ansible.builtin.file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/test</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">testuser</span></span><br><span class="line">    <span class="attr">recurse:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建一个软连接</span></span><br><span class="line">  <span class="attr">ansible.builtin.file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/root/bin/pyhton</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/usr/bin/python3</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">link</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-copy"><a href="#知识点：ansible-builtin-copy" class="headerlink" title="知识点：ansible.builtin.copy"></a>知识点：ansible.builtin.copy</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 将 master 上的文件或目录，复制到远程主机上</span><br><span class="line">  - 将远程主机的文件或目录，复制到远程主机的其他位置</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">* src</span><br><span class="line">  - master 上的文件的位置</span><br><span class="line">  - 如果 src 是目录，并且不是以 &#x27;/&#x27; 结尾，则表示整个目录及其所有内容都复制到远程主机</span><br><span class="line">  - 如果 src 是目录，并且以 &#x27;/&#x27; 结尾，则只将目录下的所有内容都复制到远程主机</span><br><span class="line"></span><br><span class="line">* remote_src</span><br><span class="line">  - boolean</span><br><span class="line">  - 指定 &quot;src&quot; 是在 master 上还是远程主机上</span><br><span class="line">  - 如果为 true，则相当于在每台远程主机上执行 &quot;cp SRC DEST&quot; 指令</span><br><span class="line"></span><br><span class="line">* content</span><br><span class="line">  - 不使用 master 上的文件，而是直接指定文件的内容，换行需要使用 \n</span><br><span class="line"></span><br><span class="line">* dest</span><br><span class="line">  - 远程主机上存放文件的位置</span><br><span class="line"></span><br><span class="line">* force</span><br><span class="line">  - 当有重复文件时，是否覆盖，默认为 yes</span><br><span class="line"></span><br><span class="line">* backup</span><br><span class="line">  - 是否进行备份</span><br><span class="line"></span><br><span class="line">* owner、group、mode</span><br><span class="line">  - 指定复制完成后文件的 owner、group、mode</span><br><span class="line"></span><br><span class="line">* directory_mode</span><br><span class="line">  - 在复制目录时，对子目录指定目录的权限</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">从</span> <span class="string">master</span> <span class="string">上复制一个文件到远程主机上</span></span><br><span class="line">  <span class="attr">ansible.builtin.copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/tmp/1.data</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/1.data</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-fetch"><a href="#知识点：ansible-builtin-fetch" class="headerlink" title="知识点：ansible.builtin.fetch"></a>知识点：ansible.builtin.fetch</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 将远程主机上的文件，复制到 master 上</span><br><span class="line">  - 会在 master 的本地位置上，为每一台远程主机单独创建一个子目录</span><br><span class="line">  - 目前只支持文件，不支持目录</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* dest</span><br><span class="line">  - master 上存放远程文件的位置</span><br><span class="line">  - 必须是一个目录</span><br><span class="line">  - 可以自动创建</span><br><span class="line"></span><br><span class="line">* src</span><br><span class="line">  - 远程主机上需要获取的文件</span><br><span class="line">  - 必须是一个 file，不能是目录</span><br><span class="line">  - 不支持通配符写法</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">获取每台远程主机的</span> <span class="string">zookeeper</span> <span class="string">用户的公钥文件到</span> <span class="string">master</span> <span class="string">上</span></span><br><span class="line">  <span class="attr">ansible.builtin.fetch:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/home/zookeeper/.ssh/id_rsa.pub</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/zookeeper_pub/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-unarchive"><a href="#知识点：ansible-builtin-unarchive" class="headerlink" title="知识点：ansible.builtin.unarchive"></a>知识点：ansible.builtin.unarchive</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 将 master 主机上的压缩包，解压到远程主机上</span><br><span class="line">  - 将远程主机上的压缩包，解压到远程主机的某个目录上</span><br><span class="line">  - 解压时不需要指定压缩包的压缩方式，如 gzip、bzip 等，ansible 会自动判断</span><br><span class="line"></span><br><span class="line">* 注意</span><br><span class="line">  - 虽然 unarchive 模块可以自动将 master 上的压缩包复制到远程主机上再解压，但仍推荐先使用 copy 将压缩包复制到远程主机上以后，再使用 unarchive 模块进行解压</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* remote_src</span><br><span class="line">  - 指示压缩包是否在 master 上，yes 代表压缩包在远程主机上，no 代表压缩包在 master 上，默认为 no</span><br><span class="line"></span><br><span class="line">* copy</span><br><span class="line">  - 指示压缩包是否在 master 上，yes 代表压缩包在 master 上，no 代表压缩包在远程主机上，与 remote_src 功能相同但互斥，可用但已废弃</span><br><span class="line"></span><br><span class="line">* src</span><br><span class="line">  - 指定压缩包的位置，并且当 remote_src=yes 时支持 &#x27;http://&#x27; 或 &#x27;ftp://&#x27; 方式来从网络上先下载文件再解压</span><br><span class="line"></span><br><span class="line">* dest</span><br><span class="line">  - 指定解压的路径</span><br><span class="line"></span><br><span class="line">* creates</span><br><span class="line">  - 如果目标路径已存在，则不执行操作</span><br><span class="line"></span><br><span class="line">* keep_newer</span><br><span class="line">  - 如果目标路径中存在比较新的文件，则不覆盖这些文件</span><br><span class="line"></span><br><span class="line">* mode</span><br><span class="line">  - 指定解压后文件的权限。</span><br><span class="line">  - 采用 755 方式</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">将</span> <span class="string">master</span> <span class="string">上的一个压缩包在远程主机上解压</span></span><br><span class="line">  <span class="attr">src:</span> <span class="string">/tmp/test.tar.gz</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">/tmp/</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署</span> <span class="string">jdk</span> <span class="string">(1/5)</span> <span class="string">复制</span> <span class="string">jdk</span> <span class="string">压缩包到远程主机</span></span><br><span class="line">  <span class="attr">ansible.builtin.copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">jdk-8u371-linux-x64.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/usr/local/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署</span> <span class="string">jdk</span> <span class="string">(2/5)</span> <span class="string">在远程主机上解压压缩包</span></span><br><span class="line">  <span class="attr">ansible.builtin.unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/usr/local/jdk-8u371-linux-x64.tar.gz</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/usr/local/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署</span> <span class="string">jdk</span> <span class="string">(3/5)</span> <span class="string">修改</span> <span class="string">jdk</span> <span class="string">目录权限</span></span><br><span class="line">  <span class="attr">ansible.builtin.file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/usr/local/jdk1.8.0_371</span> </span><br><span class="line">    <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">755</span></span><br><span class="line">    <span class="attr">recurse:</span> <span class="literal">true</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署</span> <span class="string">jdk</span> <span class="string">(4/5)</span> <span class="string">创建</span> <span class="string">jdk</span> <span class="string">软链</span></span><br><span class="line">  <span class="attr">ansible.builtin.file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/usr/local/jdk</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/usr/local/jdk1.8.0_371</span> </span><br><span class="line">    <span class="attr">state:</span> <span class="string">link</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">部署</span> <span class="string">jdk</span> <span class="string">(5/5)</span> <span class="string">添加</span> <span class="string">jdk</span> <span class="string">环境变量</span></span><br><span class="line">  <span class="attr">ansible.builtin.lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/profile</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">insertafter:</span> <span class="string">EOF</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;# jdk&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;export JAVA_HOME=/usr/local/jdk&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;export CLASSPATH=.:$JAVA_HOME/lib&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;export PATH=$JAVA_HOME/bin:$PATH&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：community-general-archive"><a href="#知识点：community-general-archive" class="headerlink" title="知识点：community.general.archive"></a>知识点：community.general.archive</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 作用</span><br><span class="line">  - 将远程主机上的文件或目录，进行打包压缩</span><br><span class="line">  - 注意，不会复制到 master 主机上</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* path</span><br><span class="line">  - 指定目标主机上需要打包和压缩的文件的绝对路径</span><br><span class="line">  - 可以是一个文件、目录、通配符、列表</span><br><span class="line"></span><br><span class="line">* dest</span><br><span class="line">  - 指定压缩文件的存放位置</span><br><span class="line">  - 如果 path 指向超过一个文件，则必须指定 dest</span><br><span class="line"></span><br><span class="line">* format</span><br><span class="line">  - 指定压缩的方式，默认 gz</span><br><span class="line">  - bz2</span><br><span class="line">  - gz</span><br><span class="line">  - tar</span><br><span class="line">  - xz</span><br><span class="line">  - zip</span><br><span class="line"></span><br><span class="line">* exclude_path</span><br><span class="line">  - 在打包时排除某些文件，可以是绝对路径、通配符、列表</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: Create a bz2 archive of a globbed path, while excluding specific dirnames</span><br><span class="line">  community.general.archive:</span><br><span class="line">    path:</span><br><span class="line">    - /path/foo/bar1/*</span><br><span class="line">    - /path/foo/bar2/*</span><br><span class="line">    dest: /path/file.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-find"><a href="#知识点：ansible-builtin-find" class="headerlink" title="知识点：ansible.builtin.find"></a>知识点：ansible.builtin.find</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 用来按照指定的标准(criteria)，在远程主机上搜索文件</span><br><span class="line">  - 多个参数指定的条件之间为 &quot;AND&quot; 逻辑</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">* paths (required)</span><br><span class="line">  - list / elements=string</span><br><span class="line">  - aliases: name, path</span><br><span class="line">  - 指定搜索的目标路径</span><br><span class="line"></span><br><span class="line">* recurse</span><br><span class="line">  - boolean</span><br><span class="line">  - true 表示，在搜索文件时，对于目标路径，递归搜索目录下的子目录</span><br><span class="line">  - 默认 false</span><br><span class="line"></span><br><span class="line">* depth</span><br><span class="line">  - integer</span><br><span class="line">  - 在递归搜索子目录时，指定最大的向下目录层级</span><br><span class="line">  - 仅在 &quot;recurse&quot; 参数为 ture 时有效</span><br><span class="line">  - 默认为 unlimited depth</span><br><span class="line"></span><br><span class="line">* patterns</span><br><span class="line">  - list / elements=string</span><br><span class="line">  - aliases: pattern</span><br><span class="line">  - 指定文件名搜索条件</span><br><span class="line">  - 针对文件的 basename 进行搜索，而不是文件的绝对路径</span><br><span class="line">  - 指定多个 pattern，则多个 pattern 之间为 &quot;OR&quot; 关系</span><br><span class="line">  - 使用 python regex pattern 或 shell glob pattern，取决于 &quot;use_regex&quot; 参数的设置</span><br><span class="line">  - 对于 shell glob pattern，pattern 只要匹配文件名的部分即可</span><br><span class="line">  - 对于 python regex pattern，pattern 需要与文件的 basename 完全匹配</span><br><span class="line">  - 默认匹配所用文件，即 &quot;*&quot; 或 &quot;.*&quot;</span><br><span class="line"></span><br><span class="line">* excludes</span><br><span class="line">  - list / elements=string</span><br><span class="line">  - aliases: exclude</span><br><span class="line">  - 指定文件名搜索条件</span><br><span class="line">  - 排除某些文件名，优先级高于 &quot;patterns&quot; 参数</span><br><span class="line">  - 使用 python regex pattern 或 shell glob pattern，取决于 &quot;use_regex&quot; 参数的设置</span><br><span class="line">  - 默认不排除任何文件</span><br><span class="line"></span><br><span class="line">* use_regex</span><br><span class="line">  - boolean</span><br><span class="line">  - ture 表示 patterns 参数中使用 python regex pattern</span><br><span class="line">  - false 表示 patterns 参数中使用 shell glob pattern</span><br><span class="line">  - 默认 false</span><br><span class="line"></span><br><span class="line">* age</span><br><span class="line">  - string</span><br><span class="line">  - 指定文件时间搜索条件</span><br><span class="line">  - 正 age，表示搜索时间大于等于此 age 的文件</span><br><span class="line">  - 负 age，表示搜索时间小于等于此 age 的文件</span><br><span class="line">  - 时间单位支持 seconds、minutes、hours、days、weeks，可以仅使用单位单词的首字母表示，如 1w</span><br><span class="line"></span><br><span class="line">* age_stamp</span><br><span class="line">  - string</span><br><span class="line">  - 指定 age 参数针对哪个时间属性进行计算</span><br><span class="line">  - 可选值：&quot;mtime&quot;(default)、&quot;atime&quot;、&quot;ctime&quot;</span><br><span class="line"></span><br><span class="line">* size</span><br><span class="line">  - string</span><br><span class="line">  - 指定文件大小搜索条件</span><br><span class="line">  - 只针对 file 有效，对于 dir 无效</span><br><span class="line">  - 正 size 表示搜索文件大小大于等于此 size 的文件</span><br><span class="line">  - 负 size 表示搜索文件大小小于等于此 size 的文件</span><br><span class="line">  - 大小单位使用字节，支持 b、k、m、g、t</span><br><span class="line"></span><br><span class="line">* file_type</span><br><span class="line">  - string</span><br><span class="line">  - 指定搜索的文件的类型</span><br><span class="line">  - 可选值：&quot;file&quot;(default)、&quot;directory&quot;、&quot;link&quot;、&quot;any&quot;</span><br><span class="line"></span><br><span class="line">* contains</span><br><span class="line">  - string</span><br><span class="line">  - 对文件进行内容的搜索</span><br><span class="line">  - 指定一段正则 pattern，仅返回包含此段正则的文件</span><br><span class="line">  - 仅在 file_type 为 &quot;file&quot; 时可用</span><br><span class="line"></span><br><span class="line">* read_whole_file</span><br><span class="line">  - boolean</span><br><span class="line">  - 在进行文件内容的搜索时，指定是否一次性将全部文件内容都读入到内存中</span><br><span class="line">  - ture 表示将文件全部读入到内存中，此时使用 re.search()</span><br><span class="line">  - false 表示一行一行的读取，此时使用 re.match()</span><br><span class="line">  - 默认 false</span><br><span class="line"></span><br><span class="line">* hidden</span><br><span class="line">  - boolean</span><br><span class="line">  - true 表示搜索结果中包含隐藏文件</span><br><span class="line">  - 默认 false</span><br><span class="line"></span><br><span class="line">* follow</span><br><span class="line">  - boolean</span><br><span class="line">  - true 表示返回值中，对于软连接的 path 进行 follow symlinks</span><br><span class="line">  - 默认 false</span><br><span class="line"></span><br><span class="line">* get_checksum</span><br><span class="line">  - boolean</span><br><span class="line">  - true 表示返回值中包含文件的 SHA1</span><br><span class="line">  - 默认 false</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>返回值</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* examined</span><br><span class="line">  - integer，记录查看的文件系统的数量</span><br><span class="line"></span><br><span class="line">* files</span><br><span class="line">  - list / elements=string，记录所有搜索成功搜索到的文件</span><br><span class="line">  - 范例：[&#123;&quot;...&quot;: &quot;...&quot;, &quot;checksum&quot;: &quot;16fac7be61a6e4591a33ef4b729c5c3302307523&quot;, &quot;mode&quot;: &quot;0644&quot;, &quot;path&quot;: &quot;/var/tmp/test1&quot;&#125;, &#123;&quot;...&quot;: &quot;...&quot;, &quot;path&quot;: &quot;/var/tmp/test2&quot;&#125;]</span><br><span class="line"></span><br><span class="line">* matched</span><br><span class="line">  - integer，记录搜索到的文件的数量</span><br><span class="line"></span><br><span class="line">* skipped_paths</span><br><span class="line">  - dictionary，记录跳过的 path 以及跳过的原因</span><br><span class="line">  - 范例：&#123;&quot;/laskdfj&quot;: &quot;&#x27;/laskdfj&#x27; is not a directory&quot;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">- name: Recursively find /tmp files older than 2 days</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /tmp</span><br><span class="line">    age: 2d</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: Recursively find /tmp files older than 4 weeks and equal or greater than 1 megabyte</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /tmp</span><br><span class="line">    age: 4w</span><br><span class="line">    size: 1m</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: Recursively find /var/tmp files with last access time greater than 3600 seconds</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /var/tmp</span><br><span class="line">    age: 3600</span><br><span class="line">    age_stamp: atime</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: Find /var/log files equal or greater than 10 megabytes ending with .old or .log.gz</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /var/log</span><br><span class="line">    patterns: &#x27;*.old,*.log.gz&#x27;</span><br><span class="line">    size: 10m</span><br><span class="line"></span><br><span class="line"># Note that YAML double quotes require escaping backslashes but yaml single quotes do not.</span><br><span class="line">- name: Find /var/log files equal or greater than 10 megabytes ending with .old or .log.gz via regex</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /var/log</span><br><span class="line">    patterns: &quot;^.*?\\.(?:old|log\\.gz)$&quot;</span><br><span class="line">    size: 10m</span><br><span class="line">    use_regex: yes</span><br><span class="line"></span><br><span class="line">- name: Find /var/log all directories, exclude nginx and mysql</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /var/log</span><br><span class="line">    recurse: no</span><br><span class="line">    file_type: directory</span><br><span class="line">    excludes: &#x27;nginx,mysql&#x27;</span><br><span class="line"></span><br><span class="line"># When using patterns that contain a comma, make sure they are formatted as lists to avoid splitting the pattern</span><br><span class="line">- name: Use a single pattern that contains a comma formatted as a list</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /var/log</span><br><span class="line">    file_type: file</span><br><span class="line">    use_regex: yes</span><br><span class="line">    patterns: [&#x27;^_[0-9]&#123;2,4&#125;_.*.log$&#x27;]</span><br><span class="line"></span><br><span class="line">- name: Use multiple patterns that contain a comma formatted as a YAML list</span><br><span class="line">  ansible.builtin.find:</span><br><span class="line">    paths: /var/log</span><br><span class="line">    file_type: file</span><br><span class="line">    use_regex: yes</span><br><span class="line">    patterns:</span><br><span class="line">      - &#x27;^_[0-9]&#123;2,4&#125;_.*.log$&#x27;</span><br><span class="line">      - &#x27;^[a-z]&#123;1,5&#125;_.*log$&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-4-文件编辑"><a href="#3-4-文件编辑" class="headerlink" title="3.4 文件编辑"></a>3.4 文件编辑</h2><hr>
<h3 id="知识点：ansible-builtin-lineinfile"><a href="#知识点：ansible-builtin-lineinfile" class="headerlink" title="知识点：ansible.builtin.lineinfile"></a>知识点：ansible.builtin.lineinfile</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 结束</span><br><span class="line">  - ansible 提供的文件编辑模块，以 line 为最小单位修改文件内容</span><br><span class="line">  - 整行插入、整行删除、整行替换</span><br><span class="line">  - 无法只修改一行内的部分内容</span><br><span class="line"></span><br><span class="line">* 注意</span><br><span class="line">  - 为了防止逻辑混淆，最好不要将 regexp、insertafter、insertbefore 这三个参数混用</span><br><span class="line"></span><br><span class="line">* 参数仅支持基础正则</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* path</span><br><span class="line">  - 指定要修改的文件</span><br><span class="line"></span><br><span class="line">* line</span><br><span class="line">  - 在新增行时，指定行的内容</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - 指定添加/删除行</span><br><span class="line">  - present / absent</span><br><span class="line"></span><br><span class="line">* backup</span><br><span class="line">  - 指定是否创建一个 backup 文件</span><br><span class="line"></span><br><span class="line">* regexp</span><br><span class="line">  - 使用正则来指定需要修改的行，与正则匹配的行会被替换</span><br><span class="line">  - 如果 state=present，则仅会对最后一个匹配行操作</span><br><span class="line">  - 如果 state=absent，则会删除所有的匹配行</span><br><span class="line"></span><br><span class="line">* insertafter</span><br><span class="line">  - 将 line 的内容插入某行之后，使用正则来查找行，对最后一个匹配行进行操作，可以使用特殊值 EOF</span><br><span class="line"></span><br><span class="line">* insertbefore</span><br><span class="line">  - 将 line 的内容插入谋行之前，使用正则来查找行，对最后一个匹配行进行操作，可以使用特殊值 BOF 表示文件的开头</span><br><span class="line"></span><br><span class="line">* firstmatch</span><br><span class="line">  - 对于 regexp、insertafter、insertbefore 三个参数，改为对第一个匹配行进行操作</span><br><span class="line"></span><br><span class="line">* backrefs</span><br><span class="line">  - 是否允许在 line 中使用回溯引用，只支持 regexp 参数</span><br><span class="line"></span><br><span class="line">* OTHERS</span><br><span class="line">  - FILE 模块的参数均支持</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">删除脚本中所有注释行</span></span><br><span class="line">  <span class="attr">ansible.builtin.lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/1.sh</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;^#&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">在文件第一行插入内容</span></span><br><span class="line">  <span class="attr">ansible.builtin.lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/1.sh</span></span><br><span class="line">    <span class="attr">insertbefore:</span> <span class="string">BOF</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;This is the first line&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">将</span> <span class="string">nginx</span> <span class="string">配置文件中，监听</span> <span class="number">8080</span> <span class="string">端口改为</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">ansible.builtin.lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;(.*)listen 8080&quot;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;\1listen 8081 ;&quot;</span></span><br><span class="line">    <span class="attr">backrefs:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">将</span> <span class="string">fstab</span> <span class="string">中</span> <span class="string">data12</span> <span class="string">上的设备修改为挂载到</span> <span class="string">data25</span></span><br><span class="line">  <span class="attr">ansible.builtin.lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/fstab</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;(.*)/data12(.*)&quot;</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;\1/data25\2&quot;</span></span><br><span class="line">    <span class="attr">backrefs:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-replace"><a href="#知识点：ansible-builtin-replace" class="headerlink" title="知识点：ansible.builtin.replace"></a>知识点：ansible.builtin.replace</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - ansible 提供的文件编辑模块，基于 pattern 替换文件的内容</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* path</span><br><span class="line">  - 指定要修改的文件</span><br><span class="line"></span><br><span class="line">* regexp</span><br><span class="line">  - 指定要修改的内容的 pattern，会对文件中所有与 pattern 匹配的内容都进行修改</span><br><span class="line"></span><br><span class="line">* replace</span><br><span class="line">  - 指定替换结果</span><br><span class="line"></span><br><span class="line">* backup</span><br><span class="line">  - 是否创建 backup 文件</span><br><span class="line"></span><br><span class="line">* after</span><br><span class="line">  - 指定一个正则 pattern，只有在此之后的文件内容会被修改，如果有多个匹配则以第一个为准</span><br><span class="line"></span><br><span class="line">* before</span><br><span class="line">  - 指定一个正则 pattern，只有在此之前的文件内容会被修改，如果有多个匹配则以第一个为准</span><br><span class="line"></span><br><span class="line">* OTHERS</span><br><span class="line">  - FILE 模块的参数均支持</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">注释掉</span> <span class="string">xml</span> <span class="string">文件中的某行</span></span><br><span class="line">  <span class="attr">ansible.builtin.replace:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/XXXX/config.xml</span></span><br><span class="line">    <span class="attr">regexp:</span> <span class="string">&quot;(172.16.1.101.*)&quot;</span></span><br><span class="line">    <span class="attr">replace:</span> <span class="string">&quot;&lt;-- \1 --&gt;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-5-网络工具"><a href="#3-5-网络工具" class="headerlink" title="3.5 网络工具"></a>3.5 网络工具</h2><hr>
<h3 id="知识点：ansible-builtin-get-url"><a href="#知识点：ansible-builtin-get-url" class="headerlink" title="知识点：ansible.builtin.get_url"></a>知识点：ansible.builtin.get_url</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 作用</span><br><span class="line">  - 从 HTTP、HTTPS、FTP 下载网络文件，保存到远程主机</span><br><span class="line">  - 要求远程主机必须与 HTTP、HTTPS、FTP 网络互通</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>常用参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* url</span><br><span class="line">  - 指定网络文件的 url</span><br><span class="line"></span><br><span class="line">* url_username</span><br><span class="line">* url_password</span><br><span class="line">  - 对于 HTTP basic authentication，指定 username 和 password</span><br><span class="line"></span><br><span class="line">* use_proxy</span><br><span class="line">  - boolean，是否使用代理</span><br><span class="line"></span><br><span class="line">* validate_certs</span><br><span class="line">  - boolean，是否验证 ssl 证书</span><br><span class="line"></span><br><span class="line">* dest</span><br><span class="line">  - 指定在远程主机上保存文件的绝对路径，可以是文件名，也可以是一个目录</span><br><span class="line"></span><br><span class="line">* force</span><br><span class="line">  - boolean，当 dest 是文件名时是否强制下载</span><br><span class="line">  - yes，则文件内容改变就替换文件</span><br><span class="line">  - no，则只有当目标不存在时才会下载文件</span><br><span class="line"></span><br><span class="line">* backup</span><br><span class="line">  - boolean，是否创建备份</span><br><span class="line"></span><br><span class="line">* owner、group、mode</span><br><span class="line">  - 指定下载的文件的属性</span><br><span class="line"></span><br><span class="line">* timeout</span><br><span class="line">  - 指定 url 请求的超时时间</span><br><span class="line"></span><br><span class="line">* others</span><br><span class="line">  - file 模块接受的所有参数也可以在这里工作</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">下载</span> <span class="string">foo.conf</span> <span class="string">文件</span></span><br><span class="line">  <span class="attr">ansible.builtin.get_url:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://example.com/path/file.conf</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/foo.conf</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-uri"><a href="#知识点：ansible-builtin-uri" class="headerlink" title="知识点：ansible.builtin.uri"></a>知识点：ansible.builtin.uri</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 发送 HTTP 请求给 webserver，相当于 curl 指令</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">* url</span><br><span class="line">  - 指定目标地址</span><br><span class="line"></span><br><span class="line">* method</span><br><span class="line">  - 指定 http 请求的方法</span><br><span class="line">  - 默认值 GET</span><br><span class="line"></span><br><span class="line">* body</span><br><span class="line">* body_format</span><br><span class="line">  - 指定 http 请求的请求体</span><br><span class="line"></span><br><span class="line">* src</span><br><span class="line">  - 指定发送 http 请求时携带的数据文件，相当于 &quot;curl -d @filename&quot;</span><br><span class="line"></span><br><span class="line">* remote_src</span><br><span class="line">  - boolean，指定 src 的文件是否是远程文件</span><br><span class="line"></span><br><span class="line">* dest</span><br><span class="line">  - 当下载文件时，指定下载的文件的保存位置</span><br><span class="line"></span><br><span class="line">* owner、group、mode</span><br><span class="line">  - 当下载文件时，指定下载的文件的各种属性</span><br><span class="line"></span><br><span class="line">* status_code</span><br><span class="line">  - list</span><br><span class="line">  - 对于 webserver 返回的 http 响应，视哪些状态码为 success</span><br><span class="line">  - 默认只有 200</span><br><span class="line"></span><br><span class="line">* validate_certs</span><br><span class="line">  - 是否开启 https 的认证，false 表示不开启，相当于 curl 的 &quot;-k&quot; 选项</span><br><span class="line">  - 默认值为 true</span><br><span class="line"></span><br><span class="line">* url_username</span><br><span class="line">* url_password</span><br><span class="line">  - 对于带验证的 webserver，指定使用的账号密码</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">检查是否可以访问百度，相当于</span> <span class="string">curl</span> <span class="string">http://www.baidu.com</span></span><br><span class="line">  <span class="attr">ansible.builtin.uri:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">&#x27;http://www.baidu.com&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">发送一个</span> <span class="string">POST</span> <span class="string">请求，提交数据</span></span><br><span class="line">  <span class="attr">ansible.builtin.uri:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://example.cmo/post</span></span><br><span class="line">    <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/path/to/my/file.json</span></span><br><span class="line">    <span class="attr">remote_src:</span> <span class="literal">yes</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-6-系统管理"><a href="#3-6-系统管理" class="headerlink" title="3.6 系统管理"></a>3.6 系统管理</h2><hr>
<h3 id="知识点：ansible-builtin-service"><a href="#知识点：ansible-builtin-service" class="headerlink" title="知识点：ansible.builtin.service"></a>知识点：ansible.builtin.service</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 启动、关闭 systemd unit</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - String required</span><br><span class="line">  - 指定服务名</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - String</span><br><span class="line">  - 指定执行的动作，status 默认、started、stopped、restarted、reloaded</span><br><span class="line"></span><br><span class="line">* enabled</span><br><span class="line">  - Boolean</span><br><span class="line">  - 是否设置开机启动</span><br><span class="line"></span><br><span class="line">* sleep</span><br><span class="line">  - Integer</span><br><span class="line">  - 如果是 restarted，则在重启前先睡眠一段时间</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">查看</span> <span class="string">nginx</span> <span class="string">服务的状态</span></span><br><span class="line">  <span class="attr">ansible.builtin.service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">启动</span> <span class="string">nginx</span> <span class="string">服务</span></span><br><span class="line">  <span class="attr">ansible.builtin.service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-cron"><a href="#知识点：ansible-builtin-cron" class="headerlink" title="知识点：ansible.builtin.cron"></a>知识点：ansible.builtin.cron</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 为远程主机添加、删除、修改计划任务</span><br><span class="line">  - 本质上就是更改 slave 上的 crontab 文件</span><br><span class="line"></span><br><span class="line">* 注意</span><br><span class="line">  - 对 crontab 的修改类似执行方式类似定义式，直接完整修改一条 crontab 配置</span><br><span class="line">  - 如果对某个作业进行修改，则必须同时保留各种时间参数</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - required</span><br><span class="line">  - 在 crontab 中添加的一行注释，格式为：Ansible: XXX</span><br><span class="line">  - 此注释是 ansible 后续对 crontab 的操作的基础，即如果一个 job 没有此注释，则 ansible 根本识别不到</span><br><span class="line"></span><br><span class="line">* job</span><br><span class="line">  - 指定的具体的要执行的工作</span><br><span class="line">  - 如果是要执行某个脚本，则脚本需要提前放在远程主机上</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - 指定对某一条计划任务的操作</span><br><span class="line">  - present</span><br><span class="line">    - 默认</span><br><span class="line">  - absent</span><br><span class="line">    - 删除某一条计划任务设置</span><br><span class="line">    - 并且只能删除之前由 ansible 添加的计划任务，因为需要按照 Ansible: XXX 的注释来搜索</span><br><span class="line"></span><br><span class="line">* 时间参数，语法与 crontab 原始语法完全相同，省略则默认为 &quot;*&quot;</span><br><span class="line">  - minute</span><br><span class="line">  - hour</span><br><span class="line">  - day</span><br><span class="line">  - month</span><br><span class="line">  - weekday</span><br><span class="line"></span><br><span class="line">* disabled</span><br><span class="line">  - 注释或解除注释某项计划任务，必须加上 name 参数和 job 参数</span><br><span class="line">  - 如果没有同时指定时间参数，则所有时间都会改为 &quot;*&quot;</span><br><span class="line">  - disabled=yes  添加注释</span><br><span class="line">  - disabled=no   取消注释</span><br><span class="line"></span><br><span class="line">* user</span><br><span class="line">  - 指定修改哪个用户的 crontab</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">范例一，添加一个名为</span> <span class="string">backup</span> <span class="string">mysql</span> <span class="string">计划任务，周一到周五，每天</span> <span class="number">2</span> <span class="string">点</span> <span class="number">30</span> <span class="string">分执行数据库备份脚本</span></span><br><span class="line">  <span class="attr">ansible.builtin.cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;backup mysql&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;/root/mysql_backup.sh&quot;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    minute: 30</span></span><br><span class="line"><span class="string">    hour:2</span></span><br><span class="line"><span class="string">    weekday: 1-5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: 范例二，将范例一的计划任务改为使用 mysql_backup_02.sh，注意其中的 hour 等时间参数还要带着</span></span><br><span class="line"><span class="string">  ansible.builtin.cron:</span></span><br><span class="line"><span class="string">    name: &quot;backup mysql&quot;</span></span><br><span class="line"><span class="string">    job: &quot;/root/mysql_backup_02.sh&quot;&#x27;</span></span><br><span class="line">    <span class="attr">minute:</span> <span class="number">30</span></span><br><span class="line">    <span class="string">hour:2</span></span><br><span class="line">    <span class="attr">weekday:</span> <span class="number">1</span><span class="number">-5</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">范例三，将范例二注释</span></span><br><span class="line">  <span class="attr">ansible.builtin.cron:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;backup mysql&quot;</span></span><br><span class="line">    <span class="attr">job:</span> <span class="string">&quot;/root/mysql_backup_02.sh&quot;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    minute: 30</span></span><br><span class="line"><span class="string">    hour:2</span></span><br><span class="line"><span class="string">    weekday: 1-5</span></span><br><span class="line"><span class="string">    disables: yes</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-hostname"><a href="#知识点：ansible-builtin-hostname" class="headerlink" title="知识点：ansible.builtin.hostname"></a>知识点：ansible.builtin.hostname</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 修改主机名，并且会同时修改 /etc/hostname 的内容</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">修改主机名</span></span><br><span class="line">  <span class="attr">ansible.builtin.hostname:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; HOSTNAME &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-yum"><a href="#知识点：ansible-builtin-yum" class="headerlink" title="知识点：ansible.builtin.yum"></a>知识点：ansible.builtin.yum</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 作用</span><br><span class="line">  - 使用 yum 安装、卸载软件</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - list / string</span><br><span class="line">  - 指定软件的名字，也可以是本地的 rpm 安装包</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - 指定对软件的操作</span><br><span class="line">  - present</span><br><span class="line">  - installed</span><br><span class="line">  - latest</span><br><span class="line">  - absent</span><br><span class="line">  - removed</span><br><span class="line"></span><br><span class="line">* autoremove</span><br><span class="line">  - boolean</span><br><span class="line">  - 在卸载软件时，是否自动卸载依赖包，默认 false</span><br><span class="line"></span><br><span class="line">* enablerepo</span><br><span class="line">  - 只从某些 repo 中搜索安装</span><br><span class="line"></span><br><span class="line">* disablerepo</span><br><span class="line">  - 搜索安装时不搜索某些 repo</span><br><span class="line"></span><br><span class="line">* list</span><br><span class="line">  - 查看某个 package 的所有版本，与 name 互斥</span><br><span class="line"></span><br><span class="line">* download_only</span><br><span class="line">  - boolean</span><br><span class="line">  - 是否仅下载不安装</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装</span> <span class="string">nginx、pgsql</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> [ <span class="string">nginx</span>, <span class="string">postgresql</span>, <span class="string">postgresql-server</span> ]</span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">卸载</span> <span class="string">apache</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">安装一个本地</span> <span class="string">rpm</span> <span class="string">包</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">/tmp/cir-docker.rpm</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-yum-repository"><a href="#知识点：ansible-builtin-yum-repository" class="headerlink" title="知识点：ansible.builtin.yum_repository"></a>知识点：ansible.builtin.yum_repository</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 添加或删除 yum 源</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - 指定 repo 的名称</span><br><span class="line"></span><br><span class="line">* file</span><br><span class="line">  - 指定 .repo 文件的文件名</span><br><span class="line">  - 省略则使用 &quot;name&quot; 参数的值</span><br><span class="line"></span><br><span class="line">* owner、group、mode</span><br><span class="line">  - 指定 repo 文件的属性</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present/absent</span><br><span class="line">  - 当没有 file 参数时，表示添加或删除 .repo 文件</span><br><span class="line">  - 当有 file 参数时，表示添加或删除 repo</span><br><span class="line"></span><br><span class="line">* description</span><br><span class="line">* baseurl</span><br><span class="line">* mirrorlist</span><br><span class="line">* enabled</span><br><span class="line">* gpgcheck</span><br><span class="line">  - 指定 repo 的细节</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">添加</span> <span class="string">epel</span> <span class="string">源</span></span><br><span class="line">  <span class="attr">ansible.builtin.yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">epel</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">EPEL</span> <span class="string">YUM</span> <span class="string">repo</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">https://download.fedoraproject.org/pub/epel/$releasever/$basearch/</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">删除</span> <span class="string">epel</span> <span class="string">源</span></span><br><span class="line">  <span class="attr">ansible.builtin.yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">epel</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">向一个</span> <span class="string">repo</span> <span class="string">文件中添加多个</span> <span class="string">repo</span> <span class="string">(1/2)</span></span><br><span class="line">  <span class="attr">ansible.builtin.yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">epel</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">external_repos</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">EPEL</span> <span class="string">YUM</span> <span class="string">repo</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">https://download.fedoraproject.org/pub/epel/$releasever/$basearch/</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">向一个</span> <span class="string">repo</span> <span class="string">文件中添加多个</span> <span class="string">repo</span> <span class="string">(2/2)</span></span><br><span class="line">  <span class="attr">ansible.builtin.yum_repository:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rpmforge</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">external_repos</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">RPMforge</span> <span class="string">YUM</span> <span class="string">repo</span></span><br><span class="line">    <span class="attr">baseurl:</span> <span class="string">http://apt.sw.be/redhat/el7/en/$basearch/rpmforge</span></span><br><span class="line">    <span class="attr">mirrorlist:</span> <span class="string">http://mirrorlist.repoforge.org/el7/mirrors-rpmforge</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-posix-selinux"><a href="#知识点：ansible-posix-selinux" class="headerlink" title="知识点：ansible.posix.selinux"></a>知识点：ansible.posix.selinux</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 修改 selinux 的策略</span><br><span class="line">  - 注意，修改后仍然需要重启服务器</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* state</span><br><span class="line">  - string / required</span><br><span class="line">  - 指定 selinux 的策略</span><br><span class="line">  - 可选值包括 &quot;disabled&quot;、&quot;enforcing&quot;、&quot;permissive&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">关闭</span> <span class="string">selinux</span></span><br><span class="line">  <span class="attr">ansible.posix.selinux:</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">disabled</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-posix-sysctl"><a href="#知识点：ansible-posix-sysctl" class="headerlink" title="知识点：ansible.posix.sysctl"></a>知识点：ansible.posix.sysctl</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 修改 linux 的内核参数，相当于执行 &quot;sysctl -p&quot; 指令</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* name / key</span><br><span class="line">  - string / required</span><br><span class="line">  - 指定内核参数的名称</span><br><span class="line"></span><br><span class="line">* value</span><br><span class="line">  - 指定值</span><br><span class="line"></span><br><span class="line">* sysctl_file</span><br><span class="line">  - 指定目标 sysctl.conf 文件</span><br><span class="line">  - 默认值为 /etc/sysctl.conf，但强烈不推荐使用默认值</span><br><span class="line"></span><br><span class="line">* reload</span><br><span class="line">  - boolean</span><br><span class="line">  - 指定是否重载 sysctl，相当于执行 &quot;sysctl -p&quot; 指令</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present / absent</span><br><span class="line">  - 添加或删除配置项</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">修改内核参数</span> <span class="string">&quot;net.ipv4.ip_forward&quot;</span> <span class="string">的值</span></span><br><span class="line">  <span class="attr">ansible.posix.sysctl:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;net.ipv4.ip_forward&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">reload:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">sysctl_file:</span> <span class="string">&quot;/etc/sysctl.d/kubernetes.conf&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：community-general-modprobe"><a href="#知识点：community-general-modprobe" class="headerlink" title="知识点：community.general.modprobe"></a>知识点：community.general.modprobe</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 加载或卸载内核模块</span><br><span class="line"></span><br><span class="line">* 注意</span><br><span class="line">  - 由于 &quot;persistent&quot; 参数 2.9 不支持，因此在 2.9 使用 modprobe 时需要手动建立模块的开机自动加载</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - string / required</span><br><span class="line">  - 指定待操作的模块名称</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present / absent</span><br><span class="line">  - 指定加载/卸载模块</span><br><span class="line"></span><br><span class="line">* persistent</span><br><span class="line">  - 2.9 不支持</span><br><span class="line">  - 是否设置模块开机自动加载</span><br><span class="line">  - disabled / present / absent</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">加载</span> <span class="string">ipvs</span> <span class="string">模块</span> <span class="string">(1/4)</span> <span class="string">安装</span> <span class="string">epel</span></span><br><span class="line">  <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">epel-release</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">加载</span> <span class="string">ipvs</span> <span class="string">模块</span> <span class="string">(2/4)</span> <span class="string">安装</span> <span class="string">ipvs</span></span><br><span class="line">  <span class="attr">ansible.builtin.yum:</span></span><br><span class="line">    <span class="attr">name:</span> [<span class="string">ipset</span>, <span class="string">ipvsadm</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">加载</span> <span class="string">ipvs</span> <span class="string">模块</span> <span class="string">(3/4)</span> <span class="string">加载</span> <span class="string">ipvs</span> <span class="string">模块</span></span><br><span class="line">  <span class="attr">community.general.modprobe:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;item&#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;ip_vs&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;ip_vs_rr&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;ip_vs_wrr&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;ip_vs_sh&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">加载</span> <span class="string">ipvs</span> <span class="string">模块</span> <span class="string">(4/4)</span> <span class="string">创建</span> <span class="string">ipvs</span> <span class="string">模块开机脚本</span></span><br><span class="line">  <span class="attr">ansible.builtin.lineinfile:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/etc/sysconfig/modules/ipvs.modules</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">insertafter:</span> <span class="string">EOF</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">create:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">755</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;#!/bin/bash&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;modprobe -- ip_vs&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;modprobe -- ip_vs_rr&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;modprobe -- ip_vs_wrr&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;modprobe -- ip_vs_sh&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-7-用户管理"><a href="#3-7-用户管理" class="headerlink" title="3.7 用户管理"></a>3.7 用户管理</h2><hr>
<h3 id="知识点：ansible-builtin-user"><a href="#知识点：ansible-builtin-user" class="headerlink" title="知识点：ansible.builtin.user"></a>知识点：ansible.builtin.user</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 作用</span><br><span class="line">  - 创建、删除用户</span><br><span class="line">  - 管理用户，变更用户属性</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - 指定用户名</span><br><span class="line"></span><br><span class="line">* group</span><br><span class="line">  - 指定用户的 primary group</span><br><span class="line"></span><br><span class="line">* groups</span><br><span class="line">  - 指定用户的组列表</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present / absent</span><br><span class="line">  - 执行的动作</span><br><span class="line"></span><br><span class="line">* system</span><br><span class="line">  - boolean，是否创建为系统用户</span><br><span class="line"></span><br><span class="line">* uid</span><br><span class="line">  - 手动指定用户的 uid</span><br><span class="line"></span><br><span class="line">* home</span><br><span class="line">  - 指定用户的家目录</span><br><span class="line"></span><br><span class="line">* remove</span><br><span class="line">  - boolean，在删除用户时，是否同时删除用户的家目录</span><br><span class="line"></span><br><span class="line">* append</span><br><span class="line">  - boolean，是否采用追加方式设置用户的组</span><br><span class="line"></span><br><span class="line">* password</span><br><span class="line">  - 设置用户的密码</span><br><span class="line">  - ansible 不支持明文密码，需要使用 password_hash 生成密码的密文</span><br><span class="line"></span><br><span class="line">* generate_ssh_key</span><br><span class="line">  - boolean，是否生成秘钥</span><br><span class="line">  - 如果已存在秘钥，默认不会删除已存在的秘钥，除非指定了 force=yes</span><br><span class="line"></span><br><span class="line">* ssh_key_file</span><br><span class="line">  - 指定秘钥文件，默认为 ~/.ssh/id_rsa</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">新建一个用户</span></span><br><span class="line">  <span class="attr">ansible.builtin.user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">testuser</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123;&quot;123456&quot;|password_hash(&quot;sha512&quot;)&#125;&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">删除一个用户</span></span><br><span class="line">  <span class="attr">ansible.builtin.user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">testuser</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-builtin-group"><a href="#知识点：ansible-builtin-group" class="headerlink" title="知识点：ansible.builtin.group"></a>知识点：ansible.builtin.group</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 创建、删除组</span><br><span class="line">  - 管理组</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - 指定组名</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present / absent</span><br><span class="line">  - 创建或删除组</span><br><span class="line"></span><br><span class="line">* gid</span><br><span class="line">  - 设置组 id</span><br><span class="line"></span><br><span class="line">* system</span><br><span class="line">  - 设置组为系统组</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建</span> <span class="string">testgroup</span> <span class="string">组</span></span><br><span class="line">  <span class="attr">ansible.builtin.group:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">testgroup</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">删除</span> <span class="string">testgroup</span> <span class="string">组</span></span><br><span class="line">  <span class="attr">ansible.builtin.group:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">testgroup</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-posix-authorized-key"><a href="#知识点：ansible-posix-authorized-key" class="headerlink" title="知识点：ansible.posix.authorized_key"></a>知识点：ansible.posix.authorized_key</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 添加或删除 ssh 免密</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* key</span><br><span class="line">  - string</span><br><span class="line">  - 指定需要添加公钥字符串</span><br><span class="line"></span><br><span class="line">* user</span><br><span class="line">  - string / required</span><br><span class="line">  - 指定配置免密的目标用户</span><br><span class="line"></span><br><span class="line">* path</span><br><span class="line">  - 指定 authorized_keys 文件</span><br><span class="line">  - 默认为 ~/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present / absent</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zookeeper</span> <span class="string">用户配置免密</span> <span class="string">(1/3)</span> <span class="string">创建</span> <span class="string">zookeeper</span> <span class="string">用户并新建秘钥</span></span><br><span class="line">  <span class="attr">ansible.builtin.user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">generate_ssh_key:</span> <span class="literal">true</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zookeeper</span> <span class="string">用户配置免密</span> <span class="string">(2/3)</span> <span class="string">获取所有主机的</span> <span class="string">zookeeper</span> <span class="string">用户的公钥文件到</span> <span class="string">ansible</span> <span class="string">主机</span></span><br><span class="line">  <span class="attr">ansible.builtin.fetch:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">/home/zookeeper/.ssh/id_rsa.pub</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/tmp/zookeeper_pub/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zookeeper</span> <span class="string">用户配置免密</span> <span class="string">(3/3)</span> <span class="string">配置</span> <span class="string">zookeeper</span> <span class="string">用户</span> <span class="string">ssh</span> <span class="string">互信</span></span><br><span class="line">  <span class="attr">ansible.posix.authorized_key:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">key:</span>  <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;file&#x27;, &#x27;/tmp/zookeeper_pub/&#123;&#123; item &#125;&#125;</span>/home/zookeeper/.ssh/id_rsa.pub&#x27;) &#125;&#125;&quot;</span></span><br><span class="line">  <span class="attr">with_items:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; groups.zookeeper &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：community-general-sudoers"><a href="#知识点：community-general-sudoers" class="headerlink" title="知识点：community.general.sudoers"></a>知识点：community.general.sudoers</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 功能</span><br><span class="line">  - 修改 sudoer 文件，来实现对 sudo 权限的管理</span><br><span class="line">  - 默认会在 /etc/sudoers.d/ 下添加文件</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* name</span><br><span class="line">  - string / required</span><br><span class="line">  - 指定 sudo 规则的名称</span><br><span class="line">  - 在 /etc/sudoers.d/ 下添加文件时，会使用此值作为文件名</span><br><span class="line"></span><br><span class="line">* user</span><br><span class="line">  - 指定用户名</span><br><span class="line"></span><br><span class="line">* commands</span><br><span class="line">  - list / elements=string</span><br><span class="line">  - 用户允许 sudo 执行的命令</span><br><span class="line">  - 特殊值 ALL 表示可以执行所有命令</span><br><span class="line"></span><br><span class="line">* nopassword</span><br><span class="line">  - boolean</span><br><span class="line">  - 是否允许无密码</span><br><span class="line"></span><br><span class="line">* runas</span><br><span class="line">  - 指定切换的 target 用户</span><br><span class="line">  - 支持特殊值 ALL</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present / absent</span><br><span class="line">  - 指定是添加规则还是删除规则</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hadoopamdin</span> <span class="string">用户添加</span> <span class="string">sudo</span> <span class="string">权限，结果为</span> <span class="string">hadooptest</span> <span class="string">ALL=(ALL)NOPASSWD:</span> <span class="string">ALL</span></span><br><span class="line">  <span class="attr">community.general.sudoers:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;hadoopadmin&quot;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">hadoopadmin</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">commands:</span> <span class="string">ALL</span></span><br><span class="line">    <span class="attr">runas:</span> <span class="string">ALL</span></span><br><span class="line">    <span class="attr">nopassword:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-8-硬盘管理"><a href="#3-8-硬盘管理" class="headerlink" title="3.8 硬盘管理"></a>3.8 硬盘管理</h2><hr>
<h3 id="知识点：community-general-parted"><a href="#知识点：community-general-parted" class="headerlink" title="知识点：community.general.parted"></a>知识点：community.general.parted</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 使用 parted 指令对硬盘创建分区</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">* device</span><br><span class="line">  - string / required</span><br><span class="line">  - 指定待操作的设备</span><br><span class="line"></span><br><span class="line">* label</span><br><span class="line">  - 指定分区表的类型</span><br><span class="line">  - 可选值包括 msdos、gpt 等</span><br><span class="line"></span><br><span class="line">* number</span><br><span class="line">  - 指定分区号</span><br><span class="line"></span><br><span class="line">* part_type</span><br><span class="line">  - 指定分区的类型，默认为 primary</span><br><span class="line"></span><br><span class="line">* part_start</span><br><span class="line">* part_end</span><br><span class="line">  - 指定分区开始和结束的位置</span><br><span class="line">  - 支持使用容量的方式如 1GiB</span><br><span class="line">  - 支持使用百分比的方式如 15%</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - 默认值 info，表示仅查看分区的信息</span><br><span class="line">  - present / absent 表示创建/删除分区</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建分区</span></span><br><span class="line">  <span class="attr">community.general.parted:</span></span><br><span class="line">    <span class="attr">device:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.device &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">label:</span> <span class="string">gpt</span></span><br><span class="line">    <span class="attr">number:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.partition_number &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">part_start:</span> <span class="number">0</span><span class="string">%</span></span><br><span class="line">    <span class="attr">part_end:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdb</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data1</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdc</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data2</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdd</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data3</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sde</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data4</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：community-general-filesystem"><a href="#知识点：community-general-filesystem" class="headerlink" title="知识点：community.general.filesystem"></a>知识点：community.general.filesystem</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 新建文件系统</span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* dev / device</span><br><span class="line">  - path / required</span><br><span class="line">  - 指定待操作的硬盘设备</span><br><span class="line"></span><br><span class="line">* fstype</span><br><span class="line">  - ext4 / xfs</span><br><span class="line">  - 指定文件系统的类型</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - present / absent</span><br><span class="line">  - 创建/删除文件系统</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建文件系统</span></span><br><span class="line">  <span class="attr">community.general.filesystem:</span></span><br><span class="line">    <span class="attr">dev:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.device &#125;&#125;</span><span class="template-variable">&#123;&#123; item.partition_number &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.fstype &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdb</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data1</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdc</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data2</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdd</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data3</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sde</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data4</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ansible-posix-mount"><a href="#知识点：ansible-posix-mount" class="headerlink" title="知识点：ansible.posix.mount"></a>知识点：ansible.posix.mount</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 创建挂载点、挂载/卸载硬盘、修改 fstab</span><br><span class="line"></span><br><span class="line">* 注意</span><br><span class="line">  - ansible.posix.mount 对 fstab 的修改，使用的是 &quot;src&quot; 参数的值</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>参数</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* path / name</span><br><span class="line">  - path / required</span><br><span class="line">  - 指定挂载点目录，如果挂载点目录尚不存在则会自动建立</span><br><span class="line"></span><br><span class="line">* src</span><br><span class="line">  - 指定需要挂载/卸载的设备</span><br><span class="line"></span><br><span class="line">* fstype</span><br><span class="line">  - 指定硬盘的文件系统</span><br><span class="line"></span><br><span class="line">* state</span><br><span class="line">  - 指定待进行的操作</span><br><span class="line">  - mounted   挂载硬盘并添加到 fstab 中</span><br><span class="line">  - unmounted 卸载硬盘，但不修改 fstab</span><br><span class="line">  - remounted 重新挂载硬盘，不修改 fstab</span><br><span class="line">  - absent    卸载硬盘，同时修改 fstab</span><br><span class="line">  - present             仅修改 fstab，并不挂载硬盘</span><br><span class="line">  - absent_from_fstab   仅修改 fstab，并不卸载硬盘</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">创建挂载点并挂载硬盘</span></span><br><span class="line">  <span class="attr">ansible.posix.mount:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.mount_point &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.device &#125;&#125;</span><span class="template-variable">&#123;&#123; item.partition_number &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">mounted</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.fstype &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">boot:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdb</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data1</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdc</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data2</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdd</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data3</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sde</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data4</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">使用</span> <span class="string">uuid</span> <span class="string">挂载硬盘</span> <span class="string">(1/2)</span> <span class="string">重新收集主机的</span> <span class="string">fact</span> <span class="string">信息</span></span><br><span class="line">  <span class="attr">ansible.builtin.setup:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">使用</span> <span class="string">uuid</span> <span class="string">挂载硬盘</span> <span class="string">(2/2)</span> <span class="string">挂载硬盘</span></span><br><span class="line">  <span class="attr">ansible.posix.mount:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.mount_point &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">UUID=&#123;&#123;</span> <span class="string">ansible_facts.device_links.uuids[</span> <span class="string">item.device</span> <span class="string">|</span> <span class="string">replace(&#x27;/dev/&#x27;,</span> <span class="string">&#x27;&#x27;</span><span class="string">)</span> <span class="string">]</span> <span class="string">|</span> <span class="string">first</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">mounted</span></span><br><span class="line">    <span class="attr">fstype:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.fstype &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdb</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data1</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdc</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data2</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sdd</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data3</span> &#125;</span><br><span class="line">  <span class="bullet">-</span> &#123;<span class="attr">device:</span> <span class="string">/dev/sde</span>, <span class="attr">partition_number:</span> <span class="number">1</span>, <span class="attr">fstype:</span> <span class="string">ext4</span>, <span class="attr">mount_point:</span> <span class="string">/data4</span> &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter04-Ansible-Filters"><a href="#Chapter04-Ansible-Filters" class="headerlink" title="Chapter04 Ansible Filters"></a>Chapter04 Ansible Filters</h1><ol>
<li><strong>其他 Filter</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">* 默认值</span><br><span class="line">  - mandatory</span><br><span class="line"></span><br><span class="line">* 三元运算</span><br><span class="line">  - ternary</span><br><span class="line"></span><br><span class="line">* 序列化</span><br><span class="line">  - to_json</span><br><span class="line">  - to_nice_json</span><br><span class="line">  - from_json</span><br><span class="line">  - to_yaml</span><br><span class="line">  - to_nice_yaml</span><br><span class="line">  - from_yaml</span><br><span class="line"></span><br><span class="line">* 组合数据</span><br><span class="line">  - zip</span><br><span class="line">  - zip_longest</span><br><span class="line">  - subelements</span><br><span class="line">  - combine</span><br><span class="line">  - map</span><br><span class="line">  - product 笛卡尔积</span><br><span class="line">  - ansible.builtin.permutations 排列</span><br><span class="line">  - ansible.builtin.combinations 组合</span><br><span class="line"></span><br><span class="line">* 随机数</span><br><span class="line">  - community.general.random_mac 随机 MAC 地址</span><br><span class="line">  - shuffle 列表洗牌</span><br><span class="line"></span><br><span class="line">* Managing list variables</span><br><span class="line">  - flatten 列表平整</span><br><span class="line"></span><br><span class="line">* 集合运算</span><br><span class="line">  - unique</span><br><span class="line">  - union 交集</span><br><span class="line">  - intersect 并集</span><br><span class="line">  - difference 差集</span><br><span class="line">  - symmetric_difference 对称差集</span><br><span class="line"></span><br><span class="line">* Managing network interactions</span><br><span class="line">  - ansible.netcommon.parse_cli</span><br><span class="line">  - ansible.netcommon.parse_xml</span><br><span class="line">  - ansible.netcommon.vlan_parser</span><br><span class="line"></span><br><span class="line">* 哈希和加密</span><br><span class="line">  - hash 计算哈希</span><br><span class="line">  - checksum 计算校验和</span><br><span class="line">  - vault</span><br><span class="line">  - unvault</span><br><span class="line"></span><br><span class="line">* Manipulating text</span><br><span class="line">  - comment 注释</span><br><span class="line">  - urlencode</span><br><span class="line">  - urlsplit 抽取 url 中的元素</span><br><span class="line">  - regex_findall</span><br><span class="line">  - regex_escape</span><br><span class="line"></span><br><span class="line">* Managing file names and path names</span><br><span class="line">  - basename 从路径 path 中获取文件名</span><br><span class="line">  - dirname 从路径 path 中获取目录名</span><br><span class="line">  - win_basename</span><br><span class="line">  - win_dirname</span><br><span class="line">  - win_splitdrive</span><br><span class="line">  - expanduser 对路径 path 进行 &#x27;~&#x27; 扩展</span><br><span class="line">  - expandvars 对路径 path 进行环境变量的扩展</span><br><span class="line">  - realpath 获取软连接的真实路径</span><br><span class="line">  - splitext 获取文件的后缀名</span><br><span class="line"></span><br><span class="line">* Manipulating strings</span><br><span class="line">  - quote 字符串加引号</span><br><span class="line">  - b64decode</span><br><span class="line"></span><br><span class="line">* Managing UUIDs:</span><br><span class="line">  - to_uuid 生成 UUID</span><br><span class="line"></span><br><span class="line">* Handling dates and times</span><br><span class="line">  - to_datetime 将 String 转换为 datetime 型数据</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter05-Ansible-Tests"><a href="#Chapter05-Ansible-Tests" class="headerlink" title="Chapter05 Ansible Tests"></a>Chapter05 Ansible Tests</h1><hr>
<h1 id="Chapter06-Ansible-Lookup"><a href="#Chapter06-Ansible-Lookup" class="headerlink" title="Chapter06 Ansible Lookup"></a>Chapter06 Ansible Lookup</h1>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2000/01/01/Blog01-Linux/" rel="prev" title="Blog01-Linux">
                  <i class="fa fa-chevron-left"></i> Blog01-Linux
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2000/01/01/Blog03-%E4%BA%91%E8%AE%A1%E7%AE%97/" rel="next" title="Blog03-云计算">
                  Blog03-云计算 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2000 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"per_page":true,"tags":"none","cdn":"//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
