<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","width":500,"display":"always","padding":1,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="Blog32-k8s">
<meta property="og:url" content="http://example.com/2000/01/01/Blog32-k8s/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="k8s">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2000/01/01/Blog32-k8s/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png">
<meta property="og:image" content="http://example.com/2000/01/01/Blog32-k8s/Flannel%E8%AF%A6%E8%A7%A3%E5%9B%BE%E7%89%87.jpg">
<meta property="og:image" content="http://example.com/2000/01/01/Blog32-k8s/Ingress%E5%B7%A5%E4%BD%9C%E5%9B%BE%E7%A4%BA.png">
<meta property="article:published_time" content="1999-12-31T16:00:32.000Z">
<meta property="article:modified_time" content="2023-09-09T07:38:44.202Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2000/01/01/Blog32-k8s/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png">


<link rel="canonical" href="http://example.com/2000/01/01/Blog32-k8s/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2000/01/01/Blog32-k8s/","path":"2000/01/01/Blog32-k8s/","title":"Blog32-k8s"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Blog32-k8s | Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Blog32-k8s"><span class="nav-text">Blog32-k8s</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%AE%E5%8A%A9"><span class="nav-text">帮助</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AE%B9"><span class="nav-text">内容</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter03-K8S"><span class="nav-text">Chapter03 K8S</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-K8S-%E4%BB%8B%E7%BB%8D"><span class="nav-text">3.1 K8S 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E9%97%AE%E9%A2%98"><span class="nav-text">知识点：容器编排问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：K8S 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E8%8A%82%E7%82%B9"><span class="nav-text">知识点：K8S 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E7%BB%84%E4%BB%B6"><span class="nav-text">知识点：K8S 组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-K8S-%E6%A6%82%E5%BF%B5"><span class="nav-text">3.2 K8S 概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E8%B5%84%E6%BA%90"><span class="nav-text">知识点：K8S 资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="nav-text">知识点：K8S 资源清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E6%A0%87%E7%AD%BE"><span class="nav-text">知识点：K8S 标签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E6%9C%BA%E5%88%B6"><span class="nav-text">知识点：K8S 标签选择机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-FIELD"><span class="nav-text">知识点：K8S FIELD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Anamespace"><span class="nav-text">知识点：namespace</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-K8S-%E5%AE%89%E8%A3%85"><span class="nav-text">3.3 K8S 安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E5%AE%89%E8%A3%85%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：K8S 安装介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubeadm-%E6%90%AD%E5%BB%BA-K8S-%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E%E9%9B%86%E7%BE%A4%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：kubeadm 搭建 K8S 一主多从集群范例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-K8S-%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86"><span class="nav-text">3.4 K8S 节点管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E6%B1%A1%E7%82%B9"><span class="nav-text">知识点：污点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-K8S-Pod"><span class="nav-text">3.5 K8S Pod</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：pod 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">知识点：pod 生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-%E8%B0%83%E5%BA%A6"><span class="nav-text">知识点：pod 调度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="nav-text">知识点：pod 资源清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-affinity"><span class="nav-text">知识点：pod.spec.affinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-affinity-nodeAffinity"><span class="nav-text">知识点：pod.spec.affinity.nodeAffinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-affinity-podAffinity"><span class="nav-text">知识点：pod.spec.affinity.podAffinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-affinity-podAntiAffinity"><span class="nav-text">知识点：pod.spec.affinity.podAntiAffinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers"><span class="nav-text">知识点：pod.spec.containers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-imagePullPolicy"><span class="nav-text">知识点：pod.spec.containers.imagePullPolicy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-command"><span class="nav-text">知识点：pod.spec.containers.command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-args"><span class="nav-text">知识点：pod.spec.containers.args</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-env"><span class="nav-text">知识点：pod.spec.containers.env</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-env-valueFrom"><span class="nav-text">知识点：pod.spec.containers.env.valueFrom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-envFrom"><span class="nav-text">知识点：pod.spec.containers.envFrom</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-ports"><span class="nav-text">知识点：pod.spec.containers.ports</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-resources"><span class="nav-text">知识点：pod.spec.containers.resources</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-lifecycle"><span class="nav-text">知识点：pod.spec.containers.lifecycle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-livenessProbe"><span class="nav-text">知识点：pod.spec.containers.livenessProbe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-readinessProbe"><span class="nav-text">知识点：pod.spec.containers.readinessProbe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-hostNetwork"><span class="nav-text">知识点：pod.spec.hostNetwork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-imagePullSecrets"><span class="nav-text">知识点：pod.spec.imagePullSecrets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-initContainers"><span class="nav-text">知识点：pod.spec.initContainers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-nodeName"><span class="nav-text">知识点：pod.spec.nodeName</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-nodeSelector"><span class="nav-text">知识点：pod.spec.nodeSelector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-restartPolicy"><span class="nav-text">知识点：pod.spec.restartPolicy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-tolerations"><span class="nav-text">知识点：pod.spec.tolerations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-K8S-pod-%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-text">3.6 K8S pod 控制器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-%E6%8E%A7%E5%88%B6%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：pod 控制器介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AReplicaSet%EF%BC%8Crs"><span class="nav-text">知识点：ReplicaSet，rs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ADeployment%EF%BC%8Cdeploy"><span class="nav-text">知识点：Deployment，deploy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Amatrix-server"><span class="nav-text">知识点：matrix-server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AHorizontalPodAutoscaler%EF%BC%8Chpa"><span class="nav-text">知识点：HorizontalPodAutoscaler，hpa</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ADaemonSet%EF%BC%8Cds"><span class="nav-text">知识点：DaemonSet，ds</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AJob"><span class="nav-text">知识点：Job</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ACronJob%EF%BC%8Ccj"><span class="nav-text">知识点：CronJob，cj</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-K8S-%E7%BD%91%E7%BB%9C"><span class="nav-text">3.7 K8S 网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AK8S-%E6%89%81%E5%B9%B3%E7%BD%91%E7%BB%9C"><span class="nav-text">知识点：K8S 扁平网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AFlannel"><span class="nav-text">知识点：Flannel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akube-proxy"><span class="nav-text">知识点：kube-proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aservice%EF%BC%8Csvc"><span class="nav-text">知识点：service，svc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aendpoints%EF%BC%8Cep"><span class="nav-text">知识点：endpoints，ep</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aservice-spec-type"><span class="nav-text">知识点：service.spec.type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aservice-spec-clusterIP"><span class="nav-text">知识点：service.spec.clusterIP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aservice-spec-ports"><span class="nav-text">知识点：service.spec.ports</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aservice-spec-sessionAffinity"><span class="nav-text">知识点：service.spec.sessionAffinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aservice-spec-externalName"><span class="nav-text">知识点：service.spec.externalName</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aservice-%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：service 范例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AIngress%EF%BC%8Cing"><span class="nav-text">知识点：Ingress，ing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ANginx-IngressController-%E5%AE%89%E8%A3%85"><span class="nav-text">知识点：Nginx IngressController 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AIngress-spec-backend"><span class="nav-text">知识点：Ingress.spec.backend</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AIngress-spec-rules"><span class="nav-text">知识点：Ingress.spec.rules</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AIngress-spec-tls"><span class="nav-text">知识点：Ingress.spec.tls</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aingress-nginx-Auth-%E6%93%8D%E4%BD%9C"><span class="nav-text">知识点：ingress-nginx Auth 操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Aingress-nginx-%E9%87%8D%E5%86%99%E6%93%8D%E4%BD%9C"><span class="nav-text">知识点：ingress-nginx 重写操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-K8S-%E5%AD%98%E5%82%A8"><span class="nav-text">3.8 K8S 存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Avolume"><span class="nav-text">知识点：volume</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-containers-volumeMounts"><span class="nav-text">知识点：pod.spec.containers.volumeMounts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-volumes"><span class="nav-text">知识点：pod.spec.volumes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-volumes-emptyDir"><span class="nav-text">知识点：pod.spec.volumes.emptyDir</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-volumes-hostPath"><span class="nav-text">知识点：pod.spec.volumes.hostPath</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9APersistentVolumes%EF%BC%8Cpv"><span class="nav-text">知识点：PersistentVolumes，pv</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9APersistentVolumeClaim%EF%BC%8Cpvc"><span class="nav-text">知识点：PersistentVolumeClaim，pvc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Apod-spec-volumes-persistentVolumeClaim"><span class="nav-text">知识点：pod.spec.volumes.persistentVolumeClaim</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9APersistentVolume-spec-nfs"><span class="nav-text">知识点：PersistentVolume.spec.nfs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E6%89%8B%E5%8A%A8%E5%9B%9E%E6%94%B6-pv"><span class="nav-text">知识点：手动回收 pv</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AStatefulSet%EF%BC%8Csts"><span class="nav-text">知识点：StatefulSet，sts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AStatefulSet-%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：StatefulSet 范例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9AConfigMap%EF%BC%8Ccm"><span class="nav-text">知识点：ConfigMap，cm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ASecret"><span class="nav-text">知识点：Secret</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ASecret-%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：Secret 范例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ASecret-tls-%E8%AF%81%E4%B9%A6%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：Secret tls 证书范例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Asecret-docker-%E4%BB%93%E5%BA%93%E8%AE%A4%E8%AF%81%E8%8C%83%E4%BE%8B"><span class="nav-text">知识点：secret docker 仓库认证范例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-K8S-%E5%AE%89%E5%85%A8"><span class="nav-text">3.9 K8S 安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6-API-Access-Control"><span class="nav-text">知识点：访问控制 API Access Control</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81-Authentication"><span class="nav-text">知识点：身份认证 Authentication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9A%E9%89%B4%E6%9D%83-Authorization"><span class="nav-text">知识点：鉴权 Authorization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ARBAC-Role-Based-Access-Control"><span class="nav-text">知识点：RBAC Role Based Access Control</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ARole%E3%80%81ClusterRole"><span class="nav-text">知识点：Role、ClusterRole</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9ARoleBinding%E3%80%81ClusterRoleBinding"><span class="nav-text">知识点：RoleBinding、ClusterRoleBinding</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Chapter04-kubectl"><span class="nav-text">Chapter04 kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-kubelet-%E4%BB%8B%E7%BB%8D"><span class="nav-text">4.1 kubelet 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-%E4%BB%8B%E7%BB%8D"><span class="nav-text">知识点：kubectl 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-%E6%8C%87%E4%BB%A4-flags"><span class="nav-text">知识点：kubectl 指令 flags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-help-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl help 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-SETTINGS-AND-USAGE-%E6%8C%87%E4%BB%A4"><span class="nav-text">4.2 SETTINGS AND USAGE 指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-version-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl version 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-api-resources-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl api-resources 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-explain-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl explain 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-options-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl options 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-completion-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl completion 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-GETTING-STARTED-%E6%8C%87%E4%BB%A4"><span class="nav-text">4.3 GETTING STARTED 指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-get-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl get 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-run-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl run 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-expose-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl expose 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-delete-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl delete 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-namespace-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create namespace 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-deployment-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create deployment 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-configmap-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create configmap 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-secret-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create secret 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-secret-generic-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create secret generic 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-secret-tls-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create secret tls 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-create-secret-docker-registry-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl create secret docker-registry 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-APP-MANAGEMENT-%E6%8C%87%E4%BB%A4"><span class="nav-text">4.4 APP MANAGEMENT 指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-apply-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl apply 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-edit-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl edit 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-label-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl label 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-patch-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl patch 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-rollout-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl rollout 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-rollout-history-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl rollout history 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-rollout-pause-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl rollout pause 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-rollout-restart-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl rollout restart 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-rollout-resume-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl rollout resume 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-rollout-status-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl rollout status 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-rollout-undo-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl rollout undo 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-scale-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl scale 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-autoscale-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl autoscale 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-set-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl set 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-set-env-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl set env 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-set-image-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl set image 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-set-resources-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl set resources 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-set-selector-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl set selector 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-set-serviceaccount-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl set serviceaccount 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-set-subject-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl set subject 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-WORKING-WITH-APPS-%E6%8C%87%E4%BB%A4"><span class="nav-text">4.5 WORKING WITH APPS 指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-attach-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl attach 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-cp-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl cp 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-describ-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl describ 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-exec-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl exec 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-logs-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl logs 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-top-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl top 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-top-node-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl top node 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-top-pod-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl top pod 指令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-CLUSTER-MANAGEMENT-%E6%8C%87%E4%BB%A4"><span class="nav-text">4.6 CLUSTER MANAGEMENT 指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-api-versions-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl api-versions 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-cluster-info-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl cluster-info 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-cluster-info-dump-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl cluster-info dump 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%9Akubectl-taint-%E6%8C%87%E4%BB%A4"><span class="nav-text">知识点：kubectl taint 指令</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2000/01/01/Blog32-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Blog32-k8s | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Blog32-k8s
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2000-01-01 00:00:32" itemprop="dateCreated datePublished" datetime="2000-01-01T00:00:32+08:00">2000-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-09 15:38:44" itemprop="dateModified" datetime="2023-09-09T15:38:44+08:00">2023-09-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <hr>
<h1 id="Blog32-k8s"><a href="#Blog32-k8s" class="headerlink" title="Blog32-k8s"></a>Blog32-k8s</h1><p><a href="#Chapter01-K8S-%E4%BB%8B%E7%BB%8D"><strong>Chapter01 K8S 介绍</strong></a></p>
<ul>
<li><a href="#3-1-K8S-%E4%BB%8B%E7%BB%8D">3.1 K8S 介绍</a></li>
<li><a href="#3-2-K8S-%E6%A6%82%E5%BF%B5">3.2 K8S 概念</a></li>
<li><a href="#3-3-K8S-%E5%AE%89%E8%A3%85">3.3 K8S 安装</a></li>
</ul>
<p><a href="Chapter02-K8S-Pod"><strong>Chapter02 K8S Pod</strong></a></p>
<p><a href="Chapter03-K8S-Pod-%E6%8E%A7%E5%88%B6%E5%99%A8"><strong>Chapter03 K8S Pod 控制器</strong></a></p>
<p><a href="Chapter04-K8S-%E7%BD%91%E7%BB%9C"><strong>Chapter04 K8S 网络</strong></a></p>
<p><a href="Chapter05-K8S-%E5%AD%98%E5%82%A8"><strong>Chapter05 K8S 存储</strong></a></p>
<p><a href="Chapter06-K8S-%E5%AE%89%E5%85%A8"><strong>Chapter06 K8S 安全</strong></a></p>
<p><a href="Chapter07-K8S-%E8%8A%82%E7%82%B9"><strong>Chapter07 K8S 节点</strong></a></p>
<p><a href="#Chapter04-kubectl"><strong>Chapter04 kubectl</strong></a></p>
<ul>
<li><a href="#4-1-kubelet-%E4%BB%8B%E7%BB%8D">4.1 kubelet 介绍</a></li>
<li><a href="#4-2-SETTINGS-AND-USAGE-%E5%91%BD%E4%BB%A4">4.2 SETTINGS AND USAGE 命令</a></li>
<li><a href="#4-3-GETTING-STARTED-%E5%91%BD%E4%BB%A4">4.3 GETTING STARTED 命令</a></li>
<li><a href="#4-4-APP-MANAGEMENT-%E5%91%BD%E4%BB%A4">4.4 APP MANAGEMENT 命令</a></li>
<li><a href="#4-5-WORKING-WITH-APPS-%E5%91%BD%E4%BB%A4">4.5 WORKING WITH APPS 命令</a></li>
<li><a href="#4-6-CLUSTER-MANAGEMENT-%E5%91%BD%E4%BB%A4">4.6 CLUSTER MANAGEMENT 命令</a></li>
</ul>
<hr>
<h2 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h2><ol>
<li><strong>K8S 官网</strong><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/">https://kubernetes.io/</a></li>
</ul>
</li>
<li><strong>官方文档</strong><ul>
<li>主页 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/home/">https://kubernetes.io/docs/home/</a></li>
<li>入门 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/">https://kubernetes.io/docs/setup/</a></li>
<li>概念 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/">https://kubernetes.io/docs/concepts/</a></li>
<li>任务 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/">https://kubernetes.io/docs/tasks/</a></li>
<li>教程 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/">https://kubernetes.io/docs/tutorials/</a></li>
<li>参考 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/">https://kubernetes.io/docs/reference/</a></li>
</ul>
</li>
<li><strong>kubectl</strong><ul>
<li>介绍 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/">https://kubernetes.io/docs/reference/kubectl/</a></li>
<li>子命令 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands</a></li>
</ul>
</li>
</ol>
<hr>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><ol>
<li><strong>未整理</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">* 集群</span><br><span class="line">  - 修改 kubeadm 源码，证书有效期 10 年</span><br><span class="line"></span><br><span class="line">* 节点</span><br><span class="line">  - 多主多从 K8S 集群</span><br><span class="line">  - K8S 节点管理、添加节点、删除节点</span><br><span class="line"></span><br><span class="line">* 安装</span><br><span class="line">  - 编译安装 K8S</span><br><span class="line"></span><br><span class="line">* 网络组件</span><br><span class="line">  - calico</span><br><span class="line">  - contiv</span><br><span class="line">  - flannel</span><br><span class="line"></span><br><span class="line">* 安全</span><br><span class="line"></span><br><span class="line">* 弹性伸缩</span><br><span class="line"></span><br><span class="line">* HELM</span><br><span class="line"></span><br><span class="line">* chart</span><br><span class="line"></span><br><span class="line">* kubectl alpha 指令</span><br><span class="line"></span><br><span class="line">* kubectl config 指令</span><br><span class="line"></span><br><span class="line">* kubectl plugin 指令</span><br></pre></td></tr></table></figure></li>
<li><strong>不整理</strong></li>
</ol>
<hr>
<h1 id="Chapter03-K8S"><a href="#Chapter03-K8S" class="headerlink" title="Chapter03 K8S"></a>Chapter03 K8S</h1><hr>
<h2 id="3-1-K8S-介绍"><a href="#3-1-K8S-介绍" class="headerlink" title="3.1 K8S 介绍"></a>3.1 K8S 介绍</h2><hr>
<h3 id="知识点：容器编排问题"><a href="#知识点：容器编排问题" class="headerlink" title="知识点：容器编排问题"></a>知识点：容器编排问题</h3><ol>
<li><strong>应用部署方式的演变</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 传统部署</span><br><span class="line">  - 在物理机上部署应用</span><br><span class="line">  - 优点</span><br><span class="line">    - 架构简单</span><br><span class="line">    - 不需要其它技术的参与</span><br><span class="line">  - 缺点</span><br><span class="line">    - 不能为应用程序定义资源使用边界，很难合理地分配计算资源</span><br><span class="line">    - 程序之间容易产生影响</span><br><span class="line"></span><br><span class="line">* 虚拟化部署</span><br><span class="line">  - 在虚拟机上部署应用</span><br><span class="line">  - 优点</span><br><span class="line">    - 程序的环境相互独立</span><br><span class="line">  - 缺点</span><br><span class="line">    - 每个虚拟机都要有独立的 OS 核心，开销较大</span><br><span class="line"></span><br><span class="line">* 容器化部署</span><br><span class="line">  - 在容器中部署应用</span><br><span class="line">  - 优点</span><br><span class="line">    - 共享操作系统</span><br><span class="line">    - 运行应用程序所需要的资源打包为镜像，与底层基础架构解耦</span><br><span class="line">    - 可移植性，镜像可以跨云服务商、跨操作系统发行版进行部署</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>容器编排问题</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 本质上是容器的集群化后，资源管理的问题</span><br><span class="line"></span><br><span class="line">* 稳定性需求</span><br><span class="line">  - 物理机或容器宕机时，立刻让另外一个容器启动去替补受影响的容器</span><br><span class="line"></span><br><span class="line">* 横向扩容需求</span><br><span class="line">  - 当并发访问量变大的时候，自动横向扩展容器数量</span><br><span class="line"></span><br><span class="line">* 数据持久化需求</span><br><span class="line">  - 容器更适合无状态服务，如 nginx、lvs</span><br><span class="line">  - 有状态服务，如 db，需要考虑数据的持久化文件</span><br><span class="line">  - mysql 部署到 K8S 中不稳定</span><br><span class="line">  - mongodb 部署到 K8S 中没事</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>容器编排工具</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 本质上是容器的资源管理器</span><br><span class="line"></span><br><span class="line">* Swarm：</span><br><span class="line">  - Docker 开发</span><br><span class="line">  - 优点，轻量，与 docker 结合度较好</span><br><span class="line">  - 缺点，功能欠缺，如滚动更新</span><br><span class="line">  - 201907 阿里云宣布从选择列表中清除</span><br><span class="line"></span><br><span class="line">* Mesos：</span><br><span class="line">  - Apache 维护，开源分布式资源管理框架</span><br><span class="line">  - 需要和 Marathon 结合使用</span><br><span class="line">  - 201905 twitter 宣布弃用</span><br><span class="line"></span><br><span class="line">* Kubernetes</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：K8S-介绍"><a href="#知识点：K8S-介绍" class="headerlink" title="知识点：K8S 介绍"></a>知识点：K8S 介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 历史</span><br><span class="line">  - Google 开源，使用 go 编写</span><br><span class="line">  - 之前为 Google 的一个内部项目 Borg</span><br><span class="line">  - 201409 发布第一个版本</span><br><span class="line">  - 201507 发布第一个正式版本</span><br><span class="line"></span><br><span class="line">* 主要特点</span><br><span class="line">  - 基于 http 协议进行开发</span><br><span class="line">  - C/S 结构</span><br><span class="line"></span><br><span class="line">* 优点</span><br><span class="line">  - 轻量级，消耗的资源少，由于 go</span><br><span class="line">  - 自动修复，物理机或容器崩溃，K8S 能以秒级启动新的容器</span><br><span class="line">  - 弹性伸缩，平滑，根据压力增加或删除容器</span><br><span class="line">  - 服务发现，服务可以通过自动发现的形式找到它所依赖的服务</span><br><span class="line">  - 负载均衡，基于 ipvs</span><br><span class="line">  - 滚动更新</span><br><span class="line">  - 存储编排，可以根据容器自身需求自动创建存储卷</span><br></pre></td></tr></table></figure></li>
<li><strong>周边生态</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* 监控</span><br><span class="line">  - Prometheus</span><br><span class="line">  - Grafana</span><br><span class="line"></span><br><span class="line">* 日志</span><br><span class="line">  - Elasticsearch</span><br><span class="line">  - Filebeat</span><br><span class="line">  - Logstash</span><br><span class="line">  - Kibana</span><br><span class="line"></span><br><span class="line">* 网络</span><br><span class="line">  - Flannel</span><br><span class="line">  - lstio</span><br><span class="line">  - lvs</span><br><span class="line">  - Calico</span><br><span class="line"></span><br><span class="line">* 开发</span><br><span class="line">  - jenkins</span><br><span class="line"></span><br><span class="line">* 软件管理</span><br><span class="line">  - helm</span><br><span class="line"></span><br><span class="line">* 存储</span><br><span class="line">  - ceph</span><br><span class="line">  - glusterf</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：K8S-节点"><a href="#知识点：K8S-节点" class="headerlink" title="知识点：K8S 节点"></a>知识点：K8S 节点</h3><ol>
<li><strong>控制节点 master</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 集群的管理平面</span><br><span class="line">  - 负责对集群进行管理</span><br><span class="line">  - 负责接收客户端请求</span><br></pre></td></tr></table></figure></li>
<li><strong>工作节点 node</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 集群的业务平面</span><br><span class="line">  - 负责为容器提供运行环境</span><br><span class="line">  - master 分配容器到 node 节点上</span><br><span class="line">  - node 节点上的 docker 运行容器</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：K8S-组件"><a href="#知识点：K8S-组件" class="headerlink" title="知识点：K8S 组件"></a>知识点：K8S 组件</h3><ol>
<li><strong>master 节点组件</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 只在 master 节点上运行</span><br><span class="line"></span><br><span class="line">* apiserver</span><br><span class="line">  - 资源操作的唯一入口</span><br><span class="line">  - 接收用户输入的指令</span><br><span class="line">  - 提供认证、授权、API 注册和发现等机制</span><br><span class="line"></span><br><span class="line">* Scheduler</span><br><span class="line">  - 集群资源调度</span><br><span class="line">  - 按照预定的调度策略将 Pod 调度到相应的 node 节点上</span><br><span class="line"></span><br><span class="line">* ControllerManager</span><br><span class="line">  - 维护集群的状态</span><br><span class="line">  - 程序部署安排、故障检测、自动扩展、滚动更新等</span><br><span class="line"></span><br><span class="line">* Etcd</span><br><span class="line">  - 可信赖的分布式键值存储服务，天生支持集群化</span><br><span class="line">  - v2 版，数据储存在内存中</span><br><span class="line">  - v3 版，数据持久化在硬盘</span><br><span class="line">  - K8S v1.11 以前使用 v2 版，之后使用 v3 版</span><br><span class="line">  - 存储集群中各种资源对象的信息</span><br></pre></td></tr></table></figure></li>
<li><strong>node 节点组件</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在所有节点上运行，包括 master 节点和 node 节点</span><br><span class="line"></span><br><span class="line">* Kubelet</span><br><span class="line">  - 维护容器的生命周期</span><br><span class="line">  - 通过控制 docker 来创建、更新、销毁容器</span><br><span class="line"></span><br><span class="line">* Kube-Proxy</span><br><span class="line">  - 负责集群内部的服务发现和负载均衡</span><br><span class="line"></span><br><span class="line">* Docker</span><br><span class="line">  - 容器运行时</span><br></pre></td></tr></table></figure></li>
<li><strong>组件调用关系</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 集群启动</span><br><span class="line">  - K8S 集群启动之后，master 和 node 都会将自身的信息存储到 etcd 中</span><br><span class="line"></span><br><span class="line">* 创建 pod</span><br><span class="line">  - 客户端发送指令到 apiserver</span><br><span class="line">  - apiserver 调用 scheduler，来选择 node</span><br><span class="line">  - scheduler 读取 etcd 中各个 node 的信息，按照策略进行计算，将结果告知 apiserver</span><br><span class="line">  - apiserver 调用 controller-manager，去调度 Node 节点启动容器</span><br><span class="line">  - kubelet 接收到指令，通知 docker</span><br><span class="line">  - docker 启动容器</span><br><span class="line">  - KubeProxy 为容器创建访问规则</span><br></pre></td></tr></table></figure></li>
<li><strong>其他组件</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* CoreDNS</span><br><span class="line">  - K8S 内部的 dns</span><br><span class="line">  - 会为 K8S 集群内 service 对象创建域名</span><br><span class="line"></span><br><span class="line">* Dashboard</span><br><span class="line">  - K8S 提供的 web 客户端 API</span><br><span class="line"></span><br><span class="line">* IngressController</span><br><span class="line">  - K8S 提供的七层代理</span><br><span class="line"></span><br><span class="line">* Fedetation</span><br><span class="line">  - 多 K8S 集群管理工具</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-2-K8S-概念"><a href="#3-2-K8S-概念" class="headerlink" title="3.2 K8S 概念"></a>3.2 K8S 概念</h2><hr>
<h3 id="知识点：K8S-资源"><a href="#知识点：K8S-资源" class="headerlink" title="知识点：K8S 资源"></a>知识点：K8S 资源</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - resource</span><br><span class="line">  - K8S 中，一切皆资源，用户通过操作资源来管理 K8S</span><br><span class="line">  - 类似 Linux 中一切皆为文件、JAVA 中一切皆对象</span><br><span class="line">  - 所谓创建资源，相当于实例化一个资源类，创建一个资源对象</span><br><span class="line"></span><br><span class="line">* 资源类型 TYPE</span><br><span class="line">  - 所有的操作时均需要指定资源类型</span><br><span class="line">  - 资源类型均有对应的缩写</span><br><span class="line"></span><br><span class="line">* 资源对象命名</span><br><span class="line">  - 可以使用 lower、digit、&#x27;-&#x27;、</span><br><span class="line">  - 不允许使用 upper</span><br></pre></td></tr></table></figure></li>
<li><strong>资源分类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">* 元数据型</span><br><span class="line">  - hpa</span><br><span class="line">  - podtemplete</span><br><span class="line">  - limitrange</span><br><span class="line"></span><br><span class="line">* 集群级资源</span><br><span class="line">  - no，node</span><br><span class="line">  - ns，namespace</span><br><span class="line">  - pv，persistentvolume</span><br><span class="line">  - 安全</span><br><span class="line">    - role</span><br><span class="line"></span><br><span class="line">* 命名空间级资源</span><br><span class="line">  - 工作负载 workload</span><br><span class="line">    - po，pod</span><br><span class="line">    - rc，replicationcontroller</span><br><span class="line">    - rs，replicaset</span><br><span class="line">    - deploy，deployment</span><br><span class="line">    - ds，daemonset</span><br><span class="line">    - job</span><br><span class="line">    - cj，cronjob</span><br><span class="line">    - hpa，horizontalpodautoscaler</span><br><span class="line">    - sts，statefulset</span><br><span class="line">  - 服务发现及负载均衡 ServiceDiscovery and LoadBalance</span><br><span class="line">    - svc，service</span><br><span class="line">    - ing，ingress</span><br><span class="line">  - 存储</span><br><span class="line">    - volume</span><br><span class="line">    - pvc，persistentvolumeclaim</span><br><span class="line">    - CSI（容器存储接口，可扩展各种第三方存储卷）</span><br><span class="line">  - 配置</span><br><span class="line">    - cm，configmap</span><br><span class="line">    - secret</span><br><span class="line">    - downwardapi（把外部环境中的信息输出给容器）</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：K8S-资源清单"><a href="#知识点：K8S-资源清单" class="headerlink" title="知识点：K8S 资源清单"></a>知识点：K8S 资源清单</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - resource configuration</span><br><span class="line">  - K8S 中资源对象的定义文件</span><br><span class="line">  - 支持 yaml 格式或 json 格式</span><br><span class="line">  - 默认 YAML，也推荐 YAML</span><br><span class="line">  - 与 kubectl 命令不同，区分大小写，区分单数复数</span><br><span class="line">  - 须严格遵循 kubectl explain 中的内容</span><br></pre></td></tr></table></figure></li>
<li><strong>一级属性</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在 K8S 中，所有资源的一级属性大多数情况下都一样</span><br><span class="line"></span><br><span class="line">* apiVersion: STRING</span><br><span class="line">  - 指定资源对象的版本号</span><br><span class="line">  - 版本号由 K8S 内部定义，版本号必须可以用 kubectl api-versions 查询到</span><br><span class="line"></span><br><span class="line">* kind: STRING</span><br><span class="line">  - 指定资源类型</span><br><span class="line"></span><br><span class="line">* metadata: Object</span><br><span class="line">  - 设置资源对象的元数据，主要是资源标识和说明</span><br><span class="line"></span><br><span class="line">* spec: Object</span><br><span class="line">  - 详细设置资源对象的各个属性的详细值</span><br><span class="line">  - 定义文件中最重要、最复杂的部分</span><br><span class="line"></span><br><span class="line">* status: Object</span><br><span class="line">  - 状态信息</span><br><span class="line">  - 内容由 K8S 自动生成自动填写，通常不要手动在 yaml 文件中指定</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单值类型</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 也就是 kubectl explain 中显示的内容</span><br><span class="line"></span><br><span class="line">* &lt;integer&gt;</span><br><span class="line"></span><br><span class="line">* &lt;string&gt;</span><br><span class="line"></span><br><span class="line">* &lt;[]string&gt;</span><br><span class="line">  - 字符串列表</span><br><span class="line"></span><br><span class="line">* &lt;boolean&gt;</span><br><span class="line"></span><br><span class="line">* &lt;Object&gt;</span><br><span class="line">  - 对象</span><br><span class="line">  - 在其中设置属性</span><br><span class="line"></span><br><span class="line">* &lt;[]Object&gt;</span><br><span class="line">  - 对象列表</span><br><span class="line"></span><br><span class="line">* &lt;map[string]string&gt;</span><br><span class="line">  - 字符串 k-v 对字典</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：K8S-标签"><a href="#知识点：K8S-标签" class="headerlink" title="知识点：K8S 标签"></a>知识点：K8S 标签</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - LABEL</span><br><span class="line">  - 用来给资源对象上添加标签，继而实现分组和选择</span><br><span class="line">  - 一个资源对象可以同时具有多个 label，label 之间无优先级</span><br><span class="line"></span><br><span class="line">* 格式</span><br><span class="line">  key=value</span><br><span class="line"></span><br><span class="line">* 相关指令</span><br><span class="line">  - kubectl label 指令，可以对资源对象进行添加、更新、删除标签</span><br><span class="line">  - kubectl 中 -l flag，可以通过 label 进行资源对象的筛选</span><br><span class="line"></span><br><span class="line">* 常用 label</span><br><span class="line">  - version</span><br><span class="line">  - env:test、env:dev</span><br><span class="line">  - tier:frontend、tier:backend</span><br><span class="line"></span><br><span class="line">* 节点的默认 label</span><br><span class="line">  - beta.kubernetes.io/arch=amd64</span><br><span class="line">  - beta.kubernetes.io/os=linux</span><br><span class="line">  - kubernetes.io/arch=amd64</span><br><span class="line">  - kubernetes.io/hostname=master</span><br><span class="line">  - kubernetes.io/os=linux</span><br><span class="line">  - node-role.kubernetes.io/master=</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：K8S-标签选择机制"><a href="#知识点：K8S-标签选择机制" class="headerlink" title="知识点：K8S 标签选择机制"></a>知识点：K8S 标签选择机制</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 标签选择机制 Label-Selector</span><br><span class="line">  - K8S 提供的，根据标签来选择资源对象的机制</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>集合方式选择器 matchExpressions</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - matchExpressions 列表中每一项都是一个只针对一个 KEY 的集合运算表达式</span><br><span class="line">  - matchExpressions 整个列表中的项为 AND 逻辑</span><br><span class="line"></span><br><span class="line">* 操作符 operator</span><br><span class="line">  - In</span><br><span class="line">    - 资源对象的 KEY 标签，其值 VALUE 出现在 values 列表中</span><br><span class="line">  - NotIn</span><br><span class="line">    - 资源对象的 KEY 标签，其值 VALUE 没有出现在 values 列表中</span><br><span class="line">    - values 列表不能为空</span><br><span class="line">  - Exists</span><br><span class="line">    - 资源对象具有 KEY 标签</span><br><span class="line">    - values 列表必须为空</span><br><span class="line">  - DoesNotExist</span><br><span class="line">    - 资源对象没有 KEY 标签</span><br><span class="line">    - values 列表必须为空</span><br><span class="line">  - Gt</span><br><span class="line">    - 资源对象的 KEY 标签，其值 VALUE 要比 values 中的值大</span><br><span class="line">    - values 列表必须只包含一个元素，并且必须是 integer</span><br><span class="line">  - Lt</span><br><span class="line">    - 资源对象的 KEY 标签，其值 VALUE 要比 values 中的值小</span><br><span class="line">    - values 列表必须只包含一个元素，并且必须是 integer</span><br></pre></td></tr></table></figure></li>
<li><strong>K-V 方式选择器 matchLabels</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">  <span class="attr">key01:</span> <span class="string">value</span></span><br><span class="line">  <span class="attr">key02:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - matchLabels 中设置 label 的 k-v 对</span><br><span class="line">  - matchLabels 整个列表为 AND 逻辑</span><br><span class="line">  - 资源对象需要具有这些 key，并且 value 就是 k-v 对中的值</span><br></pre></td></tr></table></figure></li>
<li><strong>topologyKey</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 拓扑域</span><br><span class="line">  - 对于一组资源对象，如果均具有某个 label，则 label-value 相同的资源对象，位于一个拓扑域中</span><br><span class="line"></span><br><span class="line">* topologyKey</span><br><span class="line">  - 指定拓扑域的划分参考哪个标签为维度</span><br><span class="line"></span><br><span class="line">* 例如</span><br><span class="line">  - node01 version=v1 env=test</span><br><span class="line">  - node02 version=v1 env=test</span><br><span class="line">  - node03 version=v2 env=production</span><br><span class="line">  - node04 version=v2 env=production</span><br><span class="line">  - node05 version=v3 env=production</span><br><span class="line">  - node06 version=v3 env=unused</span><br><span class="line">  - 指定 topologyKey: version</span><br><span class="line">    - node01、node02 位于同一拓扑域 version=v1 中</span><br><span class="line">    - node03、node04 位于同一拓扑域 version=v2 中</span><br><span class="line">    - node05、node06 位于同一拓扑域 version=v3 中</span><br><span class="line">  - 指定 topologyKey: env</span><br><span class="line">    - node01、node02 位于同一拓扑域中</span><br><span class="line">    - node03、node04、node05 位于同一拓扑域中</span><br><span class="line">    - node06 单独位于一个拓扑域中</span><br><span class="line"></span><br><span class="line">* 对于节点 node，如果指定 topologyKey: kubernetes.io/hostname，则每一个节点自己单独在一个拓扑域中</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：K8S-FIELD"><a href="#知识点：K8S-FIELD" class="headerlink" title="知识点：K8S FIELD"></a>知识点：K8S FIELD</h3><ol>
<li><strong>Field-Selector 机制</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">matchFields:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 集合方式选择器</span><br><span class="line">  - matchFields 列表中每一项只对一个 KEY 进行判断</span><br><span class="line">  - matchFields 整个列表中的项为 AND 逻辑</span><br><span class="line"></span><br><span class="line">* 操作符</span><br><span class="line">  - In</span><br><span class="line">    - 资源对象的 KEY FIELD，其值 VALUE 出现在 values 列表中</span><br><span class="line">  - NotIn</span><br><span class="line">    - 资源对象的 KEY FIELD，其值 VALUE 没有出现在 values 列表中</span><br><span class="line">    - values 列表不能为空</span><br><span class="line">  - Exists</span><br><span class="line">    - 资源对象具有 KEY FIELD</span><br><span class="line">    - values 列表必须为空</span><br><span class="line">  - DoesNotExist</span><br><span class="line">    - 资源对象没有 KEY FIELD</span><br><span class="line">    - values 列表必须为空</span><br><span class="line">  - Gt</span><br><span class="line">    - 资源对象的 KEY FIELD，其值 VALUE 要比 values 中的值大</span><br><span class="line">    - values 列表必须只包含一个元素，并且必须是 integer</span><br><span class="line">  - Lt</span><br><span class="line">    - 资源对象的 KEY FIELD，其值 VALUE 要比 values 中的值小</span><br><span class="line">    - values 列表必须只包含一个元素，并且必须是 integer</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：namespace"><a href="#知识点：namespace" class="headerlink" title="知识点：namespace"></a>知识点：namespace</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 命名空间</span><br><span class="line">  - 逻辑上对应资源组</span><br><span class="line">  - 删除 namespace，会连通其下的所有资源对象一起被删除</span><br></pre></td></tr></table></figure></li>
<li><strong>作用</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 实现多套环境的资源隔离</span><br><span class="line">  - 同一个 namespace 下的资源对象可以相互访问</span><br><span class="line">  - 不属于同一个 namespace 则相互不可见</span><br><span class="line">  - 同一个 namespace 下，同一类型的资源对象不可重名，不同类型的资源对象可以重名</span><br><span class="line">  - 创建 pod 时，如果不手动指定 namespace，则使用 default namespace</span><br><span class="line"></span><br><span class="line">* 实现说多租户的资源隔离</span><br><span class="line">  - 通过 K8S 的授权机制，将不同的 namespace 交给不同租户进行管理</span><br><span class="line">  - 通过 K8S 的资源配额机制，限定不同租户能占用的资源资源配额</span><br></pre></td></tr></table></figure></li>
<li><strong>namespace 状态</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* Active</span><br><span class="line">  - 表示 namespace 正在使用中</span><br><span class="line"></span><br><span class="line">* Terminating</span><br><span class="line">  - 表示 namespace 正在删除中</span><br></pre></td></tr></table></figure></li>
<li><strong>namespace 分类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* default</span><br><span class="line">  - 默认命名空间</span><br><span class="line"></span><br><span class="line">* kube-system</span><br><span class="line">  - 核心命名空间</span><br><span class="line">  - 存放集群的核心组件</span><br><span class="line"></span><br><span class="line">* kube-public</span><br><span class="line">  - 公共命名空间</span><br><span class="line">  - 其中的资源可以被所有人访问，包括未认证用户</span><br><span class="line"></span><br><span class="line">* kube-node-lease</span><br><span class="line">  - 集群节点之间的心跳维护，v1.13 开始引入</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-3-K8S-安装"><a href="#3-3-K8S-安装" class="headerlink" title="3.3 K8S 安装"></a>3.3 K8S 安装</h2><hr>
<h3 id="知识点：K8S-安装介绍"><a href="#知识点：K8S-安装介绍" class="headerlink" title="知识点：K8S 安装介绍"></a>知识点：K8S 安装介绍</h3><ol>
<li><strong>安装方式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* minikube</span><br><span class="line">  - 一个用于快速搭建 kubernetes 单节点的工具</span><br><span class="line"></span><br><span class="line">* kubeadm</span><br><span class="line">  - 一个用于快速搭建 kubernetes 集群的工具</span><br><span class="line"></span><br><span class="line">* 编译安装</span><br><span class="line">  - 从官网下载每个组件的二进制包，依次去安装</span><br><span class="line">  - 难点，组件之间需要产生证书</span><br></pre></td></tr></table></figure></li>
<li><strong>注意点</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* hostname</span><br><span class="line"></span><br><span class="line">* swap</span><br><span class="line">  - K8S 默认强制要求所有节点禁用 swap</span><br><span class="line">  - 如果必须开启 swap 分区，则需要在集群安装过程中指定相应的参数</span><br><span class="line">  - K8S 禁用 swap 的原因，防止容器被调度到 HD 让，会大大降低效率</span><br><span class="line"></span><br><span class="line">* 系统版本</span><br><span class="line">  - centos 7.5 以上</span><br><span class="line">  - K8S 要求内核版本 3.10 以上，但推荐 4.4 以上，因为 3.10 可能会出奇怪的 bug</span><br><span class="line"></span><br><span class="line">* docker</span><br><span class="line">  - docker 默认 cgroup driver为 cgroupfs，kubernetes 推荐使用 systemd 来代替 cgroupfs</span><br><span class="line"></span><br><span class="line">* 网络插件</span><br><span class="line">  - kubernetes 支持多种网络插件，如 flannel、calico、canal 等</span><br><span class="line">  - flannel 插件使用的是 DaemonSet 控制器，它会在每个节点上都运行</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubeadm-搭建-K8S-一主多从集群范例"><a href="#知识点：kubeadm-搭建-K8S-一主多从集群范例" class="headerlink" title="知识点：kubeadm 搭建 K8S 一主多从集群范例"></a>知识点：kubeadm 搭建 K8S 一主多从集群范例</h3><ol>
<li><strong>规划</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* IP 规范</span><br><span class="line">  - master 192.168.31.150</span><br><span class="line">  - node1 192.168.31.151</span><br><span class="line">  - node2 192.168.31.152</span><br><span class="line">  - pod 网段 10.101.0.0</span><br><span class="line">  - service 网段 10.102.0.0</span><br><span class="line"></span><br><span class="line">* 组件版本</span><br><span class="line">  - docker 18.06.3</span><br><span class="line">  - kubelet 1.17.4</span><br><span class="line">  - kubeadm 1.17.4</span><br><span class="line">  - kubectl 1.17.4</span><br><span class="line">  - flannel</span><br></pre></td></tr></table></figure></li>
<li><strong>第一步 准备工作</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 基本配置</span></span><br><span class="line"></span><br><span class="line">* 配置时间同步</span><br><span class="line"></span><br><span class="line">* 禁用 selinux</span><br><span class="line"></span><br><span class="line">* 禁用 iptables 和 firewalld</span><br><span class="line">  systemctl stop iptables &amp;&amp; systemctl disable iptables</span><br><span class="line">  systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line"></span><br><span class="line">* 禁用 swap</span><br><span class="line"></span><br><span class="line">* 安装基础工具</span><br><span class="line">  yum -y install wget</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 内核添加网桥过滤和地址转发功能</span></span><br><span class="line"></span><br><span class="line">* 修改 linux 内核参数</span><br><span class="line">  echo -e &#x27;net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">  net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">  net.ipv4.ip_forward = 1&#x27; &gt; /etc/sysctl.d/kubernetes.conf</span><br><span class="line"></span><br><span class="line">* 重新加载配置</span><br><span class="line">    sysctl -p</span><br><span class="line"></span><br><span class="line">* 加载网桥过滤模块</span><br><span class="line">  modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">* 查看网桥过滤模块是否加载成功</span><br><span class="line">  lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置 ipvs</span></span><br><span class="line"></span><br><span class="line">* 安装 ipvs 管理工具</span><br><span class="line">  yum -y install ipset</span><br><span class="line">  yum -y install epel-release</span><br><span class="line">  yum -y install ipvsadm</span><br><span class="line"></span><br><span class="line">* 添加模块脚本文件</span><br><span class="line">  echo -e &#x27;#!/bin/bash</span><br><span class="line">  modprobe -- ip_vs</span><br><span class="line">  modprobe -- ip_vs_rr</span><br><span class="line">  modprobe -- ip_vs_wrr</span><br><span class="line">  modprobe -- ip_vs_sh</span><br><span class="line">  modprobe -- nf_conntrack_ipv4&#x27; &gt; /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">* 执行脚本文件</span><br><span class="line">  chmod +x /etc/sysconfig/modules/ipvs.modules &amp;&amp; /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">* 检查 ipvs 的 5 个模块是否加载</span><br><span class="line">  lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">* 重启服务器，使所有配置生效</span><br></pre></td></tr></table></figure></li>
<li><strong>第二步 安装集群组件</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 docker</span></span><br><span class="line"></span><br><span class="line">* 切换 aliyun 镜像源</span><br><span class="line">  wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line">* 查看支持的 docker 版本</span><br><span class="line">  yum list docker-ce --showduplicates</span><br><span class="line"></span><br><span class="line">* 安装指定版本的 docker-ce</span><br><span class="line">  yum -y install --setopt=obsoletes=0 docker-ce-18.06.3.ce-3.el7</span><br><span class="line"></span><br><span class="line">* 为 docker 添加 daemon 文件</span><br><span class="line">  mkdir /etc/docker</span><br><span class="line">  echo -e &#x27;&#123;</span><br><span class="line">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://kn0t2bca.mirror.aliyuncs.com&quot;]</span><br><span class="line">  &#125;&#x27; &gt; /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line">* 启动 docker</span><br><span class="line">  systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl enable docker</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 kubelet、kubectl、kubeadm</span></span><br><span class="line"></span><br><span class="line">* 切换 aliyun kubenetes 镜像源</span><br><span class="line">  echo -e &#x27;[kubernetes]</span><br><span class="line">  name=Kubernetes</span><br><span class="line">  baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">  enabled=1</span><br><span class="line">  gpgcheck=0</span><br><span class="line">  repo_gpgcheck=0</span><br><span class="line">  gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">         http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg&#x27; &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line"></span><br><span class="line">* 安装 kubeadm、kubelet 和 kubectl</span><br><span class="line">  yum -y install --setopt=obsoletes=0 kubeadm-1.17.4-0 kubelet-1.17.4-0 kubectl-1.17.4-0</span><br><span class="line"></span><br><span class="line">* 配置 kubelet 的 cgroup</span><br><span class="line">  echo -e &#x27;KUBELET_CGROUP_ARGS=&quot;--cgroup-driver=systemd&quot;</span><br><span class="line">  KUBE_PROXY_MODE=&quot;ipvs&quot; &#x27; &gt; /etc/sysconfig/kubelet</span><br><span class="line"></span><br><span class="line">* 设置 kubelet 开机自启</span><br><span class="line">  systemctl enable kubelet</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载集群组件镜像</span></span><br><span class="line"></span><br><span class="line">* 查看所需的镜像版本</span><br><span class="line">  kubeadm config images list 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">* 从 aliyun kubernetes 仓库下载镜像</span><br><span class="line">  for i in `kubeadm config images list 2&gt;/dev/null`</span><br><span class="line">  do</span><br><span class="line">    imageName=$&#123;i:11&#125;</span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName</span><br><span class="line">    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName</span><br><span class="line">    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName</span><br><span class="line">  done</span><br></pre></td></tr></table></figure></li>
<li><strong>第三步 创建集群</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 初始化集群，在 master 节点执行</span></span><br><span class="line"></span><br><span class="line">* 启动 master 集群镜像</span><br><span class="line">  kube_version=$(kubeadm config images list 2&gt;/dev/null | grep -P -o &#x27;(?&lt;=kube-apiserver:).*&#x27;)</span><br><span class="line">  kubeadm init \</span><br><span class="line">    --kubernetes-version=$&#123;kube_version&#125; \</span><br><span class="line">    --pod-network-cidr=10.101.0.0/16 \</span><br><span class="line">    --service-cidr=10.102.0.0/16 \</span><br><span class="line">    --apiserver-advertise-address=192.168.31.150</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当显示 <span class="string">&quot;Your Kubernetes control-plane has initialized successfully!&quot;</span> 就表示执行成功</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最后一行显示的 <span class="string">&quot;kubeadm join 192.168.31.150::6443 --token XXXX --discovery-token-ca-cert-hash XXXX&quot;</span>，表示了添加 node 节点到 K8S 集群的指令</span></span><br><span class="line"></span><br><span class="line">* 创建 kubectl HOME 配置文件</span><br><span class="line">  mkdir -p ~/.kube</span><br><span class="line">  cp -i /etc/kubernetes/admin.conf ~/.kube/config</span><br><span class="line">  chown $(id -u):$(id -g) ~/.kube/config</span><br><span class="line"></span><br><span class="line">* 验证 master 节点</span><br><span class="line">  kubectl get nodes</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将 node 节点加入集群</span></span><br><span class="line"></span><br><span class="line">* 在 node 节点执行 kubeadm 命令添加节点</span><br><span class="line">  kubeadm join 192.168.31.150::6443 --token XXXX --discovery-token-ca-cert-hash XXXX</span><br><span class="line"></span><br><span class="line">* 在 master 上执行 scp 为 node 节点创建 kubectl HOME 配置文件（可选）</span><br><span class="line">  scp -r ~/.kube node1:~/</span><br><span class="line"></span><br><span class="line">* 验证 node 节点</span><br><span class="line">  kubectl get nodes</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 fannel 网络插件，在 master 节点执行</span></span><br><span class="line"></span><br><span class="line">* 下载 flannel 的 yaml 定义文件 kube-flannel.yml</span><br><span class="line">  mkdir ~/.k8s-yaml</span><br><span class="line">  wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml -P ~/.k8s-yaml/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 视情况修改 yaml 文件中仓库</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 较早版本采用 quay.io 仓库，在国外，建议改为 quay-mirror.qiniu.com</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新版本已改为 docker.io 仓库，如果已经配置了 docker 镜像加速则可以直接访问</span></span><br><span class="line"></span><br><span class="line">* 添加网络插件</span><br><span class="line">  kubectl apply -f ~/.k8s-yaml/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">* 验证网络插件</span><br><span class="line">* 等一段时间后，节点的状态应该都是 &quot;Ready&quot;</span><br><span class="line">  kubect get nodes</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-4-K8S-节点管理"><a href="#3-4-K8S-节点管理" class="headerlink" title="3.4 K8S 节点管理"></a>3.4 K8S 节点管理</h2><hr>
<h3 id="知识点：污点"><a href="#知识点：污点" class="headerlink" title="知识点：污点"></a>知识点：污点</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 污点 taint</span><br><span class="line">  - 用于限制将 pod 调度到节点上</span><br><span class="line">  - 节点可以同时设置多个污点</span><br><span class="line">  - pod 可以设置容忍 Toleration 来强行调度到节点上</span><br><span class="line"></span><br><span class="line">* 相关指令</span><br><span class="line">  - kubectl taint，用于添加或删除污点</span><br><span class="line"></span><br><span class="line">* kubeadm 搭建的集群默认会给 master 节点添加一个污点，所以 pod 就不会调度到 master 节点上</span><br><span class="line">  - node-role.kubernetes.io/master</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>污点形式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* key=value:effect</span><br><span class="line"></span><br><span class="line">* key=value</span><br><span class="line">  - 污点的标签，用作分组管理污点</span><br><span class="line">  - K-V 形式构成了一个二层的标签</span><br><span class="line">  - key 以 letter 或 number 开头，可以包含letters、numbers、hyphens、dots、underscores，也可以包含 &#x27;/&#x27;，最大 253 个字符</span><br><span class="line">  - value 可以省略，以 letter 或 number 开头，可以包含 letters、numbers、hyphens、dots、underscores，最大 63 个字符</span><br><span class="line"></span><br><span class="line">* effect</span><br><span class="line">  - 指定污点的类型，包含以下三种</span><br><span class="line">  - PreferNoSchedule，尽量避免把 Pod 调度到此节点上，除非没有其他节点可调度</span><br><span class="line">  - NoSchedule，严格限制，将不会把 Pod 调度到此节点上，但是不会驱离当前节点上已存在的 Pod</span><br><span class="line">  - NoExecute，最严格限制，将不会把 Pod 调度到此节点上，同时也会驱离当前节点上已存在的 Pod</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-5-K8S-Pod"><a href="#3-5-K8S-Pod" class="headerlink" title="3.5 K8S Pod"></a>3.5 K8S Pod</h2><hr>
<h3 id="知识点：pod-介绍"><a href="#知识点：pod-介绍" class="headerlink" title="知识点：pod 介绍"></a>知识点：pod 介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - pod 是 K8S 最基础的资源，最小的资源封装集合</span><br><span class="line">  - pod 是 K8S 对容器的最小管理单位，容器运行在 pod 中，K8S 通过 pod 管理容器</span><br><span class="line">  - pod 完全运行在一个节点上，不会跨主机</span><br><span class="line">  - K8S 通过 pod 副本，实现应用的高可用</span><br><span class="line">  - pod 不重启容器，只删除重建容器</span><br><span class="line"></span><br><span class="line">* K8S 集群的各个组件也是以 pod 方式运行的，位于 kube-system namespace 中</span><br><span class="line">  - coredns</span><br><span class="line">  - etcd-master</span><br><span class="line">  - kube-apiserver-master</span><br><span class="line">  - kube-controller-manager-master</span><br><span class="line">  - kube-flannel</span><br><span class="line">  - kube-proxy</span><br><span class="line">  - kube-scheduler-master</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 结构</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 用户容器</span><br><span class="line">  - 也称为主容器 main container</span><br><span class="line">  - 一个 pod 中可以有多个用户容器</span><br><span class="line">  - 一个 pod 下，用户容器不可以重名</span><br><span class="line">  - pod 会监控用户容器的运行，保证用户容器处于正常状态</span><br><span class="line">  - 当用户容器发生故障， pod 会重建用户容器</span><br><span class="line">    - 旧的会处于 stop 状态保留</span><br><span class="line">    - 重建用户容器不会导致 pod 重启，不会导致重启 pause 容器或重新进行初始化容器</span><br><span class="line">    - 重建用户容器会使 pod restart 数 +1</span><br><span class="line">  - 删除 pod 会删除 pod 下所有的用户容器，包括 stop 的容器</span><br><span class="line"></span><br><span class="line">* pause 容器</span><br><span class="line">  - pause 容器是 pod 的根容器，是评估整个 Pod 的健康状态的依据</span><br><span class="line">  - pause 容器是的创建是创建 pod 的第一步，一个 pod 只能有一个 pause 容器</span><br><span class="line">    - 创建 pause 容器与初始化容器同步进行</span><br><span class="line">  - pause 容器故障会导致 pod 需要重新经历完成的启动过程，包括初始化容器等</span><br><span class="line">  - 用户容器共用 pause 容器的网络栈</span><br><span class="line">    - 在 pause 容器上设置 IP 地址，所有用户容器都共享此 IP，实现 pod 内部的网路通信和 pod 对外的网络通信</span><br><span class="line">    - 用户容器没有自己独立的 IP 地址</span><br><span class="line">    - 在一个 pod 内，用户容器直接可以直接使用 localhost:port 方式相互通信</span><br><span class="line">    - 在一个 pod 内，端口不能重复</span><br><span class="line">    - 在一个 pod 内，所有的用户容器的 hostname 都是 pod name</span><br><span class="line">  - 用户容器共用 pause 容器的存储卷</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 对容器的管理</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 用户容器的名字，以数字结尾，用来表示容器的生命周期轮次</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 状态</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">* 也称为相位 phase</span><br><span class="line"></span><br><span class="line">* Pending</span><br><span class="line">  - 挂起</span><br><span class="line">  - apiserver 已经创建了 pod 资源对象，但它尚未被完全建立</span><br><span class="line">  - 通常是因为 pod 调度完成或者仍处于下载镜像的过程中</span><br><span class="line"></span><br><span class="line">* Init: N/M</span><br><span class="line">  - 初始化容器</span><br><span class="line">  - N 表示已执行，M 表示总数</span><br><span class="line"></span><br><span class="line">* Running</span><br><span class="line">  - 运行中</span><br><span class="line">  - pod 已经被调度至某节点，并且所有容器都已经被 kubelet 创建完成</span><br><span class="line"></span><br><span class="line">* Succeeded</span><br><span class="line">  - 成功</span><br><span class="line">  - pod 中的所有容器都已经成功，并且终止，并且不会被重启</span><br><span class="line"></span><br><span class="line">* Failed</span><br><span class="line">  - 失败</span><br><span class="line">  - pod 中所有容器都已经终止，但至少有一个容器的退出状态非 0</span><br><span class="line"></span><br><span class="line">* Unknown</span><br><span class="line">  - 未知</span><br><span class="line">  - apiserver 无法正常获取到 pod 对象的状态信息，通常由网络通信失败所导致</span><br><span class="line"></span><br><span class="line">* Terminating</span><br><span class="line">  - pod 正在删除中</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get pod</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get pod -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   1/1     Running   0          11s   10.244.1.138   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RESTERTS    pod 重启用户容器的次数</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-生命周期"><a href="#知识点：pod-生命周期" class="headerlink" title="知识点：pod 生命周期"></a>知识点：pod 生命周期</h3><ol>
<li><strong>pod 生命周期</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">* 创建 pod</span><br><span class="line">  - 创建 pause 容器</span><br><span class="line">  - 初始化网络和数据卷</span><br><span class="line"></span><br><span class="line">* 初始化容器阶段 init container phase</span><br><span class="line">  - 在 pause 容器创建完成并成功初始化忘了和数据卷后开始</span><br><span class="line">  - 依次创建初始化容器</span><br><span class="line">  - 每个初始化容器成功结束后，创建下一个初始化容器</span><br><span class="line">  - 相关配置 pod.spec.initContainers</span><br><span class="line"></span><br><span class="line">* 主容器阶段 main container phase</span><br><span class="line">  - 启动容器</span><br><span class="line">    - 在最后一个初始化容器成功退出后，开始</span><br><span class="line">    - 同时启动所有的用户容器</span><br><span class="line">    - 在启动用户容器的同时，在用户容器中执行设置的启动后钩子函数 postStart</span><br><span class="line">    - 后钩子函数运行成功后，容器才会被视为正常启动</span><br><span class="line">    - 相关配置 pod.spec.containers.lifecycle.postStart</span><br><span class="line">  - 存活探测</span><br><span class="line">    - 后钩子结束后开始</span><br><span class="line">    - 容器就绪性探针 readinessProbe</span><br><span class="line">    - 相关配置 pod.spec.containers.readinessProbe</span><br><span class="line">    - 容器存活性探针 livenessProbe</span><br><span class="line">    - 相关配置 pod.spec.containers.livenessProbe</span><br><span class="line">  - 结束容器</span><br><span class="line">    - 停止容器存活性探测和容器就绪性探测</span><br><span class="line">    - 执行终止前钩子 preStop</span><br><span class="line">    - 相关配置 pod.spec.containers.lifecycle.preStop</span><br><span class="line"></span><br><span class="line">* pod 每次重启，都需要完整经历一次生命周期，即从 pause 容器、初始化容器开始</span><br><span class="line"></span><br><span class="line">* 探针、钩子函数都是由 kubelet 对容器进行检测</span><br><span class="line">  - 诊断结果为三种</span><br><span class="line">    - 成功</span><br><span class="line">    - 失败</span><br><span class="line">    - 未知</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 创建过程</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. 用户发送要创建 pod 的信息给 apiserver</span><br><span class="line"></span><br><span class="line">2. apiserver 生成 pod 对象信息，同时返回确认信息至客户端</span><br><span class="line"></span><br><span class="line">3. apiserver 将生成的 pod 对象信息信息存入 etcd</span><br><span class="line">  - 在整个 pod 生命周期中，apiserver 通过不断更新 etcd 中记录的 pod 对象信息，来反映 pod 的变化</span><br><span class="line">  - 其它组件使用 watch 机制来跟踪检查 apiserver 上的变动</span><br><span class="line"></span><br><span class="line">4. scheduler 发现有新的 pod 对象要创建，根据调度算法计算出分配的主机</span><br><span class="line"></span><br><span class="line">5. scheduler 将调度计算结果发送给 apiserver，apiserver 将调度计算结果存入到 etcd 中</span><br><span class="line"></span><br><span class="line">6. node 节点上的 kubelet 通过 watch etcd，发现有 pod 调度过来，尝试调用 docker 启动容器</span><br><span class="line"></span><br><span class="line">7. kubelet 将 pod 创建成功的信息发送给 apiserver</span><br><span class="line"></span><br><span class="line">8. apiserver 将 pod 信息存入到 etcd 中</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 删除过程</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1. 用户发送要删除 pod 的信息给 apiserver</span><br><span class="line"></span><br><span class="line">2. apiServcer 在 etcd 中将 pod 标记为 terminating 状态，并设置宽限期</span><br><span class="line">  - 宽限期默认 30s</span><br><span class="line">  - 在宽限期内，pod 被 apiServcer 视为 dead</span><br><span class="line"></span><br><span class="line">3. kubelet 通过 watch etcd，监控到 pod 状态转为 terminating 状态，开始关闭 pod</span><br><span class="line"></span><br><span class="line">4. 端点控制器通过 watch etcd，监控到 pod 对象的关闭行为，将其从所有匹配到此端点的 service 资源的端点列表中移除</span><br><span class="line">  - 流量停止发送给 pod</span><br><span class="line"></span><br><span class="line">5. 宽限期结束后，若 pod 中还存在仍在运行的进程，那么 pod 对象会收到立即终止的信号</span><br><span class="line">  - kubelet 请求 apiserver 将此 pod 资源的宽限期设置为 0 从而完成删除操作，此时 pod 对于用户已不可见</span><br></pre></td></tr></table></figure></li>
<li><strong>图示</strong><br><img src="/2000/01/01/Blog32-k8s/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png"></li>
</ol>
<hr>
<h3 id="知识点：pod-调度"><a href="#知识点：pod-调度" class="headerlink" title="知识点：pod 调度"></a>知识点：pod 调度</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 调度，即一个 Pod 在哪个 Node 节点上运行</span><br><span class="line">  - K8S 默认采用自动调度，由 Scheduler 组件自动完成，不受人工控制</span><br><span class="line">  - K8S 支持人工对调度进行介入</span><br></pre></td></tr></table></figure></li>
<li><strong>Scheduler 调度介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* Scheduler 在启动后，会一直监听 apiserver</span><br><span class="line">  - 获取 podspec.NodeName 为空的 pod</span><br><span class="line">  - 为 pod 创建一个与 node 的 binding，表明此 pod 应该放在哪个节点</span><br><span class="line"></span><br><span class="line">* Scheduler 并不直接控制 pod，仅根据调度算法进行计算</span><br><span class="line">  - Scheduler 计算出结果，发送给 apiserver</span><br><span class="line">  - apiserver 将结果存入到 etcd 中</span><br><span class="line">  - node 上的 kubectl 通过 watch etcd，获知调度请求，继而启动 pod</span><br><span class="line"></span><br><span class="line">* Scheduler 进程应当保证是奇数个</span><br><span class="line">  - 投票</span><br><span class="line"></span><br><span class="line">* Scheduler 的调度过程</span><br><span class="line">  - predicate 预选</span><br><span class="line">  - priority 优选</span><br><span class="line"></span><br><span class="line">* Scheduler 的调度原则</span><br><span class="line">  - 公平</span><br><span class="line">    - 保证每个节点都能被利用到</span><br><span class="line">  - 资源高效利用</span><br><span class="line">    - 集群所有资源最大化被使用</span><br><span class="line">  - 效率</span><br><span class="line">    - 能够尽快计算出调度的结果</span><br><span class="line">  - 灵活</span><br><span class="line">    - 允许用户根据需求控制调度的逻辑</span><br></pre></td></tr></table></figure></li>
<li><strong>Scheduler 预选阶段 predicate</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 目的，过滤掉不满足条件的节点</span><br><span class="line">  - 预选阶段会对一系列策略进行匹配，只要有任何一个策略不满足，则节点就会被排除</span><br><span class="line">  - 预选阶段如果没有合适的节点，则 pod 会一直处于 pending 状态，不断重试调度</span><br><span class="line">  - 预选节点如果有多个节点满足条件，就进入优选阶段对节点进行排序</span><br><span class="line"></span><br><span class="line">* predicate 支持的策略</span><br><span class="line">  - PodFitsResources</span><br><span class="line">    - 节点上的剩余资源是否大于 pod 请求的资源</span><br><span class="line">  - PodFitsHost</span><br><span class="line">    - 如果 pod 指定了 NodeName 配置，则节点是否符合 pod 的 NodeName 配置</span><br><span class="line">  - PodFitsHostPorts</span><br><span class="line">    - 节点是否已存在 pod 与申请 pod 的端口冲突</span><br><span class="line">  - PodSelectorMatches</span><br><span class="line">    - 如果 pod 指定了 Label 匹配，则节点 Label 是否满足 Pod 的配置</span><br><span class="line">  - NoDiskConflict</span><br><span class="line">    - 节点是否存在已 mount 的 volume 与 pod 的 volume 相冲突</span><br></pre></td></tr></table></figure></li>
<li><strong>Scheduler 优选阶段</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 接收</span><br><span class="line">  - 对预选后的结果计算优先级，按照优先级进行排序</span><br><span class="line"></span><br><span class="line">* 每一个优先级项就是一个 K-V 对</span><br><span class="line">  - K 是优先级项的名称</span><br><span class="line">  - V 是优先级项的权重</span><br><span class="line">  - 根据节点的情况，计算出相应 K 的 V 值</span><br><span class="line"></span><br><span class="line">* 在综合了所有优先级项 K-V 后，按照算法计算得出最优结果</span><br><span class="line"></span><br><span class="line">* 部分优先级项</span><br><span class="line">  - LeastResquestedPriority</span><br><span class="line">    - 节点的 CPU 和 Memory 使用率</span><br><span class="line">    - 使用率越低，则权重值越高</span><br><span class="line">    - 用来倾向 CPU 和 Memory 使用率低的节点</span><br><span class="line">  - BalancedResourceAllocation</span><br><span class="line">    - 节点的 CPU 和 Mempry 使用率的平衡情况</span><br><span class="line">    - CPU 和 Memory 的使用率约接近，则权重越高</span><br><span class="line">    - 用来倾向 CPU 和 Memory 均衡的节点</span><br><span class="line">  - ImageLocalityPriority</span><br><span class="line">    - 节点已经拥有 pod 所需要运行的镜像</span><br><span class="line">    - 镜像总大小越大，权重越高</span><br><span class="line">    - 用来倾向不需要额外下载镜像、或下载量较少的节点</span><br></pre></td></tr></table></figure></li>
<li><strong>人工介入调度</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 定向调度</span><br><span class="line">  - 人工手动指定 pod 在某台 node 上运行</span><br><span class="line">  - 定向调度是强制的</span><br><span class="line">    - 即，即使 node 不存在或故障，也会将 pod 调度到此 node 上，此时 pod 必然会运行失败</span><br><span class="line">  - pod.spec.nodeName</span><br><span class="line">  - pod.spec.nodeSelector</span><br><span class="line"></span><br><span class="line">* 亲和性调度</span><br><span class="line">  - pod.spec.affinity.nodeAffinity</span><br><span class="line">  - pod.spec.affinity.podAffinity</span><br><span class="line">  - pod.spec.affinity.podAntiAffinity</span><br><span class="line"></span><br><span class="line">* 污点和容忍</span><br><span class="line">  - node 污点 taint</span><br><span class="line">  - pod 容忍 pod.spec.tolerations</span><br></pre></td></tr></table></figure></li>
<li><strong>自定义调度器</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* K8S 支持自行编写调度器</span><br><span class="line"></span><br><span class="line">* pod.spec.schedulername 可以指定使用某个调度器</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-资源清单"><a href="#知识点：pod-资源清单" class="headerlink" title="知识点：pod 资源清单"></a>知识点：pod 资源清单</h3><ol>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl explain pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>                       <span class="comment"># 采用自主式 pod</span></span><br><span class="line"><span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">containers:</span> <span class="string">&lt;[]Object&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">affinity:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="string">&lt;boolean&gt;</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">volumes:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">initContainers:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">nodeSelector:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">  <span class="attr">tolerations:</span> <span class="string">&lt;[]Object&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动一个仅 nginx 的 pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-affinity"><a href="#知识点：pod-spec-affinity" class="headerlink" title="知识点：pod.spec.affinity"></a>知识点：pod.spec.affinity</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 pod 的各种亲和性</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">affinity:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">podAffinity:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">podAntiAffinity:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-affinity-nodeAffinity"><a href="#知识点：pod-spec-affinity-nodeAffinity" class="headerlink" title="知识点：pod.spec.affinity.nodeAffinity"></a>知识点：pod.spec.affinity.nodeAffinity</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 pod 的节点亲和性</span><br><span class="line">  - 本质上一组调度规则组成的列表</span><br><span class="line">  - 如果同时定义了 nodeSelector 和 nodeAffinity，那么必须两个条件都得到满足，Pod 才能运行在指定的 Node 上</span><br><span class="line">  - 节点亲和性的设置只在创建 pod 时生效，在 pod 运行期间不会造成影响</span><br><span class="line">    - 如果一个 pod 所在的 Node 在 Pod 运行期间其标签发生了改变，不再符合该 Pod 的节点亲和性需求，则系统将忽略此变化</span><br><span class="line"></span><br><span class="line">* 软限制</span><br><span class="line">  - 优先调度，如果没有 node 符合规则，则采用自动调度</span><br><span class="line">  - 当有多可选结果时，按照权重进行选择</span><br><span class="line">  - 权重的计算方式为，符合的所有规则的权重之和</span><br><span class="line"></span><br><span class="line">* 硬限制</span><br><span class="line">  - 如果没有 node 符合规则，则采用调度失败</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodeAffinity:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span>   <span class="comment"># 软限制方式</span></span><br><span class="line">  <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;Object&gt;</span>      <span class="comment"># 硬限制方式</span></span><br></pre></td></tr></table></figure></li>
<li><strong>软限制 preferredDuringSchedulingIgnoredDuringExecution</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置节点亲和性软限制的规则列表</span><br><span class="line">  - 针对规则列表中的设置，来计算相应节点的权重</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">weight:</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span>      <span class="comment"># 设置此条规则的权重，范围在 1-100</span></span><br><span class="line">  <span class="attr">preference:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>   <span class="comment"># 设置此条规则的详细要求，所有要求之间以 AND 逻辑存在，即要满足一条规则的话需要满足 preference 下的所有设置</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span>        <span class="comment"># 设置 Label-Selector 机制的筛选条件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">    <span class="attr">matchFields:</span> <span class="string">&lt;[]Object&gt;</span>             <span class="comment"># 设置 Field-Selector 机制的筛选条件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>硬限制 requiredDuringSchedulingIgnoredDuringExecution</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置节点亲和性硬限制的规则列表</span><br><span class="line">  - 列表中的每一项代表一条规则</span><br><span class="line">  - 所有的规则之间是 OR 逻辑，一个 node 只需满足其中一条就视节点符合条件</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">nodeSelectorTerms:</span> <span class="string">&lt;[]Object&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span>            <span class="comment"># 设置 Label-Selector 机制的筛选条件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">matchFields:</span> <span class="string">&lt;[]Object&gt;</span>                 <span class="comment"># 设置 Field-Selector 机制的筛选条件</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 软限制，优先调度到 env 标签为 test 的节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">env</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">test</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 硬限制，调度到标签 &quot;nodetype&quot; 的值为 &quot;xxx&quot; 或 &quot;yyy&quot; 的节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodetype</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 硬限制，调度到不含有 &quot;nodetype&quot; 标签的节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodetype</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">Exists</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-affinity-podAffinity"><a href="#知识点：pod-spec-affinity-podAffinity" class="headerlink" title="知识点：pod.spec.affinity.podAffinity"></a>知识点：pod.spec.affinity.podAffinity</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 pod 的 pod 亲和性</span><br><span class="line">  - 对 pod 的 label 进行匹配</span><br><span class="line">  - 实现让新创建的 Pod 跟参照 pod 在一个区域</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - 如果两个应用频繁交互，应当尽量将两个应用部署在同一个 node，以减少因网络通信而带来的性能损耗，例如 tomcat 与数据库</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">podAffinity:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span>   <span class="comment"># 软限制</span></span><br><span class="line">  <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 硬限制</span></span><br></pre></td></tr></table></figure></li>
<li><strong>软限制 preferredDuringSchedulingIgnoredDuringExecution</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 pod 亲和性软限制的规则列表</span><br><span class="line">  - 针对规则列表中的设置，来计算相应节点的权重</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">weight:</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span>          <span class="comment"># 权重，范围在 1-100</span></span><br><span class="line">  <span class="attr">podAffinityTerm:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>  <span class="comment"># 规则的具体细节</span></span><br><span class="line">    <span class="attr">namespaces:</span> <span class="string">&lt;[]string&gt;</span>                  <span class="comment"># 指定参考 pod 所在的命名空间，省略则表示与设置 pod 相同的命名空间</span></span><br><span class="line">    <span class="attr">topologyKey:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>        <span class="comment"># 指定调度的拓扑域 label</span></span><br><span class="line">                                            <span class="comment"># 调度到参考 pod 所在节点的同一拓扑域的节点</span></span><br><span class="line">                                            <span class="comment"># kubernetes.io/hostname 则相当于将 pod 放在参考 pod 的同一节点</span></span><br><span class="line">                                            <span class="comment"># beta.kubernetes.io/os 则将 pod 放在与参考 pod 具有相同操作系统类型的节点</span></span><br><span class="line">    <span class="attr">labelSelector:</span> <span class="string">&lt;Object&gt;</span>             <span class="comment"># 选择参考 pod，采用 Label-Selector 机制</span></span><br><span class="line">      <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span>          <span class="comment"># 集合方式</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>           <span class="comment"># 不支持 Gt 和 Lt 操作符</span></span><br><span class="line">        <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">      <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span>      <span class="comment"># K-V 方式</span></span><br><span class="line">        <span class="attr">key01:</span> <span class="string">value</span></span><br><span class="line">        <span class="attr">key02:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure></li>
<li><strong>硬限制 requiredDuringSchedulingIgnoredDuringExecution</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 pod 亲和性硬限制的规则列表</span><br><span class="line">  - 列表中的每一项代表一条规则</span><br><span class="line">  - 所有的规则之间是 OR 逻辑，一个 node 只需满足其中一条就视节点符合条件</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">namespaces:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">topologyKey:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">labelSelector:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">      <span class="attr">key01:</span> <span class="string">value</span></span><br><span class="line">      <span class="attr">key02:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 软限制，将 pod 调度到标签 web 为 web01 或 web02 的 pod 所在的节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">web</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span> [<span class="string">&quot;web01&quot;</span>,<span class="string">&quot;web02&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 软限制，将 pod 调度到标签 web 为 web01 且标签 env 为 test 的 pod 所在的节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchLabels:</span></span><br><span class="line">              <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">              <span class="attr">env:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 硬限制，将 pod 调度到标签 web 为 web01 或 web02 的 pod 所在的节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">        <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">web</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;web01&quot;</span>,<span class="string">&quot;web02&quot;</span>]</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-affinity-podAntiAffinity"><a href="#知识点：pod-spec-affinity-podAntiAffinity" class="headerlink" title="知识点：pod.spec.affinity.podAntiAffinity"></a>知识点：pod.spec.affinity.podAntiAffinity</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 pod 的 pod 反亲和性</span><br><span class="line">  - 配置内容与 pod 亲和性基本相同</span><br><span class="line">  - 根据 pod label 匹配</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - 一个应用的多副本，应当分散在不同 node 上，以提高服务的高可用性</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">podAntiAffinity:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span>   <span class="comment"># 软限制</span></span><br><span class="line">  <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span>    <span class="comment"># 硬限制</span></span><br></pre></td></tr></table></figure></li>
<li><strong>软限制 preferredDuringSchedulingIgnoredDuringExecution</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">weight:</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">podAffinityTerm:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span></span><br><span class="line">    <span class="attr">topologyKey:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">    <span class="attr">namespaces:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">    <span class="attr">labelSelector:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">        <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">      <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">        <span class="attr">key01:</span> <span class="string">value</span></span><br><span class="line">        <span class="attr">key02:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure></li>
<li><strong>硬限制 requiredDuringSchedulingIgnoredDuringExecution</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">namespaces:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">topologyKey:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">labelSelector:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">values:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">      <span class="attr">key01:</span> <span class="string">value</span></span><br><span class="line">      <span class="attr">key02:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers"><a href="#知识点：pod-spec-containers" class="headerlink" title="知识点：pod.spec.containers"></a>知识点：pod.spec.containers</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 pod 中所包含的容器，已经每个容器的详细配置</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>     <span class="comment"># 容器名称</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&lt;string&gt;</span>               <span class="comment"># 镜像名称</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">args:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">ports:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">lifecycle:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">livenessProbe:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">readinessProbe:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">workingDir:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">volumeMounts:</span> <span class="string">&lt;[]Object&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-imagePullPolicy"><a href="#知识点：pod-spec-containers-imagePullPolicy" class="headerlink" title="知识点：pod.spec.containers.imagePullPolicy"></a>知识点：pod.spec.containers.imagePullPolicy</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置容器的镜像拉取策略</span><br><span class="line">  - 支持三个值，Always、IfNotPresent、Never</span><br><span class="line">    - Always，总是拉取</span><br><span class="line">    - IfNotPresent，只有当本地没有时才拉取</span><br><span class="line">    - Never，从不拉取，要是本地没有就报错</span><br><span class="line">  - 默认值</span><br><span class="line">    - 对于 latest 镜像为 Always</span><br><span class="line">    - 其他为 IfNotPresent</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-command"><a href="#知识点：pod-spec-containers-command" class="headerlink" title="知识点：pod.spec.containers.command"></a>知识点：pod.spec.containers.command</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置容器的命令替换</span><br><span class="line">  - exec 格式</span><br><span class="line">  - 替换 Dockerfile 的 ENTRYPOINT 设置</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">command:</span> <span class="string">&lt;[]string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为 busybox 容器额外设置一个守护指令</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;while sleep 5 ; do sleep 5 ; done &#x27;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-args"><a href="#知识点：pod-spec-containers-args" class="headerlink" title="知识点：pod.spec.containers.args"></a>知识点：pod.spec.containers.args</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置容器的命令替换</span><br><span class="line">  - exec 格式</span><br><span class="line">  - 替换 Dockerfile 的 CMD 设置</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">args:</span> <span class="string">&lt;[]string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-env"><a href="#知识点：pod-spec-containers-env" class="headerlink" title="知识点：pod.spec.containers.env"></a>知识点：pod.spec.containers.env</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 为容器指定环境变量</span><br><span class="line">  - 环境变量可以直接在容器的 command 配置中使用，用来调整容器的启动指令</span><br><span class="line">  - 指定变量替换需要使用 $(var) 而不是 $&#123;var&#125;</span><br><span class="line"></span><br><span class="line">* value 和 valueFrom 只能选择一种</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">valueFrom:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过环境变量修改容器的启动指令</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ubuntu</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ubuntu01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ubuntu:20.04</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;echo&quot;</span>,<span class="string">&quot;$(data)&quot;</span>]</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">value:</span> <span class="number">3333</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-env-valueFrom"><a href="#知识点：pod-spec-containers-env-valueFrom" class="headerlink" title="知识点：pod.spec.containers.env.valueFrom"></a>知识点：pod.spec.containers.env.valueFrom</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 在为容器设置环境变量时，从某个来源处获取环境变量的 value</span><br><span class="line"></span><br><span class="line">* 支持四种方式，只能使用一种</span><br><span class="line">  - configMapKeyRef     # 从相同 namespace 的 configmap 中获取 value</span><br><span class="line">  - secretKeyRef        # 从相同 namespace 的 secret 中获取 value</span><br><span class="line">  - fieldRef            # 从 pod 的 field 中获取 value</span><br><span class="line">  - resourceFieldRef    # 从容器的 resource limit 中获取 value</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">valueFrom:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">configMapKeyRef:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">fieldRef:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">resourceFieldRef:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">secretKeyRef:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">valueFrom:</span></span><br><span class="line">  <span class="attr">configMapKeyRef:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>    <span class="comment"># 指定 configmap 中的 key</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&lt;string&gt;</span>              <span class="comment"># 指定 configmap 的名字</span></span><br><span class="line">    <span class="attr">optional:</span> <span class="string">&lt;boolean&gt;</span>         <span class="comment"># 指定是否必须要求 configmap 和 key 已经设置</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">valueFrom:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">secretKeyRef:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>    <span class="comment"># 指定 secret 中的 key</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&lt;string&gt;</span>              <span class="comment"># 指定 secret 的名字</span></span><br><span class="line">    <span class="attr">optional:</span> <span class="string">&lt;boolean&gt;</span>         <span class="comment"># 指定是否必须要求 secret 和 key 已经设置</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">valueFrom:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">fieldRef:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">&lt;string&gt;</span>              <span class="comment"># FieldPath 的模式的版本，默认即可，默认 v1</span></span><br><span class="line">    <span class="attr">fieldPath:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>    <span class="comment"># 想要获取的 field</span></span><br><span class="line"></span><br><span class="line"><span class="string">fieldPath</span> <span class="string">目前支持的值</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metadata.name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metadata.namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metadata.labels</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metadata.annotations</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">spec.nodeName</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">spec.serviceAccountName</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">status.hostIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">status.podIP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">status.podIPs</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">valueFrom:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">resourceFieldRef:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-envFrom"><a href="#知识点：pod-spec-containers-envFrom" class="headerlink" title="知识点：pod.spec.containers.envFrom"></a>知识点：pod.spec.containers.envFrom</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 将一整个 configmap 中的 K-V 都导入到容器中作为环境变量</span><br><span class="line"></span><br><span class="line">* configMapRef 和 secretRef 只能选择一种</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">envFrom: &lt;[]Object&gt;</span><br><span class="line">- prefix: &lt;string&gt;          # 为导入的环境变量，全部添加前缀</span><br><span class="line">  configMapRef: &lt;Object&gt;    # 指定要导入的 configmap</span><br><span class="line">    name: &lt;string&gt;              # 指定 configmap NAME</span><br><span class="line">    optional: &lt;boolean&gt;         # 指定是否 configmap 必须已设置</span><br><span class="line">  secretRef: &lt;Object&gt;       # 指定要导入的 secret</span><br><span class="line">    name: &lt;string&gt;              # 指定 secret NAME</span><br><span class="line">    optional: &lt;boolean&gt;         # 指定是否 secret 必须已设置</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-ports"><a href="#知识点：pod-spec-containers-ports" class="headerlink" title="知识点：pod.spec.containers.ports"></a>知识点：pod.spec.containers.ports</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置容器要暴露的端口的列表</span><br><span class="line"></span><br><span class="line">* 省略 hostPort 就表示与 containerPort 相同</span><br><span class="line"></span><br><span class="line">* 如果同时设置了 containerPort 和 hostPort，则表示设置容器端口映射</span><br><span class="line">  - 基本没用</span><br><span class="line">  - 在 pod 控制器管理下的 pod 多副本模式，若采取了此设置，可能导致在同一个 node 上运行的多个 pod 副本相冲突而发生 pod 启动失败</span><br><span class="line"></span><br><span class="line">* 如果采用 hostNetwork 模式的网络，则必须要指定容器的 containerPort，并且 hostPort 要和 containerPort 相同</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span>                        <span class="comment"># 为这项配置起个名字</span></span><br><span class="line">  <span class="attr">containerPort:</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span>   <span class="comment"># 指定容器要暴露的端口</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="string">&lt;integer&gt;</span>                   <span class="comment"># 指定端主机端口，省略则与 containerPort 相同</span></span><br><span class="line">  <span class="attr">protocol:</span> <span class="string">&lt;string&gt;</span>                    <span class="comment"># 指定协议，默认 TCP，可以是 UDP、TCP、SCTP</span></span><br><span class="line">  <span class="attr">hostIP:</span> <span class="string">&lt;string&gt;</span>                      <span class="comment"># 指定主机 IP，一般省略表示主机的所有 IP</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 pod 中容器进行端口绑定，80 映射到主机 3333 端口</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="number">3333</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-resources"><a href="#知识点：pod-spec-containers-resources" class="headerlink" title="知识点：pod.spec.containers.resources"></a>知识点：pod.spec.containers.resources</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 对容器设置资源限制</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">limits:</span> <span class="string">&lt;map[string]string&gt;</span>     <span class="comment"># 为容器指定最大资源，当主机剩余资源不足时，会重启容器</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&lt;string&gt;</span>                     <span class="comment"># CPU core 数量，可以是小数</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">&lt;string&gt;</span>                  <span class="comment"># 内存大小</span></span><br><span class="line">  <span class="attr">requests:</span> <span class="string">&lt;map[string]string&gt;</span>   <span class="comment"># 为容器指定最小资源，当主机剩余资源不足时，容器无法启动</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制容器 CPU 最大为 2，内存最大为 100m</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-lifecycle"><a href="#知识点：pod-spec-containers-lifecycle" class="headerlink" title="知识点：pod.spec.containers.lifecycle"></a>知识点：pod.spec.containers.lifecycle</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置容器的钩子函数 hook</span><br><span class="line">  - 在容器内执行</span><br><span class="line">  - 能够感知 lifecycle event，在对应的时刻运行用户指定的程序代码</span><br><span class="line"></span><br><span class="line">* K8S 提供了两个钩子函数</span><br><span class="line">  - postStart</span><br><span class="line">    - 创建容器时执行</span><br><span class="line">    - 如果失败了，会按照重启策略进行重启容器</span><br><span class="line">  - preStop</span><br><span class="line">    - 终止容器前执行</span><br><span class="line">    - 在其完成之前会阻塞删除容器的操作，执行完成之后容器将成功终止</span><br><span class="line"></span><br><span class="line">* 钩子函数支持三种执行方式，配置时只能选择一种方式</span><br><span class="line">  - exec</span><br><span class="line">    - 在容器内执行指令</span><br><span class="line">    - 如果命令的退出状态为 0 则成功，否则失败</span><br><span class="line">  - httpGet</span><br><span class="line">    - 对指定的地址发送 http get 请求</span><br><span class="line">    - 相应状态码 200-400 之间则成功，否则失败</span><br><span class="line">  - tcpSocket</span><br><span class="line">    - 以容器的 ip:port 为 socket 建立一个 tcp 连接，目的是检查容器是否打开了端口</span><br><span class="line">    - 如果成功建立 tcp 连接则成功</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">postStart:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">httpGet:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">tcpSocket:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">preStop:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">    <span class="attr">httpGet:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">httpHeaders:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">tcpSocket:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;date&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;cat&quot;</span>,<span class="string">&quot;/usr/local/nginx/logs/access.log&quot;</span>]</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-livenessProbe"><a href="#知识点：pod-spec-containers-livenessProbe" class="headerlink" title="知识点：pod.spec.containers.livenessProbe"></a>知识点：pod.spec.containers.livenessProbe</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置容器的存活性探针</span><br><span class="line">  - 检测容器是否正常运行</span><br><span class="line">  - 如果检测到异常，k8s 会杀死容器，根据 restartpolicy 重建容器</span><br><span class="line"></span><br><span class="line">* 与容器钩子函数相同，支持三种执行方式，只能选择一种方式</span><br><span class="line">  - exec</span><br><span class="line">  - httpGet</span><br><span class="line">  - tcpSocker</span><br></pre></td></tr></table></figure></li>
<li><strong>ges</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="string">&lt;integer&gt;</span>       <span class="comment"># 连续探测失败多少次才被认定为容器故障，默认 3，最小 1</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="string">&lt;integer&gt;</span>    <span class="comment"># 容器启动后等待多少秒执行第一次探测</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="string">&lt;integer&gt;</span>          <span class="comment"># 执行探测的频率，默认 10 秒，最小 1 秒</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="string">&lt;integer&gt;</span>       <span class="comment"># 连续探测成功多少次才被认定为成功，默认是 1</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="string">&lt;integer&gt;</span>         <span class="comment"># 探测超时时间，默认 1 秒，最小 1 秒</span></span><br><span class="line">  <span class="attr">exec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">httpGet:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">httpHeaders:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">tcpSocket:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="number">3333</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">3333</span>          <span class="comment"># 探测 3333 端口</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">60</span>    <span class="comment"># 频率 60s</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-readinessProbe"><a href="#知识点：pod-spec-containers-readinessProbe" class="headerlink" title="知识点：pod.spec.containers.readinessProbe"></a>知识点：pod.spec.containers.readinessProbe</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置容器的就绪性探针</span><br><span class="line">  - 检测容器是否可以接收请求</span><br><span class="line">  - 在检测成功之前，k8s 不会向此 pod 转发流量，不会将 pod ip 加入到与其匹配的 service endpoint 中</span><br><span class="line"></span><br><span class="line">* 相关属性配置与容器存活性探针相同</span><br><span class="line"></span><br><span class="line">* 与容器钩子函数相同，支持三种执行方式，只能选择一种方式</span><br><span class="line">  - exec</span><br><span class="line">  - httpGet</span><br><span class="line">  - tcpSocker</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">readinessProbe:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">exec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">httpGet:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">httpHeaders:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">tcpSocket:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-hostNetwork"><a href="#知识点：pod-spec-hostNetwork" class="headerlink" title="知识点：pod.spec.hostNetwork"></a>知识点：pod.spec.hostNetwork</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 指定 pod 的网络为使用主机网络</span><br><span class="line">  - 官方手册原文：Host networking requested for this pod. Use the host&#x27;s network namespace.</span><br><span class="line"></span><br><span class="line">* 若采取此模式，则容器的暴露端口必须要指定</span><br><span class="line">  - 官方手册原文：If this option is set, the ports that will be used must be specified.</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostNetwork:</span> <span class="string">&lt;boolean&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-imagePullSecrets"><a href="#知识点：pod-spec-imagePullSecrets" class="headerlink" title="知识点：pod.spec.imagePullSecrets"></a>知识点：pod.spec.imagePullSecrets</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 为 pod 指定下载镜像时的仓库认证信息</span><br><span class="line">  - 仓库认证须提前保存在此 namespace 中的 secret 中，kubernetes.io/dockerconfigjson 类型</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullSecrets:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span>              <span class="comment"># 指定仓库认证 secret 的 name</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-initContainers"><a href="#知识点：pod-spec-initContainers" class="headerlink" title="知识点：pod.spec.initContainers"></a>知识点：pod.spec.initContainers</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 为 pod 配置初始化容器</span><br><span class="line"></span><br><span class="line">* 初始化容器</span><br><span class="line">  - 在 pod 启动用户容器之前运行的容器，为用户容器做一些前置工作</span><br><span class="line">  - 初始化容器可以有多个，按顺序串行执行</span><br><span class="line">    - 前一个初始化容器成功运行并结束后，才会运行下一个</span><br><span class="line">    - 若某初始化容器运行失败，则 K8S 会不断重启它，直到成功完成</span><br><span class="line">    - 如果多次尝试后仍无法成功，则 K8S 认为 pod 启动时被</span><br><span class="line">    - 所有的初始化容器都成功运行并结束后，才会开始启动用户容器</span><br><span class="line">  - 如果对 pod 的初始化容器进行更改，则会导致 pod 重启</span><br><span class="line"></span><br><span class="line">* 初始化容器需要在网络和数据卷初始化完成后才会启动，即 pause 容器启动并运行后</span><br><span class="line"></span><br><span class="line">* 初始化容器全部结束前，pod 不会变为 ready 状态</span><br><span class="line"></span><br><span class="line">* 初始化容器的重启，受 restartpolicy 的影响</span><br><span class="line"></span><br><span class="line">* 修改初始化容器的字段</span><br><span class="line">  - 修改其他字段，都不会在 pod 的当前生命周期轮次中生效</span><br><span class="line">  - 修改 image 字段，会导致 pod 重启</span><br><span class="line"></span><br><span class="line">* 初始化容器的配置，与主容器的配置大致相同</span><br><span class="line">  - 不支持钩子函数</span><br><span class="line">  - 不支持探针</span><br><span class="line"></span><br><span class="line">* 初始化容器之间不能重名，不能与用户容器重名</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - 检测环境</span><br><span class="line">  - 提供主容器中不具备的工具程序或自定义代码</span><br><span class="line">  - 为主容器提供文件，尤其是主容器没有权限访问的文件</span><br><span class="line">  - 延后主容器的启动，直至其依赖的条件得到满足</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置内容基本与 pod.spec.Containers 相同</span></span><br><span class="line"><span class="attr">initContainers:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">&lt;[]string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化容器中 ping 192.168.1.1</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">inti01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until ping 192.168.1.1 -c 1 ; do echo waiting for 192.168.1.1 ...; sleep 2; done;&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init02</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ping&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;www.baidu.com&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span>              <span class="comment"># 不知道为什么，busybox 执行 ping -c，&quot;-c 1&quot; 必须要分开写，否则报错</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init03</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;until nslookup myservice ; do echo waiting for network ; sleep 5 ; done ;&quot;</span>]</span><br><span class="line">    <span class="comment"># 对 myservice 进行解析</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-nodeName"><a href="#知识点：pod-spec-nodeName" class="headerlink" title="知识点：pod.spec.nodeName"></a>知识点：pod.spec.nodeName</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 pod 定向调度，按照 node 名</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodeName: &lt;string&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动指定 pod 调度到 node1 节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-nodeSelector"><a href="#知识点：pod-spec-nodeSelector" class="headerlink" title="知识点：pod.spec.nodeSelector"></a>知识点：pod.spec.nodeSelector</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 配置 pod 定向调度，按照 label 选择 node</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodeSelector:</span> <span class="string">&lt;map[string]string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定 pod 调度到具有 nodeenv=test 标签的节点上</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">nodeenv:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-restartPolicy"><a href="#知识点：pod-spec-restartPolicy" class="headerlink" title="知识点：pod.spec.restartPolicy"></a>知识点：pod.spec.restartPolicy</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 pod 中容器的重启策略</span><br><span class="line">  - 包括用户容器、初始化容器</span><br><span class="line"></span><br><span class="line">* 容器的重启，会按照指数级进行延迟 exponential back-off delay</span><br><span class="line">  - 故障容器首次重启，会立刻执行</span><br><span class="line">  - 此容器之后重启，会被依次延迟 10s、20s、40s、80s、160s、300s，之后都是延迟 300s</span><br><span class="line">  - 容器 10 min 没有重启，则 K8S 重置重启延迟</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">restartPolicy:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="comment"># Always        默认值，总是自动重启，即使容器是正常退出的</span></span><br><span class="line"><span class="comment"># OnFailure     仅在容器故障时重启，即退出状态不为 0</span></span><br><span class="line"><span class="comment"># Never         从不重启</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-tolerations"><a href="#知识点：pod-spec-tolerations" class="headerlink" title="知识点：pod.spec.tolerations"></a>知识点：pod.spec.tolerations</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - pod 设置容忍</span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&lt;string&gt;</span>                   <span class="comment"># 容忍的污点的 key</span></span><br><span class="line">                                  <span class="comment"># Empty means match all taint keys.</span></span><br><span class="line">                                  <span class="comment"># If the key is empty, operator must be Exists; this combination means to match all values and all keys.</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&lt;string&gt;</span>                 <span class="comment"># 容忍的污点的 value</span></span><br><span class="line">                                  <span class="comment"># If the operator is Exists, the value should be empty, otherwise just a regular string.</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&lt;string&gt;</span>                <span class="comment"># 容忍的污点类型</span></span><br><span class="line">                                  <span class="comment"># Empty means match all taint effects.</span></span><br><span class="line">                                  <span class="comment"># When specified, allowed values are NoSchedule, PreferNoSchedule and NoExecute.</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&lt;string&gt;</span>              <span class="comment"># 操作符</span></span><br><span class="line">                                  <span class="comment"># Valid operators are Exists and Equal.</span></span><br><span class="line">                                  <span class="comment"># Defaults to Equal.</span></span><br><span class="line">                                  <span class="comment"># Exists is equivalent to wildcard for value, so that a pod can tolerate all taints of a particular category.</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="string">&lt;integer&gt;</span>    <span class="comment"># 容忍时间，仅当 effect 为 NoExecute 时生效，表示 pod 在 Node 上的停留时间</span></span><br><span class="line">                                  <span class="comment"># By default, it is not set, which means tolerate the taint forever (do not evict).</span></span><br><span class="line">                                  <span class="comment"># Zero and negative values will be treated as 0 (evict immediately) by the system.</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-6-K8S-pod-控制器"><a href="#3-6-K8S-pod-控制器" class="headerlink" title="3.6 K8S pod 控制器"></a>3.6 K8S pod 控制器</h2><hr>
<h3 id="知识点：pod-控制器介绍"><a href="#知识点：pod-控制器介绍" class="headerlink" title="知识点：pod 控制器介绍"></a>知识点：pod 控制器介绍</h3><ol>
<li><strong>K8S 管理 pod 的方式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 自主式 pod</span><br><span class="line">  - K8S 直接创建的 Pod</span><br><span class="line">  - 没有副本数量的管理，删除 pod 不会被自动重建</span><br><span class="line">  - 没有生命周期管理</span><br><span class="line">  - 不推荐</span><br><span class="line"></span><br><span class="line">* pod 控制器</span><br><span class="line">  - K8S 通过 pod 控制器创建和管理 pod</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 控制器介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* pod 控制器 controler</span><br><span class="line">  - Pod 控制器是 K8S 管理 pod 的中间层</span><br><span class="line">  - pod 控制器会自动创建 pod 并维护</span><br><span class="line">    - 保证 pod 的副本数量符合用户的期望值</span><br><span class="line">    - 保证每一个 pod 始终保持正常状态</span><br><span class="line">    - 当出现故障时，pod 控制器会自动重建 pod</span><br><span class="line"></span><br><span class="line">* pod 控制器是 K8S 的灵魂，K8S 通过 pod 控制器来实现对 pod 的各种高级功能</span><br><span class="line">  - rs，pod 副本数管理</span><br><span class="line">  - deploy，pod 版本升级回退</span><br><span class="line">  - hpa，pod 副本数自动扩容缩容</span><br><span class="line"></span><br><span class="line">* pod 控制器与 pod 配置一一对应</span><br><span class="line">  - 一个 pod 控制器只能管理从一个 pod 配置产生的 pod</span><br><span class="line">  - 一个 pod 控制器下的 pod 只能是互为副本的关系，配置均相同</span><br><span class="line">  - 多个配置的 pod，每个都需要一个与其对应的 pod 控制器</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 控制器分类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* ReplicationController，rc</span><br><span class="line">  - 比较原始的 pod 控制器，已废弃</span><br><span class="line"></span><br><span class="line">* ReplicaSet，rs</span><br><span class="line">  - 用来替代 ReplicationController</span><br><span class="line">  - 保证副本数量一直维持在期望值</span><br><span class="line">  - 支持 pod 数量扩容缩容，支持镜像版本升级降级</span><br><span class="line"></span><br><span class="line">* Deployment，deploy</span><br><span class="line">  - ReplicaSet 的上层</span><br><span class="line">  - 通过控制 ReplicaSet 继而控制 Pod</span><br><span class="line">  - 支持滚动升级、版本回退</span><br><span class="line"></span><br><span class="line">* HorizontalPodAutoscaler，hpa</span><br><span class="line">  - 可以根据集群负载自动调整 Pod 的数量，实现削峰填谷</span><br><span class="line"></span><br><span class="line">* DaemonSet，ds</span><br><span class="line">  - daemon 式 pod 控制器，一般用于守护进程类的任务</span><br><span class="line">  - 每个 node 上仅运行一个副本</span><br><span class="line"></span><br><span class="line">* Job</span><br><span class="line">  - 执行一次性任务</span><br><span class="line">  - 它创建出来的 pod 只要完成任务就立即退出，不需要重启或重建</span><br><span class="line"></span><br><span class="line">* Cronjob，cj</span><br><span class="line">  - 执行周期性任务</span><br><span class="line">  - 周期性创建 Pod 执行任务，不需要持续后台运行</span><br><span class="line"></span><br><span class="line">* StatefulSet，sts</span><br><span class="line">  - 管理有状态应用</span><br></pre></td></tr></table></figure></li>
<li><strong>pod 控制器的删除</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 先通过扩缩容的方式，将 controler 的 replicasclear 调整为 0，删除所有 pod</span><br><span class="line"></span><br><span class="line">* 再删除 controler 对象</span><br><span class="line"></span><br><span class="line">* 可以通过 kubectl delete --cascade=false 来设置仅删除 controler 对象，保留 pod 对象，但不推荐</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ReplicaSet，rs"><a href="#知识点：ReplicaSet，rs" class="headerlink" title="知识点：ReplicaSet，rs"></a>知识点：ReplicaSet，rs</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* ReplicaSet 会保证 pod 的副本数量始终维持在用户期望的数值</span><br><span class="line">  - 会持续监听这些 Pod 的运行状态</span><br><span class="line">  - 一旦 Pod 发生故障，就会自动重启</span><br><span class="line">  - 一旦 pod 被删除或节点故障，就会自动重建</span><br><span class="line">  - 一旦 pod 副本数量多于期望值，也会自动回收</span><br><span class="line"></span><br><span class="line">* rs 通过 label 确定其所管理的 pod</span><br><span class="line">  - 如果 pod 的标签更新后，与 rs 的标签选择器不再匹配，则 rs 会认为此 pod 不属于自己管理，并会新建 pod 以满足 pod 副本数</span><br><span class="line"></span><br><span class="line">* 支持对 pod 数量的扩缩容</span><br><span class="line"></span><br><span class="line">* 支持镜像版本升级降级</span><br><span class="line">  - 可以从 nginx:1.17.1 变更成 nginx:1.17.2</span><br><span class="line">  - 无法从 nginx 变更成 tomcat</span><br><span class="line"></span><br><span class="line">* pod 命名</span><br><span class="line">  - pod 名称统一为 rs 名称后面拼接 &#x27;-XXXXX&#x27; 的 5 位随机码</span><br><span class="line"></span><br><span class="line">* rs 与 rc 没有本质的不同，只是 rs 相比 rc 多了对集合式标签选择的支持</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get rs</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get rs -o wide</span><br><span class="line">NAME      DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">nginx01   2         2         2       2s    nginx        nginx:1.17.1   web=web01</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="string">&lt;integer&gt;</span>                   <span class="comment"># 指定 pod 副本数量，默认 1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>         <span class="comment"># 选择器，建立 pod 和 rs 之间的关系，采用 Label Selector 机制</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">&lt;Object&gt;</span>                    <span class="comment"># pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span>       <span class="comment"># 必须</span></span><br><span class="line">    <span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个 nginx rs，副本为 2，标签为 web:web01</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Deployment，deploy"><a href="#知识点：Deployment，deploy" class="headerlink" title="知识点：Deployment，deploy"></a>知识点：Deployment，deploy</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 最常用的 controler</span><br><span class="line">  - K8S v1.2 引入</span><br><span class="line"></span><br><span class="line">* 功能</span><br><span class="line">  - 支持 ReplicaSet 的所有功能</span><br><span class="line">  - 支持发布的停止、继续</span><br><span class="line">  - 支持滚动升级/回退版本</span><br><span class="line"></span><br><span class="line">* deployment restartpolicy 只支持 Always</span><br></pre></td></tr></table></figure></li>
<li><strong>deployment 与 rs</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* deployment 通过管理 ReplicaSet 继而管理 pod</span><br><span class="line">  - Replicaset 管理 pod，实现副本功能</span><br><span class="line">  - Deployment 管理 ReplicaSet，实现滚动升级/回退功能</span><br><span class="line">    - 稳定运行时，一个 Deployment 对应一个 ReplicaSet</span><br><span class="line">    - 升级回退时，一个 Deployment 对应两个 ReplicaSet</span><br><span class="line"></span><br><span class="line">* 命名</span><br><span class="line">  - rs 命名为在 deploy 名称后面追加 &#x27;-XXXXXXXXXX&#x27; 的 10 位随机码</span><br><span class="line">  - pod 命名还是在 rs 名称后面追加 &#x27;-XXXXX&#x27; 的 5 位随机码</span><br><span class="line"></span><br><span class="line">* deployment 会保存一部分历史 ReplicaSet，实现版本回退功能</span><br><span class="line">  - 历史 ReplicaSet 中，pod 数为 0</span><br><span class="line">  - deployment.spec.revisionHistoryLimit 设置保存的 ReplicaSet 数量，默认 10</span><br><span class="line">  - kubectl rollout undo 进行版本回退</span><br></pre></td></tr></table></figure></li>
<li><strong>deployment 更新</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* 更新</span><br><span class="line">  - 升级与回退，都会被视为更新</span><br><span class="line">  - 变更与 pod 有关的内容会被视为更新，如 deployment.spec.template 中的内容</span><br><span class="line">  - 变更 deployment 自己的内容，不会被视为更新，如副本数、更新策略</span><br><span class="line">  - 因为 deployment 的版本管理基于 rs，rs 在 deployment 中的体现就是 templete</span><br><span class="line"></span><br><span class="line">* deployment 更新</span><br><span class="line">  - 只要发生更新，则版本号加 +1，因而当前版本的版本号最大</span><br><span class="line">  - 升级会创建新的 ReplicaSet，利用新 ReplicaSet 逐渐替代旧 ReplicaSet，之后旧 ReplicaSet 作为历史版本进行保存</span><br><span class="line">  - 回退则不创建 ReplicaSet，直接使用历史 ReplicaSet，原 ReplicaSet 作为历史版本进行保存</span><br><span class="line">  - deployment 支持对更新行为进行一系列操作，如 pause、resume、restart 等，通过一系列 kubectl rollout 指令</span><br><span class="line">  - kubectl describe rs 可以在 Annotations 中查看某个 rs 在 rollout history 中对应着哪个 revision</span><br><span class="line"></span><br><span class="line">* 金丝雀发布</span><br><span class="line">  - 通过对更新行为进行控制，可以实现金丝雀发布</span><br><span class="line">  - 过程</span><br><span class="line">    - 开始更新</span><br><span class="line">    - 在更新操作完成前，暂停更新行为</span><br><span class="line">    - 将一部分流量发送到已更新的 pod 上</span><br></pre></td></tr></table></figure></li>
<li><strong>deployment 更新策略</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">* deployment 支持两种更新策略 spec.strategy</span><br><span class="line">  - 重建更新</span><br><span class="line">  - 滚动更新</span><br><span class="line"></span><br><span class="line">* 重建更新 Recreate</span><br><span class="line">  - 过程</span><br><span class="line">    - 创建新 rs</span><br><span class="line">    - 一口气结束旧 rs 中全部 pod</span><br><span class="line">    - 一口气创建新 rs 中全部 pod</span><br><span class="line"></span><br><span class="line">* 滚动更新 RollingUpdate</span><br><span class="line">  - 默认策略</span><br><span class="line">  - 对 pod 进行滚动更新</span><br><span class="line">    - 边销毁边创建</span><br><span class="line">    - 在更新过程中存在两个版本的 Pod</span><br><span class="line"></span><br><span class="line">* 滚动更新的过程</span><br><span class="line">  - 创建新 rs</span><br><span class="line">  - 新 rs 进行扩容，创建部分 pod 副本</span><br><span class="line">  - 旧 rs 进行缩容，结束部分 pod 副本，必须等新 rs 中 pod 已经启动后才会进行</span><br><span class="line">  - 滚动继续，直到所有 pod 都已经更新</span><br><span class="line">  - 旧的 rs pod 数量变为 0，被当做历史版本进行保存</span><br><span class="line"></span><br><span class="line">* 滚动更新的配置，通过设置 spec.strategy.rollingUpdate 实现，仅当 spec.strategy.type=RollingUpdate 时生效，支持两个属性</span><br><span class="line">  - maxUnavailable</span><br><span class="line">    - 指定升级过程中不可用的 Pod 的最大数量</span><br><span class="line">    - 即，每次旧 rs 缩容时的 pod 副本数量</span><br><span class="line">    - 可以设置为 pod 数量或比例，比例会被换算成 pod 数量，默认 25%</span><br><span class="line">  - maxSurge</span><br><span class="line">    - 指定升级过程中可以超过期望的 Pod 的最大数量</span><br><span class="line">    - 即，每次新 rs 扩容时的 pod 副本数量</span><br><span class="line">    - 可以设置为 pod 数量或比例，比例会被换算成 pod 数量，默认 25%</span><br></pre></td></tr></table></figure></li>
<li><strong>kubect get deploy</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get deploy -o wide</span><br><span class="line">NAME      READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">nginx01   3/3     3            3           18s   nginx        nginx:1.17.1   web=web01</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span>                      <span class="comment"># deployment 名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="string">&lt;integer&gt;</span>                 <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">paused:</span> <span class="string">&lt;boolean&gt;</span>                   <span class="comment"># 是否暂停部署，默认 false</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="string">&lt;integer&gt;</span>  <span class="comment"># 部署超时时间，默认 600s</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">&lt;Object&gt;</span>                  <span class="comment"># 镜像更新策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&lt;string&gt;</span>                        <span class="comment"># 指定更新策略，&quot;Recreate&quot; 或 &quot;RollingUpdate&quot;</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">&lt;Object&gt;</span>                  <span class="comment"># 选择器，建立与 pod 的联系，Label-Selector 机制</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">  <span class="attr">template:</span>                           <span class="comment"># pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span>         <span class="comment"># 必须</span></span><br><span class="line">    <span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">containers:</span> <span class="string">&lt;[]Object&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：matrix-server"><a href="#知识点：matrix-server" class="headerlink" title="知识点：matrix-server"></a>知识点：matrix-server</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - metrics-server 是 K8S 中一个可以收集集群中的资源使用情况的可选组件</span><br><span class="line">  - kubectl top 相关指令需要用到 matrix-server</span><br></pre></td></tr></table></figure></li>
<li><strong>下载 matrix-server</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 deployment 的属性，变更镜像仓库和和初始化参数</span></span><br><span class="line">cd metrics-server/deploy/1.8+/</span><br><span class="line">vim metrics-server-deployment.yaml</span><br><span class="line">  spec:</span><br><span class="line">    ...</span><br><span class="line">    template:</span><br><span class="line">      ...</span><br><span class="line">      spec:</span><br><span class="line">        ...</span><br><span class="line">        hostNetwork: true</span><br><span class="line">        ...</span><br><span class="line">        containers:</span><br><span class="line">          ...</span><br><span class="line">          image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span><br><span class="line">          ...</span><br><span class="line">          args:</span><br><span class="line">            - --kubelet-insecure-tls</span><br><span class="line">            - --kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br></pre></td></tr></table></figure></li>
<li><strong>启动 matrix-server</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ./</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 matrix-server 的运行情况</span></span><br><span class="line">kubectl get pod -n kube-system</span><br><span class="line">...</span><br><span class="line">metrics-server-6b976979db-2xwbj   1/1     Running   0          90s</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 node 的资源情况</span></span><br><span class="line">kubectl top node</span><br><span class="line">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">master   98m          4%     1067Mi          62%</span><br><span class="line">node1    27m          1%     727Mi           42%</span><br><span class="line">node2    34m          1%     800Mi           46%</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 pod 的资源使用情况</span></span><br><span class="line">kubectl top pod -n kube-system</span><br><span class="line">NAME                              CPU(cores)   MEMORY(bytes)</span><br><span class="line">...</span><br><span class="line">coredns-6955765f44-7ptsb          3m           9Mi</span><br><span class="line">coredns-6955765f44-vcwr5          3m           8Mi</span><br><span class="line">etcd-master                       14m          145Mi</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：HorizontalPodAutoscaler，hpa"><a href="#知识点：HorizontalPodAutoscaler，hpa" class="headerlink" title="知识点：HorizontalPodAutoscaler，hpa"></a>知识点：HorizontalPodAutoscaler，hpa</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* HorizontalPodAutoscaler</span><br><span class="line">  - pod 水位线自动缩放</span><br><span class="line">  - 削峰填谷</span><br><span class="line">  - 在 deploy 的基础上，增加了基于 pod cpu 利用率来自动扩容缩容 pod 副本的功能</span><br><span class="line">  - 通过管理 deploy，继而管理 pod</span><br><span class="line">  - 通过对 hpa 设置指标，超出指标就会扩容，利用率下降时就会缩容</span><br><span class="line">  - 缩容会有一定的延迟，以保证不会因为 cpu 利用率的波动导致频繁扩容缩容</span><br><span class="line"></span><br><span class="line">* hpa 仅适用于 deploy 和 ds</span><br><span class="line"></span><br><span class="line">* K8S v1 仅支持 cpu 使用率，Valpha 版本中支持内存和用户自定义的 matric 扩缩容</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get hpa</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get hpa -n dev</span><br><span class="line">NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">pc-hpa   Deployment/nginx   0%/3%     1         10        1          62s</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span>           <span class="comment"># 最大 pod 数量</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="string">&lt;integer&gt;</span>                      <span class="comment"># 最小 pod 数量</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="string">&lt;integer&gt;</span>   <span class="comment"># CPU 使用率指标，超过指标就会扩容，数字表示百分比</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>         <span class="comment"># 指定要管理的资源</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建一个 nginx deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx01</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建一个 nginx-hpa 对 nginx deployment 进行扩缩容管理</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-hpa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">30</span>      <span class="comment"># 设置 pod 利用率超过 30% 时就进行扩容</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：DaemonSet，ds"><a href="#知识点：DaemonSet，ds" class="headerlink" title="知识点：DaemonSet，ds"></a>知识点：DaemonSet，ds</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 保证在集群中的每一个 node 上都运行一个 pod 副本，有且只有一个</span><br><span class="line">  - 会动态持续的保证每个 node 上都有一个 pod 副本</span><br><span class="line">    - 每当向集群中添加一个 node 时，自动在该节点上运行一个 pod</span><br><span class="line">    - 每当从集群中移除一个 ndoe 时，自动删除相应的 pod</span><br><span class="line">  - 由于污点，默认情况下只会在 slave 节点上运行</span><br><span class="line"></span><br><span class="line">* ds 也支持版本回滚功能</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - Pod 提供的功能是节点级别的，即每个节点都需要且只需要一个</span><br><span class="line">  - 集群存储，如 glusterd、ceph</span><br><span class="line">  - 日志收集，如 fluentd、logstash</span><br><span class="line">  - 节点监控，如 prometheus node exporter、collectd、datadog、new relic、ganglia gmond</span><br><span class="line"></span><br><span class="line">* 命名</span><br><span class="line">  - pod 名为 ds 名之后追加 &#x27;-xxxxx&#x27;</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get ds</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get ds -o wide</span><br><span class="line">NAME       DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">nginx-ds   2         2         2       2            2           &lt;none&gt;          86s   nginx-con    nginx:1.17.1   web=web01</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="string">&lt;integer&gt;</span>       <span class="comment"># 保留历史版本数</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">updateStrategy:</span> <span class="string">&lt;Object&gt;</span>              <span class="comment"># 更新策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>         <span class="comment"># 选择器，指定管理的 pod，Label-selector 机制</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>         <span class="comment"># pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">    <span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">containers:</span> <span class="string">&lt;[]Object&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在每一个 node 上运行一个 nginx pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-con</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Job"><a href="#知识点：Job" class="headerlink" title="知识点：Job"></a>知识点：Job</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 实现批处理作业功能</span><br><span class="line">  - 批量运行一次性作业</span><br><span class="line">  - 一个 pod 就是一个一次性作业</span><br><span class="line"></span><br><span class="line">* 作业运行</span><br><span class="line">  - pod 结束后，不论成功或失败，状态为 ContainerCannotRun，不会被删除对象</span><br><span class="line">  - job 运行结束后，不会被删除对象，其元数据中保存了 job 的运行结果</span><br><span class="line">  - kubectl describe job 中 Pods Statuses 可以查看 job 中 pod 的运行结果</span><br><span class="line">    - running</span><br><span class="line">    - successed</span><br><span class="line">    - failed</span><br><span class="line"></span><br><span class="line">* 作业失败</span><br><span class="line">  - 如果 pod 运行发生错误，则 job 会尝试重启 pod 中的容器</span><br><span class="line">    - 重启 pod 不会被认为作业失败</span><br><span class="line">    - job.spec.backoffLimit 可以设置重启的次数，默认 6</span><br><span class="line">    - 如果超过重启次数后，pod 仍然没有成功，则认为作业失败，failed 次数 +1</span><br><span class="line">  - job.spec.activeDeadlineSeconds 可以设置整个 job 的生效时间</span><br><span class="line">    - 如果 job 运行超时，则会强制停止 job 的运行</span><br><span class="line">      - 正在运行中的 pod 会被强制停止，并被当做 failed 进行计数</span><br><span class="line">      - 未开始运行的 pod 不会被创建，并被当做 failed 进行计数</span><br><span class="line"></span><br><span class="line">* jod 中 pod 重启策略只能 Never 或者 OnFailure</span><br><span class="line">  - OnFailure 表示 job 会在 pod 运行错误时重启容器，不认为此 pod 作业失败，直到重启次数超过限制时才认为作业失败</span><br><span class="line">  - Never 表示 job 会在 pod 出现故障时直接结束此 pod 的运行，并认为此 pod 作业失败，job 的 failed 次数 +1，并开始下一个 pod 的运行</span><br><span class="line">  - 如果指定为 Always，则 pod 出现故障时会导致 job 一直重启容器，此时 job 会被此 pod 卡住陷入死循环</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get job</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get job -o wide</span><br><span class="line">NAME          COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">busybox-job   0/30          18s        18s   busybox      busybox:1.30   app=busy</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="string">&lt;integer&gt;</span>              <span class="comment"># 指定需要成功执行结束的 pod 数量</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="string">&lt;integer&gt;</span>              <span class="comment"># 指定并行 pod 数</span></span><br><span class="line">  <span class="attr">activeDeadlineSeconds:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">manualSelector:</span> <span class="string">&lt;boolean&gt;</span>           <span class="comment"># 是否使用选择器机制来选择 pod，默认 false，建议 true</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">    <span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">containers:</span> <span class="string">&lt;[]Object&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># job 运行 busybox 进行 10 个作业</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox-job</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">activeDeadlineSeconds:</span> <span class="number">120</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">manualSelector:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busy</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">busy</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：CronJob，cj"><a href="#知识点：CronJob，cj" class="headerlink" title="知识点：CronJob，cj"></a>知识点：CronJob，cj</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - CronJob 通过管理 job，实现周期性执行 job</span><br><span class="line">  - 结束执行的 job 会被保留，数量超过限制时则删除最老的 job</span><br><span class="line"></span><br><span class="line">* 命名</span><br><span class="line">  - job 命名为在 cj 后追加 &#x27;-TIMESTAMP&#x27; 后缀</span><br><span class="line">  - pod 命名依然是在 job 后追加 &#x27;-xxxxx&#x27; 后缀</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get cj</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get job -o wide</span><br><span class="line">NAME       SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">sleep-cj   */1 * * * *   False     0        &lt;none&gt;          9s    sleep-con    busybox:1.30   &lt;none&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">concurrencyPolicy:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">startingDeadlineSeconds:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">successfulJobHistoryLimit:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">failedJobHistoryLimit:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>        <span class="comment"># job 模板</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* cj.spec.schedule: &lt;string&gt; -required-</span><br><span class="line">  - 指定 cj 的执行时间</span><br><span class="line">  - 采用 linux cron 格式</span><br><span class="line"></span><br><span class="line">* cj.spec.concurrencyPolicy: &lt;string&gt;</span><br><span class="line">  - 指定 cj 的并发方式，即若前一轮 job 仍未结束而新一轮 job 时间已到，应当如何处理</span><br><span class="line">    - Allow   并发运行</span><br><span class="line">    - Forbid  禁止并发运行，如果前一轮 job 未结束，则跳过新一轮 job</span><br><span class="line">    - Replace 替换，结束前一轮 job，将其标记为失败，启动新一轮 job</span><br><span class="line"></span><br><span class="line">* cj.spec.successfulJobHistoryLimit: &lt;integer&gt;</span><br><span class="line">  - 保留的执行成功的历史 job 的数量，超过的话会删除最老的 job 对象</span><br><span class="line">  - 默认 3</span><br><span class="line"></span><br><span class="line">* cj.spec.failedJobHistoryLimit: &lt;integer&gt;</span><br><span class="line">  - 保留的执行失败的历史 job 的数量，超过的话会删除最老的 job 对象</span><br><span class="line">  - 默认 1</span><br><span class="line"></span><br><span class="line">* cj.spec.startingDeadlineSeconds: &lt;integer&gt;</span><br><span class="line">  - 设置 job 的启动超时时长</span><br><span class="line">    - 某些情况下，会导致 job 在应该被调度的时间点没有启动，如 cj 发生错误</span><br><span class="line">      - 由于并发设置导致跳过 job 调度不属于此情况，因为并发 Forbid 相当于直接删除的这一次的调度</span><br><span class="line">    - 正常情况话，cj 每 10s 检查一次，若发现有 job 应该被调度而没有启动，则会尝试启动 job</span><br><span class="line">    - 若 job 延迟的时间过久，超过了超时时长，则 cj 不会启动 job，而是直接认为此 job 失败</span><br><span class="line">  - 默认无限长</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sleep-cj</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">concurrencyPolicy:</span> <span class="string">Forbid</span></span><br><span class="line">  <span class="attr">successfulJobHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">failedJobHistoryLimit:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">startingDeadlineSeconds:</span> <span class="number">120</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sleep-con</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>,<span class="string">&quot;5&quot;</span>]</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-7-K8S-网络"><a href="#3-7-K8S-网络" class="headerlink" title="3.7 K8S 网络"></a>3.7 K8S 网络</h2><hr>
<h3 id="知识点：K8S-扁平网络"><a href="#知识点：K8S-扁平网络" class="headerlink" title="知识点：K8S 扁平网络"></a>知识点：K8S 扁平网络</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* K8S 的网络模型假定所有的 pod 都在一个可以直接连通的扁平网络空间中</span><br><span class="line">  - 每一个 pod 都会被分配一个 vip</span><br><span class="line">  - 在 K8S 内网中可以通过 vip 访问任意的 pod</span><br><span class="line">  - GCE Google Compute Engine 中自动支持扁平网络空间</span><br><span class="line">  - 自建集群通常使用 flannel 来实现扁平网络</span><br><span class="line"></span><br><span class="line">* 同一个 pod 内的容器，相互之间可以直接通过 localhost:port 通信</span><br><span class="line"></span><br><span class="line">* pod 之间的通信，通过 Overlay Network 访问</span><br><span class="line"></span><br><span class="line">* pod 与 service 之间的通信，通过节点的 iptables/ipvs 实现</span><br><span class="line"></span><br><span class="line">* K8S 中有三个网络平面</span><br><span class="line">  - 节点网络，是唯一真实的物理网络</span><br><span class="line">  - pod 网络</span><br><span class="line">  - service 网络</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Flannel"><a href="#知识点：Flannel" class="headerlink" title="知识点：Flannel"></a>知识点：Flannel</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - Flannel 是在 K8S 中最常用的扁平化网络解决方案</span><br><span class="line">  - 由 CoreOS 团队针对 K8S 设计的一个网络规范服务</span><br><span class="line"></span><br><span class="line">* Flannel 采用两层封装，以实现扁平网络</span><br><span class="line">  - 类似于隧道</span><br><span class="line">  - 外层采用 udp，源地址和目的地址为节点 ip，端口为 flannel 的端口</span><br><span class="line">  - 内层封装的 pod 间通信的 ip 包，源地址和目的地址为 pod vip，端口为 pod 中的应用的端口</span><br><span class="line"></span><br><span class="line">* 功能</span><br><span class="line">  - 让集群中不同节点上的 pod，都具有全集群唯一的 vip</span><br><span class="line">  - 在这些 vip 之间建立一个覆盖网络 Overlay Networl</span><br><span class="line">  - 通过覆盖网络，使 pod 与 pod 可以直接通过 vip 相互通信，而不需要对 pod 进行 nodeIP 的端口映射</span><br></pre></td></tr></table></figure></li>
<li><strong>网络结构</strong><br><img src="/2000/01/01/Blog32-k8s/Flannel%E8%AF%A6%E8%A7%A3%E5%9B%BE%E7%89%87.jpg" alt="**Flannel详解**"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* docker 建立 docker0 网桥，为每个 pod pause 容器分配 vip</span><br><span class="line"></span><br><span class="line">* flannel 建立 flanneld 守护进程，默认监听 udp 8472 端口</span><br><span class="line"></span><br><span class="line">* flanneld 建立 flannel0 网桥</span><br><span class="line">  - flannel0 会抓取 docker0 发送的数据包</span><br><span class="line">  - flannel0 会维护一个 pod vip 的路由表，内容为 pod vip 与 node ip 的对应关系，从 etcd 中获取</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 同节点 pod to pod 通信</span><br><span class="line">  - 两个 pod 直接通过 docker0 网桥实现相互访问</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 跨节点 pod to pod 通信</span><br><span class="line">  - 源 pod 准备数据包</span><br><span class="line">    - 源地址写源 pod 的 vip</span><br><span class="line">    - 目标地址写目标 pod 的 vip</span><br><span class="line">  - 源 pod 将数据包发送给本节点的 docker0</span><br><span class="line">  - flannel0 从 docker0 处抓取到数据包</span><br><span class="line">  - flannel0 通过 vip 路由表，获得目标 pod 的节点的物理 ip</span><br><span class="line">  - lannnel0 对数据包进行二次封装</span><br><span class="line">    - 源地址写本 node 的物理 ip</span><br><span class="line">    - 目标地址写目标 pod 的节点的物理 ip</span><br><span class="line">    - 目标端口写 8742</span><br><span class="line">    - 协议采用 udp</span><br><span class="line">  - flanneld 从 flannel0 处获得封装后的数据包</span><br><span class="line">  - flanneld 将数据包发送给 node 物理网卡</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* pod to service</span><br><span class="line">  - 根据 iptables/ipvs 的规则进行转发</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* pod to 外网</span><br><span class="line">  - pod 发送数据包到宿主机网卡</span><br><span class="line">  - 宿主机网卡完成路由选择</span><br><span class="line">  - iptables 执行 Masquerade，把源 ip 改为宿主机 ip，然后向外网发送</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 外网 to pod</span><br><span class="line">  - nodeport service</span><br></pre></td></tr></table></figure></li>
<li><strong>Flannel 和 etcd</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* etcd 中存储 flannel 可分配的 ip 地址段资源</span><br><span class="line">  - flannel 在启动后会向 etcd 插入自己的网段</span><br><span class="line">  - flannel 在之后分配了 vip 后，会将记录插入到 etcd 中</span><br><span class="line"></span><br><span class="line">* flannel 监控 etcd，获得每个 pod 的 node ip，并在内存中建立维护 pod-node 路由表</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kube-proxy"><a href="#知识点：kube-proxy" class="headerlink" title="知识点：kube-proxy"></a>知识点：kube-proxy</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - kube-proxy 用来为 service 创建网络转发规则</span><br><span class="line">  - service 本质上是对网络转发规则的抽象</span><br><span class="line">  - kube-proxy 实际创建规则</span><br><span class="line">  - flannel 不属于 kube-proxy 的内容</span><br><span class="line"></span><br><span class="line">* kube-proxy 以 Daemonset 的方式运行在每个 node 上</span><br><span class="line"></span><br><span class="line">* 工作流程</span><br><span class="line">  - apiserver 将要创建的 service 写入到 etcd</span><br><span class="line">  - 所有节点上的 kube-proxy 通过 watch etcd 发现 service 的信息，然后在自己 node 上创建相应的网络转发规则</span><br><span class="line"></span><br><span class="line">* kube-proxy 本身并不具有负载均衡功能，其负载均衡功能基于底层 ipvs 来支持</span><br><span class="line">  - 通过建立 ipvs 时指定相应的参数</span><br></pre></td></tr></table></figure></li>
<li><strong>kube-proxy 的三种模式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* userspace 模式</span><br><span class="line">  - 1.0 版本时为默认模式</span><br><span class="line">  - kube-proxy 实际参与到流量转发过程中，且扮演一个四层负载均衡器的角色</span><br><span class="line">    - 流量发往 kube-proxy</span><br><span class="line">    - kube-proxy 发往 pod</span><br><span class="line">  - 优缺点</span><br><span class="line">    - 比较稳定</span><br><span class="line">    - 效率很差，因为会增加内核空间和用户空间的数据拷贝</span><br><span class="line"></span><br><span class="line">* iptables 模式</span><br><span class="line">  - 1.1 新增</span><br><span class="line">  - 1.2 开始为默认模式</span><br><span class="line">  - kube-proxy 不实际参与流量转发，只是建立 iptables 转发规则</span><br><span class="line">    - 需要对 service 后端的每个 pod 都建立 iptables 规则</span><br><span class="line">  - kube-proxy 不再承担四层负载均衡的角色</span><br><span class="line">  - 优缺点</span><br><span class="line">    - 效率较 userspace 模式高一些，但依然很差</span><br><span class="line">    - 不能提供灵活的 LB 策略，如当后端 pod 失败时，流量依然会转发到此 pod 上</span><br><span class="line"></span><br><span class="line">* ipvs 模式</span><br><span class="line">  - 1.8.0-beta.0 新增</span><br><span class="line">  - 1.14 开始为默认模式</span><br><span class="line">  - 对 iptables 模式的升级，改为建立 ipvs 转发规则</span><br><span class="line">  - K8S 推荐使用</span><br><span class="line">  - 优缺点</span><br><span class="line">    - ipvs 相对 iptables 转发效率更高</span><br><span class="line">    - ipvs 支持多种 LB 算法</span><br><span class="line">      - rr 轮询</span><br><span class="line">      - lc 最小连接数</span><br><span class="line">      - dh 目标哈希</span><br><span class="line">      - sh 源哈希</span><br><span class="line">      - sed 最短期望延迟</span><br><span class="line">      - nq 不排队调度</span><br></pre></td></tr></table></figure></li>
<li><strong>kube-proxy 启用 ipvs</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ipvs 需要内核添加相应的模块，否则 K8S 会自动使用 iptables 模式</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 ipvs 模块后，还需要重新配置 kube-proxy</span></span><br><span class="line"></span><br><span class="line">kubectl -n kube-system edit cm kube-proxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 kube-proxy 的配置，将 data.mode 的值改为 ipvs</span></span><br><span class="line"></span><br><span class="line">kubectl -n kube-system delete pod -l k8s-app=kube-proxy</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除重建所有 kube-proxy</span></span><br><span class="line"></span><br><span class="line">ipvsadm -Ln</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 ipvs 网络转发规则，此时会显示 kube-proxy 建立的规则</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：service，svc"><a href="#知识点：service，svc" class="headerlink" title="知识点：service，svc"></a>知识点：service，svc</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - K8S 中最常用的网络</span><br><span class="line">  - service 会将管理的 pod 打包，为其并提供统一的入口地址</span><br><span class="line"></span><br><span class="line">* K8S 会为 service 分配一个 vip，service 在其生命周期之中 vip 固定</span><br><span class="line">  - pod 在其生命周期之间，ip 不固定</span><br><span class="line">  - pod 删除重建后 ip 会更换</span><br><span class="line">  - service.spec.clusterIP 可以指定 service 的 ip，若省略则 service 自动为其分配 ip</span><br><span class="line"></span><br><span class="line">* kube-proxy 根据 service 的配置，在本节点中修改相应的 iptagles/ipvs 规则</span><br><span class="line">  - 每台节点的 kube=proxy 都会进行修改</span><br><span class="line"></span><br><span class="line">* service 自动支持四层负载均衡</span><br><span class="line">  - 默认流量会被以轮询的方式转发给 pod</span><br><span class="line"></span><br><span class="line">* service 自动支持服务发现</span><br><span class="line">  - 当 pod 副本增减时，service 会自动发现并将 pod 的变化，并从自己的 ep 中添加或删除相应的 pod</span><br><span class="line">  - 然后 kube-proxy 自动增减转发规则</span><br><span class="line"></span><br><span class="line">* service 的域名</span><br><span class="line">  - SERVICE_NAME.NAMESPACE.svc.CLUSTER_DOMAIN</span><br><span class="line">    - CLUSTER_DOMAIN 默认为 cluster.local.</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get service</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get service -o wide</span><br><span class="line">NAME             TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE   SELECTOR</span><br><span class="line">nginx-nodeport   NodePort   10.98.41.207   &lt;none&gt;        3333:30001/TCP   15s   web=web01</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">&lt;map[string]string&gt;</span>       <span class="comment"># 选择器，Label-Selector 方式，用于确定 service 来代理哪些 pod</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">ports:</span> <span class="string">&lt;[]Object&gt;</span>                   <span class="comment"># 端口信息</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span>            <span class="comment"># 指定 service 的端口</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">&lt;string&gt;</span>                  <span class="comment"># 指定 pod 暴露的端口，若省略则与 port 设置相同</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="string">&lt;integer&gt;</span>                   <span class="comment"># 指定在主机上绑定的端口，省略则会自动分配，仅在 NodePort 和 LoadBalancer 时需要</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：endpoints，ep"><a href="#知识点：endpoints，ep" class="headerlink" title="知识点：endpoints，ep"></a>知识点：endpoints，ep</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* Endpoint 也是一个资源对象，在里面记录了对应的 service 的所有 pod 的访问地址</span><br><span class="line">  - 存储在 etcd 中</span><br><span class="line">  - 根据 service 配置中 selector 描述产生的</span><br><span class="line">  - service 和 pod 之间的联系通过 endpoints 实现的</span><br><span class="line">  - 当 pod label 发生变化，endpoint 会自动修改自己的内容</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get endpoints</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get endpoints -o wide</span><br><span class="line">NAME              ENDPOINTS                        AGE</span><br><span class="line">nginx-clusterip   10.244.1.195:80,10.244.2.91:80   5m57s</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：service-spec-type"><a href="#知识点：service-spec-type" class="headerlink" title="知识点：service.spec.type"></a>知识点：service.spec.type</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">* 指定 service 的类型</span><br><span class="line"></span><br><span class="line">* ClusterIP</span><br><span class="line">  - 默认值</span><br><span class="line">  - service ip 只能被在集群内部节点访问</span><br><span class="line"></span><br><span class="line">* NodePort</span><br><span class="line">  - 将 service ip:port 与 node ip:port 绑定</span><br><span class="line">  - 外部可以通过访问任意节点的 node ip:port 的方式来访问 service 继而访问 pod</span><br><span class="line">  - kube-proxy 会自动在每个节点上建立针对本节点的网络转发规则</span><br><span class="line">  - 主机 port 只能使用 30000-32767</span><br><span class="line">  - 缺点</span><br><span class="line">    - 当 service 过多时，会占用很多主机的物理端口</span><br><span class="line"></span><br><span class="line">* LoadBalancer</span><br><span class="line">  - 使用外接负载均衡器完成到服务的负载分发，通常是云服务商的 LB 产品</span><br><span class="line">  - LoadBalancer 和 NodePort 很相似，目的都是向外部暴露一个端口</span><br><span class="line">  - 区别在于 LoadBalancer 会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的</span><br><span class="line">    - client 将请求发送到 LB 设备</span><br><span class="line">    - LB 设备将请求负载均衡到各个 node</span><br><span class="line">    - node 中 iptables/ipvs 识别到请求，转发给 service</span><br><span class="line"></span><br><span class="line">* ExternalName</span><br><span class="line">  - 把集群外部的服务引入集群内部，使集群内部可以直接使用外部服务</span><br><span class="line">  - 即，ExternalName 类型的 Service 是对外部服务进行代理，pod 发送请求给 ExternalName service 就是向对应的外部服务发送请求</span><br><span class="line">  - kube-proxy 不会对此 service 创建 iptables/ipvs 规则</span><br><span class="line">    - 本质上是对 coreDNS 中设置一个 CNAME</span><br><span class="line">    - 当有应用在查询 DNS 中查询此 service 时，DNS 会返回相应的 CNAME</span><br><span class="line">  - 需要 service.spec.externalName 指定外部服务的地址</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：service-spec-clusterIP"><a href="#知识点：service-spec-clusterIP" class="headerlink" title="知识点：service.spec.clusterIP"></a>知识点：service.spec.clusterIP</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 为 service 指定 ip</span><br><span class="line">  - 如不指定，或为空，则 ip 由 K8S 自动分配</span><br><span class="line">  - 若指定但已经被使用，则 service 创建失败</span><br><span class="line">  - 在 ClusterIP、NodePort、LoadBalancer 时有效</span><br><span class="line">  - 在 ExternalName 时无效</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">clusterIP:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>无头服务 HeadLiness Service</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* clusterIP 设置为 None 或空，service 称为 HeadLiness Service</span><br><span class="line"></span><br><span class="line">* 此时 service 不会获得 vip，kube-proxy 也不会为 service 创建转发规则，自然也没有负载均衡和路由</span><br><span class="line"></span><br><span class="line">* 无头服务依然可以通过 service 的域名访问到 pod</span><br><span class="line"></span><br><span class="line">* 查看无头服务 service 在 K8S coreDNS 中的 a 记录</span><br><span class="line">  - dig -t A SERVICE_NAME.NAMESPACE.svc.cluster.local. @COREDNS_IP</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：service-spec-ports"><a href="#知识点：service-spec-ports" class="headerlink" title="知识点：service.spec.ports"></a>知识点：service.spec.ports</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 指定 service 的端口绑定设置</span><br><span class="line">  - service ip:port 与 pod ip:port 的端口绑定</span><br><span class="line">  - 在 NodePort 和 LoadBalancer 类型 service 时，设置 node ip:port &lt;--&gt; service ip:port &lt;--&gt; node ip:port</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">port:</span> <span class="string">&lt;integer&gt;</span> <span class="string">-required-</span>            <span class="comment"># 指定 service port</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="string">&lt;string&gt;</span>                  <span class="comment"># 指定 pod port，省略则与 service port 相同</span></span><br><span class="line">  <span class="attr">nodePort:</span> <span class="string">&lt;integer&gt;</span>                   <span class="comment"># 指定 node port ，省略则会自动分配，仅在 NodePort 和 LoadBalancer 时需要</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">protocol:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：service-spec-sessionAffinity"><a href="#知识点：service-spec-sessionAffinity" class="headerlink" title="知识点：service.spec.sessionAffinity"></a>知识点：service.spec.sessionAffinity</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 用户维护 service 的 session 亲和性，设置 service 是否开启会话保持</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sessionAffinity:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># None        默认，不开启会话保持</span></span><br><span class="line"><span class="comment"># ClientIP    开启会话保持，此时查看 ipvsadm 会发现负载均衡配置添加了 &#x27;persistent&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：service-spec-externalName"><a href="#知识点：service-spec-externalName" class="headerlink" title="知识点：service.spec.externalName"></a>知识点：service.spec.externalName</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 只在 service 类型为 ExternalName 时有效</span><br><span class="line"></span><br><span class="line">* 用来指定外部服务器的地址</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">externalName:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：service-范例"><a href="#知识点：service-范例" class="headerlink" title="知识点：service 范例"></a>知识点：service 范例</h3><ol>
<li><strong>范例一，ClusterIP</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 规划</span><br><span class="line">  - deployment 运行 nginx</span><br><span class="line">  - pod 80 端口与 service 3333 端口绑定</span><br><span class="line">  - 内部可以通过 service ip:3333 访问 nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 deploy</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建 service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-clusterip</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3333</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例二，NodePort service</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 规划</span><br><span class="line">  - deployment 运行 nginx</span><br><span class="line">  - pod 80 与 service 3333 绑定</span><br><span class="line">  - service 3333 与 node 30001 绑定</span><br><span class="line">  - 外部可以通过任意节点的 node ip:30001 访问 nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 nginx</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建 service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-nodeport</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3333</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30001</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例三，ExternalName</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">*</span> <span class="string">规划</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">将外部的</span> <span class="string">www.baidu.com</span> <span class="string">作为</span> <span class="string">ExternalName</span> <span class="string">加入到集群中</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">K8S</span> <span class="string">内部可以通过访问</span> <span class="string">service</span> <span class="string">来访问</span> <span class="string">www.baidu.com</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-externalname</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">www.baidu.com</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Ingress，ing"><a href="#知识点：Ingress，ing" class="headerlink" title="知识点：Ingress，ing"></a>知识点：Ingress，ing</h3><ol>
<li><strong>Ingress</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - K8S 提供的资源类型，实现七层反向代理功能</span><br><span class="line">  - 1.11 版本加入</span><br><span class="line">  - 官方文档 https://kubernetes.io/docs/concepts/services-networking/ingress/</span><br><span class="line"></span><br><span class="line">* 一个 Ingress 资源对象本质上是七层反向代理规则的抽象</span><br><span class="line">  - 在 Ingress 中编写域名与 service 的映射规则</span><br><span class="line">  - ingress controller 会自动将这些映射规则转化为 Nginx 的反向代理配置，然后对外部提供服务</span><br><span class="line">  - service 对七层反向代理后的结果进行负载均衡</span><br><span class="line"></span><br><span class="line">* 优点</span><br><span class="line">  - 节省了操作</span><br><span class="line">    - 原先为手动更新七层反向代理配置，手动加载配置</span><br><span class="line">    - 现在为仅编写域名与 service 的映射逻辑，K8S 自动生成七层反向代理配置，自动为反向代理程序加载配置</span><br><span class="line">  - 节约主机端口</span><br><span class="line">    - Ingress Controler 占用一个主机端口，用于提供外部访问</span><br><span class="line">    - 所有的后端 service 都可以是 ClusterIp 形式</span><br><span class="line"></span><br><span class="line">* 生产环境结构</span><br><span class="line">  - 防火墙 --&gt; 调度器 --&gt; IngressController --&gt; service</span><br><span class="line">  - IngressController pod 多副本实现高可用</span><br></pre></td></tr></table></figure></li>
<li><strong>IngressController</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* 具体实现反向代理及负载均衡的程序</span><br><span class="line">  - 解析 Ingress 中定义的规则</span><br><span class="line">  - 将规则转化为反向代理程序的配置</span><br><span class="line">  - 反向代理程序负责具体的请求转发，将具体域名的 request 转发到指定的 service</span><br><span class="line"></span><br><span class="line">* IngressController 会动态感知 Ingress 中规则的变化</span><br><span class="line">  - 动态生成反向代理程序的配置</span><br><span class="line">  - 动态加载新生成的配置</span><br><span class="line"></span><br><span class="line">* IngressController 结构</span><br><span class="line">  - 一个 ingress namespace</span><br><span class="line">  - 一个 NodePort service</span><br><span class="line">  - 一个 反向代理程序 pod</span><br><span class="line">    - 以 nginx-ingress为例</span><br><span class="line">      - 运行一个 /usr/bin/dumb-init 进程，用于初始化 nginx-ingress-controller 进程</span><br><span class="line">      - 运行一个 nginx-ingress-controller 进程，用于生成 nginx 配置、reload nginx</span><br><span class="line">      - 运行一组 nginx master/worker 进程，进行实际的反向代理</span><br><span class="line"></span><br><span class="line">* 实现方式</span><br><span class="line">  - Nginx</span><br><span class="line">    - 官网 https://kubernetes.github.io/ingress-nginx/</span><br><span class="line">    - 部署文档 https://kubernetes.github.io/ingress-nginx/deploy/</span><br><span class="line">    - 代码 https://github.com/kubernetes/ingress-nginx</span><br><span class="line">  - Contour</span><br><span class="line">  - Haproxy</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get ing</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get ing -o wide</span><br><span class="line"></span><br><span class="line">NAME            HOSTS             ADDRESS   PORTS   AGE</span><br><span class="line">ingress-nginx   aaa.bbb.ccc.com             80      11s</span><br><span class="line"></span><br><span class="line">kubectl -n ingress-nginx get svc -o wide</span><br><span class="line">NAME            TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE   SELECTOR</span><br><span class="line">ingress-nginx   NodePort   10.104.249.179   &lt;none&gt;        80:31084/TCP,443:31464/TCP   62m   app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl describe ing</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test describe ing</span><br><span class="line"></span><br><span class="line">Name:             ingress-nginx</span><br><span class="line">Namespace:        test</span><br><span class="line">Address:          10.104.249.179</span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host             Path  Backends</span><br><span class="line">  ----             ----  --------</span><br><span class="line">  aaa.bbb.ccc.com  /   nginx-service:80 (10.244.1.241:80)</span><br><span class="line">Annotations:</span><br><span class="line">  kubectl.kubernetes.io/last-applied-configuration:  &#123;&quot;apiVersion&quot;:&quot;extensions/v1beta1&quot;,&quot;kind&quot;:&quot;Ingress&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;ingress-nginx&quot;,&quot;namespace&quot;:&quot;test&quot;&#125;,&quot;spec&quot;:&#123;&quot;rules&quot;:[&#123;&quot;host&quot;:&quot;aaa.bbb.ccc.com&quot;,&quot;http&quot;:&#123;&quot;paths&quot;:[&#123;&quot;backend&quot;:&#123;&quot;serviceName&quot;:&quot;nginx-service&quot;,&quot;servicePort&quot;:80&#125;,&quot;path&quot;:&quot;/&quot;&#125;]&#125;&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason  Age   From                      Message</span><br><span class="line">  ----    ------  ----  ----                      -------</span><br><span class="line">  Normal  CREATE  65s   nginx-ingress-controller  Ingress test/ingress-nginx</span><br><span class="line">  Normal  UPDATE  12s   nginx-ingress-controller  Ingress test/ingress-nginx</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">backend:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">rules:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">tls:</span> <span class="string">&lt;[]Object&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>图示</strong><br><img src="/2000/01/01/Blog32-k8s/Ingress%E5%B7%A5%E4%BD%9C%E5%9B%BE%E7%A4%BA.png"></li>
</ol>
<hr>
<h3 id="知识点：Nginx-IngressController-安装"><a href="#知识点：Nginx-IngressController-安装" class="headerlink" title="知识点：Nginx IngressController 安装"></a>知识点：Nginx IngressController 安装</h3><ol>
<li><strong>操作</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载 yaml 文件</span></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 mandatory.yaml 文件中仓库到七牛云</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0 --&gt; quay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发布资源</span></span><br><span class="line">kubectl apply -f ./</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会创建一个 namespace ingress-nginx，并在其中创建 deployment、service 以及相应的 configmap 和 role 等</span></span><br><span class="line">kubectl -n ingress-nginx get deployment,service -o wide</span><br><span class="line">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS                 IMAGES                                                                  SELECTOR</span><br><span class="line">deployment.apps/nginx-ingress-controller   1/1     1            1           4m22s   nginx-ingress-controller   quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0   app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx</span><br><span class="line"></span><br><span class="line">NAME                    TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE     SELECTOR</span><br><span class="line">service/ingress-nginx   NodePort   10.104.249.179   &lt;none&gt;        80:31084/TCP,443:31464/TCP   4m22s   app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Ingress-spec-backend"><a href="#知识点：Ingress-spec-backend" class="headerlink" title="知识点：Ingress.spec.backend"></a>知识点：Ingress.spec.backend</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 为 Ingress 指定默认服务器</span><br><span class="line">  - 如果 request 不匹配任何的 roles 则从 backend 转发</span><br><span class="line"></span><br><span class="line">* backend 和 roles 两个至少要指定一个</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">backend:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br><span class="line">  <span class="attr">servicePort:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Ingress-spec-rules"><a href="#知识点：Ingress-spec-rules" class="headerlink" title="知识点：Ingress.spec.rules"></a>知识点：Ingress.spec.rules</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 设置 Ingress 中域名与 service 的绑定关系的规则列表</span><br><span class="line"></span><br><span class="line">* 如果没有设定，或 request 与 rules 中任何规则都不匹配，则 request 会被转发到 backend</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&lt;string&gt;</span>      <span class="comment"># 指定对 request url 中主机名的匹配，目前不支持 IP 格式，不支持 &#x27;:&#x27; 来指定端口</span></span><br><span class="line">  <span class="attr">http:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">    <span class="attr">paths:</span> <span class="string">&lt;[]Object&gt;</span> <span class="string">-required-</span>    <span class="comment"># 指定后端 service 的地址，指定多个则自动进行负载均衡</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&lt;string&gt;</span>                    <span class="comment"># 指定对 request url 中资源路径的匹配</span></span><br><span class="line">      <span class="attr">backend:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span></span><br><span class="line">        <span class="attr">serviceName:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>    <span class="comment"># 指定后端 service</span></span><br><span class="line">        <span class="attr">servicePort:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>    <span class="comment"># 指定后端 service 的端口</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建 deployment，运行 nginx</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建 service，为 deployment 提供访问</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建 ingress，将域名 aaa.bbb.ccc.com 与 service 绑定</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">aaa.bbb.ccc.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Ingress-spec-tls"><a href="#知识点：Ingress-spec-tls" class="headerlink" title="知识点：Ingress.spec.tls"></a>知识点：Ingress.spec.tls</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 介绍</span><br><span class="line">  - 为 https 指定证书</span><br><span class="line">  - 证书需要提前以 secret 的方式存放在 K8S 中</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tls:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">&lt;[]string&gt;</span>       <span class="comment"># 指定使用此证书的域名</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">XXXX.XXXX.XXXX</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">XXXX.XXXX.XXXX</span></span><br><span class="line">  <span class="attr">secretName:</span> <span class="string">&lt;string&gt;</span>    <span class="comment"># 指定证书名</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建证书</span></span><br><span class="line">openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/C=CN/ST=BJ/L=BJ/O=nginx/CN=aaa.bbb.ccc.com&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建 secret，保存证书</span></span><br><span class="line">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span><br></pre></td></tr></table></figure>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 nginx deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建 nginx service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 创建 ingress，使用 tls 证书</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">aaa.bbb.ccc.com</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">www1.aaa.bbb.ccc.com</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">www2.aaa.bbb.ccc.com</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">aaa.bbb.ccc.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www1.aaa.bbb.ccc.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ingress-nginx-Auth-操作"><a href="#知识点：ingress-nginx-Auth-操作" class="headerlink" title="知识点：ingress-nginx Auth 操作"></a>知识点：ingress-nginx Auth 操作</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 通过 htpasswd 进行用户身份验证</span><br><span class="line"></span><br><span class="line">* 官方文档 https://kubernetes.github.io/ingress-nginx/examples/auth/basic/</span><br><span class="line"></span><br><span class="line">* 通过指定 ingress annotation 实现用户身份验证</span><br><span class="line"></span><br><span class="line">* 密码文件须提前保存到 K8S secret 中</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>操作</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 htpasswd</span></span><br><span class="line">yum -y install httpd-tools</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生产密码文件，保存 foo 用户的密码</span></span><br><span class="line">mkdir basic-auth</span><br><span class="line">htpasswd -c basic-auth/PasswdFile foo PASSWD</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存密码文件</span></span><br><span class="line">kubectl create secret generic basic-auth --from-file=PasswdFile</span><br></pre></td></tr></table></figure></li>
<li><strong>建立 ingress</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  namespace: test</span><br><span class="line">  annotation：</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-type: basic</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-secret: basic-auth</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-realm: &#x27;Authentication Require - foo&#x27;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - XXXX</span><br><span class="line">  - XXXX</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ingress-nginx-重写操作"><a href="#知识点：ingress-nginx-重写操作" class="headerlink" title="知识点：ingress-nginx 重写操作"></a>知识点：ingress-nginx 重写操作</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 通过指定 ingress annotation 进行重写</span><br><span class="line"></span><br><span class="line">* nginx.ingress.kubernetes.io/rewrite-target: &lt;string&gt;        必须重定向流量的目标 uri</span><br><span class="line"></span><br><span class="line">* nginx.ingress.kubernetes.io/ssl-redirect: &lt;boolean&gt;         指示位置部分是否仅可访问 ssl（当 ingress 包含证书时默认为 true）</span><br><span class="line"></span><br><span class="line">* nginx.ingress.kubernetes.io/force-ssl-redirect: &lt;boolean&gt;   即使 ingress 未启用 tls，也强制重定向到 https</span><br><span class="line"></span><br><span class="line">* nginx.ingress.kubernetes.io/app-root: &lt;string&gt;              定义 controller 必须重定向的应用程序根，如果它在 &#x27;/&#x27; 上下文中</span><br><span class="line"></span><br><span class="line">* nginx.ingress.kubernetes.io/use-regex: &lt;boolean&gt;            指示 ingress 上定义的路径是否使用正则表达式</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-8-K8S-存储"><a href="#3-8-K8S-存储" class="headerlink" title="3.8 K8S 存储"></a>3.8 K8S 存储</h2><hr>
<h3 id="知识点：volume"><a href="#知识点：volume" class="headerlink" title="知识点：volume"></a>知识点：volume</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* volume 用来储存 pod 中的数据</span><br><span class="line">  - 数据持久化</span><br><span class="line">  - 容器间数据交互</span><br><span class="line"></span><br><span class="line">* volume 生命期与 pod 相同，与用户容器无关</span><br><span class="line">  - 用户容器终止或重启，不会影响到 volume</span><br><span class="line">  - For any kind of volume in a given pod, data is preserved across container restarts.</span><br><span class="line"></span><br><span class="line">* volume 实际挂载到 pod 的 pause 容器上</span><br><span class="line">  - Pod 中的用户容器通过共享 pause 容器的 volume，实现 volume 的挂载</span><br><span class="line">  - 多个用户容器挂载同一个 volume 来实现数据交互</span><br><span class="line"></span><br><span class="line">* ephemeral volumes 和 persistent volumes</span><br><span class="line">  - ephemeral volumes，临时卷，生命期与 pod 生命期相同</span><br><span class="line">  - persistent volumes，持久卷，生命期超越 pod 生命期</span><br><span class="line">  - Ephemeral volume types have a lifetime of a pod, but persistent volumes exist beyond the lifetime of a pod.</span><br><span class="line">  - 当 pod 终止并退出时，K8S 会摧毁 ephemeral volumes，不会摧毁 persistent volumes</span><br><span class="line">  - When a pod ceases to exist, Kubernetes destroys ephemeral volumes; however, Kubernetes does not destroy persistent volumes.</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-containers-volumeMounts"><a href="#知识点：pod-spec-containers-volumeMounts" class="headerlink" title="知识点：pod.spec.containers.volumeMounts"></a>知识点：pod.spec.containers.volumeMounts</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 为容器指定需要挂载的 volume，以及在容器中的挂载位置</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumeMounts:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>      <span class="comment"># 指定 volume 挂载到容器内的位置</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>           <span class="comment"># 指定要挂载的 volume 的 name</span></span><br><span class="line">  <span class="attr">subPath:</span> <span class="string">&lt;string&gt;</span>                   <span class="comment"># 指定将 volume 下的子路径挂载到容器内，默认 &quot;&quot; 表示 volume 的根</span></span><br><span class="line">  <span class="attr">subPathExpr:</span> <span class="string">&lt;string&gt;</span>               <span class="comment"># 指定将 volume 下的子路径挂载到容器内</span></span><br><span class="line">                                      <span class="comment"># 功能与 subPath 相同，但支持以 $&#123;VAR_NAME&#125; 的形式扩展环境变量</span></span><br><span class="line">                                      <span class="comment"># 与 subPath 只能指定一个</span></span><br><span class="line">  <span class="attr">mountPropagation:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">readOnly:</span> <span class="string">&lt;boolean&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-volumes"><a href="#知识点：pod-spec-volumes" class="headerlink" title="知识点：pod.spec.volumes"></a>知识点：pod.spec.volumes</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 在 pod 中创建 volume</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>       <span class="comment"># 指定 volume 的 name，Must be a DNS_LABEL and unique within the pod.</span></span><br><span class="line">  <span class="comment"># 以下的属性用来指定 volume 的类型以及细节</span></span><br><span class="line">  <span class="comment"># 每个 volume 配置只能选择其中一种</span></span><br><span class="line">  <span class="attr">emptyDir:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">hostPath:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">nfs:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">configMap:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">persistentVolumeClaim:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">azureDisk:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">azureFile:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">cephfs:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">gitRepo:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">rbd:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">vsphereVolume:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-volumes-emptyDir"><a href="#知识点：pod-spec-volumes-emptyDir" class="headerlink" title="知识点：pod.spec.volumes.emptyDir"></a>知识点：pod.spec.volumes.emptyDir</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 将一个目录挂载到容器上</span><br><span class="line">  - emptyDir 是最基础的 Volume 类型</span><br><span class="line">  - emptyDir 在 Pod 被分配到 Node 上时创建，会指向 node 上的一个目录，创建初始为空目录</span><br><span class="line">  - 无须为 emptyDir 指定在 node 上对应的目录，因为 kubernetes 会自动分配一个目录</span><br><span class="line"></span><br><span class="line">* emptyDir volume 是 ephemeral volumes</span><br><span class="line">  - 生命期与 pod 相同</span><br><span class="line">  - pod 结束时，emptyDir 中的数据也会被删除</span><br><span class="line"></span><br><span class="line">* emptyDir 应用场景</span><br><span class="line">  - 容器临时数据目录，如排序</span><br><span class="line">  - 容器间共享数据</span><br><span class="line">  - init container 向用户容器中提供数据</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">emptyDir:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">medium:</span> <span class="string">&lt;string&gt;</span>        <span class="comment"># 指定存储媒介</span></span><br><span class="line">                          <span class="comment"># 默认 &quot;&quot; 表示 node 的默认媒介，也可以指定 &quot;Memory&quot;</span></span><br><span class="line">  <span class="attr">sizeLimit:</span> <span class="string">&lt;string&gt;</span>     <span class="comment"># 指定 emptyDir 的容量限制，默认无限制</span></span><br><span class="line">                          <span class="comment"># The size limit is also applicable for memory medium. The maximum usage on memory medium EmptyDir would be the minimum value between the SizeLimit specified here and the sum of memory limits of all containers in a pod.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常用方式，表示 emptyDir 一切默认</span></span><br><span class="line"><span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 emptydir volume 挂载到容器的 /usr/local/nginx/logs 目录</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/nginx/logs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-empytdir</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-empytdir</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-volumes-hostPath"><a href="#知识点：pod-spec-volumes-hostPath" class="headerlink" title="知识点：pod.spec.volumes.hostPath"></a>知识点：pod.spec.volumes.hostPath</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">* ​hostPath 可以将 node 上的一个实际目录或文件挂载到容器中</span><br><span class="line">  - 数据实际存储在 node 上</span><br><span class="line"></span><br><span class="line">* hostPath 是 persistent volumes</span><br><span class="line">  - 重启 pod 或删除 pod 不会导致数据被删除</span><br><span class="line"></span><br><span class="line">* hostPath 的类型 type</span><br><span class="line">  - DirectoryOrCreate   目录，存在就使用，不存在就先创建后使用</span><br><span class="line">  - Directory           目录，必须存在</span><br><span class="line">  - FileOrCreate        文件，存在就使用，不存在就先创建后使用</span><br><span class="line">  - File                文件，必须存在</span><br><span class="line">  - Socket              unix 插槽，必须存在</span><br><span class="line">  - CharDevice          字符设备，必须存在</span><br><span class="line">  - BlockDevice         块设备，必须存在</span><br><span class="line"></span><br><span class="line">* 注意点</span><br><span class="line">  - hostPath 需要注意 hostPath 的权限</span><br><span class="line">    - 如果 K8S 不是以 root 启动的，则 hostPath 应具有与 kubelet 进程相同的 user.group</span><br><span class="line">  - hostPath 是基于 node 的，需要提前在 node 上为 hostPath 准备配置</span><br><span class="line">    - 如果 pod 被重新调度，而新 node 上并没有为 hostPath 提前准备，则可能发生问题，如本应存在 nfs 上的数据被保存到本地</span><br><span class="line"></span><br><span class="line">* 应用场景</span><br><span class="line">  - cAdvisor 需要使用节点的 /dev/cgroups</span><br><span class="line"></span><br><span class="line">* K8S 官方并不推荐使用 hostPath</span><br><span class="line">  - 若使用，尽量以 readonly 的方式使用</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostPath:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>   <span class="comment"># hostPath 在 node 节点上的路径</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 hostPath 挂载到容器的 /usr/local/nginx/logs</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">web:</span> <span class="string">web01</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/nginx/logs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-hostpath</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-hostpath</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/tmp/logs</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：PersistentVolumes，pv"><a href="#知识点：PersistentVolumes，pv" class="headerlink" title="知识点：PersistentVolumes，pv"></a>知识点：PersistentVolumes，pv</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 持久化卷</span><br><span class="line">  - 是对底层的共享存储的一种抽象</span><br><span class="line">  - pv 对上层屏蔽了存储的具体细节，使上层不需要关心如何使用存储技术</span><br><span class="line"></span><br><span class="line">* pv 不属于 namespace</span><br></pre></td></tr></table></figure></li>
<li><strong>pv 的回收策略</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* pv.spec.persistentVolumeReclaimPolicy</span><br><span class="line"></span><br><span class="line">* 当 pv 被 pvc 释放后，如何处理 pv 中的数据</span><br><span class="line">  - Retain</span><br><span class="line">    - 保留</span><br><span class="line">    - pv 与 pvc 解绑后，数据不会被删除，需要手工清理数据</span><br><span class="line">    - pv 将始终保持 Release 状态，不会被其他 pvc 重新绑定</span><br><span class="line">  - Delete</span><br><span class="line">    - 删除</span><br><span class="line">    - pv 与 pvc 解绑后，K8S 中会删除 pv 对象，同时后端存储会删除 pv 中的数据</span><br><span class="line">    - 常见于云服务商的存储服务</span><br><span class="line">  - Recycle</span><br><span class="line">    - 回收</span><br><span class="line">    - 清除 PV 中的数据，本质上是执行 rm -rf /thevolume/*</span><br><span class="line">    - 回收后的 pv 将变为 Avaliable 状态，可以直接再次被 pvc 使用</span><br><span class="line">    - K8S 目前已建议废弃</span><br><span class="line"></span><br><span class="line">* 对于 anually created PersistentVolumes，默认值为 Retain，对于 dynamically provisioned PersistentVolumes，默认值为 Delete</span><br></pre></td></tr></table></figure></li>
<li><strong>pv 的状态</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">* Available</span><br><span class="line">  - pv 已创建，还未被任何 PVC 绑定</span><br><span class="line">  - 此状态的 pv 可以被 pvc 绑定</span><br><span class="line"></span><br><span class="line">* Bound</span><br><span class="line">  - PV 已经被 pvc 绑定</span><br><span class="line"></span><br><span class="line">* Released</span><br><span class="line">  - pv 已被 pvc 释放</span><br><span class="line">  - 此状态的 pv 不可以被 pvc 绑定</span><br><span class="line"></span><br><span class="line">* Failed</span><br><span class="line">  - pv 的自动回收失败</span><br><span class="line"></span><br><span class="line">* pv 状态的轮转</span><br><span class="line">  - 新创建的 pv，其状态为 Avaliable</span><br><span class="line">  - pvc 绑定 pv，pv 状态变为 Bound</span><br><span class="line">  - 删除 pvc，pv 状态变为 Released</span><br><span class="line">  - 如果 pv 的回收策略为 Delete，则会对 pv 进行回收</span><br><span class="line">    - 删除后端数据</span><br><span class="line">    - 后端数据删除后，删除 pv 对象</span><br><span class="line">  - 如果 pv 的鬼手策略为 Retain，则 pv 将始终处于 Released 状态</span><br><span class="line">    - 不会删除后端数据</span><br><span class="line">    - 不会删除 pv 对象</span><br><span class="line">    - pv 无法被其他 pvc 绑定</span><br><span class="line"></span><br><span class="line">* pv 回收状态为 retain 时，卡在 Released 状态的意义</span><br><span class="line">  - 在 released 状态，只删除 pv 对象，不会删除后端数据</span><br><span class="line">    - 是否要删除后端数据，完全由人工决定</span><br><span class="line">  - 如果想要重新使用 pv 中的数据</span><br><span class="line">    - 可以删除 pv 对象，然后重建一个相同的 pv，这他妈居然是 K8S 官方推荐方式</span><br><span class="line">    - 也可以 edit pv 对象，手动回收 pv</span><br><span class="line">  - 如果想要重新使用 pv 所代表的空间</span><br><span class="line">    - 手动 rm -f 后端数据</span><br><span class="line">    - 手动删除 pv 对象</span><br><span class="line">    - 重建一个完全相同的 pv 对象</span><br><span class="line">    - 这他妈也是 K8S 官方推荐方式</span><br></pre></td></tr></table></figure></li>
<li><strong>pv 的访问模式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 访问模式，用于确定 pv 如何被使用</span><br><span class="line"></span><br><span class="line">* pv.spec.accessModes 用于设置 pv 支持的访问模式</span><br><span class="line">  - ReadWriteOnce         RWO，读写，只能被一个 node 挂载</span><br><span class="line">  - ReadOnlyMany          ROX，只读，可以被多个 node 挂载</span><br><span class="line">  - ReadWriteMany         RWX，读写，可以被多个 node 挂载</span><br><span class="line">  - ReadWriteOncePod      RWOP，读写，只能被一个 pod 使用，只支持 CSI volumes 并且 K8S 须高于 1.22+.</span><br><span class="line"></span><br><span class="line">* 不同类型的 pv，能支持的访问模式也不同</span><br><span class="line">  - 官方表格 https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get pv</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv -o wide</span><br><span class="line">NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       STORAGECLASS   REASON   AGE     VOLUMEMODE</span><br><span class="line">pv1    3G         RWX            Retain           Bound    test/pvc1                           3m35s   Filesystem</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span>       <span class="comment"># 用于给 pvc 进行筛选</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span> <span class="string">&lt;map[string]string&gt;</span>     <span class="comment"># 指定 pv 的一些限制，目前只支持容量限制</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&lt;string&gt;</span>        <span class="comment"># 指定 pv 的存储类型</span></span><br><span class="line">                                    <span class="comment"># 相当于一个 pv 和 pvc 专有的 label</span></span><br><span class="line">                                    <span class="comment"># 在 pvc 匹配 pv 时只有 storageClassName 相同的 pv 和 pv 可以匹配</span></span><br><span class="line">                                    <span class="comment"># 习惯上在实际使用中填写存储类型，如 nfs、cephfs 等，或 fast、slow 等</span></span><br><span class="line">  <span class="attr">accessModes:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="comment"># 以下为 pv 支持的存储类型，只能选择一种</span></span><br><span class="line">  <span class="attr">nfs:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：PersistentVolumeClaim，pvc"><a href="#知识点：PersistentVolumeClaim，pvc" class="headerlink" title="知识点：PersistentVolumeClaim，pvc"></a>知识点：PersistentVolumeClaim，pvc</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* ​持久卷声明</span><br><span class="line">  - 存储请求方案</span><br><span class="line">  - 用户对于存储需求的声明，向 K8S 系统发出的资源需求申请</span><br><span class="line">  - 用户在 pvc 中提出想要使用的 pv 的属性</span><br><span class="line">  - K8S 根据用户的要求匹配 pv，将匹配到的 pv 与 pvc 进行绑定</span><br><span class="line">  - 如果找不到，pvc 会一直处于 pending 状态，直到管理员创建了一个符合其要求的 pv</span><br><span class="line"></span><br><span class="line">* 不同于 pv，pvc 是属于 namespace 的</span><br><span class="line"></span><br><span class="line">* pvc 与 pv 的匹配由 K8S 自动完成</span><br><span class="line">  - 基于 label</span><br><span class="line">  - 最合适的</span><br><span class="line"></span><br><span class="line">* pvc 会独占 pv</span><br><span class="line">  - 排他性</span><br><span class="line">  - pv 一旦与某个 pvc 绑定，就不能再与其他 pvc 绑定了</span><br><span class="line"></span><br><span class="line">* pvc 不需要关注 pv 的存储类别，只要提出资源需求的要求即可</span><br><span class="line">  - 在 pvc 中不需要指定诸如 nfs 等内容</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get pvc</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get pvc -o wide</span><br><span class="line">NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE</span><br><span class="line">pvc1   Bound    pv1      3G         RWX                           8s    Filesystem</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> <span class="string">&lt;[]string&gt;</span>               <span class="comment"># 指定 pv 应当支持的访问模式</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">&lt;Object&gt;</span>                    <span class="comment"># 选择器，Label-selector 机制，选择想要使用的 pv</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">    <span class="attr">matchLabels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">&lt;Object&gt;</span>                   <span class="comment"># 指定 pv 的资源情况，目前只支持对 storage 进行设置</span></span><br><span class="line">    <span class="attr">requests:</span> <span class="string">&lt;map[string]string&gt;</span>           <span class="comment"># 指定 minimum storage 需求</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">limits:</span> <span class="string">&lt;map[string]string&gt;</span>             <span class="comment"># 指定 maximum storage 需求</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个 nvs pv</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv1</span><br><span class="line">  labels:</span><br><span class="line">    type: nfs</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 3G</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  nfs:</span><br><span class="line">    server: 192.168.31.160</span><br><span class="line">    path: /data/nfs/pv1</span><br><span class="line">---</span><br><span class="line"># 创建 pvc</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc1</span><br><span class="line">  namespace: test</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      type: nfs</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1G</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：pod-spec-volumes-persistentVolumeClaim"><a href="#知识点：pod-spec-volumes-persistentVolumeClaim" class="headerlink" title="知识点：pod.spec.volumes.persistentVolumeClaim"></a>知识点：pod.spec.volumes.persistentVolumeClaim</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 在 pod 中定义将 pvc 定义为 volume</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">persistentVolumeClaim: &lt;Object&gt;</span><br><span class="line">  claimName: &lt;string&gt; -required-      # 指定 pvc 的名字</span><br><span class="line">  readOnly: &lt;boolean&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 创建 deploy，其中的 pod 中使用 pvc</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  namespace: test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      web: web01</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        web: web01</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx-container</span><br><span class="line">        image: nginx:1.17.1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /usr/local/nginx/logs</span><br><span class="line">          name: log-pvc</span><br><span class="line">      volumes:</span><br><span class="line">      - name: log-pvc</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: pvc1</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：PersistentVolume-spec-nfs"><a href="#知识点：PersistentVolume-spec-nfs" class="headerlink" title="知识点：PersistentVolume.spec.nfs"></a>知识点：PersistentVolume.spec.nfs</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 创建一个 nfs 类型的 pv</span><br></pre></td></tr></table></figure></li>
<li><strong>语法</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nfs: &lt;Object&gt;</span><br><span class="line">  server: &lt;string&gt; -required-     # 指定 NFS 服务器</span><br><span class="line">  path: &lt;string&gt; -required-       # 指定 NFS 上的路径</span><br><span class="line">  readOnly: &lt;boolean&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个 nfs 类型的 pv</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1G</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.160</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/nfs/pv1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：手动回收-pv"><a href="#知识点：手动回收-pv" class="headerlink" title="知识点：手动回收 pv"></a>知识点：手动回收 pv</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 如果 pv 的回收策略是 retain，则当 pvc 与 pv 解绑后，pv 会一直处于 Released 状态</span><br><span class="line"></span><br><span class="line">* 通过手动 edit pv 来使 pv 恢复为 Available 状态</span><br><span class="line"></span><br><span class="line">* 仅清除 pv 的元数据中记录的 pvc 的绑定关系，不会导致后端数据被删除</span><br></pre></td></tr></table></figure></li>
<li><strong>操作</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit pv NAME</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 ClaimRef 属性及其所有子属性删除</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除后，pv 将恢复到 Available 状态</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：StatefulSet，sts"><a href="#知识点：StatefulSet，sts" class="headerlink" title="知识点：StatefulSet，sts"></a>知识点：StatefulSet，sts</h3><ol>
<li><strong>官方文档</strong></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#stable-network-id">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#stable-network-id</a></li>
</ul>
<ol start="2">
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* StatefulSet 是有状态服务而设计的 pod 控制器</span><br><span class="line">  - deploy 和 rs 是为无状态服务而设计的</span><br><span class="line"></span><br><span class="line">* StatefulSet 支持 pod 版本回退，支持滚动更新</span><br></pre></td></tr></table></figure></li>
<li><strong>StatefulSet pod</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 按序创建/删除 pod</span><br><span class="line">  - 有序部署，有序扩展</span><br><span class="line">    - 即 pod 是有顺序的，在部署或扩展时需要按顺序依次进行</span><br><span class="line">    - 从 0 到 N-1</span><br><span class="line">    - 之前所有之前的 pod 必须处于 ready 或 running 状态，才会启动下一个 pod 运行</span><br><span class="line">    - 基于 init container 来实现</span><br><span class="line">  - 有序收缩、有序删除</span><br><span class="line">    - 从 N-1 到 0</span><br><span class="line">* pod 命名</span><br><span class="line">  - $(StatefulSet-name)-N</span><br><span class="line"></span><br><span class="line">* 标签</span><br><span class="line">  - pod 创建时，会被自动添加一个标签，statefulset.kubernetes.io/pod-name，值为 pod 的名字</span><br></pre></td></tr></table></figure></li>
<li><strong>StatefulSet 存储</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* StatefulSet 会自动为每个 pod 创建 pvc</span><br><span class="line">  - StatefulSet.spec.volumeClaimTemplates 中设置 pvc 的列表</span><br><span class="line">  - StatefulSet.spec.volumeClaimTemplates 每设置一项，pod 就会收到一个 pvc</span><br><span class="line">  - pvc 命名</span><br><span class="line">    - $(pvc-name)-$(pod-name)</span><br><span class="line"></span><br><span class="line">* 新版本中添加了 StatefulSet.spec.persistentVolumeClaimRetentionPolicy，可以设置当 StatefulSet 删除/扩容/缩容时对于 pvc 的回收策略</span><br><span class="line">  - Kubernetes v1.23 [alpha]</span><br><span class="line">  - 需要开启 StatefulSetAutoDeletePVC feature gate</span><br></pre></td></tr></table></figure></li>
<li><strong>StatefulSet 网络</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* StatefulSet 目前只能使用 headless service，需要手动创建</span><br><span class="line"></span><br><span class="line">* StatefulSet 会为每个 pod 建立固定的网络标识 Stable Network ID</span><br><span class="line">  - 网络标识不会因为 pod 被重调度而发生变化</span><br><span class="line">  - 可以通过各种网络标识来与 StatefulSet pod 建立通信</span><br><span class="line">  - pod hostname</span><br><span class="line">    - $(pod-name)</span><br><span class="line">  - service domain</span><br><span class="line">    - $(service-name).$(namespace).svc.$(cluster-domain)</span><br><span class="line">  - pod domain</span><br><span class="line">    - $(pod-name).$(service-name).$(namespace).svc.$(cluster-domain)</span><br><span class="line"></span><br><span class="line">* StatefulSet 中，使用 pod 域名而非 pod ip 来进行通信</span><br><span class="line">  - 域名格式，podName.headlessServiceName</span><br><span class="line">  - 当 node 发生故障导致 pod 漂移时，ip 可能变化，但域名不会变化</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line"><span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">&lt;string&gt;</span>         <span class="comment"># OrderedReady/Parallel</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">updateStrategy:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="string">&lt;integer&gt;</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>         <span class="comment"># pod 选择器</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&lt;string&gt;</span> <span class="string">-required-</span>      <span class="comment"># 使用的 service</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">&lt;Object&gt;</span> <span class="string">-required-</span>         <span class="comment"># pod 模板</span></span><br><span class="line">    <span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">labels:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">    <span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">containers:</span> <span class="string">&lt;[]Object&gt;</span> <span class="string">-required-</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">        <span class="attr">ports:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span> <span class="string">&lt;[]Object&gt;</span>      <span class="comment"># pvc 模板</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line">    <span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&lt;namespace&gt;</span></span><br><span class="line">    <span class="attr">spec:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">      <span class="attr">accessModes:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">        <span class="attr">limits:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">        <span class="attr">requests:</span> <span class="string">&lt;map[string]string&gt;</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">&lt;string&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：StatefulSet-范例"><a href="#知识点：StatefulSet-范例" class="headerlink" title="知识点：StatefulSet 范例"></a>知识点：StatefulSet 范例</h3><ol>
<li><strong>第一步，创建三个 pv</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2G</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.160</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/nfs/pv1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2G</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.160</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/nfs/pv2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2G</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.31</span><span class="number">.160</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/nfs/pv3</span></span><br></pre></td></tr></table></figure></li>
<li><strong>第二步，创建 Headless Service</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li>
<li><strong>第三部，创建 StatefulSet</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteMany&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;nfs&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：ConfigMap，cm"><a href="#知识点：ConfigMap，cm" class="headerlink" title="知识点：ConfigMap，cm"></a>知识点：ConfigMap，cm</h3><ol>
<li><strong>官方文档</strong></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/configmap/">https://kubernetes.io/docs/concepts/configuration/configmap/</a></li>
</ul>
<ol start="2">
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* configmap 用来向容器中传递配置信息</span><br><span class="line">  - 1.2 版本引入</span><br><span class="line">  - 可以保存单个属性，或整个配置文件，或 JSON 二进制大对象</span><br><span class="line"></span><br><span class="line">* configmap 本质上是一个字符串 K-V 对映射</span><br><span class="line">  - K-V 表示文件</span><br><span class="line">    - K 是文件名</span><br><span class="line">    - V 是文件的内容</span><br><span class="line">  - K-V 表示字面值</span><br><span class="line">    - K 就是属性名</span><br><span class="line">    - V 就是属性值</span><br><span class="line"></span><br><span class="line">* kubectl create configmap 可以创建 configmap</span><br><span class="line">  - 如果要保存文件则推荐此推荐方式</span><br><span class="line"></span><br><span class="line">* kubectl describe configmap 可以查看 configmap 的内容</span><br><span class="line"></span><br><span class="line">* kubectl edit configmap 可以动态修改 configmap 的内容，继而动态更新 pod 中的配置</span><br><span class="line">  - 如果 configmap 是以 volume 挂载到 pod 中，则更新可能会有一些延迟，经验值约 10s</span><br></pre></td></tr></table></figure></li>
<li><strong>ConfigMap 的使用</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 在 pod 资源清单中提供环境变量</span><br><span class="line">  - pod.spec.containers.env.valueFrom</span><br><span class="line">  - pod.spec.containers.envFrom</span><br><span class="line"></span><br><span class="line">* 以 volume 形式挂载到容器中提供文件</span><br><span class="line">  - configmap 在 pod 中都会映射为一个目录</span><br><span class="line">  - configmap.data 中的每一个 K-V 都会被映射成一个文件</span><br><span class="line">  - K 为文件名</span><br><span class="line">  - V 为文件内容</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">data:</span> <span class="string">&lt;map[string]string&gt;</span>       <span class="comment"># 设置配置文件和文件的内容</span></span><br><span class="line">                                <span class="comment"># 由于 data 是 &lt;map[string]string&gt; 格式，K-V 中 V 可以使用 yaml 的 &#x27;|&#x27; 符号来保存多行字符串</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 configmap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">c01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">|</span>               <span class="comment"># 使用 yaml 的多行字符串</span></span><br><span class="line">    <span class="string">username:admin</span></span><br><span class="line">    <span class="string">password:123456</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 将 configmap 挂载到容器中</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/configmap/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">c01</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Secret"><a href="#知识点：Secret" class="headerlink" title="知识点：Secret"></a>知识点：Secret</h3><ol>
<li><strong>官方文档</strong></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/secret/">https://kubernetes.io/docs/concepts/configuration/secret/</a></li>
</ul>
<ol start="2">
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">* secret 是 K8S 提供用来储存敏感信息的资源对象</span><br><span class="line">  - secret 与 configmap 类似</span><br><span class="line">  - configmap 的设计目的是储存配置</span><br><span class="line">  - secret 的设计目的是储存身份信息</span><br><span class="line">  - secret 为各种身份信息设计了相配套的类型 type，如 ssl 认证、tls 证书、docker 仓库认证等</span><br><span class="line"></span><br><span class="line">* secret 的最主要用途是储存身份信息</span><br><span class="line">  - 可以避免在代码中包含身份信息</span><br><span class="line">  - 避免在 pod 的工作流中，如 creating、viewing、editing 等中暴露身份信息</span><br><span class="line"></span><br><span class="line">* secret 的数据储存在 etcd 中，以 bash64 编码的结构储存，未加密</span><br><span class="line"></span><br><span class="line">* secret 的数据在内部也是以 K-V 的形式存在</span><br><span class="line">  - 如果 K-V 保存的是文件，则 K 是文件名，V 是文件的内容</span><br><span class="line">  - secret 也可以以 volume 的形式挂载到容器中，挂载为目录，内中的内容以文件的形式存在</span><br><span class="line"></span><br><span class="line">* K8S 建议使用 RBAC 来对 reading 和 writing secret 进行限制</span><br><span class="line">  - 任何具有 API access 的人，或者任何具有 etcd 访问权限的人，都可以查看和修改 secret</span><br><span class="line">  - 任何具有 create pod 的人，包括间接创建 pod 如 create deployment，都能够通过此权限阅读当前 namespace 中的任意 secret</span><br></pre></td></tr></table></figure></li>
<li><strong>secret 的种类</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">* 资源清单中 secret.type 配置</span><br><span class="line"></span><br><span class="line">* Opaque</span><br><span class="line">  - 储存用户任意定义的数据</span><br><span class="line"></span><br><span class="line">* kubernetes.io/service-account-token</span><br><span class="line">  - ServiceAccount token</span><br><span class="line">  - K8S 会自动为每个 namespace 创建一个默认的 ServiceAccount secret，用来为 pod 提供访问 API 资源的 token</span><br><span class="line">  - 默认 ServiceAccount secret 会挂载到 pod 的 /run/secrets/kubernetes.io/serviceaccount 上</span><br><span class="line">  - 从 1.22 开始，K8S 不再将 ServiceAccount secret 挂载到 pod 上，而是改为推荐采用 TokenRequest API 来获取 token</span><br><span class="line">  - K8S 建议，除非无法使用 TokenRequest API 时，再通过 ServiceAccount secret 来获得 token</span><br><span class="line"></span><br><span class="line">* kubernetes.io/dockercfg</span><br><span class="line">  - serialized ~/.dockercfg file</span><br><span class="line"></span><br><span class="line">* kubernetes.io/dockerconfigjson</span><br><span class="line">  - 用于 docker registry 认证的 secret</span><br><span class="line">  - 需要与 pod 在相同的 namespace</span><br><span class="line">  - 在 pod.sepc.imagePullSecrets 中使用</span><br><span class="line"></span><br><span class="line">* kubernetes.io/basic-auth</span><br><span class="line">  - credentials for basic authentication</span><br><span class="line"></span><br><span class="line">* kubernetes.io/ssh-auth</span><br><span class="line">  - credentials for SSH authentication</span><br><span class="line"></span><br><span class="line">* kubernetes.io/tls</span><br><span class="line">  - 储存 tls 证书</span><br><span class="line">  - tls.crt</span><br><span class="line">  - tls.key</span><br><span class="line"></span><br><span class="line">* bootstrap.kubernetes.io/token</span><br><span class="line">  - bootstrap token data</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl get secret</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get secrets -o wide</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-pvhfd   kubernetes.io/service-account-token   3      167m</span><br><span class="line">s01                   Opaque                                2      32m</span><br></pre></td></tr></table></figure></li>
<li><strong>kubectl describe secret</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test describe secrets s01</span><br><span class="line">Name:         s01</span><br><span class="line">Namespace:    test</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:</span><br><span class="line">Type:         Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:  8 bytes</span><br><span class="line">username:  3 bytes</span><br></pre></td></tr></table></figure></li>
<li><strong>资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span> <span class="string">&lt;Object&gt;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">data:</span> <span class="string">&lt;map[string]string&gt;</span>         <span class="comment"># 指定 secret 的 data，以 bash64 格式</span></span><br><span class="line"><span class="attr">stringData:</span> <span class="string">&lt;map[string]string&gt;</span>   <span class="comment"># 指定 secret 的 data，以明文字符格式</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Secret-范例"><a href="#知识点：Secret-范例" class="headerlink" title="知识点：Secret 范例"></a>知识点：Secret 范例</h3><ol>
<li><strong>范例一</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spec.data 方式</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">s01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">XXXX</span>    <span class="comment"># 输入 base64 编码后的值</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">XXXX</span></span><br></pre></td></tr></table></figure></li>
<li><strong>范例二</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spec.stringData 方式</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">s01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">abc</span>     <span class="comment"># 输入明文</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Secret-tls-证书范例"><a href="#知识点：Secret-tls-证书范例" class="headerlink" title="知识点：Secret tls 证书范例"></a>知识点：Secret tls 证书范例</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 作用与 kubectl -n test create secret tls s01 --cert=tls.crt --key=tls.key 相同</span><br><span class="line"></span><br><span class="line">* tls 证书 secret 推荐采用 data 方式</span><br></pre></td></tr></table></figure></li>
<li><strong>操作</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取 crt 和 key 文件的 bash64 编码，并且输出中不带换行</span></span><br><span class="line">cat tls.crt | bash64 -w 0</span><br><span class="line">cat tls.key | bash64 -w 0</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">s01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">XXXX</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">XXXX</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：secret-docker-仓库认证范例"><a href="#知识点：secret-docker-仓库认证范例" class="headerlink" title="知识点：secret docker 仓库认证范例"></a>知识点：secret docker 仓库认证范例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建 docker 仓库认证 secret</span></span><br><span class="line">kubectl -n test create secret docker-registry sss \</span><br><span class="line">  --docker-server DOCKER_REGISTRY_SERVER \</span><br><span class="line">  --docker-username DOCKER_USER \</span><br><span class="line">  --docker-password DOCKER_PASSWORD</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># pod 中使用仓库认证</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod01</span><br><span class="line">  namespace: test</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: container01</span><br><span class="line">    image: server/registry/repository:v1234</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: sss</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-9-K8S-安全"><a href="#3-9-K8S-安全" class="headerlink" title="3.9 K8S 安全"></a>3.9 K8S 安全</h2><hr>
<h3 id="知识点：访问控制-API-Access-Control"><a href="#知识点：访问控制-API-Access-Control" class="headerlink" title="知识点：访问控制 API Access Control"></a>知识点：访问控制 API Access Control</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* apiserver 是 K8S 集群各个组件通信的中介，也是外部控制的入口，所以 K8S 的安全机制基本就是围绕 apiserver 设计的</span><br><span class="line"></span><br><span class="line">* Access Control 本质，就是对客户端发出的请求进行身份认证、鉴权、准入操作</span><br><span class="line">  - apiserver 是访问及管理资源对象的唯一入口</span><br><span class="line">  - 任何一个请求访问 apiserver，都要经过下面三个流程</span><br><span class="line"></span><br><span class="line">* 身份认证 Authentication</span><br><span class="line">  - 确认请求者的身份</span><br><span class="line"></span><br><span class="line">* 鉴权 Authorization</span><br><span class="line">  - 判断用户是否有权限对访问的资源执行特定的动作</span><br><span class="line"></span><br><span class="line">* 准入控制 Admission Control</span><br><span class="line">  - 用于补充授权机制以实现更加精细的访问控制功能</span><br></pre></td></tr></table></figure></li>
<li><strong>Account 类型</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* User Account</span><br><span class="line">  - 一般用户</span><br><span class="line">  - 是独立于 kubernetes 之外的其他服务管理的用户账号</span><br><span class="line"></span><br><span class="line">* Service Account</span><br><span class="line">  - K8S 管理的账号</span><br><span class="line">  - 用于为 Pod 中的服务进程在访问 Kubernetes 时提供身份标识</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：身份认证-Authentication"><a href="#知识点：身份认证-Authentication" class="headerlink" title="知识点：身份认证 Authentication"></a>知识点：身份认证 Authentication</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">* K8S 提供了 3 种客户端身份认证方式</span><br><span class="line"></span><br><span class="line">* HTTP Base 认证</span><br><span class="line">  - 最简单</span><br><span class="line">  - 安全性最低</span><br><span class="line">  - 通过用户名+密码的方式认证</span><br><span class="line">    - 把 &quot;用户名:密码&quot; 用 BASE64 算法进行编码</span><br><span class="line">    - 编码后的字符串放在 HTTP 请求中的 Header Authorization 域里发送给服务端</span><br><span class="line"></span><br><span class="line">* HTTP Token 认证</span><br><span class="line">  - 通过 Token 来识别合法用户</span><br><span class="line">  - K8S 会为每个创建一个 Token</span><br><span class="line">  - Token 是一段很长的字符串</span><br><span class="line">  - 当客户端发起 API 调用请求时，将 Toker 放在 HTTP Header 中</span><br><span class="line">  - API Server 收到 Token 后，与服务器中保存的 token 进行比对，然后确认用户身份</span><br><span class="line"></span><br><span class="line">* HTTPS 证书认证</span><br><span class="line">  - 基于 CA 根证书签名的双向数字证书认证方式</span><br><span class="line">  - 安全性最高</span><br><span class="line">  - 操作最麻烦</span><br><span class="line"></span><br><span class="line">* K8S 允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* HTTPS 证书认证大体分为 3 个过程</span><br><span class="line"></span><br><span class="line">* 证书申请和下发</span><br><span class="line">  - 客户端和服务端都向 CA 申请证书</span><br><span class="line"></span><br><span class="line">* 客户端和服务端的双向认证</span><br><span class="line">  - 客户端向服务器端发起请求，建立 https 连接，并得到客户端的证书</span><br><span class="line">    - 服务端下发自己的证书给客户端</span><br><span class="line">    - 客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥</span><br><span class="line">    - 客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器</span><br><span class="line">  - 客户端发送自己的证书给服务器端</span><br><span class="line">    - 服务端接收到证书后，通过私钥解密证书，在证书中获得客户端的公钥</span><br><span class="line">    - 用该公钥认证证书信息，确认客户端是否合法</span><br><span class="line">  - 服务器端和客户端进行通信</span><br><span class="line">    - 服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端</span><br><span class="line">    - 服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="知识点：鉴权-Authorization"><a href="#知识点：鉴权-Authorization" class="headerlink" title="知识点：鉴权 Authorization"></a>知识点：鉴权 Authorization</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 认证成功后就开始间却</span><br><span class="line"></span><br><span class="line">* K8S 会根据事先定义的授权策略来决定用户是否有权限访问</span><br><span class="line"></span><br><span class="line">* 每个发送到 apiserver 的请求都带上了用户和资源的信息</span><br><span class="line">  - 发送请求的用户</span><br><span class="line">  - 请求的路径</span><br><span class="line">  - 请求的动作</span><br><span class="line"></span><br><span class="line">* 授权就是根据这些信息和授权策略进行比较</span><br><span class="line">  - 如果符合策略，则认为授权通过</span><br><span class="line">  - 否则会返回错误</span><br></pre></td></tr></table></figure></li>
<li><strong>授权策略</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* API Server目前支持以下几种授权策略</span><br><span class="line"></span><br><span class="line">* AlwaysDeny</span><br><span class="line">  - 表示拒绝所有请求</span><br><span class="line">  - 一般用于测试</span><br><span class="line"></span><br><span class="line">* AlwaysAllow</span><br><span class="line">  - 允许接收所有请求</span><br><span class="line">  - 相当于集群不需要授权流程</span><br><span class="line">  - Kubernetes 默认的策略</span><br><span class="line"></span><br><span class="line">* ABAC</span><br><span class="line">  - 基于属性的访问控制</span><br><span class="line">  - 表示使用用户配置的授权规则对用户请求进行匹配和控制</span><br><span class="line"></span><br><span class="line">* Webhook</span><br><span class="line">  - 通过调用外部 REST 服务对用户进行授权</span><br><span class="line"></span><br><span class="line">* Node</span><br><span class="line">  - 一种专用模式</span><br><span class="line">  - 用于对 kubelet 发出的请求进行访问控制</span><br><span class="line"></span><br><span class="line">* RBAC</span><br><span class="line">  - 基于角色的访问控制</span><br><span class="line">  - kubeadm 安装方式下的默认选项</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：RBAC-Role-Based-Access-Control"><a href="#知识点：RBAC-Role-Based-Access-Control" class="headerlink" title="知识点：RBAC Role Based Access Control"></a>知识点：RBAC Role Based Access Control</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* 基于角色的访问控制</span><br><span class="line"></span><br><span class="line">* 主要是在描述一件事情，给哪些对象授予了哪些权限</span><br><span class="line"></span><br><span class="line">* 对象</span><br><span class="line">  - User</span><br><span class="line">  - Groups</span><br><span class="line">  - ServiceAccount</span><br><span class="line"></span><br><span class="line">* 角色</span><br><span class="line">  代表着一组定义在资源上的可操作动作(权限)的集合</span><br><span class="line"></span><br><span class="line">* 绑定</span><br><span class="line">  将定义好的角色跟用户绑定在一起</span><br></pre></td></tr></table></figure></li>
<li><strong>资源对象</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* RBAC 引入了 4 个顶级资源对象</span><br><span class="line"></span><br><span class="line">* Role、ClusterRole</span><br><span class="line">  - 角色</span><br><span class="line">  - 用于指定一组权限</span><br><span class="line"></span><br><span class="line">* RoleBinding、ClusterRoleBinding</span><br><span class="line">  - 角色绑定</span><br><span class="line">  - 用于将角色（权限）赋予给对象</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：Role、ClusterRole"><a href="#知识点：Role、ClusterRole" class="headerlink" title="知识点：Role、ClusterRole"></a>知识点：Role、ClusterRole</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 一个角色就是一组权限的集合</span><br><span class="line"></span><br><span class="line">* 白名单</span><br><span class="line"></span><br><span class="line">* Role 只能对命名空间内的资源进行授权，需要指定 nameapce</span><br><span class="line"></span><br><span class="line">* ClusterRole 可以对集群范围内资源、跨 namespaces 的范围资源、非资源类型进行授权</span><br></pre></td></tr></table></figure></li>
<li><strong>Role 资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">rules:</span> <span class="string">&lt;[]Object&gt;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">&lt;[]string&gt;</span>                  <span class="comment"># 支持的API组列表,&quot;&quot; 空字符串，表示核心API群</span></span><br><span class="line">  <span class="attr">nonResourceURLs:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">&lt;[]string&gt;</span>               <span class="comment"># 支持的资源对象列表</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">&lt;[]string&gt;</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">&lt;[]string&gt;</span> <span class="string">-required-</span>      <span class="comment"># 允许的对资源对象的操作方法列表</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 需要详细说明的是，rules中的参数：</span><br><span class="line"></span><br><span class="line">- apiGroups: 支持的API组列表</span><br><span class="line"></span><br><span class="line">  &quot;&quot;,&quot;apps&quot;, &quot;autoscaling&quot;, &quot;batch&quot;</span><br><span class="line"></span><br><span class="line">- resources：支持的资源对象列表</span><br><span class="line"></span><br><span class="line">  &quot;services&quot;, &quot;endpoints&quot;, &quot;pods&quot;,&quot;secrets&quot;,&quot;configmaps&quot;,&quot;crontabs&quot;,&quot;deployments&quot;,&quot;jobs&quot;,</span><br><span class="line">  &quot;nodes&quot;,&quot;rolebindings&quot;,&quot;clusterroles&quot;,&quot;daemonsets&quot;,&quot;replicasets&quot;,&quot;statefulsets&quot;,</span><br><span class="line">  &quot;horizontalpodautoscalers&quot;,&quot;replicationcontrollers&quot;,&quot;cronjobs&quot;</span><br><span class="line"></span><br><span class="line">- verbs：对资源对象的操作方法列表</span><br><span class="line"></span><br><span class="line">  &quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;, &quot;exec&quot;</span><br></pre></td></tr></table></figure></li>
<li><strong>ClusterRoleRole 资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="attr">aggregationRule:</span> <span class="string">&lt;Object&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：RoleBinding、ClusterRoleBinding"><a href="#知识点：RoleBinding、ClusterRoleBinding" class="headerlink" title="知识点：RoleBinding、ClusterRoleBinding"></a>知识点：RoleBinding、ClusterRoleBinding</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount</span><br><span class="line"></span><br><span class="line">* RoleBinding 可以将同一 namespace 中的 subject 绑定到某个 Role 下，则此 subject 即具有该 Role 定义的权限</span><br><span class="line"></span><br><span class="line">* ClusterRoleBinding 在整个集群级别和所有namespaces将特定的subject与ClusterRole绑定，授予权限</span><br></pre></td></tr></table></figure></li>
<li><strong>RoleBinding 资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">authorization-role-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">heima</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">authorization-role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure></li>
<li><strong>ClusterRoleBinding 资源清单</strong><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">authorization-clusterrole-binding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">heima</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">authorization-clusterrole</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Chapter04-kubectl"><a href="#Chapter04-kubectl" class="headerlink" title="Chapter04 kubectl"></a>Chapter04 kubectl</h1><hr>
<h2 id="4-1-kubelet-介绍"><a href="#4-1-kubelet-介绍" class="headerlink" title="4.1 kubelet 介绍"></a>4.1 kubelet 介绍</h2><hr>
<h3 id="知识点：kubectl-介绍"><a href="#知识点：kubectl-介绍" class="headerlink" title="知识点：kubectl 介绍"></a>知识点：kubectl 介绍</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* kubectl 是 K8S 提供的，对 K8S 集群进行管理的命令行工具</span><br><span class="line"></span><br><span class="line">* 使用 Kubernetes API 来与 Kubernetes 集群的控制面(control plane)进行通信</span><br><span class="line"></span><br><span class="line">* 配置文件</span><br><span class="line">  - $HOME/.kube/config</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl COMMAND TYPE NAME [flags]</span><br><span class="line">  kubectl COMMAND -f FILENAME [flags]</span><br><span class="line"></span><br><span class="line">* TYPE/NAME 方式</span><br><span class="line">  kubectl COMMAND TYPE/NAME [TYPE/NAME ...] [flags]</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 支持一次对多个资源对象操作，并且资源对象可以属于不同的 TYPE</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 不支持补全</span></span><br><span class="line"></span><br><span class="line">* 推荐方式</span><br><span class="line">  kubectl -n NAMESPACE COMMAND ...</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 在设置了补全后，支持对资源对象名进行补全</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">* COMMAND</span><br><span class="line">  - 指定要对资源执行的操作</span><br><span class="line"></span><br><span class="line">* TYPE</span><br><span class="line">  - 指定资源类型</span><br><span class="line">  - 不区分大小写</span><br><span class="line">  - 不区分单数、复数</span><br><span class="line">  - 不区分全写、缩写</span><br><span class="line">  - 可以采用 TYPE[.VERSION][.GROUP] 的格式</span><br><span class="line"></span><br><span class="line">* NAME</span><br><span class="line">  - 指定资源对象的名称</span><br><span class="line">  - 名称区分大小写</span><br><span class="line">  - 省略 NAME 表示对所有资源执行操作</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-指令-flags"><a href="#知识点：kubectl-指令-flags" class="headerlink" title="知识点：kubectl 指令 flags"></a>知识点：kubectl 指令 flags</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 指令选项</span><br><span class="line"></span><br><span class="line">* 不同的 kubectl command 支持的 flag 不同</span><br><span class="line"></span><br><span class="line">* 理论上，flag 放在 kubectl 指令的任何地方皆可，推荐放在最后</span><br></pre></td></tr></table></figure></li>
<li><strong>flag 格式</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-F VALUE</span><br><span class="line">--FLAG VALUE、--FLAG=VALUE</span><br><span class="line">--FLAG、--FLAT=ture          # 布尔型 flag</span><br><span class="line">--FLAG=false                 # 布尔型 flag</span><br></pre></td></tr></table></figure></li>
<li><strong>常用 flag</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-h, --help</span><br><span class="line">-f, --filename FILENAME     # 指定资源清单文件</span><br><span class="line">-n, --namespace NAMESPACE   # 指定命名空间，默认 default 命名空间</span><br><span class="line">-v, --v LEVEL               # 指定输出日志的级别</span><br><span class="line">--dry-run                   # Must be &quot;none&quot;, &quot;server&quot;, or &quot;client&quot;.</span><br><span class="line">                            # If client strategy, only print the object that would be sent, without sending it.</span><br><span class="line">                            # If server strategy, submit server-side request without persisting the resource.</span><br><span class="line">--                          # 对于有追加 COMMAND 的 kubectl 指令，用于分隔 kubectl flag 和 COMMAND args</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-l, --selector              # label query</span><br><span class="line"><span class="meta">#</span><span class="bash"> -l a=01</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l a=01,b=02              <span class="comment"># AND 逻辑，-l 无法表示 OR 逻辑</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l a!=01</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l <span class="string">&#x27;a in (01, 02)&#x27;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -l <span class="string">&#x27;a notin (01, 02)&#x27;</span>     <span class="comment"># 标签 a 的值不为 01 或 02 的对象，以及没有标签 a 的对象</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-o, --output FORMAT         # 指定输出格式</span><br><span class="line"><span class="meta">#</span><span class="bash"> -o name                       <span class="comment"># 仅输出资源名</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o wide                       <span class="comment"># 宽格式</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o yaml                       <span class="comment"># 以 yaml 格式输出</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o json                       <span class="comment"># 以 json 格式输出</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o custom-columns=&lt;spec&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o custom-columns-file=&lt;filename&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o jsonpath=&lt;template&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -o jsonpath-file=&lt;filename&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--sory-by                   # 输出结果排序</span><br><span class="line"><span class="meta">#</span><span class="bash"> --sort-by name                <span class="comment"># 安装资源对象的名称排序</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --sort-by kind                <span class="comment"># 安装资源对象的名称排序</span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-help-指令"><a href="#知识点：kubectl-help-指令" class="headerlink" title="知识点：kubectl help 指令"></a>知识点：kubectl help 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* kubectl help</span><br><span class="line"></span><br><span class="line">* kubectl --help</span><br><span class="line"></span><br><span class="line">* kubectl help COMMADN</span><br><span class="line"></span><br><span class="line">* kubectl COMMADN --help</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="4-2-SETTINGS-AND-USAGE-指令"><a href="#4-2-SETTINGS-AND-USAGE-指令" class="headerlink" title="4.2 SETTINGS AND USAGE 指令"></a>4.2 SETTINGS AND USAGE 指令</h2><hr>
<h3 id="知识点：kubectl-version-指令"><a href="#知识点：kubectl-version-指令" class="headerlink" title="知识点：kubectl version 指令"></a>知识点：kubectl version 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 输出当前 client 和 server 的版本信息</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl version</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -o, --output yaml|json</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-api-resources-指令"><a href="#知识点：kubectl-api-resources-指令" class="headerlink" title="知识点：kubectl api-resources 指令"></a>知识点：kubectl api-resources 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 列出当前 server 支持的 API 资源类</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl api-resources</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  --namespaced</span><br><span class="line">  --namespaced=false</span><br><span class="line">  --api-group APIGROUP    # 仅打印 APIGROUP 中的资源类型</span><br><span class="line">  --verbs VERB            # 查看支持 VERB 命令的资源类型</span><br><span class="line">  --cached</span><br><span class="line">  --no-headers</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resources</span><br><span class="line">kubectl api-resources -o wide</span><br><span class="line">kubectl api-resources --sort-by=name</span><br><span class="line">kubectl api-resources --namespaced            # 仅打印属于命名空间的资源类型</span><br><span class="line">kubectl api-resources --namespaced=false      # 仅打印不属于命名空间的资源类型</span><br><span class="line">kubectl api-resources --api-group=extensions</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-explain-指令"><a href="#知识点：kubectl-explain-指令" class="headerlink" title="知识点：kubectl explain 指令"></a>知识点：kubectl explain 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 查看指定资源类的属性介绍，包括类型、描述等</span><br><span class="line"></span><br><span class="line">* Type.FieldName[.FieldName]</span><br><span class="line">  - JSONPath 格式</span><br><span class="line">  - Type 不区分大小写，不区分单数复数</span><br><span class="line">  - FieldName 区分大小写，区分单数复数</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl explain RESOURCE</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  --recursive     # 递归列出子层的 field，输出格式为 OpenAPI 格式，即仅输出省略描述信息</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl explain pods</span><br><span class="line">kubectl explain pods.spec.containers</span><br><span class="line">kubectl explain pods.spec.containers.volumeMounts --recursive</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-options-指令"><a href="#知识点：kubectl-options-指令" class="headerlink" title="知识点：kubectl options 指令"></a>知识点：kubectl options 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 列出被所有命令接受的 flag，即通用选项</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl options</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-completion-指令"><a href="#知识点：kubectl-completion-指令" class="headerlink" title="知识点：kubectl completion 指令"></a>知识点：kubectl completion 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 针对指定的 SHELL 程序，生成补全功能源码</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl completion SHELL</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bash-completion ; echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 bash 支持 kubectl 补全</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="4-3-GETTING-STARTED-指令"><a href="#4-3-GETTING-STARTED-指令" class="headerlink" title="4.3 GETTING STARTED 指令"></a>4.3 GETTING STARTED 指令</h2><hr>
<h3 id="知识点：kubectl-get-指令"><a href="#知识点：kubectl-get-指令" class="headerlink" title="知识点：kubectl get 指令"></a>知识点：kubectl get 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 查看指定的资源对象的信息</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl get TYPE</span><br><span class="line">  kubectl get TYPE NAME</span><br><span class="line">  kubectl get TYPE/NAME [ ...]</span><br><span class="line">  kubectl get TYPE -l label</span><br><span class="line">  kubectl get -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  -f, --filename FILENAME</span><br><span class="line">  -A, --all-namespaces        # 查看所有的命名空间</span><br><span class="line">  --show-kind                 # 显示资源对象的类型</span><br><span class="line">  --show-labels               # 显示资源对象的 label</span><br><span class="line">  -L, --label-columns LABELS  # 显示资源对象指定的 lable 的值，以列的方式，&#x27;LABELS&#x27; 可以是逗号分隔的列表，也可以是多个 -L 选项</span><br><span class="line"></span><br><span class="line">  -w, --watch                 # 以 watch 的方式查看</span><br><span class="line">  --watch-only                # 以 watch 的方式查看，仅打印变化</span><br><span class="line"></span><br><span class="line">  -o, --output wide</span><br><span class="line">  -o, --output yaml           # 打印资源对象的全部配置，以 yaml 格式</span><br><span class="line">  -o, --output json           # 打印资源对象的全部配置，以 json 格式</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test get pod</span><br><span class="line">kubectl -n test get pod web01</span><br><span class="line">kubectl -n test get pod web01 -o wide</span><br><span class="line"></span><br><span class="line">kubectl -n test get pod,service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 <span class="built_in">test</span> 命名空间下所有的 pod 和 service</span></span><br><span class="line"></span><br><span class="line">kubectl -n test get pods/web01 service/frontend</span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时查看一个 pod 对象和一个 service 对象</span></span><br><span class="line"></span><br><span class="line">kubectl -n test get pod -L version,environment</span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示所有 pod 的 version 和 environment 两个标签的值</span></span><br><span class="line"></span><br><span class="line">kubectl get -f pod.yaml -o yaml</span><br><span class="line"></span><br><span class="line">kubectl -n test get pod -l env=production</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-run-指令"><a href="#知识点：kubectl-run-指令" class="headerlink" title="知识点：kubectl run 指令"></a>知识点：kubectl run 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 创建一个 deployment</span><br><span class="line">* K8S 建议使用资源清单文件</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl run NAME --image IMAGE [--command] [--] [COMMAND] [args...]</span><br><span class="line">  kubectl run -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  --image IMAGE</span><br><span class="line">  -i, --stdic</span><br><span class="line">  -t, --tty</span><br><span class="line">  -r, --replicas NUMBER   # 指定 pod 副本数</span><br><span class="line">  -l, --labels LABEL      # 为 pod 指定标签</span><br><span class="line">  --env=&quot;key=value&quot;       # 为 pod 指定环境变量，一个 --env 选项只能指定一个环境变量</span><br><span class="line">  --expose                # 为 pod 创建一个 ClusterIP service，此时必须指定 --port</span><br><span class="line">  --port PORT             # 指定 pod 需要暴露的端口</span><br><span class="line">  --restart               # Always、OnFailure、Never，默认 Always</span><br><span class="line">  --command               # true，表示 extra arguments 用来覆盖 Dockerfile 的 ENTRYPOINT</span><br><span class="line">                          # false，默认，表示 extra arguments 用来覆盖 Dockerfile 的 CMD 配置</span><br><span class="line">                          # If true and extra arguments are present, use them as the &#x27;command&#x27; field in the container, rather than the &#x27;args&#x27; field which is the default.</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl run web01 --image=nginx --port=80 -l tier=backend</span><br><span class="line"></span><br><span class="line">kubectl run web01 --image=nginx --env=&quot;a=01&quot; --env=&quot;b=02&quot;</span><br><span class="line"></span><br><span class="line">kubectl run web01 --image=nginx -- &lt;arg1&gt; &lt;arg2&gt; ... &lt;argN&gt;</span><br><span class="line"></span><br><span class="line">kubectl run web01 --image=nginx --command -- &lt;cmd&gt; &lt;arg1&gt; ... &lt;argN&gt;</span><br><span class="line"></span><br><span class="line">kubectl run -it busybox --image=busybox --restart=Never</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl run web --image=nginx --dry-run=client</span><br><span class="line">kubectl run web --image=nginx --overrides=&#x27;&#123; &quot;apiVersion&quot;: &quot;v1&quot;, &quot;spec&quot;: &#123; ... &#125; &#125;&#x27;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-expose-指令"><a href="#知识点：kubectl-expose-指令" class="headerlink" title="知识点：kubectl expose 指令"></a>知识点：kubectl expose 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 将某个资源对象暴露给 service</span><br><span class="line">  - 新建一个 service，并将资源对象的端口与 service 的端口绑定</span><br><span class="line">  - 适用的资源包括 pod、service、replicationcontroller、deployment、replicaset</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl expose TYPE NAME [--port=port] [--protocol=TCP|UDP|SCTP] [--target-port=number-or-name]</span><br><span class="line">  kubectl expose -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  --port=PORT                 # 必须，资源对象要绑定的端口</span><br><span class="line">  --target-port=PORT/NAME     # 必须，新建 service 的端口</span><br><span class="line">  --name NAME                 # 新建 service 的名字</span><br><span class="line">  --type TYPE                 # 新建 service 的类型，ClusterIP、NodePort、LoadBalancer、ExternalName，默认 ClusterIP</span><br><span class="line">  -l, --labels LABEL          # 新建 service 添加标签</span><br><span class="line">  --protocol PROCOCOL</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test expose deploy nginx01 --name=svc-nginx01 --port=80 --target-port=3333 --type=ClusterIP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 nginx01 的 80 端口绑定给 service 的 3333 端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新 service 的名字为 svc-nginx01</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-delete-指令"><a href="#知识点：kubectl-delete-指令" class="headerlink" title="知识点：kubectl delete 指令"></a>知识点：kubectl delete 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 删除资源对象</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl delete TYPE NAME</span><br><span class="line">  kubectl delete TYPE -l LABEL</span><br><span class="line">  kubectl delete TYPE --all</span><br><span class="line">  kubectl delete -f FILENAME</span><br><span class="line">  kubectl delete -k DIRECTORY</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  --all                       # 不推荐</span><br><span class="line">  --cascade=false             # 不推荐，对于如 pod 控制器等，仅删除控制器对象，不删除 pod 对象</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test delete pod nginx01</span><br><span class="line"></span><br><span class="line">kubectl delete -f pod.json</span><br><span class="line"></span><br><span class="line">kubectl -n test delete pods -l name=myLabel</span><br><span class="line"></span><br><span class="line">kubectl delete -f &#x27;*.json&#x27;</span><br><span class="line">kubectl delete -k dir</span><br><span class="line">cat pod.yaml | kubectl delete -f -</span><br></pre></td></tr></table></figure></li>
<li>**其他范例<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod,service baz foo</span><br><span class="line">kubectl delete pod foo --now</span><br><span class="line">kubectl delete pod foo --force</span><br><span class="line">kubectl delete pods --all</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-指令"><a href="#知识点：kubectl-create-指令" class="headerlink" title="知识点：kubectl create 指令"></a>知识点：kubectl create 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 根据资源清单创建资源</span><br><span class="line"></span><br><span class="line">* 资源清单可以是文件，也可以是 stdin</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl create -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  --edit         # Edit the API resource before creating</span><br><span class="line">  --record       # 记录资源对象每次更新时的命令，可以在 rollout history 的 CHANGE-CAUSE 字段中显示出来</span><br><span class="line">                 # Record current kubectl command in the resource annotation.</span><br><span class="line">                 # If set to false, do not record the command.</span><br><span class="line">                 # If set to true, record the command.</span><br><span class="line">                 # If not set, default to updating the existing annotation value only if one already exists.</span><br><span class="line">  --save-config  # If true, the configuration of current object will be saved in its annotation.</span><br><span class="line">                 # Otherwise, the annotation will be unchanged.</span><br><span class="line">                 # This flag is useful when you want to perform kubectl apply on this object in the future.</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f 1.yaml</span><br><span class="line"></span><br><span class="line">kubectl create -f 1.yaml --record --save-config</span><br><span class="line"><span class="meta">#</span><span class="bash"> --save-config 可以让对象在之后的运行过程中允许使用 kubectl patch 进行更新</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --record 可以当对象在 kubectl rollout <span class="built_in">history</span> 中显示创建指令</span></span><br></pre></td></tr></table></figure></li>
<li><strong>其他范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat pod.json | kubectl create -f -</span><br><span class="line"></span><br><span class="line">kubectl create -f registry.yaml --edit -o json</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-namespace-指令"><a href="#知识点：kubectl-create-namespace-指令" class="headerlink" title="知识点：kubectl create namespace 指令"></a>知识点：kubectl create namespace 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 创建命名空间</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl create namespace NAME</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-deployment-指令"><a href="#知识点：kubectl-create-deployment-指令" class="headerlink" title="知识点：kubectl create deployment 指令"></a>知识点：kubectl create deployment 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 创建 deployment</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl create deployment NAME --image=IMAGE -- [COMMAND] [args...]</span><br><span class="line">  kubectl create deployment -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  -r --replicas NUMBER      # 指定 pod 副本数</span><br><span class="line">  --port PORT               # 指定容器暴露的端口</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test create deployment nginx01 --image=nginx</span><br><span class="line"></span><br><span class="line">kubectl -n test create deployment nginx01 --image=nginx --replicas=3 --port=80</span><br><span class="line"></span><br><span class="line">kubectl -n test create deployment busybox --image=busybox -- date</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-configmap-指令"><a href="#知识点：kubectl-create-configmap-指令" class="headerlink" title="知识点：kubectl create configmap 指令"></a>知识点：kubectl create configmap 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 创建 configmap</span><br><span class="line"></span><br><span class="line">* 有四种种使用方式</span><br><span class="line">  - 基于目录</span><br><span class="line">    - K 是文件的 basename</span><br><span class="line">    - 只会收录一级普通文件</span><br><span class="line">    - 其他文件，如软链接、子目录等，不会收录</span><br><span class="line">  - 基于文件</span><br><span class="line">  - 基于字面值</span><br><span class="line">  - 基于环境文件</span><br><span class="line">    - 环境文件的内容是一系列 K-V</span><br><span class="line">    - 环境文件中的 K-V 会成为 configmap 中的 K-V</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl create configmap NAME [--from-file=[key=]source] [--from-literal=key1=value1]</span><br><span class="line"></span><br><span class="line">* flags</span><br><span class="line">  --from-file         # 基于文件创建，或基于目录创建</span><br><span class="line">  --from-file=[key=]  # 基于文件创建，同时在 configmap 中对文件改名</span><br><span class="line">  --from-literal      # 基于字面值创建</span><br><span class="line">  --from-env-file	    # 基于环境文件创建，当指定多个 --from-env-file 选项时，只有最后一个 --from-env-file 选项会生效</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubectl create configmap NAME --from-file=DIR</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从目录中创建 configmap</span></span><br><span class="line"></span><br><span class="line">kubectl create configmap NAME --from-file=FILE1 --from-file=FILE2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于文件创建 configmap</span></span><br><span class="line"></span><br><span class="line">kubectl create configmap NAME --from-file=key1=FILE1 --from-file=KEY2=FILE2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于文件创建 configmap，同时指定文件的 KEY</span></span><br><span class="line"></span><br><span class="line">kubectl create configmap NAME --from-literal=KEY1=CONFIG1 --from-literal=KEY2=CONFIG2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于字面值创建 configmap</span></span><br><span class="line"></span><br><span class="line">cat x.env</span><br><span class="line">  name=computer</span><br><span class="line">  date=2</span><br><span class="line">kubectl create configmap NAME --from-env-file=x.env</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于环境变量创建</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-secret-指令"><a href="#知识点：kubectl-create-secret-指令" class="headerlink" title="知识点：kubectl create secret 指令"></a>知识点：kubectl create secret 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 一系列创建 secret 的 subcommand</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-secret-generic-指令"><a href="#知识点：kubectl-create-secret-generic-指令" class="headerlink" title="知识点：kubectl create secret generic 指令"></a>知识点：kubectl create secret generic 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 最常用的创建 secret 的指令</span><br><span class="line"></span><br><span class="line">* 会自动对 string 进行 base64 的转换</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl create generic NAME [--type=string] [--from-file=[key=]source] [--from-literal=key1=value1] [--dry-run=server|client|none]</span><br><span class="line"></span><br><span class="line">* flags</span><br><span class="line">  --type              # 指定 secret 的类型，默认 Opaque</span><br><span class="line">  --from-file         # 基于文件创建，或基于目录创建</span><br><span class="line">  --from-file=[key=]  # 基于文件创建，同时在 secret 中对文件改名</span><br><span class="line">  --from-literal      # 基于字面值创建</span><br><span class="line">  --from-env-file	    # 基于环境文件创建，当指定多个 --from-env-file 选项时，只有最后一个 --from-env-file 选项会生效</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test create secret generic s01 --from-file DIR</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于目录创建 secret</span></span><br><span class="line"></span><br><span class="line">kubectl -n test create secret generic s01 --from-file ./</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于当前目录创建 secret</span></span><br><span class="line"></span><br><span class="line">kubectl -n test create secret generic s01 --from-file=FILE01 --from-file=FILE02</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于文件创建 secret</span></span><br><span class="line"></span><br><span class="line">kubectl -n test create secret generic s01 --from-literal=name=apple --from-literal=password=123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 基于文本值创建 secret</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-secret-tls-指令"><a href="#知识点：kubectl-create-secret-tls-指令" class="headerlink" title="知识点：kubectl create secret tls 指令"></a>知识点：kubectl create secret tls 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 创建 kubernetes.io/tls 类型的 secret，用来保存 tls 证书</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl create tls NAME --cert=FILE --key=FILE</span><br><span class="line"></span><br><span class="line">* flags</span><br><span class="line">  --cert    # 指定 tls.crt 文件</span><br><span class="line">  --key     # 指定 tls.key 文件</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test create tls secret-cert --cert=tls.crt --key=tls.key</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-create-secret-docker-registry-指令"><a href="#知识点：kubectl-create-secret-docker-registry-指令" class="headerlink" title="知识点：kubectl create secret docker-registry 指令"></a>知识点：kubectl create secret docker-registry 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 创建 kubernetes.io/dockerconfigjson 类型的 secret，用来保存 docker 仓库的认证</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl create docker-registry NAME --docker-server=SERVER --docker-username=USER --docker-password=PASSWORD [--docker-email=EMAIL]</span><br><span class="line">  kubectl create docker-registry NAME --from-file=.dockerconfigjson=DockerConfigJsonFile</span><br><span class="line"></span><br><span class="line">* flags</span><br><span class="line">  --docker-server</span><br><span class="line">  --docker-username</span><br><span class="line">  --docker-password</span><br><span class="line">  --docker-email</span><br><span class="line">  --from-file=.dockerconfigjson=DockerConfigJsonFile    # 直接使用现有的 docker config json 文件来创建 secret</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test create secret docker-registry my-secret \</span><br><span class="line">  --docker-server DOCKER_REGISTRY_SERVER \</span><br><span class="line">  --docker-username DOCKER_USER \</span><br><span class="line">  --docker-password DOCKER_PASSWORD</span><br><span class="line"></span><br><span class="line">kubectl -n test create secret docker-registry my-secret \</span><br><span class="line">  --from-file=.dockerconfigjson=path/to/.docker/config.json</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="4-4-APP-MANAGEMENT-指令"><a href="#4-4-APP-MANAGEMENT-指令" class="headerlink" title="4.4 APP MANAGEMENT 指令"></a>4.4 APP MANAGEMENT 指令</h2><hr>
<h3 id="知识点：kubectl-apply-指令"><a href="#知识点：kubectl-apply-指令" class="headerlink" title="知识点：kubectl apply 指令"></a>知识点：kubectl apply 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 使资源清单定义的资源对象生效，相当于 kubectl create + kubectl patch</span><br><span class="line">  - 如果资源对象不存在，则创建</span><br><span class="line">  - 如果资源对象已存在，则更新</span><br><span class="line"></span><br><span class="line">* 支持目录操作</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl apply -f FILENAME</span><br><span class="line">  kubectl apply -k DIRECTORY</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -- record</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pod.yaml</span><br></pre></td></tr></table></figure></li>
<li><strong>其他范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">kubectl apply -f &#x27;*.yaml&#x27;</span><br><span class="line"></span><br><span class="line">kubectl apply -k dir/</span><br><span class="line"></span><br><span class="line">cat pod-web01.yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-edit-指令"><a href="#知识点：kubectl-edit-指令" class="headerlink" title="知识点：kubectl edit 指令"></a>知识点：kubectl edit 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 编辑资源对象的资源清单，并立刻生效</span><br><span class="line">* 场景</span><br><span class="line">  - pod 控制器调整副本数量</span><br><span class="line">  - pod 控制器调整镜像版本</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl edit TYPE NAME</span><br><span class="line">  kubectl edit TYPE/NAME</span><br><span class="line">  kubectl edit -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test edit deployment nginx01</span><br><span class="line"></span><br><span class="line">kubectl -n test edit deployment/nginx01</span><br><span class="line"></span><br><span class="line">kubectl edit -f deployment.nginx.yml</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-label-指令"><a href="#知识点：kubectl-label-指令" class="headerlink" title="知识点：kubectl label 指令"></a>知识点：kubectl label 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 为资源对象添加/移除/更新标签</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl label TYPE NAME KEY=VALUE [KEY=VALUE ...]</span><br><span class="line">  kubectl label -f FILENAME KEY=VALUE [KEY=VALUE ...]</span><br><span class="line"></span><br><span class="line">* KEY=VALYE</span><br><span class="line">  - 添加标签</span><br><span class="line">  - 更新标签</span><br><span class="line"></span><br><span class="line">* KEY-</span><br><span class="line">  - 移除标签</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  --overwrite               # 更新标签</span><br><span class="line">  --all                     # 命名空间下所有 TYPE 型的资源对象都更新标签</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test label pods nginx01 foo=bar</span><br><span class="line"></span><br><span class="line">kubectl -n test label pods nginx01 foo=bar --overwrite</span><br><span class="line"></span><br><span class="line">kubectl -n test label pods foo=bar --all</span><br><span class="line"></span><br><span class="line">kubectl label -f nginx01.yml foo=bar</span><br><span class="line"></span><br><span class="line">kubectl -n test label pods nginx01 foo-</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-patch-指令"><a href="#知识点：kubectl-patch-指令" class="headerlink" title="知识点：kubectl patch 指令"></a>知识点：kubectl patch 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 更新资源</span><br><span class="line"></span><br><span class="line">* 适用于 kubectl apply 创建的对象，或 kubectl create --save-config 创建的对象</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -f 1.yaml</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-rollout-指令"><a href="#知识点：kubectl-rollout-指令" class="headerlink" title="知识点：kubectl rollout 指令"></a>知识点：kubectl rollout 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 和资源发布相关的一系列指令</span><br><span class="line">  - 暂停</span><br><span class="line">  - 恢复</span><br><span class="line">  - 重新开始</span><br><span class="line"></span><br><span class="line">* 资源发布</span><br><span class="line">  - 版本升级</span><br><span class="line">  - 版本回退</span><br><span class="line"></span><br><span class="line">* 支持的资源类型</span><br><span class="line">  - deployments</span><br><span class="line">  - daemonsets</span><br><span class="line">  - *statefulsets</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-rollout-history-指令"><a href="#知识点：kubectl-rollout-history-指令" class="headerlink" title="知识点：kubectl rollout history 指令"></a>知识点：kubectl rollout history 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 查看资源对象的发布版本的历史记录</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl rollout history TYPE NAME</span><br><span class="line">  kubectl rollout history TYPE/NAME</span><br><span class="line">  kubectl rollout history -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -o, --output yaml   # 只能显示当前版本，不管是不是指定了版本号</span><br><span class="line">  --revision          # 查看指定版本号的版本的信息（此选项有问题）</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test rollout history deploy nginx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 deploy 的发布版本历史记录</span></span><br><span class="line"></span><br><span class="line">kubectl -n test rollout history deploy nginx --revision=3</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-rollout-pause-指令"><a href="#知识点：kubectl-rollout-pause-指令" class="headerlink" title="知识点：kubectl rollout pause 指令"></a>知识点：kubectl rollout pause 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 暂停资源对象的发布行为</span><br><span class="line">* 手速要快</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl rollout pause TYPE NAME</span><br><span class="line">  kubectl rollout pause TYPE/NAME</span><br><span class="line">  kubectl rollout pause -f FILENAME</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test rollout pause deployment nginx</span><br><span class="line"></span><br><span class="line">kubectl -n test set image deployment nginx01 nginx=nginx:1.17.2 &amp;&amp; kubectl -n test rollout pause deployment nginx01</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-rollout-restart-指令"><a href="#知识点：kubectl-rollout-restart-指令" class="headerlink" title="知识点：kubectl rollout restart 指令"></a>知识点：kubectl rollout restart 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 对资源对象重新执行一次上一次的发布行为</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl rollout restart TYPE NAME</span><br><span class="line">  kubectl rollout restart TYPE/NAME</span><br><span class="line">  kubectl rollout restart -f FILENAME</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test rollout restart deployment nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-rollout-resume-指令"><a href="#知识点：kubectl-rollout-resume-指令" class="headerlink" title="知识点：kubectl rollout resume 指令"></a>知识点：kubectl rollout resume 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 恢复资源对象的发布行为</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl rollout resume TYPE NAME</span><br><span class="line">  kubectl rollout resume TYPE/NAME</span><br><span class="line">  kubectl rollout resume -f FILENAME</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test rollout resume deployment nginx</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-rollout-status-指令"><a href="#知识点：kubectl-rollout-status-指令" class="headerlink" title="知识点：kubectl rollout status 指令"></a>知识点：kubectl rollout status 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* 查看资源对象发布的情况</span><br><span class="line">* 结果</span><br><span class="line">  - 已经成功发布 successfully rolled out，命令执行结束并退出</span><br><span class="line">  - 正在发布中，则持续 watch</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl rollout status TYPE NAME</span><br><span class="line">  kubectl rollout status TYPE/NAME</span><br><span class="line">  kubectl rollout status -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -w, --watch   # 默认 true</span><br><span class="line">  --timeout N   # The length of time to wait before ending watch, zero means never.</span><br><span class="line">                # Any other values should contain a corresponding time unit (e.g. 1s, 2m, 3h).</span><br><span class="line">  --revision    # Pin to a specific revision for showing its status. Defaults to 0 (last revision).（不懂，实验不出来）</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test rollout status deployment nginx01</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-rollout-undo-指令"><a href="#知识点：kubectl-rollout-undo-指令" class="headerlink" title="知识点：kubectl rollout undo 指令"></a>知识点：kubectl rollout undo 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 对资源对象进行版本回退</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl rollout undo TYPE NAME --to-revision NUMBER</span><br><span class="line">  kubectl rollout undo TYPE/NAME --to-revision NUMBER</span><br><span class="line">  kubectl rollout undo -f FILENAME --to-revision NUMBER</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  --to-revision NUMBER    # 指定要回退到的版本，版本号参考 rollout history 中的记录，默认 0 表示上一个版本</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test rollout undo deployment nginx --to-revision=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 deployment 回退到版本号为 <span class="string">&#x27;3&#x27;</span> 的那个版本上</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-scale-指令"><a href="#知识点：kubectl-scale-指令" class="headerlink" title="知识点：kubectl scale 指令"></a>知识点：kubectl scale 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 扩容或缩容 pod 控制器下的 pod 副本数量</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl scale --replicas=COUNT TYPE NAME</span><br><span class="line">  kubectl scale --replicas=COUNT TYPE/NAME</span><br><span class="line">  kubectl scale --replicas=COUNT -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  --replicas        # 指定调整后 pod 的数量</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test scale rs nginx01 --replicas 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 rs nginx01 下的 pod 副本数量调整为 3 个</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-autoscale-指令"><a href="#知识点：kubectl-autoscale-指令" class="headerlink" title="知识点：kubectl autoscale 指令"></a>知识点：kubectl autoscale 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 自动调整 pod 数量</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-set-指令"><a href="#知识点：kubectl-set-指令" class="headerlink" title="知识点：kubectl set 指令"></a>知识点：kubectl set 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 变更资源对象的某个属性</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-set-env-指令"><a href="#知识点：kubectl-set-env-指令" class="headerlink" title="知识点：kubectl set env 指令"></a>知识点：kubectl set env 指令</h3><hr>
<h3 id="知识点：kubectl-set-image-指令"><a href="#知识点：kubectl-set-image-指令" class="headerlink" title="知识点：kubectl set image 指令"></a>知识点：kubectl set image 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 变更 pod 或 pod 控制器的中容器的镜像</span><br><span class="line">* 支持的资源类型</span><br><span class="line">  - pod</span><br><span class="line">  - replicationcontroller</span><br><span class="line">  - deployment</span><br><span class="line">  - daemonset</span><br><span class="line">  - statefulset</span><br><span class="line">  - cronjob</span><br><span class="line">  - replicaset</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl set image TYPE NAME CONTAINER_NAME=CONTAINER_IMAGE [ ...]</span><br><span class="line">  kubectl set image -f FILENAME CONTAINER_NAME=CONTAINER_IMAGE [ ...]</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test set image deployment nginx web01=nginx:1.17.1 web02=nginx:1.17.2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 变更 pod 中两个容器的镜像版本</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-set-resources-指令"><a href="#知识点：kubectl-set-resources-指令" class="headerlink" title="知识点：kubectl set resources 指令"></a>知识点：kubectl set resources 指令</h3><hr>
<h3 id="知识点：kubectl-set-selector-指令"><a href="#知识点：kubectl-set-selector-指令" class="headerlink" title="知识点：kubectl set selector 指令"></a>知识点：kubectl set selector 指令</h3><hr>
<h3 id="知识点：kubectl-set-serviceaccount-指令"><a href="#知识点：kubectl-set-serviceaccount-指令" class="headerlink" title="知识点：kubectl set serviceaccount 指令"></a>知识点：kubectl set serviceaccount 指令</h3><hr>
<h3 id="知识点：kubectl-set-subject-指令"><a href="#知识点：kubectl-set-subject-指令" class="headerlink" title="知识点：kubectl set subject 指令"></a>知识点：kubectl set subject 指令</h3><hr>
<h2 id="4-5-WORKING-WITH-APPS-指令"><a href="#4-5-WORKING-WITH-APPS-指令" class="headerlink" title="4.5 WORKING WITH APPS 指令"></a>4.5 WORKING WITH APPS 指令</h2><hr>
<h3 id="知识点：kubectl-attach-指令"><a href="#知识点：kubectl-attach-指令" class="headerlink" title="知识点：kubectl attach 指令"></a>知识点：kubectl attach 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 连接到容器中</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-cp-指令"><a href="#知识点：kubectl-cp-指令" class="headerlink" title="知识点：kubectl cp 指令"></a>知识点：kubectl cp 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* pod 文件复制</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-describ-指令"><a href="#知识点：kubectl-describ-指令" class="headerlink" title="知识点：kubectl describ 指令"></a>知识点：kubectl describ 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 查看资源对象的详细描述信息和最近的日志</span><br><span class="line">* 可以只查看指定的资源对象，也可以查看一组资源对象</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl describe TYPE NAME</span><br><span class="line">  kubectl describe TYPE NAME_PREFIX</span><br><span class="line">  kubectl describe TYPE -l label</span><br><span class="line">  kubectl describe TYPE/NAME [TYPE/NAME ...]</span><br><span class="line">  kubectl describe -f FILENAME</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test describe pod nginx01</span><br><span class="line"></span><br><span class="line">kubectl -n test describe pod/nginx01</span><br><span class="line"></span><br><span class="line">kubectl -n test describe pod</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 <span class="built_in">test</span> 命名空间下所有 pod 的描述信息</span></span><br><span class="line"></span><br><span class="line">kubectl -n test describe pod -l version=v1.17.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 按照标签选择 pod</span></span><br><span class="line"></span><br><span class="line">kubectl describe -f pod.json</span><br><span class="line"></span><br><span class="line">kubectl describe node node01</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看节点的描述信息</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-exec-指令"><a href="#知识点：kubectl-exec-指令" class="headerlink" title="知识点：kubectl exec 指令"></a>知识点：kubectl exec 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 切换到容器环境执行指令</span><br><span class="line">  - 与 docker exec 一样，可以用来进入容器</span><br><span class="line"></span><br><span class="line">* 如果省略 -c flags:</span><br><span class="line">  - use the kubectl.kubernetes.io/default-container annotation for selecting the container to be attached or the first container in the pod will be chosen</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl exec POD       -c CONTAINER [flags] [--] COMMAND [ARGS ...]</span><br><span class="line">  kubectl exec TYPE/NAME -c CONTAINER [flags] [--] COMMAND [ARGS ...]</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  -c, --container CONTAINER</span><br><span class="line">  -i, --stdin</span><br><span class="line">  -t, --tty</span><br><span class="line">  --</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test exec busybox -c busybox-container-01 -it -- /bin/bash</span><br><span class="line"># 进入容器环境</span><br><span class="line"></span><br><span class="line">kubectl -n test exec busybox -c busybox-container-01 -- date</span><br><span class="line"># 以容器环境执行一个命令，将结果打印到当前终端</span><br><span class="line"></span><br><span class="line">kubectl exec mypod -i -t -- ls -t /usr</span><br><span class="line"># 使用 -- 区分 kubectl 指令参数和 COMMAND 的 参数</span><br><span class="line"></span><br><span class="line">kubectl exec deploy/mydeployment -- date</span><br><span class="line"># Get output from running &#x27;date&#x27; command from the first pod of the deployment mydeployment, using the first container by default</span><br><span class="line"></span><br><span class="line">kubectl exec svc/myservice -- date</span><br><span class="line"># Get output from running &#x27;date&#x27; command from the first pod of the service myservice, using the first container by default</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-logs-指令"><a href="#知识点：kubectl-logs-指令" class="headerlink" title="知识点：kubectl logs 指令"></a>知识点：kubectl logs 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 查看 pod 容器日志</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl logs POD_NAME</span><br><span class="line">  kubectl logs TYPE/NAME</span><br><span class="line">  kubectl logs -l LABEL</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -n, --namespace NAMESPACE</span><br><span class="line">  -f, --follow</span><br><span class="line">  -p, --previous              # 打印容器上一个生命周期的，如果还存在的话</span><br><span class="line">  -c, --container CONTAINER   # 指定要查看的容器</span><br><span class="line">  --all-containers            # 查看 pod 下所有容器的日志</span><br><span class="line">  --tail NUMBER</span><br><span class="line">  --since TIME                # 只查看最近时间的日志</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs web -c web01</span><br><span class="line"></span><br><span class="line">kubectl logs web -c web01 -f</span><br><span class="line"></span><br><span class="line">kubectl logs -l app=web --all-containers</span><br><span class="line"></span><br><span class="line">kubectl logs web --since=1h</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-top-指令"><a href="#知识点：kubectl-top-指令" class="headerlink" title="知识点：kubectl top 指令"></a>知识点：kubectl top 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 显示集群的资源使用情况的一系列指令</span><br><span class="line">  - cpu</span><br><span class="line">  - memory</span><br><span class="line"></span><br><span class="line">* This command requires Metrics Server to be correctly configured and working on the server.</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-top-node-指令"><a href="#知识点：kubectl-top-node-指令" class="headerlink" title="知识点：kubectl top node 指令"></a>知识点：kubectl top node 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* 查看 node 的资源使用情况</span><br><span class="line">  - cpu</span><br><span class="line">  - menory</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl top node</span><br><span class="line">  kubectl top node NAME</span><br><span class="line">  kubectl top node -l label</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  --no-headers</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-top-pod-指令"><a href="#知识点：kubectl-top-pod-指令" class="headerlink" title="知识点：kubectl top pod 指令"></a>知识点：kubectl top pod 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 查看 pod 的资源使用情况</span><br><span class="line">  - cpu</span><br><span class="line">  - menory</span><br><span class="line"></span><br><span class="line">* Due to the metrics pipeline delay, they may be unavailable for a few minutes since pod creation.</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl top pod</span><br><span class="line">  kubectl top pod NAME</span><br><span class="line">  kubectl top pod -l label</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -A, --all-namespaces</span><br><span class="line">  --containers            # 同时打印出 pod 中的容器</span><br><span class="line">  --no-headers</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n test top pod</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="4-6-CLUSTER-MANAGEMENT-指令"><a href="#4-6-CLUSTER-MANAGEMENT-指令" class="headerlink" title="4.6 CLUSTER MANAGEMENT 指令"></a>4.6 CLUSTER MANAGEMENT 指令</h2><hr>
<h3 id="知识点：kubectl-api-versions-指令"><a href="#知识点：kubectl-api-versions-指令" class="headerlink" title="知识点：kubectl api-versions 指令"></a>知识点：kubectl api-versions 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 查看当前 K8S server 对 api 资源支持的版本</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl api-versions</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-cluster-info-指令"><a href="#知识点：kubectl-cluster-info-指令" class="headerlink" title="知识点：kubectl cluster-info 指令"></a>知识点：kubectl cluster-info 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 打印集群信息</span><br></pre></td></tr></table></figure></li>
<li><strong>格式</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl cluster-info</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-cluster-info-dump-指令"><a href="#知识点：kubectl-cluster-info-dump-指令" class="headerlink" title="知识点：kubectl cluster-info dump 指令"></a>知识点：kubectl cluster-info dump 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 打印集群的 dump 信息</span><br><span class="line">  - 用作 debug，当集群故障时</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl cluster-info dump</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -A, --all-namespaces      # dump 所有的命名空间</span><br><span class="line">  --namespaces LIST         # dump 列表中的命名空间</span><br><span class="line">  --output-directory DIR    # 指定保存信息的目录</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info dump --all-namespaces --output-directory=/tmp/dir</span><br><span class="line"><span class="meta">#</span><span class="bash"> dump 所有的命名空间，保存到 /tmp/dir 目录下</span></span><br><span class="line"></span><br><span class="line">kubectl cluster-info dump --namespaces default,kube-system --output-directory=/tmp/dir</span><br><span class="line"><span class="meta">#</span><span class="bash"> dump 指定的命名空间</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="知识点：kubectl-taint-指令"><a href="#知识点：kubectl-taint-指令" class="headerlink" title="知识点：kubectl taint 指令"></a>知识点：kubectl taint 指令</h3><ol>
<li><strong>介绍</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* 为节点设置污点</span><br></pre></td></tr></table></figure></li>
<li><strong>用法</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 格式</span><br><span class="line">  kubectl taint node NODE KEY=VAL:TAINT_EFFECT [ ...]</span><br><span class="line"></span><br><span class="line">* flags:</span><br><span class="line">  -l LABEL    # 按照标签来选择节点</span><br></pre></td></tr></table></figure></li>
<li><strong>范例</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 foo=bar:PreferNoSchedule</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置污点</span></span><br><span class="line"></span><br><span class="line">kubectl taint nodes node1 foo=:PreferNoSchedule</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置污点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> K8S 官方文档此处说可以省略 <span class="string">&#x27;=&#x27;</span>，但实际上如果省略 <span class="string">&#x27;=&#x27;</span> 就会报错</span></span><br><span class="line"></span><br><span class="line">kubectl taint nodes node1 foo:PreferNoSchedule-</span><br><span class="line"><span class="meta">#</span><span class="bash"> 去除污点</span></span><br><span class="line"></span><br><span class="line">kubectl taint nodes node1 foo-</span><br><span class="line"><span class="meta">#</span><span class="bash"> 去除所有 key 为 foo 的污点</span></span><br><span class="line"></span><br><span class="line">kubectl taint nodes MASTER node-role.kubernetes.io/master=:PreferNoSchedule</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 master 节点的默认污点改为 PreferNoSchedule，以保证到集群资源利用率过高时将部分 pod 调度到 master 上运行</span></span><br></pre></td></tr></table></figure></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2000/01/01/Blog31-docker/" rel="prev" title="Blog31-docker">
                  <i class="fa fa-chevron-left"></i> Blog31-docker
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2000/01/01/Blog41-nginx/" rel="next" title="Blog41-nginx">
                  Blog41-nginx <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2000 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"per_page":true,"tags":"none","cdn":"//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
